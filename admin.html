<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin Panel</title>
    
    <link rel="icon" type="image/png" href="https://i.ibb.co/20mS3KgF/IMG-20250630-184409.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/phosphor-icons"></script>
    
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .sidebar-item.active { background-color: #4f46e5; color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2); }
        .sidebar-item.active i { color: white; }
        .sidebar-item { transition: all 0.2s ease-in-out; }
        .sidebar-item:hover { background-color: #e0e7ff; color: #4f46e5; }
        .sidebar-item:hover i { color: #4f46e5; }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .form-input, .filter-input, .form-select { background-color: #f8fafc; border: 1px solid #e2e8f0; transition: all 0.3s ease; }
        .form-input:focus, .filter-input:focus, .form-select:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2); }
        .btn-primary { background-color: #4f46e5; transition: background-color 0.3s ease; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-primary:disabled { background-color: #a5b4fc; cursor: not-allowed; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; }
        .loader { border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid #fff; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; margin-left: 8px; }
        .modal-overlay { background-color: rgba(17, 24, 39, 0.7); backdrop-filter: blur(5px); transition: opacity 0.3s ease-in-out; }
        .modal-content { transition: transform 0.3s ease-in-out; }
        .sidebar-mobile { transform: translateX(-100%); transition: transform 0.3s ease-in-out; }
        .sidebar-mobile.open { transform: translateX(0); }
        .data-card { background-color: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: all 0.2s ease-in-out; border: 1px solid #e5e7eb; }
        .data-card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.08); }
        .action-card { cursor: pointer; }
        .live-feed-display { background-color: #111827; color: #d1d5db; font-family: 'Courier New', Courier, monospace; }
        .live-feed-display .feed-item { animation: slideIn 0.5s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        .paid { color: #22c55e; }
        .not-paid { color: #ef4444; }
        #imageViewerModal .modal-content { animation: zoomIn 0.3s ease-out; }
        @keyframes zoomIn { from { transform: scale(0.8); } to { transform: scale(1); } }
    </style>
</head>
<body class="bg-gray-100 antialiased">

    <div class="relative min-h-screen md:flex">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar-mobile fixed inset-y-0 left-0 bg-white shadow-xl w-64 z-30 md:relative md:translate-x-0">
            <div class="p-6 flex items-center justify-between border-b">
                <span class="text-2xl font-bold text-indigo-600">Admin Panel</span>
                <button id="closeMobileMenuBtn" class="md:hidden text-gray-500 hover:text-gray-800"><i class="ph-x text-2xl"></i></button>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <a href="#" class="sidebar-item flex items-center p-3 rounded-lg text-gray-700 active" data-view="dashboard"><i class="ph-layout text-xl mr-3"></i><span>Dashboard</span></a>
                <a href="#" class="sidebar-item flex items-center justify-between p-3 rounded-lg text-gray-700" data-view="approvals">
                    <div class="flex items-center"><i class="ph-check-square-offset text-xl mr-3"></i><span>Approvals</span></div>
                    <span id="pending-count-badge" class="bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                </a>
                <a href="#" class="sidebar-item flex items-center p-3 rounded-lg text-gray-700" data-view="all-members"><i class="ph-users-three text-xl mr-3"></i><span>All Members</span></a>
                <a href="#" class="sidebar-item flex items-center p-3 rounded-lg text-gray-700" data-view="data-entry"><i class="ph-note-pencil text-xl mr-3"></i><span>Data Entry</span></a>
                <a href="#" class="sidebar-item flex items-center p-3 rounded-lg text-gray-700" data-view="data-explorer"><i class="ph-database text-xl mr-3"></i><span>Data Explorer</span></a>
                <a href="#" class="sidebar-item flex items-center p-3 rounded-lg text-gray-700" data-view="gallery"><i class="ph-images text-xl mr-3"></i><span>Gallery</span></a>
                <a href="registration.html" target="_blank" class="sidebar-item flex items-center p-3 rounded-lg text-gray-700"><i class="ph-user-plus text-xl mr-3"></i><span>New Registration</span></a>
                <a href="https://bankcommunity.sbs/" target="_blank" class="sidebar-item flex items-center p-3 rounded-lg text-gray-700"><i class="ph-bank text-xl mr-3"></i><span>Bank Site</span></a>
            </nav>
            <div class="p-4 border-t"><button id="logoutBtn" class="w-full flex items-center p-3 rounded-lg text-gray-700 hover:bg-red-100 hover:text-red-600"><i class="ph-sign-out text-xl mr-3"></i><span>Logout</span></button></div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-4 sm:p-6 md:p-8 lg:p-10 overflow-y-auto">
            <div class="md:hidden flex justify-between items-center mb-6"><h1 id="mobile-header-title" class="text-2xl font-bold text-gray-800">Dashboard</h1><button id="mobileMenuBtn" class="text-gray-600 focus:outline-none"><i class="ph-list text-3xl"></i></button></div>
            
            <div id="dashboard-view" class="view active"></div>
            <div id="approvals-view" class="view"></div>
            <div id="all-members-view" class="view"></div>
            <div id="data-entry-view" class="view"></div>
            <div id="data-explorer-view" class="view"></div>
            <div id="gallery-view" class="view"></div>
        </main>
    </div>

    <!-- All Modals -->
    <div id="memberDetailModal" class="modal-overlay fixed inset-0 z-50 hidden items-center justify-center p-4 opacity-0"></div>
    <div id="editMemberModal" class="modal-overlay fixed inset-0 z-50 hidden items-center justify-center p-4 opacity-0"></div>
    <div id="confirmModal" class="modal-overlay fixed inset-0 z-50 hidden items-center justify-center p-4 opacity-0">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md p-6 scale-95">
            <h3 id="confirmModalTitle" class="text-lg font-bold text-gray-900">Confirmation</h3>
            <p id="confirmModalMessage" class="mt-2 text-sm text-gray-600">Are you sure?</p>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="confirmCancelBtn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">Cancel</button>
                <button id="confirmOkBtn" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">Confirm</button>
            </div>
        </div>
    </div>
    <div id="imageViewerModal" class="modal-overlay fixed inset-0 z-50 hidden items-center justify-center p-4 opacity-0">
        <div class="modal-content relative w-full h-full flex items-center justify-center">
            <img id="fullImageView" src="" class="max-w-[90vw] max-h-[90vh] object-contain rounded-lg shadow-2xl">
            <button id="closeImageViewer" class="absolute top-2 right-2 text-white bg-black bg-opacity-50 rounded-full p-2 hover:bg-opacity-75 transition-colors">
                <i class="ph-x text-3xl"></i>
            </button>
        </div>
    </div>
    
    <script type="module">
        if (sessionStorage.getItem('isAdminLoggedIn') !== 'true') { window.location.href = 'login.html'; }

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getDatabase, ref, onValue, get, update, remove, push } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        let db, auth, IMGBB_API_KEY;
        let allMembersData = {}, allTransactions = [], approvedMemberObjects = [], allGalleryData = {};

        async function startApp() {
            try {
                const response = await fetch('/api/config');
                if (!response.ok) throw new Error('Config fetch failed');
                const config = await response.json();
                
                IMGBB_API_KEY = config.imgbb.apiKey;
                const app = initializeApp(config.firebase);
                auth = getAuth(app);
                db = getDatabase(app);

                attachNavigationHandlers();
                fetchAllData();
            } catch (error) {
                console.error("App Init Failed:", error);
                document.body.innerHTML = `<div class="text-center p-8"><h1>Initialization Error</h1><p>${error.message}</p><a href='login.html'>Go to Login</a></div>`;
            }
        }

        function fetchAllData() {
            onValue(ref(db), (snapshot) => {
                if (!snapshot.exists()) { console.warn("No data in Firebase."); return; }
                const data = snapshot.val();
                allMembersData = data.members || {};
                allGalleryData = data.gallery || {};
                processAllData(allMembersData);
            });
        }

        function processAllData(members) {
            for (const memberId in members) {
                const member = members[memberId];
                let balance = 0;
                if (member.transactions) {
                    const memberTransactions = Object.values(member.transactions);
                    const totalSip = memberTransactions.reduce((sum, tx) => sum + parseFloat(tx['SIP Payment'] || 0), 0);
                    const totalLoanPayment = memberTransactions.reduce((sum, tx) => sum + parseFloat(tx['Loan Payment'] || 0), 0);
                    const totalExtraPayment = memberTransactions.reduce((sum, tx) => sum + parseFloat(tx['Extra Balance'] || 0), 0);
                    const totalLoan = memberTransactions.reduce((sum, tx) => sum + parseFloat(tx.Loan || 0), 0);
                    balance = (totalSip + totalLoanPayment + totalExtraPayment) - totalLoan;
                }
                members[memberId].currentBalance = balance;
            }
            
            allMembersData = members;

            approvedMemberObjects = Object.entries(members)
                .filter(([id, m]) => m.status === 'Approved' && m.fullName)
                .map(([id, m]) => ({ name: m.fullName, id: id, balance: m.currentBalance }))
                .sort((a, b) => a.name.localeCompare(b.name));

            allTransactions = [];
            for (const memberId in members) {
                const member = members[memberId];
                if (member.transactions) {
                    for (const txId in member.transactions) {
                        allTransactions.push({ ...member.transactions[txId], memberId, txId, Name: member.fullName });
                    }
                }
            }
            allTransactions.sort((a, b) => new Date(b.Date) - new Date(a.Date));
            
            const activeViewId = document.querySelector('.view.active')?.id.replace('-view', '');
            if (activeViewId) {
                navigateToView(activeViewId, true);
            }
        }
        
        // --- RENDER FUNCTIONS FOR EACH VIEW ---

        function renderDashboard() {
            const container = document.getElementById('dashboard-view');
            
            const today = new Date();
            const todayString = today.toISOString().split('T')[0];

            const todaysTransactions = allTransactions.filter(t => {
                if (!t.Date) return false;
                return new Date(t.Date).toISOString().split('T')[0] === todayString;
            });

            const todaysSip = todaysTransactions.reduce((sum, t) => sum + parseFloat(t['SIP Payment'] || 0), 0);
            const todaysLoan = todaysTransactions.reduce((sum, t) => sum + parseFloat(t.Loan || 0), 0);

            const currentDay = today.getDate();
            const isSipWindow = currentDay >= 1 && currentDay <= 10;
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            const sipStatusList = Object.entries(allMembersData)
                .filter(([id, m]) => m.status === 'Approved')
                .map(([id, member]) => {
                    const hasPaid = Object.values(member.transactions || {}).some(tx => 
                        tx['SIP Payment'] > 0 &&
                        new Date(tx.Date).getMonth() === currentMonth &&
                        new Date(tx.Date).getFullYear() === currentYear
                    );
                    return { name: member.fullName, hasPaid };
                })
                .sort((a, b) => a.name.localeCompare(b.name));

            container.innerHTML = `
                <h1 class="text-3xl font-bold text-gray-800 mb-6 hidden md:block">Dashboard</h1>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="lg:col-span-1 live-feed-display rounded-xl shadow-md p-4 h-64 flex flex-col">
                        <h3 class="text-lg font-semibold text-white mb-3">Live Activity Today</h3>
                        <div id="live-feed-container" class="flex-grow overflow-y-auto space-y-2 pr-2">
                           ${todaysTransactions.length === 0 ? '<p class="text-gray-400">No activity yet today.</p>' : 
                             todaysTransactions.map(t => {
                                let activity = '';
                                if (t['SIP Payment']) activity = `<span class="text-green-400">SIP of ₹${t['SIP Payment']}</span> by ${t.Name}`;
                                else if (t.Loan) activity = `<span class="text-red-400">Loan of ₹${t.Loan}</span> to ${t.Name}`;
                                else if (t['Loan Payment']) activity = `<span class="text-blue-400">Payment of ₹${t['Loan Payment']}</span> by ${t.Name}`;
                                else if (t['Extra Balance']) activity = `<span class="text-yellow-400">Extra of ₹${t['Extra Balance']}</span> by ${t.Name}`;
                                return `<div class="feed-item text-sm">${activity}</div>`;
                             }).join('')
                           }
                        </div>
                    </div>
                    <div class="lg:col-span-2 bg-white rounded-xl shadow-md p-6 h-64 flex flex-col">
                         <h3 class="text-lg font-semibold text-gray-800 mb-3">Current Month SIP Status ${isSipWindow ? '<span class="text-sm font-normal text-red-500">(Payment Window Active)</span>' : ''}</h3>
                         <div class="flex-grow overflow-y-auto">
                            <ul id="sip-status-list" class="space-y-3">
                                ${sipStatusList.map(s => `
                                    <li class="flex justify-between items-center text-sm">
                                        <span>${s.name}</span>
                                        <span class="font-bold ${s.hasPaid ? 'paid' : 'not-paid'}">${s.hasPaid ? 'PAID' : 'NOT PAID'}</span>
                                    </li>
                                `).join('')}
                            </ul>
                         </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="data-card p-6"><div class="flex items-center text-green-500"><i class="ph-money text-2xl mr-3"></i><h2 class="font-medium">Today's SIP Collection</h2></div><p class="text-3xl font-bold text-green-600 mt-2">₹${todaysSip.toLocaleString('en-IN')}</p></div>
                    <div class="data-card p-6"><div class="flex items-center text-red-500"><i class="ph-chart-line-down text-2xl mr-3"></i><h2 class="font-medium">Today's Loan Disbursed</h2></div><p class="text-3xl font-bold text-red-600 mt-2">₹${todaysLoan.toLocaleString('en-IN')}</p></div>
                    <div class="data-card action-card p-6" data-target-view="approvals"><div class="flex items-center text-yellow-500"><i class="ph-clock text-2xl mr-3"></i><h2 class="font-medium">Pending Approvals</h2></div><p id="pending-count-stat" class="text-3xl font-bold text-yellow-600 mt-2">0</p></div>
                    <div class="data-card action-card p-6" data-target-view="all-members"><div class="flex items-center text-indigo-500"><i class="ph-users-three text-2xl mr-3"></i><h2 class="font-medium">Approved Members</h2></div><p id="approved-count-stat" class="text-3xl font-bold text-indigo-600 mt-2">0</p></div>
                </div>
            `;
            const pendingCount = Object.values(allMembersData).filter(m => m.status === 'Pending').length;
            const approvedCount = Object.values(allMembersData).filter(m => m.status === 'Approved').length;
            document.getElementById('pending-count-stat').textContent = pendingCount;
            document.getElementById('approved-count-stat').textContent = approvedCount;
        }
        
        function renderApprovals(members) { 
            const container = document.getElementById('approvals-view');
            container.innerHTML = `<h1 class="text-3xl font-bold text-gray-800 mb-6">Pending Registrations</h1><div id="approvals-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>`;
            const approvalContainer = container.querySelector('#approvals-container');
            const badge = document.getElementById('pending-count-badge');
            let pendingCount = 0;
            for (const memberId in members) {
                const member = members[memberId];
                if (member.status === 'Pending') {
                    pendingCount++;
                    const card = document.createElement('div');
                    card.className = 'data-card p-4 space-y-3';
                    card.innerHTML = `<div class="flex items-center space-x-4"><img src="${member.profilePicUrl}" onerror="this.src='https://placehold.co/64x64/E0E7FF/4F46E5?text=User'" class="w-16 h-16 rounded-full object-cover border-2 border-gray-200"><div><p class="font-bold text-lg text-gray-800">${member.fullName}</p><p class="text-sm text-gray-500">Applied: ${new Date(member.createdAt).toLocaleDateString()}</p></div></div><p class="text-sm text-gray-600"><i class="ph-phone-call text-indigo-500"></i> ${member.mobileNumber}</p><button class="review-btn btn-primary w-full text-white font-bold py-2 px-4 rounded-lg" data-id="${memberId}">Review Application</button>`;
                    approvalContainer.appendChild(card);
                }
            }
            if (pendingCount > 0) { badge.textContent = pendingCount; badge.classList.remove('hidden'); } 
            else { approvalContainer.innerHTML = `<p class="text-center text-gray-500 col-span-full mt-8">No pending applications found.</p>`; badge.classList.add('hidden'); }
        }

        function renderAllMembersPage(members, searchTerm = '') { 
            const container = document.getElementById('all-members-view');
            container.innerHTML = `<h1 class="text-3xl font-bold text-gray-800 mb-6">All Approved Members</h1><div class="mb-4"><input type="text" id="member-search-input" placeholder="Search members by name..." class="form-input w-full p-3 rounded-lg" value="${searchTerm}"></div><div id="all-members-container" class="bg-white rounded-xl shadow-md overflow-x-auto"></div>`;
            const listContainer = container.querySelector('#all-members-container');
            const approvedMembers = Object.entries(members)
                .filter(([id, member]) => member.status === 'Approved' && member.fullName.toLowerCase().includes(searchTerm.toLowerCase()));

            if (approvedMembers.length === 0) {
                listContainer.innerHTML = `<p class="text-center text-gray-500 p-8">No approved members found.</p>`;
                return;
            }

            const table = document.createElement('table');
            table.className = 'w-full text-sm text-left text-gray-500';
            table.innerHTML = `<thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th scope="col" class="px-6 py-3">Name</th><th scope="col" class="px-6 py-3 hidden md:table-cell">Mobile</th><th scope="col" class="px-6 py-3">Balance</th><th scope="col" class="px-6 py-3">Actions</th></tr></thead><tbody></tbody>`;
            const tbody = table.querySelector('tbody');
            approvedMembers.forEach(([id, member]) => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${member.fullName}</td>
                    <td class="px-6 py-4 hidden md:table-cell">${member.mobileNumber}</td>
                    <td class="px-6 py-4 font-medium ${member.currentBalance >= 0 ? 'text-green-600' : 'text-red-600'}">₹${member.currentBalance.toLocaleString('en-IN')}</td>
                    <td class="px-6 py-4 flex items-center space-x-4">
                        <button class="view-profile-btn font-medium text-indigo-600 hover:underline" data-id="${id}">View</button>
                        <button class="edit-member-btn font-medium text-green-600 hover:underline" data-id="${id}">Edit</button>
                        <button class="delete-member-btn font-medium text-red-600 hover:underline" data-id="${id}" data-name="${member.fullName}">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            listContainer.appendChild(table);
        }

        function renderDataEntryForm() {
            const container = document.getElementById('data-entry-view');
            const today = new Date().toISOString().split('T')[0];
            container.innerHTML = `
                <h1 class="text-3xl font-bold text-gray-800 mb-6">New Transaction Entry</h1>
                <form id="data-entry-form" class="bg-white p-8 rounded-xl shadow-md space-y-6">
                    <div>
                        <label for="entry-type" class="block text-sm font-medium text-gray-700 mb-1">Transaction Type</label>
                        <select id="entry-type" class="form-select w-full p-3 rounded-lg">
                            <option value="sip">SIP Payment</option>
                            <option value="loan">Loan</option>
                            <option value="loan_payment">Loan Payment</option>
                            <option value="extra_payment">Extra Payment</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="entry-date" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                            <input type="date" id="entry-date" class="form-input w-full p-3 rounded-lg" value="${today}" required>
                        </div>
                        <div>
                            <label for="entry-name" class="block text-sm font-medium text-gray-700 mb-1">Member Name</label>
                            <select id="entry-name" class="form-select w-full p-3 rounded-lg" required>
                                <option value="">Select a member...</option>
                                ${approvedMemberObjects.map(m => `<option value="${m.id}">${m.name}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label for="current-balance" class="block text-sm font-medium text-gray-700 mb-1">Current Balance</label>
                        <input type="text" id="current-balance" class="form-input w-full p-3 rounded-lg bg-gray-200" value="Select a member to see balance" readonly>
                    </div>

                    <!-- Dynamic Fields -->
                    <div id="sip-fields">
                        <label for="sip-payment" class="block text-sm font-medium text-gray-700 mb-1">SIP Payment Amount</label>
                        <input type="number" id="sip-payment" placeholder="e.g., 500" class="form-input w-full p-3 rounded-lg">
                    </div>
                    <div id="loan-fields" class="hidden">
                         <label for="loan-amount" class="block text-sm font-medium text-gray-700 mb-1">Loan Amount</label>
                        <input type="number" id="loan-amount" placeholder="e.g., 10000" class="form-input w-full p-3 rounded-lg">
                    </div>
                    <div id="loan-payment-fields" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="loan-payment-amount" class="block text-sm font-medium text-gray-700 mb-1">Loan Payment Amount</label>
                            <input type="number" id="loan-payment-amount" placeholder="e.g., 2000" class="form-input w-full p-3 rounded-lg">
                        </div>
                        <div>
                            <label for="return-amount" class="block text-sm font-medium text-gray-700 mb-1">Return Amount</label>
                            <input type="number" id="return-amount" placeholder="e.g., 50" class="form-input w-full p-3 rounded-lg">
                        </div>
                    </div>
                     <div id="extra-payment-fields" class="hidden">
                         <label for="extra-balance-amount" class="block text-sm font-medium text-gray-700 mb-1">Extra Balance Amount</label>
                        <input type="number" id="extra-balance-amount" placeholder="e.g., 1000" class="form-input w-full p-3 rounded-lg">
                    </div>

                    <!-- Common Fields -->
                    <div>
                        <label for="penalty-amount" class="block text-sm font-medium text-gray-700 mb-1">Penalty Amount (Optional)</label>
                        <input type="number" id="penalty-amount" placeholder="e.g., 10" class="form-input w-full p-3 rounded-lg">
                    </div>
                    <div>
                        <label for="entry-document" class="block text-sm font-medium text-gray-700 mb-1">Document Picture (Optional)</label>
                        <input type="file" id="entry-document" class="form-input w-full p-2 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                    </div>

                    <div class="flex justify-end">
                        <button type="submit" id="submit-entry-btn" class="btn-primary flex items-center justify-center text-white font-bold py-3 px-6 rounded-lg">
                            Submit Entry
                            <span class="loader hidden"></span>
                        </button>
                    </div>
                </form>
            `;
        }

        function renderDataExplorer() {
            const container = document.getElementById('data-explorer-view');
            container.innerHTML = `
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Data Explorer</h1>
                <div class="bg-white p-4 rounded-xl shadow-md mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="explorer-name-filter" class="text-sm font-medium text-gray-700">Filter by Name</label>
                            <select id="explorer-name-filter" class="filter-input w-full p-2 rounded-lg mt-1">
                                <option value="all">All Members</option>
                                ${approvedMemberObjects.map(m => `<option value="${m.name}">${m.name}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label for="explorer-type-filter" class="text-sm font-medium text-gray-700">Filter by Type</label>
                            <select id="explorer-type-filter" class="filter-input w-full p-2 rounded-lg mt-1">
                                <option value="all">All Transactions</option>
                                <option value="SIP Payment">SIP Payment</option>
                                <option value="Loan">Loan</option>
                                <option value="Loan Payment">Loan Payment</option>
                                <option value="Extra Balance">Extra Balance</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="explorer-results-container" class="bg-white rounded-xl shadow-md overflow-x-auto"></div>
            `;
            applyExplorerFilters();
        }

        function applyExplorerFilters() {
            const container = document.getElementById('explorer-results-container');
            if (!container) return;

            const nameFilter = document.getElementById('explorer-name-filter').value;
            const typeFilter = document.getElementById('explorer-type-filter').value;

            let filteredTransactions = allTransactions;

            if (nameFilter !== 'all') {
                filteredTransactions = filteredTransactions.filter(tx => tx.Name === nameFilter);
            }

            if (typeFilter !== 'all') {
                filteredTransactions = filteredTransactions.filter(tx => tx[typeFilter] && parseFloat(tx[typeFilter]) > 0);
            }

            if (filteredTransactions.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 p-8">No matching transactions found.</p>`;
                return;
            }

            const table = document.createElement('table');
            table.className = 'w-full text-sm text-left text-gray-500';
            table.innerHTML = `<thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr>
                <th scope="col" class="px-6 py-3">Date</th>
                <th scope="col" class="px-6 py-3">Name</th>
                <th scope="col" class="px-6 py-3">Type</th>
                <th scope="col" class="px-6 py-3 text-right">Amount</th>
            </tr></thead><tbody></tbody>`;
            const tbody = table.querySelector('tbody');

            filteredTransactions.forEach(tx => {
                let type = 'Unknown';
                let amountHtml = '';
                let amountColor = 'text-gray-800';

                if (tx['SIP Payment']) {
                    type = 'SIP';
                    amountColor = 'text-green-600';
                    amountHtml = `₹${parseFloat(tx['SIP Payment']).toLocaleString('en-IN')}`;
                } else if (tx['Loan']) {
                    type = 'Loan';
                    amountColor = 'text-red-600';
                    amountHtml = `₹${parseFloat(tx['Loan']).toLocaleString('en-IN')}`;
                } else if (tx['Loan Payment']) {
                    type = 'Payment';
                    amountColor = 'text-blue-600';
                    const payment = parseFloat(tx['Loan Payment'] || 0);
                    const returnAmt = parseFloat(tx['Return amount'] || 0);
                    const penaltyAmt = parseFloat(tx['Penalty amount'] || 0);
                    amountHtml = `<div class="font-bold">₹${payment.toLocaleString('en-IN')}</div>`;
                    if (returnAmt > 0 || penaltyAmt > 0) {
                        amountHtml += `<div class="text-xs text-gray-500 mt-1">`;
                        if (returnAmt > 0) amountHtml += `Return: ₹${returnAmt}`;
                        if (penaltyAmt > 0) amountHtml += `${returnAmt > 0 ? ' | ' : ''}Penalty: ₹${penaltyAmt}`;
                        amountHtml += `</div>`;
                    }
                } else if (tx['Extra Balance']) {
                    type = 'Extra';
                    amountColor = 'text-yellow-600';
                    amountHtml = `₹${parseFloat(tx['Extra Balance']).toLocaleString('en-IN')}`;
                }

                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4">${new Date(tx.Date).toLocaleDateString('en-GB')}</td>
                    <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${tx.Name}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 font-semibold leading-tight ${amountColor} bg-opacity-20 bg-gray-200 rounded-full">${type}</span></td>
                    <td class="px-6 py-4 text-right ${amountColor}">${amountHtml}</td>
                `;
                tbody.appendChild(row);
            });
            container.innerHTML = '';
            container.appendChild(table);
        }

        function renderGallery(galleryData) {
            const container = document.getElementById('gallery-view');
            container.innerHTML = `<h1 class="text-3xl font-bold text-gray-800 mb-6">Gallery Management</h1><div id="gallery-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>`;
            const galleryContainer = container.querySelector('#gallery-container');
            if (!galleryData || Object.keys(galleryData).length === 0) {
                galleryContainer.innerHTML = `<p class="text-center text-gray-500 col-span-full mt-8">No images in gallery.</p>`;
                return;
            }
            for (const key in galleryData) {
                const item = galleryData[key];
                const card = document.createElement('div');
                card.className = 'relative group';
                card.innerHTML = `
                    <img src="${item.url}" class="gallery-image w-full h-40 object-cover rounded-lg shadow-md cursor-pointer transition-transform duration-300 group-hover:scale-105">
                    <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-60 transition-all flex items-center justify-center">
                        <button class="delete-gallery-btn text-white opacity-0 group-hover:opacity-100 transition-opacity p-2 bg-red-600 rounded-full" data-key="${key}"><i class="ph-trash text-2xl"></i></button>
                    </div>
                `;
                galleryContainer.appendChild(card);
            }
        }
        
        // --- MODAL AND HELPER FUNCTIONS ---

        function openModal(modal) { modal.classList.remove('hidden', 'opacity-0'); }
        function closeModal(modal) { modal.classList.add('opacity-0'); setTimeout(() => modal.classList.add('hidden'), 300); }
        function showConfirmation(title, message) { return new Promise(resolve => { const modal = document.getElementById('confirmModal'); modal.querySelector('#confirmModalTitle').textContent = title; modal.querySelector('#confirmModalMessage').textContent = message; openModal(modal); const okBtn = modal.querySelector('#confirmOkBtn'); const cancelBtn = modal.querySelector('#confirmCancelBtn'); const cleanup = () => { closeModal(modal); okBtn.onclick = null; cancelBtn.onclick = null; }; okBtn.onclick = () => { cleanup(); resolve(true); }; cancelBtn.onclick = () => { cleanup(); resolve(false); }; }); }
        
        async function handleFormSubmission(e) {
            e.preventDefault();
            const btn = document.getElementById('submit-entry-btn');
            const loader = btn.querySelector('.loader');
            btn.disabled = true;
            loader.classList.remove('hidden');

            const memberId = document.getElementById('entry-name').value;
            if (!memberId) {
                alert('Please select a member.');
                btn.disabled = false;
                loader.classList.add('hidden');
                return;
            }
            const memberName = approvedMemberObjects.find(m => m.id === memberId)?.name;
            const date = document.getElementById('entry-date').value;
            const file = document.getElementById('entry-document').files[0];

            let imageUrl = '';
            if (file) {
                const formData = new FormData();
                formData.append('image', file);
                try {
                    const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData });
                    const json = await res.json();
                    if (!json.success) throw new Error(json.error.message);
                    imageUrl = json.data.url;
                } catch (err) {
                    alert('Image upload failed: ' + err.message);
                    btn.disabled = false;
                    loader.classList.add('hidden');
                    return;
                }
            }

            const transactionData = {
                Date: new Date(date).toISOString(),
                Name: memberName,
                "SIP Payment": document.getElementById('sip-payment').value || "",
                "Loan": document.getElementById('loan-amount').value || "",
                "Loan Payment": document.getElementById('loan-payment-amount').value || "",
                "Return amount": document.getElementById('return-amount').value || "",
                "Extra Balance": document.getElementById('extra-balance-amount').value || "",
                "Penalty amount": document.getElementById('penalty-amount').value || "",
                imageUrl: imageUrl
            };

            try {
                const txRef = ref(db, `members/${memberId}/transactions`);
                await push(txRef, transactionData);
                alert('Transaction added successfully!');
                e.target.reset();
                document.getElementById('entry-type').dispatchEvent(new Event('change'));
                document.getElementById('current-balance').value = 'Select a member to see balance';
            } catch (err) {
                alert('Failed to save transaction: ' + err.message);
            } finally {
                btn.disabled = false;
                loader.classList.add('hidden');
            }
        }

        // --- EVENT HANDLERS ---
        
        function attachNavigationHandlers() {
            const sidebar = document.getElementById('sidebar');
            document.getElementById('mobileMenuBtn').addEventListener('click', () => sidebar.classList.add('open'));
            document.getElementById('closeMobileMenuBtn').addEventListener('click', () => sidebar.classList.remove('open'));
            document.querySelectorAll('.sidebar-item[data-view]').forEach(item => item.addEventListener('click', (e) => { e.preventDefault(); if (!item.hasAttribute('target')) navigateToView(item.dataset.view); }));
            document.getElementById('dashboard-view').addEventListener('click', e => { const card = e.target.closest('.action-card'); if (card && card.dataset.targetView) navigateToView(card.dataset.targetView); });
            document.getElementById('logoutBtn').addEventListener('click', async () => { await signOut(auth); sessionStorage.removeItem('isAdminLoggedIn'); window.location.href = 'login.html'; });
            document.querySelectorAll('.modal-overlay').forEach(modal => modal.addEventListener('click', e => { if (e.target === modal) closeModal(modal); }));
            document.getElementById('confirmCancelBtn').addEventListener('click', () => closeModal(document.getElementById('confirmModal')));
            document.getElementById('closeImageViewer').addEventListener('click', () => closeModal(document.getElementById('imageViewerModal')));
        }

        function navigateToView(viewId, forceRender = false) {
            const currentActiveView = document.querySelector('.view.active');
            if (currentActiveView?.id === `${viewId}-view` && !forceRender) {
                return;
            }

            document.getElementById('mobile-header-title').textContent = viewId.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            document.querySelectorAll('.sidebar-item').forEach(i => i.classList.toggle('active', i.dataset.view === viewId));
            document.querySelectorAll('.view').forEach(view => {
                const isActive = view.id === `${viewId}-view`;
                view.classList.toggle('active', isActive);
                if(isActive) {
                    if(viewId === 'dashboard') renderDashboard();
                    else if (viewId === 'approvals') renderApprovals(allMembersData);
                    else if (viewId === 'all-members') renderAllMembersPage(allMembersData);
                    else if (viewId === 'data-entry') renderDataEntryForm();
                    else if (viewId === 'data-explorer') renderDataExplorer();
                    else if (viewId === 'gallery') renderGallery(allGalleryData);
                }
            });
            if (document.getElementById('sidebar').classList.contains('open')) {
                document.getElementById('sidebar').classList.remove('open');
            }
        }

        document.body.addEventListener('input', e => {
            if (e.target.id === 'member-search-input') {
                renderAllMembersPage(allMembersData, e.target.value);
            }
            if (e.target.id === 'explorer-name-filter' || e.target.id === 'explorer-type-filter') {
                applyExplorerFilters();
            }
        });

        document.body.addEventListener('change', e => {
            if (e.target.id === 'entry-type') {
                const type = e.target.value;
                document.getElementById('sip-fields').classList.toggle('hidden', type !== 'sip');
                document.getElementById('loan-fields').classList.toggle('hidden', type !== 'loan');
                document.getElementById('loan-payment-fields').classList.toggle('hidden', type !== 'loan_payment');
                document.getElementById('extra-payment-fields').classList.toggle('hidden', type !== 'extra_payment');
            }
            if (e.target.id === 'entry-name') {
                const selectedMemberId = e.target.value;
                const balanceDisplay = document.getElementById('current-balance');
                if (selectedMemberId) {
                    const member = approvedMemberObjects.find(m => m.id === selectedMemberId);
                    if (member) {
                        balanceDisplay.value = `₹ ${member.balance.toLocaleString('en-IN')}`;
                    }
                } else {
                    balanceDisplay.value = 'Select a member to see balance';
                }
            }
        });
        
        document.body.addEventListener('submit', e => {
            if (e.target.id === 'data-entry-form') {
                handleFormSubmission(e);
            }
        });
        
        document.body.addEventListener('click', async e => {
            const reviewBtn = e.target.closest('.review-btn');
            if(reviewBtn) alert('Review functionality to be implemented.');

            const viewProfileBtn = e.target.closest('.view-profile-btn');
            if(viewProfileBtn) alert('View profile functionality to be implemented.');

            const editMemberBtn = e.target.closest('.edit-member-btn');
            if(editMemberBtn) alert('Edit member functionality to be implemented.');

            const deleteMemberBtn = e.target.closest('.delete-member-btn');
            if(deleteMemberBtn) {
                const confirmed = await showConfirmation(`Delete ${deleteMemberBtn.dataset.name}?`, 'This will permanently delete the member and all their transactions. This action cannot be undone.');
                if(confirmed) {
                    try {
                        await remove(ref(db, `members/${deleteMemberBtn.dataset.id}`));
                        alert('Member deleted successfully.');
                    } catch (err) {
                        alert('Error deleting member: ' + err.message);
                    }
                }
            }

            const galleryImg = e.target.closest('.gallery-image');
            if (galleryImg) {
                const modal = document.getElementById('imageViewerModal');
                modal.querySelector('#fullImageView').src = galleryImg.src;
                openModal(modal);
            }

            const deleteGalleryBtn = e.target.closest('.delete-gallery-btn');
            if(deleteGalleryBtn) {
                const confirmed = await showConfirmation('Delete Image?', 'Are you sure you want to permanently delete this image?');
                if(confirmed) {
                    try {
                        await remove(ref(db, `gallery/${deleteGalleryBtn.dataset.key}`));
                        alert('Image deleted successfully.');
                    } catch (err) {
                        alert('Error deleting image: ' + err.message);
                    }
                }
            }
        });

        startApp();
    </script>
</body>
</html>

