<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <!-- All head content like icons, fonts, styles are the same -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/phosphor-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        /* All styles are the same */
        body { font-family: 'Poppins', sans-serif; }
        .sidebar-item.active { background-color: #4f46e5; color: white; }
        .sidebar-item.active i { color: white; }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-100 antialiased">

    <div class="relative min-h-screen md:flex">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar-mobile fixed inset-y-0 left-0 bg-white shadow-xl w-64 z-30 md:relative md:translate-x-0">
            <div class="p-6 flex items-center justify-between border-b">
                <span class="text-2xl font-bold text-indigo-600">Admin Panel</span>
                <button id="closeMobileMenuBtn" class="md:hidden"><i class="ph-x text-2xl"></i></button>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <a href="#" class="sidebar-item flex items-center p-3 rounded-lg active" data-view="dashboard"><i class="ph-layout text-xl mr-3"></i><span>Dashboard</span></a>
                
                <!-- NEW: Approvals Link with Badge -->
                <a href="#" class="sidebar-item flex items-center justify-between p-3 rounded-lg" data-view="approvals">
                    <div class="flex items-center">
                        <i class="ph-check-square-offset text-xl mr-3"></i>
                        <span>Approvals</span>
                    </div>
                    <span id="pending-count-badge" class="bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                </a>
                
                <a href="#" class="sidebar-item flex items-center p-3 rounded-lg" data-view="data-entry"><i class="ph-note-pencil text-xl mr-3"></i><span>Data Entry</span></a>
                <a href="#" class="sidebar-item flex items-center p-3 rounded-lg" data-view="firebase-data"><i class="ph-database text-xl mr-3"></i><span>Firebase Explorer</span></a>
                <!-- Other links are the same -->
            </nav>
            <div class="p-4 border-t">
                <button id="logoutBtn" class="w-full flex items-center p-3 rounded-lg text-gray-700 hover:bg-red-100 hover:text-red-600">
                    <i class="ph-sign-out text-xl mr-3"></i>
                    <span>Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-4 sm:p-6 md:p-8 lg:p-10 overflow-y-auto">
            <!-- Dashboard View (Unchanged) -->
            <div id="dashboard-view" class="view active">...</div>
            
            <!-- Data Entry View (Unchanged) -->
            <div id="data-entry-view" class="view">...</div>

            <!-- Firebase Data Explorer View (Unchanged) -->
            <div id="firebase-data-view" class="view">...</div>

            <!-- NEW: Approvals View -->
            <div id="approvals-view" class="view">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Pending Registrations</h1>
                <div id="approvals-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Pending application cards will be populated here -->
                </div>
            </div>
        </main>
    </div>

    <!-- All existing modals are the same -->
    
    <!-- NEW: Approval Detail Modal -->
    <div id="approvalDetailModal" class="modal-overlay fixed inset-0 z-50 hidden items-center justify-center p-4 opacity-0">
        <div class="modal-content bg-white p-6 rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col transform scale-95">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="text-xl font-bold text-gray-800">Review Application</h3>
                <button class="close-modal-btn text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="approvalDetailContent" class="flex-1 overflow-y-auto pr-2">
                <!-- Details will be injected here -->
            </div>
            <div class="pt-4 border-t mt-4 flex justify-end space-x-3">
                <button id="rejectBtn" class="btn-danger font-bold py-2 px-6 rounded-lg flex items-center">
                    <i class="ph-x-circle mr-2"></i> Reject
                </button>
                <button id="approveBtn" class="btn-primary bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg flex items-center">
                    <i class="ph-check-circle mr-2"></i> Approve
                </button>
            </div>
        </div>
    </div>


    <script type="module">
        // --- IMPORTANT: Authentication Guard ---
        if (sessionStorage.getItem('isAdminLoggedIn') !== 'true') {
            window.location.href = 'login.html';
        }

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getDatabase, ref, onValue, update, remove } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        // Main App Starter
        async function startApp() {
            try {
                const response = await fetch('/api/config');
                if (!response.ok) throw new Error('Config fetch failed');
                const config = await response.json();
                
                const app = initializeApp(config.firebase);
                const auth = getAuth(app);
                const db = getDatabase(app);

                // Attach all event handlers
                attachGlobalHandlers(auth, db);
                
                // Fetch initial data
                fetchPendingApprovals(db);
                // fetchTransactionData(); // Your existing function
                // fetchAndRenderFirebaseData(); // Your existing function

            } catch (error) {
                console.error("App Initialization Failed:", error);
                alert("Could not connect to the server. Redirecting to login.");
                window.location.href = 'login.html';
            }
        }

        function attachGlobalHandlers(auth, db) {
            // Logout Logic
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    sessionStorage.removeItem('isAdminLoggedIn');
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error("Logout failed:", error);
                }
            });

            // Sidebar navigation
            document.querySelectorAll('.sidebar-item[data-view]').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const viewId = item.dataset.view;
                    if (viewId === 'approvals') {
                        fetchPendingApprovals(db);
                    }
                    // Your existing navigation logic...
                });
            });

            // Approval Modal Logic
            const approvalContainer = document.getElementById('approvals-container');
            approvalContainer.addEventListener('click', e => {
                const reviewBtn = e.target.closest('.review-btn');
                if(reviewBtn) {
                    const memberId = reviewBtn.dataset.id;
                    openApprovalModal(memberId, db);
                }
            });
        }

        // --- NEW: Approval System Functions ---
        function fetchPendingApprovals(db) {
            const pendingMembersRef = ref(db, 'members');
            onValue(pendingMembersRef, (snapshot) => {
                const container = document.getElementById('approvals-container');
                const badge = document.getElementById('pending-count-badge');
                container.innerHTML = '';
                let pendingCount = 0;

                if (!snapshot.exists()) {
                    container.innerHTML = `<p class="text-center text-gray-500 col-span-full">No pending applications found.</p>`;
                    badge.classList.add('hidden');
                    return;
                }

                const allMembers = snapshot.val();
                for (const memberId in allMembers) {
                    const member = allMembers[memberId];
                    if (member.status === 'Pending') {
                        pendingCount++;
                        const card = document.createElement('div');
                        card.className = 'data-card p-4 space-y-3';
                        card.innerHTML = `
                            <div class="flex items-center space-x-4">
                                <img src="${member.profilePicUrl}" class="w-16 h-16 rounded-full object-cover border-2 border-gray-200">
                                <div>
                                    <p class="font-bold text-lg text-gray-800">${member.fullName}</p>
                                    <p class="text-sm text-gray-500">Applied: ${new Date(member.createdAt).toLocaleDateString()}</p>
                                </div>
                            </div>
                            <button class="review-btn btn-primary w-full text-white font-bold py-2 px-4 rounded-lg" data-id="${memberId}">Review Application</button>
                        `;
                        container.appendChild(card);
                    }
                }
                
                if (pendingCount > 0) {
                    badge.textContent = pendingCount;
                    badge.classList.remove('hidden');
                } else {
                    container.innerHTML = `<p class="text-center text-gray-500 col-span-full">No pending applications found.</p>`;
                    badge.classList.add('hidden');
                }
            });
        }
        
        async function openApprovalModal(memberId, db) {
            const snapshot = await get(ref(db, `members/${memberId}`));
            if (!snapshot.exists()) {
                alert("Member not found!");
                return;
            }
            const data = snapshot.val();
            const modalContent = document.getElementById('approvalDetailContent');
            // Populate modal with all details from 'data' object...
            modalContent.innerHTML = `... HTML with all member details ...`;

            const modal = document.getElementById('approvalDetailModal');
            openModal(modal);

            document.getElementById('approveBtn').onclick = async () => {
                await update(ref(db, `members/${memberId}`), { status: 'Approved' });
                alert('Member Approved!');
                closeModal(modal);
            };
            document.getElementById('rejectBtn').onclick = async () => {
                const confirmed = confirm('Are you sure you want to reject and delete this application?');
                if(confirmed) {
                    await remove(ref(db, `members/${memberId}`));
                    alert('Application Rejected and Deleted.');
                    closeModal(modal);
                }
            };
        }

        // --- Helper function to open/close modals ---
        function openModal(modal) { /* ... */ }
        function closeModal(modal) { /* ... */ }

        // Start the application
        startApp();
    </script>
</body>
</html>

