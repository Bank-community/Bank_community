<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TCF Royal Analytics & AI Auditor</title>
    
    <!-- TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FONT AWESOME -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    
    <!-- GOOGLE GEMINI SDK (Generative AI) -->
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>

    <!-- MARKDOWN PARSER (For AI Responses) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        royal: {
                            dark: '#0a0f1c', // Darker background
                            card: '#111827', // Card background
                            blue: '#1e40af',
                            gold: '#fbbf24',
                            text: '#e2e8f0'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0a0f1c; color: #e2e8f0; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #fbbf24; }

        .glass-panel {
            background: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .ai-chat-bubble {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            border-radius: 12px 12px 12px 0;
            padding: 12px;
            font-size: 0.9rem;
            line-height: 1.5;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .user-chat-bubble {
            background: #374151;
            border-radius: 12px 12px 0 12px;
            padding: 10px 15px;
            font-size: 0.9rem;
        }

        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Markdown Styles for AI */
        .prose strong { color: #fbbf24; }
        .prose ul { list-style-type: disc; padding-left: 20px; }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <!-- SIDEBAR -->
    <aside class="w-64 bg-royal-card border-r border-gray-800 hidden md:flex flex-col z-20">
        <div class="p-6 border-b border-gray-800 flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-yellow-400 to-yellow-600 flex items-center justify-center text-black font-bold text-lg">
                <i class="fas fa-crown"></i>
            </div>
            <div>
                <h1 class="font-bold text-white tracking-wide">TCF AUDITOR</h1>
                <p class="text-xs text-yellow-500 uppercase tracking-widest">Nano Analytics</p>
            </div>
        </div>
        
        <nav class="flex-1 p-4 space-y-2">
            <button class="w-full text-left px-4 py-3 rounded-lg bg-royal-blue/20 text-blue-400 border border-blue-900/50 font-medium flex items-center gap-3">
                <i class="fas fa-chart-pie"></i> Dashboard
            </button>
            <!-- Only dashboard is active for this demo -->
        </nav>

        <div class="p-4 border-t border-gray-800">
            <div class="bg-gray-800/50 rounded-lg p-3">
                <p class="text-xs text-gray-400 mb-1">System Status</p>
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                    <span class="text-xs font-bold text-green-400">Live & Connected</span>
                </div>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col relative overflow-hidden">
        
        <!-- TOP HEADER -->
        <header class="h-16 border-b border-gray-800 bg-royal-card/80 backdrop-blur flex justify-between items-center px-6">
            <h2 class="text-xl font-semibold text-white">Member Performance Overview</h2>
            <div class="flex items-center gap-4">
                <div id="loader" class="flex items-center gap-2 text-yellow-500">
                    <i class="fas fa-circle-notch fa-spin"></i>
                    <span class="text-xs font-bold">ANALYZING DATA...</span>
                </div>
            </div>
        </header>

        <!-- CONTENT AREA -->
        <div class="flex-1 overflow-auto p-6 relative">
            
            <!-- STATS GRID -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-royal-card border border-gray-700 p-5 rounded-xl">
                    <p class="text-gray-400 text-xs font-bold uppercase">Total Profit Distributed</p>
                    <p id="total-profit-dist" class="text-2xl font-bold text-green-400 mt-1">‚Çπ0</p>
                </div>
                <div class="bg-royal-card border border-gray-700 p-5 rounded-xl">
                    <p class="text-gray-400 text-xs font-bold uppercase">Avg. Member Score</p>
                    <p id="avg-score" class="text-2xl font-bold text-yellow-400 mt-1">0.0</p>
                </div>
                <div class="bg-royal-card border border-gray-700 p-5 rounded-xl">
                    <p class="text-gray-400 text-xs font-bold uppercase">Active Members</p>
                    <p id="active-members-count" class="text-2xl font-bold text-blue-400 mt-1">0</p>
                </div>
                <div class="bg-royal-card border border-gray-700 p-5 rounded-xl">
                    <p class="text-gray-400 text-xs font-bold uppercase">Transaction Volume</p>
                    <p id="tx-volume" class="text-2xl font-bold text-purple-400 mt-1">0</p>
                </div>
            </div>

            <!-- MEMBERS TABLE -->
            <div class="bg-royal-card border border-gray-800 rounded-xl overflow-hidden shadow-xl">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-800/50 text-gray-400 text-xs uppercase tracking-wider border-b border-gray-700">
                                <th class="p-4 font-semibold">Member</th>
                                <th class="p-4 font-semibold text-center">Score</th>
                                <th class="p-4 font-semibold text-center">Total Profit</th>
                                <th class="p-4 font-semibold text-center">Wallet Balance</th>
                                <th class="p-4 font-semibold text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="members-table-body" class="divide-y divide-gray-800 text-sm">
                            <!-- Rows injected via JS -->
                        </tbody>
                    </table>
                </div>
            </div>

        </div>

    </main>

    <!-- AI CHAT DRAWER (Right Side) -->
    <div id="ai-drawer" class="absolute inset-y-0 right-0 w-full md:w-96 bg-[#0f141f] border-l border-gray-700 transform translate-x-full transition-transform duration-300 z-50 flex flex-col shadow-2xl">
        
        <!-- AI Header -->
        <div class="p-4 border-b border-gray-800 bg-gray-900 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-r from-blue-600 to-indigo-600 flex items-center justify-center shadow-lg shadow-blue-500/30">
                    <i class="fas fa-robot text-white text-sm"></i>
                </div>
                <div>
                    <h3 class="font-bold text-white text-sm">AI Auditor</h3>
                    <p id="ai-target-name" class="text-[10px] text-gray-400 uppercase">Select a member</p>
                </div>
            </div>
            <button id="close-ai" class="text-gray-400 hover:text-white transition-colors"><i class="fas fa-times"></i></button>
        </div>

        <!-- Chat Area -->
        <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 bg-[#0f141f]">
            <!-- Messages go here -->
            <div class="ai-chat-bubble text-white">
                <p>Namaste! üôè Main TCF ka AI Auditor hoon.</p>
                <p class="mt-2 text-gray-300 text-xs">Kisi bhi member ke 'Analyze' button pe click karein, aur main unka poora financial post-mortem kar dunga.</p>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-4 border-t border-gray-800 bg-gray-900">
            <div class="relative">
                <input id="chat-input" type="text" placeholder="Ask about score, profit, or loans..." 
                    class="w-full bg-gray-800 text-white rounded-xl py-3 pl-4 pr-12 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500 border border-gray-700">
                <button id="send-btn" class="absolute right-2 top-2 bg-blue-600 hover:bg-blue-500 text-white w-8 h-8 rounded-lg flex items-center justify-center transition-colors">
                    <i class="fas fa-paper-plane text-xs"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- LOGIC MODAL (For Raw Logs) -->
    <div id="log-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
        <div class="bg-gray-900 w-full max-w-2xl rounded-2xl border border-gray-700 shadow-2xl flex flex-col max-h-[85vh]">
            <div class="p-5 border-b border-gray-700 flex justify-between items-center">
                <h3 id="log-modal-title" class="text-lg font-bold text-yellow-500">Breakdown</h3>
                <button onclick="document.getElementById('log-modal').classList.add('hidden'); document.getElementById('log-modal').classList.remove('flex');" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div id="log-modal-content" class="p-6 overflow-y-auto space-y-4 text-sm font-mono text-gray-300">
                <!-- Injected Logs -->
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        // --- 1. CONFIGURATION & IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // GLOBAL CONFIG
        const CONFIG = {
            CAPITAL_WEIGHT: 0.40, CONSISTENCY_WEIGHT: 0.30, CREDIT_BEHAVIOR_WEIGHT: 0.30,
            TARGET_SIP: 30000
        };
        const GEMINI_API_KEY = "AIzaSyBwhJNl7Rw4Xwb8esmsIes5uVX2fWlRnSE"; // USER PROVIDED
        
        let db, auth, genAI, model;
        let GLOBAL_DATA = { members: {}, transactions: {}, activeLoans: {} };
        let CURRENT_ANALYSIS_CONTEXT = null; // Stores data of the member currently being chatted about

        // --- 2. INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Init Gemini
                genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
                model = genAI.getGenerativeModel({ model: "gemini-pro"});

                // Init Firebase
                const response = await fetch('/api/firebase-config');
                const firebaseConfig = await response.json();
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getDatabase(app);

                await signInAnonymously(auth);
                console.log("üî• Authenticated anonymously");

                await fetchDataAndAnalyze();

            } catch (e) {
                console.error("Init Error:", e);
                alert("Error initializing system: " + e.message);
            }
        });

        // --- 3. DATA FETCHING & PROCESSING ---
        async function fetchDataAndAnalyze() {
            const loader = document.getElementById('loader');
            
            // Fetch All Data
            const [membersSnap, txSnap, loansSnap] = await Promise.all([
                get(ref(db, 'members')),
                get(ref(db, 'transactions')),
                get(ref(db, 'activeLoans'))
            ]);

            GLOBAL_DATA.members = membersSnap.val() || {};
            GLOBAL_DATA.transactions = txSnap.val() || {};
            GLOBAL_DATA.activeLoans = loansSnap.val() || {};

            // Convert transactions object to array
            const txArray = Object.values(GLOBAL_DATA.transactions).map((t, i) => ({...t, id: Object.keys(GLOBAL_DATA.transactions)[i]}));
            
            // Process Member Analytics
            const tableBody = document.getElementById('members-table-body');
            tableBody.innerHTML = '';
            
            let totalProfitDistributed = 0;
            let totalScores = 0;
            let activeCount = 0;

            for (const [memberId, member] of Object.entries(GLOBAL_DATA.members)) {
                if(member.status !== 'Approved') continue;
                activeCount++;

                // 1. Run Deep Analysis
                const analysis = runNanoAnalysis(memberId, member.fullName, txArray, GLOBAL_DATA.activeLoans);
                
                // 2. Update Globals
                totalProfitDistributed += analysis.financials.lifetimeProfit;
                totalScores += analysis.scoreData.totalScore;

                // 3. Render Row
                const row = document.createElement('tr');
                row.className = "hover:bg-gray-800/50 transition-colors border-b border-gray-800 group";
                row.innerHTML = `
                    <td class="p-4">
                        <div class="flex items-center gap-3">
                            <img src="${member.profilePicUrl || 'https://placehold.co/100'}" class="w-10 h-10 rounded-full border border-gray-600 object-cover">
                            <div>
                                <p class="font-bold text-white text-sm">${member.fullName}</p>
                                <p class="text-xs text-gray-500">ID: ${memberId}</p>
                            </div>
                        </div>
                    </td>
                    <td class="p-4 text-center">
                        <div class="inline-flex flex-col items-center cursor-pointer hover:scale-105 transition-transform" onclick="showScoreLogs('${memberId}')">
                            <span class="text-lg font-bold ${getScoreColor(analysis.scoreData.totalScore)}">${analysis.scoreData.totalScore.toFixed(1)}</span>
                            <span class="text-[10px] text-gray-500 uppercase tracking-wide">View Logic</span>
                        </div>
                    </td>
                    <td class="p-4 text-center">
                        <div class="flex flex-col">
                            <span class="text-green-400 font-bold">‚Çπ${analysis.financials.lifetimeProfit.toFixed(2)}</span>
                            <span class="text-[10px] text-gray-500">${analysis.financials.profitCount} payouts</span>
                        </div>
                    </td>
                    <td class="p-4 text-center">
                        <span class="font-mono text-white bg-gray-800 px-2 py-1 rounded border border-gray-700">‚Çπ${analysis.financials.walletBalance.toFixed(2)}</span>
                    </td>
                    <td class="p-4 text-right">
                        <button onclick="openAIForMember('${memberId}')" class="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white text-xs font-bold px-4 py-2 rounded-lg shadow-lg shadow-blue-900/20 transform hover:-translate-y-0.5 transition-all flex items-center gap-2 ml-auto">
                            <i class="fas fa-robot"></i> Analyze
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);

                // Store analysis in global object for AI access
                GLOBAL_DATA.members[memberId].analysis = analysis;
            }

            // Update Header Stats
            document.getElementById('total-profit-dist').innerText = `‚Çπ${totalProfitDistributed.toLocaleString('en-IN')}`;
            document.getElementById('avg-score').innerText = activeCount ? (totalScores/activeCount).toFixed(1) : "0";
            document.getElementById('active-members-count').innerText = activeCount;
            document.getElementById('tx-volume').innerText = txArray.length;

            loader.classList.add('hidden');
        }

        function getScoreColor(score) {
            if(score >= 80) return 'text-green-400';
            if(score >= 50) return 'text-yellow-400';
            return 'text-red-400';
        }

        // --- 4. THE NANO-LOGIC ENGINE (Returns Data + LOGS) ---
        function runNanoAnalysis(memberId, memberName, allTx, allLoans) {
            const now = new Date();
            const memberTx = allTx.filter(t => t.memberId === memberId || t.name === memberName); // Handle both formats
            
            // A. SCORING LOGIC WITH LOGS
            const logs = { capital: [], consistency: [], credit: [] };
            
            // 1. Capital Score (SIP)
            const totalSip = memberTx.filter(t => t.type === 'SIP').reduce((sum, t) => sum + (Number(t.amount)||0), 0);
            const capRaw = Math.min(100, (totalSip / CONFIG.TARGET_SIP) * 100);
            logs.capital.push(`Total SIP: ‚Çπ${totalSip}`);
            logs.capital.push(`Target: ‚Çπ${CONFIG.TARGET_SIP}`);
            logs.capital.push(`Formula: (${totalSip}/${CONFIG.TARGET_SIP}) * 100 = ${capRaw.toFixed(1)}%`);
            
            // 2. Consistency Score
            // Simplified for demo: Check SIPs in last 6 months
            let consPoints = 0;
            const sipDates = memberTx.filter(t => t.type === 'SIP').map(t => new Date(t.date));
            if(sipDates.length > 0) {
                logs.consistency.push(`Found ${sipDates.length} SIP entries.`);
                consPoints = Math.min(100, sipDates.length * 10); // 10 points per SIP
            } else {
                logs.consistency.push("No SIPs found.");
            }
            
            // 3. Credit Behavior
            // Check loans
            const loans = memberTx.filter(t => t.type === 'Loan Taken');
            let creditPoints = 100; // Start perfect
            
            if(loans.length === 0) {
                creditPoints = 40; // No history
                logs.credit.push("No Loan History: Default Score 40");
            } else {
                loans.forEach(loan => {
                   // Simplified check logic
                   logs.credit.push(`Loan of ‚Çπ${loan.amount} on ${loan.date}`);
                   // logic assumes paid on time for demo unless flagged
                });
            }

            // Weighted Total
            const totalScore = (capRaw * 0.4) + (consPoints * 0.3) + (creditPoints * 0.3);

            // B. FINANCIAL TRACING
            let lifetimeProfit = 0;
            let profitCount = 0;
            const profitSources = []; // Trace where money came from

            // Find Transactions where this user received money
            // NOTE: The previous logic calculated profit dynamically. Here we simulate finding "Return" credits
            // Since original data doesn't store "Profit Received" explicitly in TX list usually, 
            // we will simulate the calculation based on "Loan Payment" interest distribution logic.
            
            // Iterating ALL transactions to find where THIS user would have earned
            allTx.forEach(tx => {
                if(tx.type === 'Loan Payment' && (Number(tx.interestPaid)||0) > 0) {
                    // Logic: 70% to community. Did this user qualify?
                    // For this demo, we assume stored 'returnAmount' implies interest generated.
                    // To accurately calculate earnings, we need the stored distribution or recalculate.
                    // For this visualization, we will check if any "Extra Payment" (Profit) exists for this user
                }
            });

            // Using the 'calculateTotalExtraBalance' logic from previous code essentially
            // Filter transactions for 'profit' types if they exist, or manual credits
            const credits = memberTx.filter(t => t.type === 'Extra Payment' || t.type === 'Profit Share'); // Adjust based on actual DB keys
            
            // Calculate Balance
            let balance = 0;
            memberTx.forEach(t => {
                if(t.type === 'Extra Payment') balance += (Number(t.amount)||0); // Profit/Credit
                if(t.type === 'Extra Withdraw') balance -= (Number(t.amount)||0);
            });

            return {
                scoreData: {
                    totalScore,
                    breakdown: { capital: capRaw, consistency: consPoints, credit: creditPoints },
                    logs
                },
                financials: {
                    lifetimeProfit: balance, // Approx for demo
                    profitCount: credits.length,
                    walletBalance: balance,
                    history: memberTx
                }
            };
        }

        // --- 5. UI INTERACTIONS ---
        window.showScoreLogs = (memberId) => {
            const data = GLOBAL_DATA.members[memberId].analysis.scoreData;
            const modal = document.getElementById('log-modal');
            const content = document.getElementById('log-modal-content');
            
            document.getElementById('log-modal-title').innerText = `Score Logic: ${GLOBAL_DATA.members[memberId].fullName}`;
            
            let html = `
                <div class="mb-4">
                    <h4 class="text-blue-400 font-bold mb-2 uppercase border-b border-gray-700 pb-1">Capital Score (40%) - ${data.breakdown.capital.toFixed(1)}/100</h4>
                    <ul class="list-disc pl-5 text-gray-400 space-y-1">
                        ${data.logs.capital.map(l => `<li>${l}</li>`).join('')}
                    </ul>
                </div>
                <div class="mb-4">
                    <h4 class="text-green-400 font-bold mb-2 uppercase border-b border-gray-700 pb-1">Consistency (30%) - ${data.breakdown.consistency.toFixed(1)}/100</h4>
                    <ul class="list-disc pl-5 text-gray-400 space-y-1">
                        ${data.logs.consistency.map(l => `<li>${l}</li>`).join('')}
                    </ul>
                </div>
                <div class="mb-4">
                    <h4 class="text-purple-400 font-bold mb-2 uppercase border-b border-gray-700 pb-1">Credit Behavior (30%) - ${data.breakdown.credit.toFixed(1)}/100</h4>
                    <ul class="list-disc pl-5 text-gray-400 space-y-1">
                        ${data.logs.credit.map(l => `<li>${l}</li>`).join('')}
                    </ul>
                </div>
                <div class="mt-6 p-4 bg-gray-800 rounded border border-gray-600 text-center">
                    <p class="text-gray-400">Total Calculation</p>
                    <p class="text-xl font-bold text-white">
                        (${data.breakdown.capital.toFixed(0)} √ó 0.4) + 
                        (${data.breakdown.consistency.toFixed(0)} √ó 0.3) + 
                        (${data.breakdown.credit.toFixed(0)} √ó 0.3) 
                        = <span class="text-yellow-400">${data.totalScore.toFixed(2)}</span>
                    </p>
                </div>
            `;
            content.innerHTML = html;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // --- 6. AI AUDITOR INTEGRATION ---
        window.openAIForMember = (memberId) => {
            const member = GLOBAL_DATA.members[memberId];
            CURRENT_ANALYSIS_CONTEXT = member;
            
            document.getElementById('ai-drawer').classList.remove('translate-x-full');
            document.getElementById('ai-target-name').innerText = `Auditing: ${member.fullName}`;
            
            // Clear chat and add greeting
            const container = document.getElementById('chat-container');
            container.innerHTML = `
                <div class="ai-chat-bubble text-white">
                    <p><strong>Auditor Online ü§ñ</strong></p>
                    <p class="mt-1">Maine <strong>${member.fullName}</strong> ka data load kar liya hai.</p>
                    <ul class="mt-2 text-xs text-gray-300 list-disc pl-4">
                        <li>Score: ${member.analysis.scoreData.totalScore.toFixed(1)}</li>
                        <li>Wallet: ‚Çπ${member.analysis.financials.walletBalance}</li>
                        <li>Transactions: ${member.analysis.financials.history.length}</li>
                    </ul>
                    <p class="mt-2 text-xs text-yellow-400">Poochiye, kya jaanna hai? (Score, Profit, ya Loans ke baare mein)</p>
                </div>
            `;
        }

        document.getElementById('close-ai').addEventListener('click', () => {
            document.getElementById('ai-drawer').classList.add('translate-x-full');
        });

        // SEND MESSAGE LOGIC
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const chatContainer = document.getElementById('chat-container');

        async function handleSendMessage() {
            const query = chatInput.value.trim();
            if(!query) return;
            if(!CURRENT_ANALYSIS_CONTEXT) {
                alert("Please select a member to analyze first.");
                return;
            }

            // Add User Bubble
            chatContainer.innerHTML += `
                <div class="flex justify-end mt-4">
                    <div class="user-chat-bubble text-white max-w-[85%]">
                        ${query}
                    </div>
                </div>
            `;
            chatInput.value = '';
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // Add Loading Bubble
            const loadingId = 'loading-' + Date.now();
            chatContainer.innerHTML += `
                <div id="${loadingId}" class="mt-4 flex gap-1 ai-chat-bubble w-16 items-center justify-center">
                    <div class="w-2 h-2 bg-white rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-white rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-white rounded-full typing-dot"></div>
                </div>
            `;
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                // PREPARE CONTEXT FOR AI
                const contextData = {
                    name: CURRENT_ANALYSIS_CONTEXT.fullName,
                    stats: CURRENT_ANALYSIS_CONTEXT.analysis,
                    rawTransactions: CURRENT_ANALYSIS_CONTEXT.analysis.financials.history.slice(-10) // Last 10 tx for context
                };

                const prompt = `
                    You are the Chief Financial Auditor of 'Trust Community Fund' (TCF).
                    
                    CONTEXT DATA (JSON):
                    ${JSON.stringify(contextData)}

                    USER QUERY: "${query}"

                    INSTRUCTIONS:
                    1. Answer in a mix of Hindi (Latin script) and English (Hinglish).
                    2. Analyze the JSON data deep down. If the score is low, explain EXACTLY why based on the logs provided in the data.
                    3. Be professional but conversational.
                    4. Use bold text for numbers (e.g., **‚Çπ500**).
                    5. If asked about profit source, look at the logs.
                    6. Keep answer under 100 words unless detailed analysis is asked.
                `;

                const result = await model.generateContent(prompt);
                const response = result.response;
                const text = response.text();

                // Remove loader
                document.getElementById(loadingId).remove();

                // Add AI Response
                chatContainer.innerHTML += `
                    <div class="mt-4 mr-auto max-w-[90%]">
                        <div class="ai-chat-bubble text-white prose prose-invert prose-sm">
                            ${marked.parse(text)}
                        </div>
                    </div>
                `;

            } catch (error) {
                document.getElementById(loadingId).remove();
                chatContainer.innerHTML += `<div class="ai-chat-bubble text-red-300 mt-4">Error: ${error.message}</div>`;
            }
            
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        sendBtn.addEventListener('click', handleSendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if(e.key === 'Enter') handleSendMessage();
        });

    </script>
</body>
</html>

