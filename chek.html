<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ImageKit Test App</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s; }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-danger:hover { background-color: #dc2626; }
        .toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 50; }
        .toast { background-color: white; border-radius: 0.5rem; padding: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 1rem; opacity: 0; transform: translateY(-20px); transition: all 0.3s ease; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast-success { border-left: 4px solid #10b981; }
        .toast-error { border-left: 4px solid #ef4444; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-6">

    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-xl text-center space-y-6">
        <h1 class="text-3xl font-bold text-gray-800">ImageKit Test App</h1>
        <p class="text-gray-600">Apni images upload aur delete karke check karein.</p>

        <div class="space-y-4">
            <input type="file" id="imageInput" class="w-full text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100" accept="image/*">
            <button id="uploadBtn" class="w-full btn btn-primary"><i class="fas fa-upload mr-2"></i> Upload Image</button>
        </div>

        <div id="imagePreviewContainer" class="mt-6 space-y-4"></div>
    </div>

    <div id="toast-container" class="toast-container"></div>

    <script>
        // --- API Keys (Insecure for production) ---
        const IMAGEKIT_PUBLIC_KEY = 'public_Nf7wxZyGD34X18W6o9HtFezad2o=';
        const IMAGEKIT_PRIVATE_KEY = 'private_qGMqr1FlHKO3mNudtWbgqwxtQvU=';
        const IMAGEKIT_URL_ENDPOINT = 'https://ik.imagekit.io/nsyr92pse';

        // --- ELEMENTS ---
        const imageInput = document.getElementById('imageInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const toastContainer = document.getElementById('toast-container');

        // --- HELPER FUNCTIONS ---
        function showToast(title, message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            const iconClass = type === 'success' ? 'fa-check-circle text-green-500' : type === 'error' ? 'fa-exclamation-circle text-red-500' : 'fa-info-circle text-blue-500';
            toast.innerHTML = `<i class="fas ${iconClass}"></i><div class="flex-1"><div>${title}</div><div class="text-xs text-gray-500">${message}</div></div>`;
            toastContainer.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 5000);
        }

        async function uploadToImageKit(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('fileName', file.name);
            formData.append('useUniqueFileName', 'true');
            formData.append('folder', 'ramazone_uploads');

            const authString = btoa(IMAGEKIT_PRIVATE_KEY + ":");

            try {
                const response = await fetch('https://upload.imagekit.io/api/v1/files/upload', {
                    method: 'POST',
                    headers: { 'Authorization': `Basic ${authString}` },
                    body: formData
                });
                const result = await response.json();
                if (result.url) {
                    return { url: result.url, fileId: result.fileId };
                } else {
                    throw new Error(result.message || 'Unknown upload error');
                }
            } catch (error) {
                console.error('Upload Error:', error);
                showToast('Upload Failed', `Error: ${error.message}`, 'error');
                return null;
            }
        }

        async function deleteFromImageKit(fileId) {
            if (!fileId) {
                showToast('Deletion Failed', 'File ID is missing!', 'error');
                return;
            }

            const authString = btoa(IMAGEKIT_PRIVATE_KEY + ":");

            try {
                const response = await fetch('https://api.imagekit.io/v1/files/purge', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Basic ${authString}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ fileIds: [fileId] }) // âœ… FIX: Ab array bheja ja raha hai
                });

                if (response.status === 204) {
                    showToast('Deletion Successful', 'Image has been removed from ImageKit.', 'success');
                    return true;
                } else {
                    const result = await response.json();
                    throw new Error(result.message || 'Unknown deletion error');
                }
            } catch (error) {
                console.error('Deletion Error:', error);
                showToast('Deletion Failed', `Error: ${error.message}`, 'error');
                return false;
            }
        }

        function createPreviewElement(url, fileId) {
            const container = document.createElement('div');
            container.className = 'flex items-center gap-4 p-4 border rounded-md shadow-sm';
            container.innerHTML = `
                <img src="${url}" class="w-20 h-20 object-cover rounded-md">
                <div class="flex-1 text-left break-all text-sm">
                    <p class="font-semibold">URL:</p>
                    <p>${url}</p>
                    <p class="font-semibold mt-2">File ID:</p>
                    <p>${fileId}</p>
                </div>
                <button class="delete-btn btn btn-danger p-2"><i class="fas fa-trash"></i></button>
            `;
            const deleteBtn = container.querySelector('.delete-btn');
            deleteBtn.addEventListener('click', async () => {
                const isDeleted = await deleteFromImageKit(fileId);
                if (isDeleted) {
                    container.remove();
                }
            });
            imagePreviewContainer.appendChild(container);
        }

        // --- EVENT LISTENERS ---
        uploadBtn.addEventListener('click', async () => {
            const file = imageInput.files[0];
            if (!file) {
                showToast('No File', 'Please select a file to upload.', 'error');
                return;
            }

            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Uploading...';
            uploadBtn.disabled = true;

            const uploadResult = await uploadToImageKit(file);

            if (uploadResult) {
                createPreviewElement(uploadResult.url, uploadResult.fileId);
                imageInput.value = ''; // Clear the input
                showToast('Upload Successful', 'Image has been uploaded!', 'success');
            }

            uploadBtn.innerHTML = '<i class="fas fa-upload mr-2"></i> Upload Image';
            uploadBtn.disabled = false;
        });
    </script>

</body>
</html>
