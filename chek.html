<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nano-to-Macro Data Reasoning System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDKs (Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, child, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- Configuration ---
        const firebaseConfig = {
  apiKey: "AIzaSyDeO8uhUVWP98NrhSyZ-oTImjKB0GDDe6M",
  authDomain: "nano-c5292.firebaseapp.com",
  databaseURL: "https://nano-c5292-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "nano-c5292",
  storageBucket: "nano-c5292.firebasestorage.app",
  messagingSenderId: "772738888247",
  appId: "1:772738888247:web:4d6733b30e0ac9e27d05b2"
};

        const GEMINI_API_KEY = "AIzaSyBwhJNl7Rw4Xwb8esmsIes5uVX2fWlRnSE"; 
        // Using standard flash model for speed and reasoning
        const GEMINI_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;

        // --- App State ---
        let dbData = null;
        let flattenedData = [];
        let schemaMap = {};
        
        // --- Initialization ---
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // UI Elements
        const statusEl = document.getElementById('status');
        const contentArea = document.getElementById('content-area');
        const analysisPanel = document.getElementById('analysis-content');
        const macroStatsEl = document.getElementById('macro-stats');

        // --- Core Functions ---

        async function init() {
            updateStatus('Authenticating...', 'blue');
            try {
                await signInAnonymously(auth);
                updateStatus('Fetching Database...', 'yellow');
                
                const dbRef = ref(db);
                const snapshot = await get(child(dbRef, "/")); // Fetch Root
                
                if (snapshot.exists()) {
                    dbData = snapshot.val();
                    updateStatus('Processing Data...', 'purple');
                    processData(dbData);
                    renderMacroView();
                    updateStatus('Ready', 'green');
                } else {
                    updateStatus('No Data Found', 'red');
                }
            } catch (error) {
                console.error(error);
                updateStatus(`Error: ${error.message}`, 'red');
            }
        }

        function updateStatus(msg, color) {
            statusEl.innerHTML = `<span class="text-${color}-500 font-bold"><i class="fas fa-circle text-xs mr-2"></i>${msg}</span>`;
        }

        // --- Data Processing & Schema Discovery ---

        function processData(data) {
            // 1. Flatten for analysis
            flattenedData = []; 
            flattenObject(data, "", flattenedData);
            
            // 2. Discover Schema/Structure
            schemaMap = analyzeSchema(data);
            
            console.log("Schema Map:", schemaMap);
            console.log("Flattened Data:", flattenedData);
        }

        function flattenObject(obj, prefix, resultList) {
            for (let key in obj) {
                if (typeof obj[key] === 'object' && obj[key] !== null) {
                    flattenObject(obj[key], prefix + key + "/", resultList);
                } else {
                    resultList.push({
                        path: prefix + key,
                        value: obj[key],
                        key: key,
                        type: typeof obj[key]
                    });
                }
            }
        }

        function analyzeSchema(data) {
            // Simple heuristic to find array-like collections or repeated objects
            let schema = {};
            Object.keys(data).forEach(key => {
                if (typeof data[key] === 'object') {
                    // It's likely a collection (e.g., "users", "orders")
                    let childKeys = Object.keys(data[key]);
                    if (childKeys.length > 0) {
                        // Sample the first child to guess structure
                        schema[key] = {
                            type: 'collection',
                            sample: data[key][childKeys[0]],
                            count: childKeys.length
                        };
                    }
                } else {
                    schema[key] = { type: 'field', value: data[key] };
                }
            });
            return schema;
        }

        // --- Reasoning Engine (Gemini) ---

        async function askGemini(contextData, targetValue, targetKey) {
            const prompt = `
            You are a Data Reasoning Engine. Analyze the following data structure and value.
            
            TARGET VALUE: "${targetValue}" (Key: ${targetKey})
            
            CONTEXT DATA (JSON Snippet):
            ${JSON.stringify(contextData, null, 2)}
            
            YOUR TASK:
            1. **Derivation:** How could this value be derived? (e.g., Sum of other fields, count of items, direct entry).
            2. **Logic:** Identify if X = Y + Z or X = Y * Z patterns exist in the context.
            3. **Why:** Explain the business logic likely behind this number.
            
            FORMAT:
            Return a JSON object with:
            {
                "derivation_paths": ["String explaining path 1", "String explaining path 2"],
                "confidence": "High/Medium/Low",
                "explanation": "Human readable explanation"
            }
            `;

            try {
                const response = await fetch(GEMINI_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });
                
                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                
                // Extract JSON from markdown code block if present
                const jsonMatch = text.match(/```json\n([\s\S]*?)\n```/) || text.match(/```\n([\s\S]*?)\n```/);
                const jsonStr = jsonMatch ? jsonMatch[1] : text;
                
                return JSON.parse(jsonStr);
            } catch (e) {
                console.error("Gemini Error", e);
                return { explanation: "Reasoning engine offline or error parsing response.", derivation_paths: [] };
            }
        }

        // --- Client-Side Reasoning Heuristics (Pre-Gemini) ---
        // Quick math checks to save API tokens and provide instant feedback
        function findMathRelations(target, context) {
            let relations = [];
            let numbers = [];
            
            // Extract all numbers from context
            for (let k in context) {
                if (typeof context[k] === 'number' && context[k] !== target) {
                    numbers.push({key: k, val: context[k]});
                }
            }

            // Check Additive (A + B = Target)
            for (let i = 0; i < numbers.length; i++) {
                for (let j = i + 1; j < numbers.length; j++) {
                    if (Math.abs((numbers[i].val + numbers[j].val) - target) < 0.001) {
                        relations.push(`${numbers[i].key} (${numbers[i].val}) + ${numbers[j].key} (${numbers[j].val}) = ${target}`);
                    }
                }
            }
            
            // Check Multiplicative (A * B = Target)
            for (let i = 0; i < numbers.length; i++) {
                for (let j = i + 1; j < numbers.length; j++) {
                    if (Math.abs((numbers[i].val * numbers[j].val) - target) < 0.001) {
                        relations.push(`${numbers[i].key} (${numbers[i].val}) Ã— ${numbers[j].key} (${numbers[j].val}) = ${target}`);
                    }
                }
            }

            return relations;
        }


        // --- UI Rendering ---

        // 1. MACRO VIEW (Dashboard)
        function renderMacroView() {
            contentArea.innerHTML = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="macro-grid"></div>';
            const grid = document.getElementById('macro-grid');
            
            macroStatsEl.innerHTML = ''; // Clear header stats

            Object.keys(schemaMap).forEach(key => {
                const item = schemaMap[key];
                
                // Create Stats Card
                const card = document.createElement('div');
                card.className = "bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition cursor-pointer border-t-4 border-blue-500";
                
                let content = `<h3 class="text-lg font-bold text-gray-700 mb-2 uppercase tracking-wide">${key}</h3>`;
                
                if (item.type === 'collection') {
                    content += `<p class="text-4xl font-extrabold text-blue-600">${item.count}</p>`;
                    content += `<p class="text-sm text-gray-400 mt-1">Records Found</p>`;
                    
                    // Add mini-chart container
                    content += `<div class="mt-4 h-32"><canvas id="chart-${key}"></canvas></div>`;
                    
                    card.onclick = () => renderMesoView(key);
                } else {
                    content += `<p class="text-2xl font-bold text-gray-800">${item.value}</p>`;
                    content += `<p class="text-xs text-gray-400">Direct Field</p>`;
                    card.onclick = () => analyzeNano(key, item.value, dbData); // Direct analysis for root fields
                }
                
                card.innerHTML = content;
                grid.appendChild(card);

                // Render Chart if collection
                if (item.type === 'collection') {
                    renderCollectionChart(key, dbData[key]);
                }
            });
        }

        // Helper to render mini charts on Macro view
        function renderCollectionChart(key, data) {
            setTimeout(() => {
                const ctx = document.getElementById(`chart-${key}`);
                if (!ctx) return;
                
                // Try to find a numeric field to chart
                const firstId = Object.keys(data)[0];
                const sample = data[firstId];
                let numericField = null;
                
                if (typeof sample === 'object') {
                    for (let f in sample) {
                        if (typeof sample[f] === 'number') {
                            numericField = f;
                            break;
                        }
                    }
                }

                if (numericField) {
                    const labels = Object.keys(data).slice(0, 10); // Limit to 10
                    const values = labels.map(k => data[k][numericField]);
                    
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels.map(l => l.substring(0,5)+'...'),
                            datasets: [{
                                label: numericField,
                                data: values,
                                backgroundColor: 'rgba(59, 130, 246, 0.5)',
                                borderColor: 'rgba(59, 130, 246, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { x: { display: false }, y: { display: false } }
                        }
                    });
                }
            }, 0);
        }

        // 2. MESO VIEW (Table/List of a collection)
        function renderMesoView(collectionName) {
            const data = dbData[collectionName];
            const keys = Object.keys(data);
            const sample = data[keys[0]];
            const columns = Object.keys(sample).slice(0, 6); // Max 6 columns

            let html = `
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                        <h2 class="text-xl font-bold text-gray-700">
                            <span class="text-blue-500 cursor-pointer hover:underline" onclick="renderMacroView()">Dashboard</span>
                            <span class="text-gray-400 mx-2">/</span>
                            ${collectionName}
                        </h2>
                        <span class="text-sm bg-blue-100 text-blue-800 py-1 px-3 rounded-full">${keys.length} items</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                <tr>
                                    <th class="px-6 py-3">ID</th>
                                    ${columns.map(c => `<th class="px-6 py-3">${c}</th>`).join('')}
                                    <th class="px-6 py-3">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${keys.map(k => {
                                    const row = data[k];
                                    return `
                                        <tr class="bg-white border-b hover:bg-gray-50">
                                            <td class="px-6 py-4 font-medium text-gray-900">${k}</td>
                                            ${columns.map(c => `<td class="px-6 py-4">${typeof row[c] === 'object' ? '[Obj]' : row[c]}</td>`).join('')}
                                            <td class="px-6 py-4">
                                                <button onclick="renderMicroView('${collectionName}', '${k}')" class="text-blue-600 hover:text-blue-900">
                                                    <i class="fas fa-microscope mr-1"></i> Inspect
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            contentArea.innerHTML = html;
        }

        // 3. MICRO VIEW (Single Entity)
        window.renderMicroView = function(collection, id) {
            const item = dbData[collection][id];
            
            let html = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Left: Entity Details -->
                    <div class="lg:col-span-2 bg-white rounded-lg shadow-md p-6">
                         <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold text-gray-700">
                                <span class="text-blue-500 cursor-pointer hover:underline" onclick="renderMacroView()">Dashboard</span>
                                <span class="text-gray-400 mx-2">/</span>
                                <span class="text-blue-500 cursor-pointer hover:underline" onclick="renderMesoView('${collection}')">${collection}</span>
                                <span class="text-gray-400 mx-2">/</span>
                                ${id}
                            </h2>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${Object.keys(item).map(key => {
                                const val = item[key];
                                const isObj = typeof val === 'object' && val !== null;
                                const displayVal = isObj ? JSON.stringify(val).substring(0,30)+'...' : val;
                                
                                return `
                                    <div class="border p-3 rounded hover:bg-blue-50 transition group relative">
                                        <span class="text-xs uppercase text-gray-400 font-bold tracking-wider block mb-1">${key}</span>
                                        <span class="text-lg font-medium text-gray-800 break-words">${displayVal}</span>
                                        
                                        <!-- Action Button for Reasoning -->
                                        ${!isObj ? `
                                        <button onclick="analyzeNano('${key}', '${val}', '${collection}', '${id}')" 
                                            class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 bg-blue-600 text-white text-xs px-2 py-1 rounded shadow hover:bg-blue-700 transition">
                                            <i class="fas fa-brain mr-1"></i> Analyze
                                        </button>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- Right: Quick Relations/JSON -->
                    <div class="bg-gray-800 text-green-400 rounded-lg shadow-md p-4 font-mono text-xs overflow-auto h-96">
                        <pre>${JSON.stringify(item, null, 2)}</pre>
                    </div>
                </div>
            `;
            contentArea.innerHTML = html;
        };

        // 4. NANO ANALYSIS (The Reasoning Engine)
        window.analyzeNano = async function(key, value, collection, id) {
            // Show loading state in sidebar
            const loadingHtml = `
                <div class="animate-pulse">
                    <div class="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
                    <div class="h-4 bg-gray-200 rounded w-1/2 mb-4"></div>
                    <div class="text-center mt-10">
                        <i class="fas fa-cog fa-spin text-4xl text-blue-500"></i>
                        <p class="mt-2 text-gray-500">Gemini is reasoning...</p>
                        <p class="text-xs text-gray-400">Searching logical paths & dependencies</p>
                    </div>
                </div>
            `;
            analysisPanel.innerHTML = loadingHtml;

            // 1. Context Gathering
            let context = {};
            let fullEntity = {};
            
            if (collection && id) {
                fullEntity = dbData[collection][id];
                context = fullEntity; // Context is the object itself
            } else {
                // Root level item
                context = dbData;
            }

            // 2. Client-Side Math Heuristics (Instant)
            let mathPaths = [];
            if (typeof parseFloat(value) === 'number' && !isNaN(parseFloat(value))) {
                mathPaths = findMathRelations(parseFloat(value), context);
            }

            // 3. Ask Gemini
            const geminiResult = await askGemini(context, value, key);

            // 4. Render Analysis
            renderAnalysisResult(key, value, mathPaths, geminiResult);
        };

        function renderAnalysisResult(key, value, mathPaths, geminiData) {
            let pathsHtml = '';

            // Math Heuristics Section
            if (mathPaths.length > 0) {
                pathsHtml += `
                    <div class="mb-4 bg-green-50 border-l-4 border-green-500 p-3">
                        <h4 class="font-bold text-green-800 text-sm mb-2"><i class="fas fa-calculator mr-2"></i>Calculated Relations</h4>
                        <ul class="list-disc list-inside text-sm text-green-700">
                            ${mathPaths.map(p => `<li>${p}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            // Gemini Reasoning Section
            const confidenceColor = geminiData.confidence === 'High' ? 'text-green-600' : (geminiData.confidence === 'Medium' ? 'text-yellow-600' : 'text-red-600');
            
            let geminiPaths = '';
            if (geminiData.derivation_paths && geminiData.derivation_paths.length) {
                geminiPaths = `
                    <h4 class="font-bold text-gray-700 text-sm mt-4 mb-2">Logical Derivations (AI)</h4>
                    <ul class="space-y-2">
                        ${geminiData.derivation_paths.map(path => `
                            <li class="flex items-start text-sm text-gray-600 bg-white p-2 rounded border">
                                <i class="fas fa-route text-blue-400 mt-1 mr-2"></i>
                                <span>${path}</span>
                            </li>
                        `).join('')}
                    </ul>
                `;
            }

            const html = `
                <div class="p-2 animate-fade-in">
                    <div class="border-b pb-4 mb-4">
                        <span class="text-xs font-bold text-gray-400 uppercase">Target Variable</span>
                        <div class="flex justify-between items-end">
                            <h2 class="text-2xl font-bold text-gray-800">${key}</h2>
                            <span class="text-3xl font-mono text-blue-600">${value}</span>
                        </div>
                    </div>

                    ${pathsHtml}

                    <div class="mb-4">
                        <span class="text-xs font-bold text-gray-400 uppercase">AI Reasoning Analysis</span>
                        <div class="mt-1 text-sm text-gray-700 leading-relaxed bg-blue-50 p-3 rounded">
                            ${geminiData.explanation}
                        </div>
                        <div class="mt-2 text-right text-xs font-bold ${confidenceColor}">
                            Confidence: ${geminiData.confidence}
                        </div>
                    </div>

                    ${geminiPaths}

                    <div class="mt-6 pt-4 border-t border-gray-100">
                        <span class="text-xs font-bold text-gray-400 uppercase">Drill-Down Actions</span>
                        <div class="mt-2 flex flex-wrap gap-2">
                            <button class="bg-gray-100 hover:bg-gray-200 text-gray-600 text-xs py-1 px-3 rounded">
                                <i class="fas fa-history mr-1"></i> Check History
                            </button>
                            <button class="bg-gray-100 hover:bg-gray-200 text-gray-600 text-xs py-1 px-3 rounded">
                                <i class="fas fa-code-branch mr-1"></i> Simulate Change
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            analysisPanel.innerHTML = html;
        }

        // --- Start ---
        window.onload = init;
        window.renderMacroView = renderMacroView; // Global scope for HTML onclicks
        window.renderMesoView = renderMesoView;

    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Top Navigation -->
    <header class="bg-white border-b h-16 flex items-center justify-between px-6 shadow-sm z-10 flex-shrink-0">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 text-white p-2 rounded-lg">
                <i class="fas fa-network-wired"></i>
            </div>
            <div>
                <h1 class="font-bold text-gray-800 text-lg leading-tight">Data Reasoner</h1>
                <p class="text-xs text-gray-500">Nano-to-Macro Analysis</p>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <div id="status" class="bg-gray-100 px-3 py-1 rounded-full text-xs font-medium">
                Initializing...
            </div>
            <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-gray-500">
                <i class="fas fa-user"></i>
            </div>
        </div>
    </header>

    <!-- Main Workspace -->
    <div class="flex flex-1 overflow-hidden">
        
        <!-- Sidebar Navigation (Macro) -->
        <nav class="w-16 bg-white border-r flex flex-col items-center py-4 gap-6 flex-shrink-0">
            <button onclick="renderMacroView()" class="w-10 h-10 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center hover:bg-blue-100 transition tooltip" title="Macro View">
                <i class="fas fa-globe"></i>
            </button>
            <button class="w-10 h-10 rounded-lg text-gray-400 hover:bg-gray-100 flex items-center justify-center transition" title="Meso View">
                <i class="fas fa-layer-group"></i>
            </button>
             <button class="w-10 h-10 rounded-lg text-gray-400 hover:bg-gray-100 flex items-center justify-center transition" title="Settings">
                <i class="fas fa-sliders-h"></i>
            </button>
        </nav>

        <!-- Central Data View -->
        <main class="flex-1 overflow-y-auto p-6 relative">
            
            <!-- Breadcrumbs / Header Stats -->
            <div class="flex justify-between items-end mb-6" id="macro-stats">
                <!-- Dynamically filled -->
            </div>

            <!-- Content Area -->
            <div id="content-area" class="pb-20">
                <!-- Views (Macro, Meso, Micro) injected here -->
                <div class="flex flex-col items-center justify-center h-64 text-gray-400">
                    <i class="fas fa-circle-notch fa-spin text-4xl mb-4 text-blue-300"></i>
                    <p>Connecting to Neural Database...</p>
                </div>
            </div>

        </main>

        <!-- Right Analysis Panel (Reasoning Engine) -->
        <aside class="w-96 bg-white border-l shadow-xl z-20 flex flex-col flex-shrink-0 transform transition-transform duration-300">
            <div class="h-14 border-b flex items-center px-4 bg-gray-50">
                <i class="fas fa-brain text-purple-600 mr-2"></i>
                <h3 class="font-bold text-gray-700 text-sm">Reasoning Engine</h3>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 bg-slate-50" id="analysis-content">
                <div class="text-center mt-20 text-gray-400">
                    <i class="fas fa-search-dollar text-4xl mb-3 opacity-20"></i>
                    <p class="text-sm">Select a data point to<br>analyze derivation logic.</p>
                </div>
            </div>

            <!-- Chat / Query Input -->
            <div class="p-4 bg-white border-t">
                <div class="relative">
                    <input type="text" placeholder="Ask 'Why is this low?'..." class="w-full bg-gray-100 text-sm border-0 rounded-lg pl-3 pr-10 py-3 focus:ring-2 focus:ring-blue-500 outline-none">
                    <button class="absolute right-2 top-2 text-blue-500 hover:bg-blue-100 p-1 rounded-full w-8 h-8 flex items-center justify-center transition">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </aside>

    </div>

</body>
</html>

