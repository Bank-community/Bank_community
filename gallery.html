<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#002366">
    <title>Gallery - Trust Community Fund</title>
    
    <!-- Using the same CSS file for consistent Theme -->
    <link rel="stylesheet" href="user-style.css">
    <script src="https://unpkg.com/feather-icons"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* Gallery Specific Styles ensuring Royal Theme matches */
        body {
            background-color: var(--bg-color);
        }

        .gallery-header {
            text-align: center;
            padding: 20px;
            background: var(--card-bg);
            margin: 20px auto;
            max-width: 1140px;
            border-radius: 16px;
            box-shadow: 0 10px 30px var(--shadow-color);
            border: 1px solid rgba(212, 175, 55, 0.2); /* Subtle Gold Border */
            position: relative;
        }

        .back-btn-wrapper {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 2 Columns on Mobile */
            gap: 15px;
            padding: 15px;
            max-width: 1140px;
            margin: 0 auto;
        }

        @media (min-width: 768px) {
            .gallery-grid {
                grid-template-columns: repeat(4, 1fr); /* 4 Columns on Desktop */
            }
        }

        /* Royal Image Card */
        .gallery-item {
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
            position: relative;
        }

        .gallery-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(212, 175, 55, 0.3); /* Gold Shadow on Hover */
            border-color: var(--accent-gold);
        }

        .gallery-img-container {
            width: 100%;
            aspect-ratio: 1 / 1; /* Square Images */
            overflow: hidden;
            background-color: #f0f0f0;
        }

        .gallery-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .gallery-item:hover .gallery-img {
            transform: scale(1.1);
        }

        .gallery-caption {
            padding: 10px;
            text-align: center;
            font-weight: 600;
            color: var(--primary-color);
            font-size: 0.9em;
            background: linear-gradient(to bottom, #ffffff, #f9fcff);
            border-top: 1px solid #eee;
        }

        /* Lightbox Specifics overriding generic modal */
        #galleryModal .modal-content {
            background: transparent;
            box-shadow: none;
            width: 100%;
            max-width: 800px;
            padding: 0;
            border: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #galleryModalImg {
            max-width: 95%;
            max-height: 80vh;
            border-radius: 8px;
            border: 4px solid var(--accent-gold);
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            object-fit: contain;
            background-color: #000;
        }

        #galleryModalCaption {
            color: white;
            margin-top: 15px;
            font-size: 1.2em;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            background: rgba(0, 35, 102, 0.8);
            padding: 8px 20px;
            border-radius: 50px;
            border: 1px solid var(--accent-gold);
        }

        .status-msg {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px;
            color: var(--light-text);
            font-size: 1.1em;
        }
        
        /* Floating Close Button Adjustment for Gallery */
        #closeGalleryModal {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1005;
        }
    </style>
</head>
<body>

    <header>
        <div class="header-display" style="height: auto; min-height: 80px; margin-bottom: 0; display: flex; align-items: center; justify-content: center;">
            <div class="ad-content" style="background: transparent; box-shadow: none;">
                <h1 style="margin: 0; font-size: 1.8em; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">Community Gallery</h1>
            </div>
        </div>
        <!-- Gold Border Bottom provided by user-style.css header rule -->
    </header>

    <div class="content-wrapper" style="margin-top: 20px;">
        <div class="gallery-header animate-on-scroll">
            <div class="back-btn-wrapper">
                <a href="index.html" class="civil-button btn-glossy" style="padding: 8px 15px; font-size: 0.9em;">
                    <i data-feather="arrow-left"></i> Back
                </a>
            </div>
            <h2 style="margin: 0; display: inline-block;">Memories</h2>
            <p style="margin: 5px 0 0 0; font-size: 0.9em;">Trust Community Events & Moments</p>
        </div>

        <div id="galleryContainer" class="gallery-grid animate-on-scroll">
            <div class="status-msg">
                <p>Loading your memories...</p>
            </div>
        </div>
    </div>

    <!-- Lightbox Modal -->
    <div id="galleryModal" class="modal">
        <span class="close" id="closeGalleryModal">×</span>
        <div class="modal-content">
            <img id="galleryModalImg" src="" alt="Full View">
            <div id="galleryModalCaption"></div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const CACHE_KEY = 'tcf_gallery_cache_v1';
        const DEFAULT_IMAGE = 'https://i.ibb.co/HTNrbJxD/20250716-222246.png';

        // --- DOM ELEMENTS ---
        const container = document.getElementById('galleryContainer');
        const modal = document.getElementById('galleryModal');
        const modalImg = document.getElementById('galleryModalImg');
        const modalCaption = document.getElementById('galleryModalCaption');
        const closeBtn = document.getElementById('closeGalleryModal');

        // --- 1. INITIALIZE APP ---
        document.addEventListener('DOMContentLoaded', async () => {
            feather.replace();
            
            // STEP 1: Load from Local Storage IMMEDIATELY (Instant Speed)
            loadFromCache();

            // STEP 2: Initialize Firebase & Sync
            await initializeFirebase();
        });

        // --- 2. CACHE SYSTEM (LOCAL STORAGE) ---
        function loadFromCache() {
            const cachedData = localStorage.getItem(CACHE_KEY);
            if (cachedData) {
                // console.log("⚡ Gallery loaded from Cache");
                const data = JSON.parse(cachedData);
                renderGallery(data);
            }
        }

        function saveToCache(data) {
            localStorage.setItem(CACHE_KEY, JSON.stringify(data));
        }

        // --- 3. FIREBASE LOGIC ---
        async function initializeFirebase() {
            try {
                // Fetch config from server (Same method as index.html)
                const response = await fetch('/api/firebase-config');
                if (!response.ok) throw new Error('Config load failed');
                const config = await response.json();

                if (!firebase.apps.length) {
                    firebase.initializeApp(config);
                }

                const db = firebase.database();
                
                // Fetch Data from 'gallery' node
                // Note: Assuming data structure is { id: { imageUrl: '...', title: '...' } }
                const galleryRef = db.ref('gallery');
                
                galleryRef.on('value', (snapshot) => {
                    const rawData = snapshot.val();
                    if (rawData) {
                        // Convert object to array
                        const galleryArray = Object.keys(rawData).map(key => ({
                            id: key,
                            ...rawData[key]
                        }));
                        
                        // Save to Cache & Update UI
                        saveToCache(galleryArray);
                        renderGallery(galleryArray);
                    } else {
                        if(!localStorage.getItem(CACHE_KEY)) {
                             container.innerHTML = '<div class="status-msg">No images found in gallery.</div>';
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase Init Error:", error);
                // Agar cache khali hai aur error aaya, tabhi error dikhao
                if (!localStorage.getItem(CACHE_KEY)) {
                    container.innerHTML = `<div class="status-msg" style="color:red;">Error loading gallery.<br><small>${error.message}</small></div>`;
                }
            }
        }

        // --- 4. RENDER UI ---
        function renderGallery(items) {
            if (!items || items.length === 0) {
                container.innerHTML = '<div class="status-msg">Gallery is empty.</div>';
                return;
            }

            container.innerHTML = ''; // Clear loading/old items

            // Reverse array to show newest first (optional)
            const sortedItems = [...items].reverse();

            sortedItems.forEach(item => {
                const card = document.createElement('div');
                card.className = 'gallery-item';
                card.onclick = () => openLightbox(item.imageUrl, item.title);

                card.innerHTML = `
                    <div class="gallery-img-container">
                        <img src="${item.imageUrl}" 
                             alt="${item.title || 'Gallery Image'}" 
                             class="gallery-img" 
                             loading="lazy"
                             onerror="this.onerror=null; this.src='${DEFAULT_IMAGE}';">
                    </div>
                    ${item.title ? `<div class="gallery-caption">${item.title}</div>` : ''}
                `;
                container.appendChild(card);
            });
        }

        // --- 5. LIGHTBOX LOGIC ---
        function openLightbox(src, caption) {
            modal.classList.add('show');
            modalImg.src = src;
            modalCaption.textContent = caption || '';
            modalCaption.style.display = caption ? 'block' : 'none';
            document.body.style.overflow = 'hidden'; // Stop background scrolling
        }

        function closeLightbox() {
            modal.classList.remove('show');
            document.body.style.overflow = ''; // Enable background scrolling
            setTimeout(() => { modalImg.src = ''; }, 300); // Clear src after animation
        }

        // Event Listeners for Modal
        closeBtn.addEventListener('click', closeLightbox);
        
        // Close on clicking outside image
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeLightbox();
        });

        // Close on Escape key
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeLightbox();
        });

        // Scroll Animation Logic (Reused from user-ui.js logic)
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('is-visible');
                    observer.unobserve(entry.target);
                }
            });
        }, { threshold: 0.1 });

        document.querySelectorAll('.animate-on-scroll').forEach(el => {
            observer.observe(el);
            // Fallback for instant load
            setTimeout(() => el.classList.add('is-visible'), 100);
        });

    </script>
</body>
</html>

