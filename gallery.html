<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rules Gallery - Bank Community</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
       :root {
            --primary-color: #1565C0;
            --primary-darker: #0D47A1;
            --background-color: #f4f7f9;
            --card-bg-color: #ffffff;
            --text-color: #263238;
            --light-text-color: #546E7A;
            --border-color: #CFD8DC;
            --shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            --font-family: 'Poppins', sans-serif;
            --border-radius: 12px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: var(--background-color); color: var(--text-color); font-family: var(--font-family); padding: 10px; }
        .container { max-width: 600px; margin: 0 auto; background: var(--card-bg-color); border-radius: 24px; box-shadow: var(--shadow); overflow: hidden; min-height: calc(100vh - 20px); }
        .header { display: flex; align-items: center; justify-content: space-between; padding: 20px 25px; border-bottom: 1px solid var(--border-color); }
        .header .title { font-size: 22px; font-weight: 600; color: var(--primary-color); }
        .back-link { color: var(--primary-color); font-weight: 500; text-decoration: none; display: flex; align-items: center; gap: 5px; }
        
        .section { padding: 25px; }
        .section-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .section-title h3 { font-size: 18px; font-weight: 600; }
        .count-badge { background-color: #e3f2fd; color: var(--primary-darker); font-size: 13px; font-weight: 600; padding: 4px 10px; border-radius: 12px; }

        /* A4 Size Grid Adjustment */
        .albums-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); /* 2 Columns strict for A4 look */
            gap: 15px; 
        }
        @media (min-width: 480px) {
            .albums-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
        }

        .album-card { 
            border-radius: var(--border-radius); 
            background-color: var(--card-bg-color); 
            cursor: pointer; 
            overflow: hidden; 
            transition: transform 0.3s ease, box-shadow 0.3s ease; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.06); 
            border: 1px solid var(--border-color);
        }
        .album-card:hover { transform: translateY(-5px); box-shadow: 0 12px 25px rgba(0,0,0,0.12); }
        
        /* A4 Aspect Ratio Container (approx 1 : 1.414) */
        .album-image { 
            width: 100%; 
            background-color: #eee; 
            background-size: cover; 
            background-repeat: no-repeat; 
            background-position: center; 
            /* A4 Ratio Logic */
            aspect-ratio: 210 / 297; 
        }
        
        .album-info { padding: 12px; text-align: center; border-top: 1px solid #f0f0f0; background: #fff; }
        .album-title { font-weight: 600; font-size: 14px; color: var(--text-color); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.4; }
        
        .status-message { padding: 40px 15px; text-align: center; color: var(--light-text-color); font-size: 16px; grid-column: 1 / -1; width: 100%; }
        
        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); align-items: center; justify-content: center; backdrop-filter: blur(5px); opacity: 0; transition: opacity 0.3s ease; }
        .modal.show { display: flex; opacity: 1; }
        .lightbox-content { position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .lightbox-image { max-width: 95vw; max-height: 85vh; border-radius: 4px; box-shadow: 0 0 20px rgba(0,0,0,0.5); object-fit: contain; background: #fff; }
        .lightbox-close, .lightbox-nav { position: absolute; color: white; cursor: pointer; font-size: 35px; font-weight: bold; user-select: none; z-index: 1001; background: rgba(0,0,0,0.3); width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.3s; }
        .lightbox-close { top: 20px; right: 20px; }
        .lightbox-nav { top: 50%; transform: translateY(-50%); }
        .lightbox-nav.prev { left: 15px; }
        .lightbox-nav.next { right: 15px; }
        .lightbox-close:hover, .lightbox-nav:hover { background: rgba(255,255,255,0.2); }
        .lightbox-details { position: absolute; bottom: 30px; color: #fff; font-size: 16px; text-align: center; background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 30px; backdrop-filter: blur(5px); font-weight: 500; }
    </style>
</head>
<body>
    <div id="appContainer" class="container">
        <header class="header">
            <a href="/index.html" class="back-link">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                Back
            </a>
            <h1 class="title">Rules Gallery</h1>
        </header>

        <section class="section">
            <div class="section-title">
                <h3 id="albumsTitle">Bank Rules</h3>
                <span id="recordCount" class="count-badge">Loading...</span>
            </div>
            <div id="albumsGrid" class="albums-grid">
                 <p class="status-message">Loading rules...</p>
            </div>
        </section>
    </div>

    <!-- Lightbox Modal -->
    <div id="lightboxModal" class="modal">
        <span class="lightbox-close" id="lightboxCloseBtn">&times;</span>
        <span class="lightbox-nav prev" id="lightboxPrevBtn">&#10094;</span>
        <span class="lightbox-nav next" id="lightboxNextBtn">&#10095;</span>
        <div class="lightbox-content">
            <img id="lightboxImage" class="lightbox-image">
            <div id="lightboxDetails" class="lightbox-details"></div>
        </div>
    </div>
    
    <script>
    // --- Global State ---
    const state = {
        allRules: [],
        lightboxCurrentIndex: 0,
    };
    
    // --- DOM Elements ---
    const getEl = (id) => document.getElementById(id);
    const albumsGrid = getEl('albumsGrid');
    const albumsTitle = getEl('albumsTitle');
    const recordCount = getEl('recordCount');
    const lightboxModal = getEl('lightboxModal');
    const lightboxImage = getEl('lightboxImage');
    const lightboxDetails = getEl('lightboxDetails');
    const lightboxCloseBtn = getEl('lightboxCloseBtn');
    const lightboxPrevBtn = getEl('lightboxPrevBtn');
    const lightboxNextBtn = getEl('lightboxNextBtn');

    // --- Utility Functions ---
    const openModal = (modal) => modal.classList.add('show');
    const closeModal = (modal) => modal.classList.remove('show');
    
    // --- Main Rendering Logic ---
    function renderRules() {
        albumsGrid.innerHTML = ''; 
        
        if (state.allRules.length === 0) {
            albumsGrid.innerHTML = `<div class="status-message"><span style="font-size: 48px;">ðŸ“‹</span><br><br><span>Abhi koi rules added nahi hain.</span></div>`;
            recordCount.textContent = '0 Rules';
            return;
        }
        
        recordCount.textContent = `${state.allRules.length} Rule${state.allRules.length === 1 ? '' : 's'}`;

        state.allRules.forEach((rule, index) => {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'album-card';
            cardDiv.onclick = () => openLightbox(index);

            // Using background-size: cover for better thumbnail, lightbox shows full
            cardDiv.innerHTML = `
                <div class="album-image" style="background-image: url('${rule.imageUrl || 'https://via.placeholder.com/210x297?text=Rule+Image'}')"></div>
                <div class="album-info">
                    <h4 class="album-title">${rule.title || 'Untitled Rule'}</h4>
                </div>
            `;
            albumsGrid.appendChild(cardDiv);
        });
    }

    // --- Lightbox Functions ---
    function openLightbox(index) {
        state.lightboxCurrentIndex = index;
        updateLightboxImage();
        openModal(lightboxModal);
    }
    const closeLightbox = () => closeModal(lightboxModal);
    
    function updateLightboxImage() {
        if (state.allRules.length === 0) { closeLightbox(); return; }
        
        // Ensure index is within bounds
        state.lightboxCurrentIndex = (state.lightboxCurrentIndex + state.allRules.length) % state.allRules.length;
        
        const rule = state.allRules[state.lightboxCurrentIndex];
        if(!rule) { closeLightbox(); return; }
        
        lightboxImage.src = rule.imageUrl;
        lightboxDetails.textContent = rule.title || 'Bank Rule';

        // Show/Hide nav buttons based on count
        const showNav = state.allRules.length > 1 ? 'flex' : 'none';
        lightboxPrevBtn.style.display = showNav;
        lightboxNextBtn.style.display = showNav;
    }

    const showNextImage = (e) => { e.stopPropagation(); state.lightboxCurrentIndex++; updateLightboxImage(); };
    const showPrevImage = (e) => { e.stopPropagation(); state.lightboxCurrentIndex--; updateLightboxImage(); };
    
    // --- Initialization ---
    async function initializePage() {
        try {
            // Attempt to fetch config, fallback if fails (simulating existing app structure)
            let configData;
            try {
                const configRes = await fetch('/api/config.js');
                if (configRes.ok) configData = await configRes.json();
            } catch (e) { console.warn('Config fetch failed, checking globals'); }

            // Logic to use global or fetched config
            const firebaseConfig = configData ? configData.firebase : (typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null);

            if (!firebaseConfig) throw new Error('Firebase configuration not found');

            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }

            // Auth Check
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    runMainApp(firebase.database());
                } else {
                    // Redirect logic preserved from user's code
                    window.location.href = `/login.html?redirect=${window.location.pathname}`;
                }
            });
        } catch (error) {
            console.error(error);
            document.body.innerHTML = `<div style="padding:20px;text-align:center;"><h3>Loading Error</h3><p>Please refresh the page.</p></div>`;
        }
    }

    function runMainApp(database) {
        // Updated Path: admin/rules
        const rulesRef = database.ref('admin/rules');
        
        rulesRef.on('value', (snapshot) => {
            const rulesData = snapshot.val();
            const rulesList = [];
            
            if (rulesData) {
                // Determine if data is array or object map
                if (Array.isArray(rulesData)) {
                    rulesData.forEach(r => { if(r) rulesList.push(r); });
                } else {
                    Object.keys(rulesData).forEach(key => {
                        rulesList.push({
                            id: key,
                            ...rulesData[key]
                        });
                    });
                }
            }
            
            state.allRules = rulesList;
            renderRules();
            
            // If modal is open, update it in case data changed underneath
            if(lightboxModal.classList.contains('show')) updateLightboxImage();
        });
    }

    // --- Event Listeners ---
    lightboxCloseBtn.addEventListener('click', closeLightbox);
    lightboxPrevBtn.addEventListener('click', showPrevImage);
    lightboxNextBtn.addEventListener('click', showNextImage);
    
    // Close modal on outside click
    lightboxModal.addEventListener('click', (e) => {
        if(e.target === lightboxModal) closeLightbox();
    });

    document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>

