<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Neumorphic Profile Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
  />
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap');
    body {
      font-family: 'Montserrat', sans-serif;
      background: #e6e3f7;
    }
    /* Neumorphic shadows */
    .neu-container {
      background: #e6e3f7;
      box-shadow: 8px 8px 16px #c1bee6, -8px -8px 16px #ffffff;
    }
    .neu-inset {
       background: #e6e3f7;
       box-shadow: inset 4px 4px 6px #c1bee6, inset -4px -4px 6px #ffffff;
    }
    .neu-button {
      background: #e6e3f7;
      box-shadow: 4px 4px 6px #c1bee6, -4px -4px 6px #ffffff;
      transition: all 0.2s ease-in-out;
    }
    .neu-button:hover {
      box-shadow: 6px 6px 10px #c1bee6, -6px -6px 10px #ffffff;
    }
    .neu-button:active, .neu-button-pressed {
      background: #e6e3f7;
      box-shadow: inset 4px 4px 6px #c1bee6, inset -4px -4px 6px #ffffff;
      color: #7a75b3;
    }
    .neu-progress-bg {
      background: #d9d7f0;
      box-shadow: inset 3px 3px 5px #b7b5d6, inset -3px -3px 5px #ffffff;
    }
    /* Custom Dropdown */
    .neu-dropdown {
        position: relative;
        display: inline-block;
    }
    .neu-dropdown-select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        padding: 12px 40px 12px 20px;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        color: #7a75b3;
        cursor: pointer;
        width: 100%;
    }
    .neu-dropdown-arrow {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: center;
        padding: 0 15px;
        pointer-events: none;
    }
    /* Loading Spinner */
    .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #7a75b3;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .hidden {
        display: none;
    }
  </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4">
  <div id="loader" class="loader mt-20"></div>
  
  <div id="dashboard-content" class="max-w-4xl w-full rounded-3xl neu-container p-4 sm:p-6 hidden pb-24 md:pb-6">
    <div class="flex flex-col md:flex-row gap-6">
      
      <!-- Main content -->
      <main class="flex-1 text-[#3f3a6e] w-full">

        <!-- Mobile Header -->
        <div class="md:hidden flex flex-col items-center text-center mb-6">
            <img id="profile-pic-mobile" src="https://i.imgur.com/6aATcZR.jpeg" alt="Profile Picture" class="neu-button w-24 h-24 rounded-full p-1.5 object-cover mb-4">
            <h1 class="text-2xl font-bold mb-2">Hello, <span id="profile-name-mobile">Kunal</span>!</h1>
            <div class="neu-dropdown neu-button rounded-xl w-full max-w-xs">
                <select id="member-select" class="neu-dropdown-select neu-button">
                    <option>Select Member</option>
                </select>
                <div class="neu-dropdown-arrow">
                    <i class="fas fa-chevron-down text-[#7a75b3]"></i>
                </div>
            </div>
        </div>

        <!-- Desktop Header -->
        <div class="hidden md:flex justify-between items-center mb-6">
             <h1 class="text-3xl font-semibold leading-tight">Hello, <span id="profile-name-desktop">Kunal</span>!</h1>
             <img id="profile-pic-desktop" src="https://i.imgur.com/6aATcZR.jpeg" alt="Profile Picture" class="neu-button w-16 h-16 rounded-full p-1 object-cover">
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 mb-6">
            <!-- Current Balance -->
            <div class="neu-inset rounded-2xl p-4 flex items-center gap-4">
                <div class="neu-button w-12 h-12 rounded-xl flex items-center justify-center text-green-500 flex-shrink-0">
                    <i class="fas fa-wallet text-2xl"></i>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Current Balance</p>
                    <p id="current-balance" class="text-xl font-bold">₹0</p>
                </div>
            </div>
            <!-- Total Loan -->
            <div class="neu-inset rounded-2xl p-4 flex items-center gap-4">
                <div class="neu-button w-12 h-12 rounded-xl flex items-center justify-center text-red-500 flex-shrink-0">
                    <i class="fas fa-hand-holding-usd text-2xl"></i>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Total Loan</p>
                    <p id="total-loan" class="text-xl font-bold">₹0</p>
                </div>
            </div>
            <!-- Return Earned -->
            <div class="neu-inset rounded-2xl p-4 flex items-center gap-4">
                <div class="neu-button w-12 h-12 rounded-xl flex items-center justify-center text-blue-500 flex-shrink-0">
                    <i class="fas fa-piggy-bank text-2xl"></i>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Return Earned</p>
                    <p id="return-earned" class="text-xl font-bold">₹0</p>
                </div>
            </div>
        </div>

        <div class="flex flex-col lg:flex-row gap-6 mb-6">
            <!-- Progress Circles -->
            <div class="flex-1 grid grid-cols-2 gap-4 sm:gap-6">
                <div class="neu-inset rounded-2xl p-4 flex flex-col items-center justify-center">
                    <div class="relative w-24 h-24 mb-2">
                        <svg class="w-full h-full" viewBox="0 0 36 36" fill="none">
                            <circle cx="18" cy="18" r="15.9155" stroke="#d9d7f0" stroke-width="3"/>
                            <circle id="sip-circle" cx="18" cy="18" r="15.9155" stroke="#7a75b3" stroke-width="3" stroke-linecap="round" stroke-dasharray="100, 100" stroke-dashoffset="100" transform="rotate(-90 18 18)"/>
                        </svg>
                        <div id="sip-percentage" class="absolute inset-0 flex items-center justify-center text-2xl font-semibold">0%</div>
                    </div>
                    <p class="text-sm text-center">SIP Payment<br>(This Month)</p>
                </div>
                <div class="neu-inset rounded-2xl p-4 flex flex-col items-center justify-center">
                    <div class="relative w-24 h-24 mb-2">
                        <svg class="w-full h-full" viewBox="0 0 36 36" fill="none">
                            <circle cx="18" cy="18" r="15.9155" stroke="#d9d7f0" stroke-width="3"/>
                            <circle id="loan-circle" cx="18" cy="18" r="15.9155" stroke="#28a745" stroke-width="3" stroke-linecap="round" stroke-dasharray="100, 100" stroke-dashoffset="100" transform="rotate(-90 18 18)"/>
                        </svg>
                        <div id="loan-percentage" class="absolute inset-0 flex items-center justify-center text-2xl font-semibold">0%</div>
                    </div>
                    <p class="text-sm text-center">Loan Repayment<br>(Current)</p>
                </div>
            </div>
            <!-- Weekly Progress -->
            <section class="neu-inset rounded-2xl p-4 sm:p-6 lg:w-2/3">
                <h2 class="text-base mb-4">Last 7 Transactions</h2>
                <div id="transaction-chart" class="flex justify-around items-end space-x-1 sm:space-x-2 h-32">
                    <!-- Bars will be generated by JS -->
                </div>
            </section>
        </div>
      </main>
    </div>
     <!-- Mobile Bottom Navigation -->
    <nav class="md:hidden fixed bottom-0 left-0 right-0 neu-container h-16 flex justify-around items-center rounded-t-2xl z-10">
        <a href="#" class="neu-button w-14 h-14 rounded-xl flex flex-col items-center justify-center text-xs text-[#7a75b3]">
            <i class="fas fa-home text-xl mb-1"></i>
            Home
        </a>
        <a href="#" class="neu-button w-14 h-14 rounded-xl flex flex-col items-center justify-center text-xs text-[#7a75b3]">
            <i class="fas fa-exchange-alt text-xl mb-1"></i>
            History
        </a>
        <a href="#" class="neu-button-pressed w-14 h-14 rounded-xl flex flex-col items-center justify-center text-xs">
            <i class="fas fa-user-alt text-xl mb-1"></i>
            Profile
        </a>
        <a href="#" class="neu-button w-14 h-14 rounded-xl flex flex-col items-center justify-center text-xs text-[#7a75b3]">
            <i class="fas fa-cog text-xl mb-1"></i>
            Settings
        </a>
    </nav>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBVCDW0Q8YaTPz_MO9FTve1FaPu42jtO2c",
            authDomain: "bank-master-data.firebaseapp.com",
            databaseURL: "https://bank-master-data-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "bank-master-data",
            storageBucket: "bank-master-data.firebasestorage.app",
            messagingSenderId: "778113641069",
            appId: "1:778113641069:web:f2d584555dee89b8ca2d64",
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- DOM Elements ---
        const loader = document.getElementById('loader');
        const dashboardContent = document.getElementById('dashboard-content');
        const memberSelect = document.getElementById('member-select');
        
        const profilePicMobile = document.getElementById('profile-pic-mobile');
        const profilePicDesktop = document.getElementById('profile-pic-desktop');
        const profileNameMobile = document.getElementById('profile-name-mobile');
        const profileNameDesktop = document.getElementById('profile-name-desktop');

        const currentBalanceEl = document.getElementById('current-balance');
        const totalLoanEl = document.getElementById('total-loan');
        const returnEarnedEl = document.getElementById('return-earned');
        const sipCircle = document.getElementById('sip-circle');
        const sipPercentageEl = document.getElementById('sip-percentage');
        const loanCircle = document.getElementById('loan-circle');
        const loanPercentageEl = document.getElementById('loan-percentage');
        const transactionChart = document.getElementById('transaction-chart');
        
        const DEFAULT_IMAGE = 'https://i.imgur.com/6aATcZR.jpeg';
        let allMembersData = {}; // Store all processed data

        // --- Data Fetching and Processing ---
        async function fetchAndProcessData() {
            const membersRef = database.ref('members');
            try {
                const snapshot = await membersRef.once('value');
                const membersData = snapshot.val();
                if (!membersData) {
                    throw new Error("No member data found.");
                }
                
                const processedData = {};
                const allTransactions = [];

                // First pass: Flatten all transactions
                for (const key in membersData) {
                    const member = membersData[key];
                    const name = member.name || key;
                    if (member.transactions) {
                        for (const txId in member.transactions) {
                            const tx = member.transactions[txId];
                            const returnAmt = tx["Return amount"] || tx["Return amount "];
                            allTransactions.push({
                                memberName: name,
                                Date: new Date(tx.Date),
                                Loan: parseFloat(tx.Loan) || 0,
                                Payment: parseFloat(tx["Loan Payment"]) || 0,
                                SipPayment: parseFloat(tx["SIP Payment"]) || 0,
                                ReturnAmount: parseFloat(returnAmt) || 0,
                                ImageUrl: tx.imageUrl || null
                            });
                        }
                    }
                }
                allTransactions.sort((a, b) => a.Date - b.Date);

                // Second pass: Process each member's data
                for (const key in membersData) {
                    const name = membersData[key].name || key;
                    const memberTxs = allTransactions.filter(tx => tx.memberName === name);
                    if (memberTxs.length === 0) continue;

                    const totalLoan = memberTxs.reduce((sum, tx) => sum + tx.Loan, 0);
                    const totalPayment = memberTxs.reduce((sum, tx) => sum + tx.Payment, 0);
                    const totalSIP = memberTxs.reduce((sum, tx) => sum + tx.SipPayment, 0);
                    
                    const lastEntryWithImage = [...memberTxs].reverse().find(r => r.ImageUrl);

                    // SIP Calculation for current month
                    const now = new Date();
                    const currentMonthSipTxs = memberTxs.filter(tx => 
                        tx.SipPayment > 0 &&
                        tx.Date.getMonth() === now.getMonth() &&
                        tx.Date.getFullYear() === now.getFullYear()
                    );
                    const totalMonthSip = currentMonthSipTxs.reduce((sum, tx) => sum + tx.SipPayment, 0);
                    const sipPercentage = Math.min(Math.round((totalMonthSip / 500) * 100), 100);

                    // Loan Repayment Calculation
                    const lastLoanTx = [...memberTxs].reverse().find(tx => tx.Loan > 0);
                    let loanRepaymentPercentage = 0;
                    if (lastLoanTx) {
                        const paymentsAfterLoan = memberTxs
                            .filter(tx => tx.Date > lastLoanTx.Date && tx.Payment > 0)
                            .reduce((sum, tx) => sum + tx.Payment, 0);
                        loanRepaymentPercentage = Math.min(Math.round((paymentsAfterLoan / lastLoanTx.Loan) * 100), 100);
                    } else {
                        loanRepaymentPercentage = 100; // No active loan
                    }
                    
                    processedData[name] = {
                        name: name,
                        balance: (totalSIP + totalPayment) - totalLoan,
                        totalLoan: totalLoan,
                        totalReturn: calculateTotalReturnForMember(name, allTransactions),
                        profilePic: lastEntryWithImage ? lastEntryWithImage.ImageUrl : DEFAULT_IMAGE,
                        sipPercentage: isNaN(sipPercentage) ? 0 : sipPercentage,
                        loanRepaymentPercentage: isNaN(loanRepaymentPercentage) ? 0 : loanRepaymentPercentage,
                        transactions: memberTxs
                    };
                }
                
                allMembersData = processedData;
                populateDropdown();
                updateDashboard('Kunal kumar'); // Load Kunal by default
                
                loader.classList.add('hidden');
                dashboardContent.classList.remove('hidden');

            } catch (error) {
                console.error("Error fetching data:", error);
                loader.textContent = "Failed to load data.";
            }
        }

        function calculateTotalReturnForMember(memberName, allTransactions) {
            let totalReturn = 0;
            const loanPayments = allTransactions.filter(tx => tx.ReturnAmount > 0);

            loanPayments.forEach(paymentTx => {
                const loanDate = allTransactions
                    .filter(tx => tx.memberName === paymentTx.memberName && tx.Loan > 0 && tx.Date < paymentTx.Date)
                    .sort((a,b) => b.Date - a.Date)[0]?.Date;
                
                if (!loanDate) return;

                const capitalPool = {};
                const txsBeforeLoan = allTransactions.filter(tx => tx.Date < loanDate);

                txsBeforeLoan.forEach(tx => {
                    capitalPool[tx.memberName] = (capitalPool[tx.memberName] || 0) + tx.SipPayment + tx.Payment - tx.Loan;
                });

                const totalCapital = Object.values(capitalPool).reduce((sum, bal) => bal > 0 ? sum + bal : sum, 0);
                
                if (totalCapital > 0 && capitalPool[memberName] > 0) {
                    const share = (capitalPool[memberName] / totalCapital) * paymentTx.ReturnAmount;
                    totalReturn += share;
                }
            });
            return totalReturn;
        }

        function populateDropdown() {
            const memberNames = Object.keys(allMembersData).sort();
            memberSelect.innerHTML = '';
            memberNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                memberSelect.appendChild(option);
            });
             memberSelect.value = 'Kunal kumar'; // Set default selection
        }

        function updateDashboard(memberName) {
            const data = allMembersData[memberName];
            if (!data) return;
            
            const shortName = data.name.split(' ')[0]; // Get first name
            profilePicMobile.src = data.profilePic || DEFAULT_IMAGE;
            profilePicDesktop.src = data.profilePic || DEFAULT_IMAGE;
            profileNameMobile.textContent = shortName;
            profileNameDesktop.textContent = data.name;

            currentBalanceEl.textContent = `₹${data.balance.toLocaleString('en-IN')}`;
            totalLoanEl.textContent = `₹${data.totalLoan.toLocaleString('en-IN')}`;
            returnEarnedEl.textContent = `₹${Math.round(data.totalReturn).toLocaleString('en-IN')}`;

            // Update SIP Circle
            sipPercentageEl.textContent = `${data.sipPercentage}%`;
            sipCircle.style.strokeDashoffset = 100 - data.sipPercentage;

            // Update Loan Circle
            loanPercentageEl.textContent = `${data.loanRepaymentPercentage}%`;
            loanCircle.style.strokeDashoffset = 100 - data.loanRepaymentPercentage;
            loanCircle.style.stroke = data.loanRepaymentPercentage >= 100 ? '#22c55e' : '#ef4444'; // Green for paid, red for due

            // Update Transaction Chart
            updateChart(data.transactions);
        }

        function updateChart(transactions) {
            transactionChart.innerHTML = '';
            const last7Txs = transactions.slice(-7);
            if (last7Txs.length === 0) {
                transactionChart.innerHTML = `<p class="text-center text-xs text-gray-400 w-full">No recent transactions.</p>`;
                return;
            }
            const maxAmount = Math.max(...last7Txs.map(tx => tx.Loan || tx.SipPayment || tx.Payment), 1); // Avoid division by zero
            
            const days = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];

            last7Txs.forEach(tx => {
                const amount = tx.Loan || tx.SipPayment || tx.Payment;
                const heightPercentage = Math.max((amount / maxAmount) * 100, 5); // Minimum height of 5%
                let barColor = '#a78bfa'; // Default purple
                if (tx.Loan > 0) barColor = '#ef4444'; // Red for loan
                if (tx.SipPayment > 0) barColor = '#3b82f6'; // Blue for SIP
                if (tx.Payment > 0) barColor = '#22c55e'; // Green for payment

                const barContainer = document.createElement('div');
                barContainer.className = 'flex flex-col items-center space-y-1 h-full justify-end flex-1';
                barContainer.innerHTML = `
                    <div class="neu-progress-bg rounded-t-md w-4/5" style="height: 100%;" title="₹${amount.toLocaleString('en-IN')} on ${tx.Date.toLocaleDateString()}">
                        <div class="rounded-t-md w-full" style="height: ${heightPercentage}%; background: ${barColor};"></div>
                    </div>
                    <span class="text-xs font-semibold">${days[tx.Date.getDay()]}</span>
                `;
                transactionChart.appendChild(barContainer);
            });
        }

        // --- Event Listeners ---
        memberSelect.addEventListener('change', (e) => {
            updateDashboard(e.target.value);
        });

        // --- Initial Call ---
        fetchAndProcessData();
    });
  </script>
</body>
</html>

