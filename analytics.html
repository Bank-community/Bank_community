<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Royal TCF Analytics & AI Auditor</title>
    
    <!-- TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FONT AWESOME -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    
    <!-- GOOGLE GEMINI SDK -->
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
    <!-- MARKDOWN PARSER -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        royal: {
                            dark: '#001540',
                            card: '#002366',
                            gold: '#D4AF37',
                            goldLight: '#F3E5AB',
                            text: '#E0E7FF'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Poppins', sans-serif; background-color: #001540; color: #e2e8f0; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #001540; }
        ::-webkit-scrollbar-thumb { background: #D4AF37; border-radius: 4px; }
        
        .glass-panel {
            background: rgba(0, 35, 102, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(212, 175, 55, 0.2);
        }

        .ai-chat-bubble {
            background: linear-gradient(135deg, #002366 0%, #001540 100%);
            border: 1px solid #D4AF37;
            border-radius: 12px 12px 12px 0;
            padding: 12px;
            font-size: 0.9rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .user-chat-bubble {
            background: #F3E5AB;
            color: #001540;
            border-radius: 12px 12px 0 12px;
            padding: 10px 15px;
            font-size: 0.9rem;
            font-weight: 500;
        }
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; background-color: #D4AF37; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <!-- SECURITY OVERLAY -->
    <div id="security-check" class="fixed inset-0 z-[100] bg-[#001540] flex flex-col items-center justify-center">
        <div class="animate-spin text-royal-gold text-4xl mb-4"><i class="fas fa-circle-notch"></i></div>
        <p class="text-royal-gold font-bold tracking-widest text-sm">VERIFYING ADMIN (princekbc2)...</p>
    </div>

    <!-- SIDEBAR -->
    <aside class="w-20 md:w-64 bg-royal-card border-r border-royal-gold/20 flex flex-col z-20">
        <div class="p-4 md:p-6 border-b border-royal-gold/20 flex items-center justify-center md:justify-start gap-3">
            <div class="w-10 h-10 rounded-full border-2 border-royal-gold flex items-center justify-center text-royal-gold font-bold text-lg shadow-[0_0_10px_rgba(212,175,55,0.5)]">
                <i class="fas fa-crown"></i>
            </div>
            <div class="hidden md:block">
                <h1 class="font-bold text-white tracking-wide">TCF AUDIT</h1>
                <p class="text-[10px] text-royal-gold uppercase tracking-widest">Nano System</p>
            </div>
        </div>
        
        <nav class="flex-1 p-2 space-y-2 mt-4">
            <button class="w-full px-4 py-3 rounded-lg bg-royal-gold/10 text-royal-gold border border-royal-gold/30 font-medium flex items-center justify-center md:justify-start gap-3">
                <i class="fas fa-chart-line"></i> <span class="hidden md:inline">Analytics</span>
            </button>
        </nav>

        <div class="p-4 border-t border-royal-gold/20">
            <button id="logout-btn" class="w-full bg-red-900/30 hover:bg-red-900/50 text-red-300 border border-red-800/50 px-4 py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-2 transition-colors">
                <i class="fas fa-sign-out-alt"></i> <span class="hidden md:inline">Secure Logout</span>
            </button>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col relative overflow-hidden bg-royal-dark">
        <!-- HEADER -->
        <header class="h-16 border-b border-royal-gold/20 bg-royal-card/80 backdrop-blur flex justify-between items-center px-6">
            <h2 class="text-lg md:text-xl font-bold text-white"><i class="fas fa-search-dollar text-royal-gold mr-2"></i> Financial Audit</h2>
            <div id="loader" class="flex items-center gap-2 text-royal-gold">
                <i class="fas fa-circle-notch fa-spin"></i>
                <span class="text-xs font-bold tracking-wider">ANALYZING DATA...</span>
            </div>
        </header>

        <!-- DASHBOARD AREA -->
        <div class="flex-1 overflow-auto p-4 md:p-6 relative custom-scrollbar">
            <!-- Stats -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-8">
                <div class="glass-panel p-5 rounded-xl border-l-4 border-l-green-500">
                    <p class="text-gray-400 text-xs font-bold uppercase tracking-widest">Total Distributed</p>
                    <p id="total-profit-dist" class="text-2xl font-bold text-green-400 mt-1">₹0</p>
                </div>
                <div class="glass-panel p-5 rounded-xl border-l-4 border-l-royal-gold">
                    <p class="text-gray-400 text-xs font-bold uppercase tracking-widest">Avg. Performance</p>
                    <p id="avg-score" class="text-2xl font-bold text-royal-gold mt-1">0.0</p>
                </div>
                <div class="glass-panel p-5 rounded-xl border-l-4 border-l-blue-400">
                    <p class="text-gray-400 text-xs font-bold uppercase tracking-widest">Active Members</p>
                    <p id="active-members-count" class="text-2xl font-bold text-blue-400 mt-1">0</p>
                </div>
                <div class="glass-panel p-5 rounded-xl border-l-4 border-l-red-500">
                    <p class="text-gray-400 text-xs font-bold uppercase tracking-widest">Late Payments</p>
                    <p id="late-payments-count" class="text-2xl font-bold text-red-400 mt-1">0</p>
                </div>
            </div>

            <!-- Table -->
            <div class="glass-panel rounded-xl overflow-hidden shadow-2xl">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-royal-card text-gray-400 text-xs uppercase tracking-wider">
                                <th class="p-4 font-semibold">Member</th>
                                <th class="p-4 font-semibold text-center">Nano Score</th>
                                <th class="p-4 font-semibold text-center">Profit</th>
                                <th class="p-4 font-semibold text-center">Balance</th>
                                <th class="p-4 font-semibold text-right">AI Auditor</th>
                            </tr>
                        </thead>
                        <tbody id="members-table-body" class="divide-y divide-royal-gold/10 text-sm"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- AI CHAT DRAWER -->
    <div id="ai-drawer" class="absolute inset-y-0 right-0 w-full md:w-[450px] bg-[#001030] border-l border-royal-gold/30 transform translate-x-full transition-transform duration-300 z-50 flex flex-col shadow-2xl">
        <div class="p-4 border-b border-royal-gold/20 bg-royal-card flex justify-between items-center shadow-lg">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-r from-royal-gold to-yellow-600 flex items-center justify-center shadow-lg border border-white/10">
                    <i class="fas fa-robot text-royal-dark text-lg"></i>
                </div>
                <div>
                    <h3 class="font-bold text-white">AI Auditor</h3>
                    <p id="ai-target-name" class="text-[10px] text-royal-gold uppercase tracking-wider">Select a member</p>
                </div>
            </div>
            <button id="close-ai" class="w-8 h-8 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center text-gray-400 hover:text-white transition-colors"><i class="fas fa-times"></i></button>
        </div>
        <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 bg-[#001030] custom-scrollbar"></div>
        <div class="p-4 border-t border-royal-gold/20 bg-royal-card">
            <div class="relative flex items-center gap-2">
                <input id="chat-input" type="text" placeholder="Ask AI..." class="flex-1 bg-royal-dark text-white rounded-xl py-3 pl-4 pr-12 text-sm focus:outline-none focus:ring-1 focus:ring-royal-gold border border-royal-gold/20">
                <button id="send-btn" class="bg-royal-gold hover:bg-yellow-500 text-royal-dark font-bold w-10 h-10 rounded-xl flex items-center justify-center transition-all shadow-lg"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <!-- LOGIC MODAL -->
    <div id="log-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black/90 backdrop-blur-sm">
        <div class="bg-[#001540] w-full max-w-2xl rounded-2xl border border-royal-gold shadow-[0_0_30px_rgba(212,175,55,0.2)] flex flex-col max-h-[85vh]">
            <div class="p-5 border-b border-royal-gold/20 flex justify-between items-center bg-royal-card/50">
                <h3 id="log-modal-title" class="text-lg font-bold text-white">Nano Breakdown</h3>
                <button onclick="document.getElementById('log-modal').classList.add('hidden'); document.getElementById('log-modal').classList.remove('flex');" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div id="log-modal-content" class="p-6 overflow-y-auto space-y-4 custom-scrollbar"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // CONFIG & KEYS
        const CONFIG = { TARGET_SIP: 30000, NEW_MEMBER_PROBATION_DAYS: 180 };
        const GEMINI_API_KEY = "AIzaSyBwhJNl7Rw4Xwb8esmsIes5uVX2fWlRnSE"; 
        
        // --- UPDATED SECURITY CONSTANT ---
        const ALLOWED_ADMIN_EMAIL = 'princekbc2@gmail.com'; 

        let db, auth, genAI, model;
        let GLOBAL_DATA = { members: {}, transactions: {}, activeLoans: {} };
        let CURRENT_ANALYSIS_CONTEXT = null; 

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('/api/firebase-config');
                const firebaseConfig = await response.json();
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getDatabase(app);
                
                // Initialize AI
                genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
                model = genAI.getGenerativeModel({ model: "gemini-pro"});

                // --- SECURITY CHECK (EMAIL BASED) ---
                onAuthStateChanged(auth, (user) => {
                    const securityScreen = document.getElementById('security-check');
                    
                    if (user && user.email === ALLOWED_ADMIN_EMAIL) {
                        // User is verified Admin
                        console.log("✅ Admin Verified: " + user.email);
                        securityScreen.classList.add('hidden'); // Remove overlay
                        fetchDataAndAnalyze(); // Start Data Load
                    } else {
                        // Not logged in or wrong user
                        console.warn("⛔ Unauthorized. Redirecting...");
                        window.location.href = 'login.html?redirect=analytics.html';
                    }
                });

                // Logout Logic
                document.getElementById('logout-btn').addEventListener('click', () => {
                    signOut(auth).then(() => {
                        window.location.href = 'login.html';
                    });
                });

            } catch (e) {
                console.error("Init Error:", e);
                alert("Security Init Failed: " + e.message);
            }
        });

        // --- DATA & ANALYSIS LOGIC ---
        async function fetchDataAndAnalyze() {
            const loader = document.getElementById('loader');
            
            const [membersSnap, txSnap, loansSnap] = await Promise.all([
                get(ref(db, 'members')),
                get(ref(db, 'transactions')),
                get(ref(db, 'activeLoans'))
            ]);

            GLOBAL_DATA.members = membersSnap.val() || {};
            GLOBAL_DATA.transactions = txSnap.val() || {};
            GLOBAL_DATA.activeLoans = loansSnap.val() || {};

            const txArray = Object.values(GLOBAL_DATA.transactions).map((t, i) => ({...t, id: Object.keys(GLOBAL_DATA.transactions)[i]}));
            txArray.sort((a,b) => new Date(a.date) - new Date(b.date));
            
            renderTable(txArray);
            loader.classList.add('hidden');
        }

        function renderTable(txArray) {
            const tableBody = document.getElementById('members-table-body');
            tableBody.innerHTML = '';
            let stats = { profit: 0, scoreSum: 0, active: 0, late: 0 };

            for (const [memberId, member] of Object.entries(GLOBAL_DATA.members)) {
                if(member.status !== 'Approved') continue;
                stats.active++;

                const analysis = runNanoAnalysis(memberId, member.fullName, txArray, GLOBAL_DATA.activeLoans);
                GLOBAL_DATA.members[memberId].analysis = analysis;
                
                stats.profit += analysis.financials.lifetimeProfit;
                stats.scoreSum += analysis.scoreData.totalScore;
                if(analysis.scoreData.hasLatePayment) stats.late++;

                const row = document.createElement('tr');
                row.className = "hover:bg-white/5 transition-colors border-b border-royal-gold/10 group";
                row.innerHTML = `
                    <td class="p-4">
                        <div class="flex items-center gap-3">
                            <img src="${member.profilePicUrl || 'https://placehold.co/100/002366/D4AF37'}" class="w-12 h-12 rounded-full border-2 border-royal-gold/50 object-cover">
                            <div>
                                <p class="font-bold text-white text-sm">${member.fullName}</p>
                                <p class="text-[10px] text-royal-gold opacity-70">ID: ${memberId}</p>
                            </div>
                        </div>
                    </td>
                    <td class="p-4 text-center">
                        <button onclick="showNanoLogic('${memberId}')" class="group relative inline-flex flex-col items-center">
                            <span class="text-lg font-bold ${getScoreColor(analysis.scoreData.totalScore)}">${analysis.scoreData.totalScore.toFixed(1)}</span>
                            <div class="h-1 w-full bg-gray-700 rounded-full mt-1 overflow-hidden">
                                <div class="h-full ${analysis.scoreData.totalScore >= 50 ? 'bg-royal-gold' : 'bg-red-500'}" style="width: ${analysis.scoreData.totalScore}%"></div>
                            </div>
                        </button>
                    </td>
                    <td class="p-4 text-center text-green-400 font-bold">₹${analysis.financials.lifetimeProfit.toLocaleString('en-IN')}</td>
                    <td class="p-4 text-center"><span class="bg-royal-card px-2 py-1 rounded border border-royal-gold/20">₹${analysis.financials.walletBalance.toLocaleString('en-IN')}</span></td>
                    <td class="p-4 text-right">
                        <button onclick="openAIForMember('${memberId}')" class="text-royal-gold border border-royal-gold hover:bg-royal-gold hover:text-royal-dark text-xs font-bold px-3 py-1 rounded transition-all">
                            <i class="fas fa-robot"></i> AUDIT
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            }
            // Update Stats UI
            document.getElementById('total-profit-dist').innerText = `₹${stats.profit.toLocaleString('en-IN')}`;
            document.getElementById('avg-score').innerText = stats.active ? (stats.scoreSum/stats.active).toFixed(1) : "0.0";
            document.getElementById('active-members-count').innerText = stats.active;
            document.getElementById('late-payments-count').innerText = stats.late;
        }

        // --- LOGIC ENGINE ---
        function runNanoAnalysis(memberId, memberName, allTx, allLoans) {
            const memberTx = allTx.filter(t => t.memberId === memberId || t.name === memberName);
            const logs = { capital: [], consistency: [], credit: [] };
            
            // 1. Capital
            const totalSip = memberTx.filter(t => t.type === 'SIP').reduce((sum, t) => sum + (Number(t.amount)||0), 0);
            const capScore = Math.min(100, (totalSip / CONFIG.TARGET_SIP) * 100);
            logs.capital.push(`Total SIP: ₹${totalSip}`);

            // 2. Consistency
            const months = new Set(memberTx.filter(t => t.type === 'SIP').map(t => new Date(t.date).getMonth() + "-" + new Date(t.date).getFullYear()));
            const consScore = Math.min(100, months.size * 10);
            logs.consistency.push(`SIP Months: ${months.size}`);

            // 3. Credit
            let creditScore = 40; 
            let hasLate = false;
            const loans = memberTx.filter(t => t.type === 'Loan Taken');
            if(loans.length > 0) {
                creditScore = 100;
                loans.forEach(l => {
                    // Simple logic: if paid, good. if active > 90 days, bad.
                    const paid = memberTx.some(t => t.type === 'Loan Payment' && new Date(t.date) > new Date(l.date));
                    if(!paid) {
                        const days = (new Date() - new Date(l.date))/(1000*3600*24);
                        if(days > 90) { creditScore -= 20; hasLate = true; logs.credit.push(`Late Loan (>90 days)`); }
                        else logs.credit.push(`Active Loan (${Math.floor(days)} days)`);
                    } else logs.credit.push(`Loan Repaid`);
                });
            } else logs.credit.push("No Loan History");
            creditScore = Math.max(0, creditScore);

            // New Member Rule
            const joinDate = memberTx[0] ? new Date(memberTx[0].date) : new Date();
            const isNew = ((new Date() - joinDate)/(1000*3600*24)) < CONFIG.NEW_MEMBER_PROBATION_DAYS;
            let total = (capScore * 0.4) + (consScore * 0.3) + (creditScore * 0.3);
            if(isNew) total *= 0.5;

            // Financials
            let profit = 0, balance = 0;
            memberTx.forEach(t => {
                if(t.type === 'Extra Payment' || t.type === 'Profit Share') { profit += Number(t.amount)||0; balance += Number(t.amount)||0; }
                if(t.type === 'Extra Withdraw') balance -= Number(t.amount)||0;
            });

            return {
                scoreData: { totalScore: total, breakdown: { capital: capScore, consistency: consScore, credit: creditScore }, logs, isNew, hasLatePayment: hasLate },
                financials: { lifetimeProfit: profit, walletBalance: balance, profitSources: [], history: memberTx }
            };
        }

        // --- UI & AI HANDLERS ---
        window.showNanoLogic = (mid) => {
            const d = GLOBAL_DATA.members[mid].analysis.scoreData;
            document.getElementById('log-modal-content').innerHTML = `
                <div class="text-white font-mono text-sm space-y-2">
                    <p class="text-blue-400">Capital: ${d.breakdown.capital.toFixed(0)} (${d.logs.capital[0]})</p>
                    <p class="text-yellow-400">Consistency: ${d.breakdown.consistency.toFixed(0)} (${d.logs.consistency[0]})</p>
                    <p class="text-green-400">Credit: ${d.breakdown.credit.toFixed(0)}</p>
                    <ul class="list-disc pl-5 text-gray-400 text-xs">${d.logs.credit.map(l=>`<li>${l}</li>`).join('')}</ul>
                    ${d.isNew ? '<p class="text-red-400 mt-2">NOTE: New Member (50% Score)</p>' : ''}
                </div>`;
            document.getElementById('log-modal').classList.remove('hidden');
            document.getElementById('log-modal').classList.add('flex');
        }

        window.openAIForMember = (mid) => {
            const m = GLOBAL_DATA.members[mid];
            CURRENT_ANALYSIS_CONTEXT = m;
            document.getElementById('ai-drawer').classList.remove('translate-x-full');
            document.getElementById('ai-target-name').innerText = m.fullName;
            document.getElementById('chat-container').innerHTML = `<div class="ai-chat-bubble text-white text-sm">Auditing <strong>${m.fullName}</strong>.<br>Score: ${m.analysis.scoreData.totalScore.toFixed(1)}</div>`;
        }
        document.getElementById('close-ai').addEventListener('click', () => document.getElementById('ai-drawer').classList.add('translate-x-full'));
        
        document.getElementById('send-btn').addEventListener('click', async () => {
            const input = document.getElementById('chat-input');
            const q = input.value;
            if(!q) return;
            const container = document.getElementById('chat-container');
            container.innerHTML += `<div class="flex justify-end mt-2"><div class="user-chat-bubble max-w-[85%]">${q}</div></div>`;
            input.value = '';
            
            try {
                const prompt = `Act as TCF Auditor. Hinglish. Data: ${JSON.stringify(CURRENT_ANALYSIS_CONTEXT.analysis)}. User: ${q}`;
                const res = await model.generateContent(prompt);
                container.innerHTML += `<div class="mt-2 ai-chat-bubble text-white text-sm">${marked.parse(res.response.text())}</div>`;
                container.scrollTop = container.scrollHeight;
            } catch(e) { container.innerHTML += `<div class="text-red-500 text-xs mt-2">Error: ${e.message}</div>`; }
        });

        function getScoreColor(s) { return s>=80?'text-green-400':s>=50?'text-royal-gold':'text-red-400'; }
    </script>
</body>
</html>


