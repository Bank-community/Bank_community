<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bank Jarvis - The Ultimate AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" />
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <!-- Chart.js for Data Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #2E7D32, #4CAF50);
            --secondary-color: #f0f4f8;
            --user-message-bg: #DCF8C6;
            --bot-message-bg: #ffffff;
            --text-dark: #1C1C1E;
            --text-light: #6C757D;
            --border-color: #e5e7eb;
            --highlight-color: #111827; 
            --shadow-light: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
            --shadow-md: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        
        /* Animation for images fading in */
        @keyframes image-fade-in {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .image-faq-img {
            animation: image-fade-in 0.5s ease-out;
        }

        /* NEW: Image loader animation */
        @keyframes spin { to { transform: rotate(360deg); } }
        .img-loader {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .img-loader-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px; /* Ensure loader has space */
            background-color: #f9fafb;
            border-radius: 8px;
        }


        body { font-family: 'Inter', 'Segoe UI', sans-serif; background-color: var(--secondary-color); }
        .chat-container { animation: fadeIn 0.5s ease-out; }
        .message { animation: fadeIn 0.3s ease-out; }
        
        .chat-messages::-webkit-scrollbar { width: 6px; }
        .chat-messages::-webkit-scrollbar-track { background: transparent; }
        .chat-messages::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        .chat-messages::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        .suggestion-pill { transition: all 0.2s ease-in-out; }
        .suggestion-pill:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }

        #lock-mode-banner { animation: fadeIn 0.5s ease; }
        .lock-icon-pulse { animation: pulse 2s infinite ease-in-out; }

        .clickable-link { color: #2563eb; font-weight: 600; text-decoration: underline; word-break: break-all; }
        .clickable-link:hover { color: #1d4ed8; }
        .chart-container { padding: 10px; margin-top: 10px; background-color: #f9fafb; border-radius: 8px; max-width: 320px; margin-left: auto; margin-right: auto; }
        
        .capital-king-card { border-left: 4px solid; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .capital-king-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }

        .modal { display: none; } .modal.active { display: flex; }
        .modal-content { animation: fadeIn 0.3s; }

        .post-answer-suggestion {
            background-color: #eef2ff; color: #4338ca; border: 1px solid #c7d2fe;
            padding: 8px 12px; margin: 4px; border-radius: 16px; font-size: 0.9em;
            cursor: pointer; transition: all 0.2s ease;
        }
        .post-answer-suggestion:hover { background-color: #e0e7ff; border-color: #a5b4fc; }

        /* NEW: Image Modal Navigation Styles */
        #modalNav {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            transform: translateY(-50%);
            padding: 0 1rem;
            pointer-events: none; /* Let clicks pass through to the image unless on buttons */
        }
        #modalNav button {
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            font-size: 24px;
            cursor: pointer;
            transition: background-color 0.2s;
            pointer-events: all; /* Make buttons clickable */
        }
        #modalNav button:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }
        #modalNav button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="antialiased">

    <!-- UPDATED: Removed max-w-4xl and mx-auto from here -->
    <div class="chat-container flex flex-col h-screen w-full bg-white shadow-2xl md:max-w-4xl md:mx-auto">
        <header class="relative flex items-center justify-center p-4 bg-gray-800 text-white shadow-lg z-10">
            <h1 class="text-xl font-bold tracking-wider">Bank Jarvis</h1>
        </header>

        <div id="lock-mode-banner" class="hidden flex items-center justify-between p-3 bg-yellow-100 border-b-2 border-yellow-300">
            <div class="flex items-center">
                <i class="fas fa-lock text-yellow-600 text-xl mr-3 lock-icon-pulse"></i>
                <div>
                    <p class="font-bold text-yellow-800">Lock Mode Active</p>
                    <p id="locked-member-name" class="text-sm text-yellow-700"></p>
                </div>
            </div>
            <button id="unlock-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded-full text-sm">Unlock</button>
        </div>

        <!-- UPDATED: Padding is now responsive for better mobile screen usage -->
        <div id="chat" class="chat-messages flex-1 p-3 sm:p-6 overflow-y-auto bg-secondary-color"></div>

        <div class="bg-white p-4 border-t border-gray-200 shadow-inner">
            <div id="suggestions" class="mb-2 flex flex-wrap gap-2"></div>
            <div class="relative">
                <input type="text" id="input" class="w-full pl-4 pr-12 py-3 bg-gray-100 rounded-full focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Jarvis se apna sawaal likhein...">
                <button id="send-btn" class="absolute right-2 top-1/2 -translate-y-1/2 bg-green-600 hover:bg-green-700 text-white w-10 h-10 rounded-full flex items-center justify-center transition-transform duration-200 hover:scale-110">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- UPDATED: Image modal now contains navigation buttons -->
    <div id="imageModal" class="modal fixed inset-0 bg-black bg-opacity-75 z-50 items-center justify-center">
        <span class="absolute top-4 right-6 text-white text-4xl font-bold cursor-pointer" onclick="window.jarvis.closeImageModal()">&times;</span>
        <img id="modalImageContent" class="max-w-[90%] max-h-[90%] rounded-lg">
        <div id="modalNav">
            <button id="prevBtn" onclick="window.jarvis.showPrevImage()"><i class="fas fa-chevron-left"></i></button>
            <button id="nextBtn" onclick="window.jarvis.showNextImage()"><i class="fas fa-chevron-right"></i></button>
        </div>
    </div>
    
    <div id="capitalKingsModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-40">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Capital Kings Ranking</h2>
                <button onclick="window.jarvis.closeCapitalModal()" class="text-gray-500 text-2xl">&times;</button>
            </div>
            <div id="capital-kings-list" class="space-y-3 overflow-y-auto"></div>
        </div>
    </div>

    <div id="capitalDetailModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-3xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Capital Score Analysis</h2>
                <button onclick="window.jarvis.closeCapitalDetailModal()" class="text-gray-500 text-2xl">&times;</button>
            </div>
            <div id="capital-detail-content" class="overflow-y-auto"></div>
        </div>
    </div>


    <script>
        // --- Step 1: Authentication & Initialization ---
        async function checkAuthAndInitialize() {
            try {
                const response = await fetch('/api/config');
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Configuration failed to load: ${errorText}`);
                }
                const config = await response.json();
                firebase.initializeApp(config.firebase);
                firebase.auth().onAuthStateChanged(user => {
                    if (user) {
                        runJarvisLogic();
                    } else {
                        window.location.href = `/login.html?redirect=${window.location.pathname}`;
                    }
                });
            } catch (error) {
                document.getElementById('chat').innerHTML = `<div class="p-4 text-red-600 text-center">Application failed to initialize: ${error.message}</div>`;
            }
        }

        // --- Step 2: Main Application Logic ---
        function runJarvisLogic() {
            const database = firebase.database();
            const faqsRef = database.ref('admin/faqs');
            const membersRef = database.ref('members');

            let isBotInitialized = false;
            let cachedMemberIndex = null;
            let cachedFaqs = null;
            let allMembersFullData = null;
            let capitalKingsData = null; 
            let lockMode = { active: false, member: null };
            let preAnalyzedCache = null;
            let chatHistory = [];
            
            // NEW: Global state for image modal gallery
            let currentImageUrls = [];
            let currentImageIndex = 0;

            const chatBox = document.getElementById('chat');
            const inputBox = document.getElementById('input');
            const sendBtn = document.getElementById('send-btn');
            const suggestionsBox = document.getElementById('suggestions');
            const lockBanner = document.getElementById('lock-mode-banner');
            const lockedMemberNameEl = document.getElementById('locked-member-name');
            const unlockBtn = document.getElementById('unlock-btn');
            const imageModal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImageContent');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');


            async function initializeBot() {
                await typeMessage("Namaste! Main aapka smart financial assistant, Jarvis hoon.", "bot");
                const typing = appendRichMessage("...", "bot typing");
                try {
                    const [memberSnapshot, faqsSnapshot] = await Promise.all([ membersRef.once('value'), faqsRef.once('value') ]);
                    
                    cachedMemberIndex = [];
                    if (memberSnapshot.exists()) {
                        allMembersFullData = memberSnapshot.val();
                        for (const key in allMembersFullData) {
                            if (allMembersFullData[key].fullName) {
                                cachedMemberIndex.push({ id: key, name: allMembersFullData[key].fullName });
                            }
                        }
                        cachedMemberIndex.sort((a,b) => a.name.localeCompare(b.name));
                    }

                    cachedFaqs = [];
                    if (faqsSnapshot.exists()) {
                        const faqsData = faqsSnapshot.val();
                        for(const key in faqsData) { 
                            // Ensure it has questions and either an answer or imageUrls
                            if(faqsData[key].questions && (faqsData[key].answer || (faqsData[key].imageUrls && faqsData[key].imageUrls.length > 0))) { 
                                cachedFaqs.push(faqsData[key]); 
                            } 
                        }
                    } 
                    
                    // Fallback FAQs if Firebase is empty
                    if (cachedFaqs.length === 0) {
                        cachedFaqs = [
                            { 
                                type: "text",
                                questions: ["बैंक कम्युनिटी लोन क्या है?", "लोन कैसे मिलता है", "community loan kya hai", "Bank community loan kya hai", "बैंक कम्युनिटी क्या है"], 
                                // UPDATED: The answer is now exactly as requested
                                answer: "Bank Community Loan एक सामुदायिक financial संस्था है, जहाँ सभी सदस्य हर माह ₹500 Rupees SIP के रूप में जमा करते हैं। यह राशि एक community fund बनाती है, जिससे जरूरतमंद members को minimum interest rate पर, पूरी transparency और तय नियमों के अनुसार loan प्रदान किया जाता है।" 
                            },
                            { type: "text", questions: ["SIP kab jama karna hota hai?", "SIP ki date kya hai"], answer: "हर महीने 1 से 10 तारीख के बीच SIP भुगतान किया जाता है।" },
                            { type: "text", questions: ["Capital Kings कौन हैं?"], answer: "Capital Kings वे सदस्य हैं जिन्होंने सबसे लंबे समय तक सबसे अधिक पूंजी रखी है।" },
                             // NEW: Example of a multi-image FAQ for demonstration
                            {
                                type: 'image',
                                questions: ["KYC ke liye kya documents chahiye?", "documents required for kyc"],
                                imageTitle: "KYC Documents Guide",
                                imageUrls: [
                                    'https://placehold.co/600x400/2E7D32/FFFFFF?text=1.+Aadhaar+Card',
                                    'https://placehold.co/600x400/4CAF50/FFFFFF?text=2.+PAN+Card',
                                    'https://placehold.co/600x400/8BC34A/FFFFFF?text=3.+Bank+Passbook'
                                ],
                                answer: "KYC ke liye aapko in documents ki zaroorat padegi: Aadhaar Card, PAN Card, aur Bank Passbook ki photo copy."
                            }
                        ];
                    }

                    typing.remove();
                    await typeMessage("Aap kisi sadasya ka naam type kar sakte hain ya koi niyam pooch sakte hain.", "bot");
                    isBotInitialized = true;
                    showDefaultSuggestions();

                } catch (error) { console.error("Initialization failed:", error); typing.innerHTML = "त्रुटि: डेटाबेस से कनेक्ट नहीं हो सका।"; }
            }
            
            // --- Core Message Handling ---
            async function handleSend(simulatedQuery = null) {
                if (!isBotInitialized) { await typeMessage("Jarvis abhi shuru ho raha hai, kripya prateeksha karein...", "bot"); return; }
                const originalQuery = simulatedQuery || inputBox.value.trim();
                const query = originalQuery.replace(/^jarvis/i, '').trim();
                if (!query) return;

                appendRichMessage(originalQuery, "user");
                if (lockMode.active) {
                    chatHistory.push({ role: 'user', parts: [{ text: query }]});
                }
                inputBox.value = '';
                suggestionsBox.innerHTML = '';
                
                if (lockMode.active) { 
                    await processLockedQuery(query, lockMode.member); 
                } else { 
                    await processGeneralQuery(query); 
                }
            }

            async function processGeneralQuery(query) {
                const matchingMembers = findMatchingMembers(query);
                const matchingFaqs = findMatchingFaqs(query, 1);
                
                if (query.match(/capital king|capital hold|sabse zyada capital/i)) {
                    await displayCapitalKings();
                    return;
                }

                if (matchingMembers.length === 1 && !query.match(/list|sabhi|all/i)) {
                    await displayMemberDetails(matchingMembers[0].id);
                } else if (matchingMembers.length > 1) {
                    await typeMessage("Mujhe is naam se milte-julte kai sadasya mile. Aap kiske baare mein janna chahte hain?", "bot");
                    matchingMembers.forEach(m => appendMemberClarification(m));
                } else if (matchingFaqs.length > 0) {
                    const topFaq = matchingFaqs[0];
                    if (topFaq.type === 'image') {
                        await displayImageFaq(topFaq);
                    } else {
                        await typeMessage(topFaq.answer, "bot");
                    }
                    showPostAnswerSuggestions(topFaq);
                } else {
                    await typeMessage(`Maaf kijiye, main keval bank community se jude sawalon ka jawab de sakta hoon.`, "bot");
                    showDefaultSuggestions();
                }
            }

            async function processLockedQuery(query, member) {
                const typing = appendRichMessage("...", "bot typing");
                try {
                    if (!preAnalyzedCache) {
                        await typeMessage("त्रुटि: सदस्य का डेटा विश्लेषण नहीं हो पाया है। कृपया अनलॉक करके फिर से लॉक करें।", "bot");
                        return;
                    }
                    
                    const analyticalAnswer = superCalculator(query, preAnalyzedCache, member.name);

                    if (analyticalAnswer) {
                        await typeMessage(analyticalAnswer.text, "bot", analyticalAnswer.text);
                        if (analyticalAnswer.chartData) {
                            renderComparisonChart(analyticalAnswer.chartData.data, analyticalAnswer.chartData.type);
                        }
                        return;
                    }

                    const transactions = allMembersFullData[member.id].transactions ? Object.values(allMembersFullData[member.id].transactions) : [];
                    
                    const prompt = `You are Jarvis, a super-intelligent financial AI assistant for a bank community. Your current focus is solely on a member named **${member.name}**. **PRIMARY DIRECTIVE:** Your main role is to ANALYZE financial data and EXPLAIN it in simple, conversational Hinglish. You are NOT a calculator. All calculations are pre-computed. Your job is to present the information clearly. **CRITICAL RULES:** 1. **Scope:** ONLY answer questions related to the provided "MEMBER'S TRANSACTION HISTORY". If the user asks about anything else (general knowledge, small talk, etc.), you MUST respond with EXACTLY this sentence: "माफ़ कीजिए, मैं अभी लॉक मोड में हूँ और सिर्फ ${member.name} से जुड़े वित्तीय सवालों का जवाब दे सकता हूँ।" 2. **Language & Formatting:** * Respond in simple, helpful Hinglish. * ALWAYS use numerals (e.g., 1500, 2000) for numbers. NEVER write them in words (e.g., "पंद्रह सौ"). * Format dates as DD-MM-YYYY. * Use newlines (\n) to separate points in a list for better readability. 3. **Context is Key:** The "CONVERSATION HISTORY" provides the last few messages. Use it to understand follow-up questions. For example, if the user asks "why?", refer to the previous answer to understand what "why" is about. **CONVERSATION HISTORY (for context):** ${JSON.stringify(chatHistory.slice(-4))} **MEMBER'S ENTIRE TRANSACTION HISTORY (for analysis):** \`\`\`json ${JSON.stringify(transactions, null, 2)} \`\`\` **User's Current Query:** "${query}"`;
                    
                    const aiResponse = await callGemini(prompt);
                    await typeMessage(aiResponse, "bot", aiResponse);

                } finally {
                    typing.remove();
                }
            }
            
            // --- Response Rendering ---
            // UPDATED: This function now formats text better for readability.
            function formatBotAnswer(content) {
                if (!content) return '';
                // Keywords to bold
                const keywords = ['लोन', 'loan', 'ब्याज', 'interest', 'SIP', 'पेनल्टी', 'penalty', 'रिटर्न', 'return', 'बाउंस', 'bounced', 'capital', 'पूँजी'];
                const keywordRegex = new RegExp(`\\b(${keywords.join('|')})\\b`, 'gi');
                let processedContent = content.replace(keywordRegex, `<strong style="color: var(--highlight-color); font-weight: 700;">$1</strong>`);
                
                // Numbers to bold
                processedContent = processedContent.replace(/(\d{1,3}(,\d{3})*(\.\d+)?%?)/g, '<strong>$1</strong>');
                
                // NEW: Add line breaks for better readability of lists and slabs.
                // Converts newlines from AI to <br>
                processedContent = processedContent.replace(/\n/g, '<br>');
                // Specifically formats slab-like structures
                processedContent = processedContent.replace(/(\d+\s*-\s*\d+\s*दिन\s*के\s*लोन\s*पर)/g, '<br><br>$1');
                processedContent = processedContent.replace(/(\d+\+\s*दिन\s*के\s*लोन\s*पर)/g, '<br><br>$1');


                return processedContent;
            }

            function processLinks(content) {
                if (!content) return '';
                const urlRegex = /(https?:\/\/[^\s"'<>`]+)/g;
                return content.replace(urlRegex, (url) => `<a href="${url}" target="_blank" class="clickable-link">${url}</a>`);
            }

            function appendRichMessage(content, type) {
                const messageEl = document.createElement('div');
                messageEl.className = `message max-w-lg mb-4 clear-both ${type === 'user' ? 'ml-auto' : 'mr-auto'}`;
                const bubbleEl = document.createElement('div');
                bubbleEl.className = `p-4 rounded-2xl shadow-md ${type === 'user' ? 'bg-user-message-bg text-gray-800 rounded-br-none' : 'bg-bot-message-bg rounded-bl-none'}`;
                
                if (type === 'bot typing') {
                    bubbleEl.innerHTML = `<div class="flex items-center space-x-2"><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.2s;"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.4s;"></div></div>`;
                } else {
                    bubbleEl.innerHTML = content;
                }
                messageEl.appendChild(bubbleEl);
                chatBox.appendChild(messageEl);
                chatBox.scrollTop = chatBox.scrollHeight;
                return bubbleEl;
            }

            function typeMessage(text, type, rawTextForHistory = null) {
                return new Promise(resolve => {
                    if (type === 'bot' && rawTextForHistory) {
                        chatHistory.push({ role: 'model', parts: [{ text: rawTextForHistory }] });
                    }
                    const finalHtml = processLinks(formatBotAnswer(text));
                    
                    const messageEl = document.createElement('div');
                    messageEl.className = `message max-w-lg mb-4 clear-both ${type === 'user' ? 'ml-auto' : 'mr-auto'}`;
                    const bubbleEl = document.createElement('div');
                    bubbleEl.className = `p-4 rounded-2xl shadow-md ${type === 'user' ? 'bg-user-message-bg text-gray-800 rounded-br-none' : 'bg-bot-message-bg rounded-bl-none'}`;
                    messageEl.appendChild(bubbleEl);
                    chatBox.appendChild(messageEl);
                    
                    let i = 0;
                    bubbleEl.innerHTML = "▋";
                    const interval = setInterval(() => {
                        if (i < text.length) {
                            bubbleEl.innerHTML = processLinks(formatBotAnswer(text.substring(0, i + 1))) + "▋";
                            chatBox.scrollTop = chatBox.scrollHeight;
                            i++;
                        } else {
                            clearInterval(interval);
                            bubbleEl.innerHTML = finalHtml;
                            chatBox.scrollTop = chatBox.scrollHeight;
                            resolve(bubbleEl);
                        }
                    }, 25);
                });
            }

            function appendMemberClarification(member) {
                const html = `<p class="font-semibold">${member.name}</p>
                    <div class="flex items-center space-x-2 mt-2">
                        <button onclick="window.jarvis.displayMemberDetails('${member.id}')" class="bg-blue-500 hover:bg-blue-600 text-white w-8 h-8 rounded-full transition-transform hover:scale-110" title="View Details"><i class="fas fa-eye"></i></button>
                        <button onclick="window.jarvis.activateLockMode({id: '${member.id}', name: '${member.name}'})" class="bg-gray-500 hover:bg-gray-600 text-white w-8 h-8 rounded-full transition-transform hover:scale-110" title="Activate Lock Mode"><i class="fas fa-lock"></i></button>
                    </div>`;
                const messageEl = document.createElement('div');
                messageEl.className = 'message bg-white p-3 rounded-lg shadow-md flex items-center justify-between';
                messageEl.innerHTML = html;
                chatBox.appendChild(messageEl);
                chatBox.scrollTop = chatBox.scrollHeight;
            }

            async function displayMemberDetails(memberId) {
                const typing = appendRichMessage("...", "bot typing");
                const memberData = allMembersFullData[memberId];
                await new Promise(resolve => setTimeout(resolve, 500));
                typing.remove();
                if (!memberData) { await typeMessage("त्रुटि: सदस्य का डेटा नहीं मिला।", "bot"); return; }
                const data = aggregateMemberData(memberData);
                const profileImageUrl = data.profilePicUrl || `https://placehold.co/100x100/E2E8F0/4A5568?text=${data.name.charAt(0)}`;
                const signatureImageUrl = data.signatureUrl || `https://placehold.co/150x75/E2E8F0/4A5568?text=No+Sign`;
                const cardHtml = `<div class="p-1"><div class="flex items-center justify-between pb-4 border-b"><div class="flex items-center"><img src="${profileImageUrl}" class="w-16 h-16 rounded-full mr-4 border-2 border-green-500 cursor-pointer" onclick="window.jarvis.openImageModal(['${profileImageUrl}'], 0)"><div><h3 class="text-xl font-bold text-gray-800">${data.name}</h3><p class="text-sm text-gray-500">Joined: ${data.joinDate}</p></div></div><button onclick="window.jarvis.activateLockMode({id: '${memberId}', name: '${data.name}'})" class="text-gray-400 hover:text-green-600 transition-transform hover:scale-125" title="Lock on this member"><i class="fas fa-lock text-2xl"></i></button></div><div class="grid grid-cols-2 gap-4 text-center py-4"><div class="bg-green-50 p-3 rounded-lg"><p class="text-sm text-green-700">Net Balance</p><p class="font-bold text-lg text-green-900">₹${data.netBalance.toLocaleString('en-IN')}</p></div><div class="bg-red-50 p-3 rounded-lg"><p class="text-sm text-red-700">Outstanding Loan</p><p class="font-bold text-lg text-red-900">₹${data.netLoanOutstanding.toLocaleString('en-IN')}</p></div></div><div class="flex items-center justify-between pt-4 border-t"><div><p class="text-sm text-gray-500">SIP Status (This Month)</p><p class="font-bold text-lg ${data.sipStatus.class}">${data.sipStatus.text}</p></div><img src="${signatureImageUrl}" class="h-10 rounded border cursor-pointer" onclick="window.jarvis.openImageModal(['${signatureImageUrl}'], 0)" alt="Signature"></div></div>`;
                appendRichMessage(cardHtml, "bot");
            }
            
            // UPDATED: Complete rewrite of this function for animations and multi-image support
            async function displayImageFaq(faq) {
                const cardContainer = document.createElement('div');
                cardContainer.className = 'p-1';

                const title = document.createElement('p');
                title.className = 'font-bold text-lg text-gray-800 mb-2';
                title.textContent = faq.imageTitle;
                cardContainer.appendChild(title);

                // Image container with loader
                const imageContainer = document.createElement('div');
                imageContainer.className = 'relative w-full max-w-xs mx-auto rounded-lg border-2 border-gray-200 shadow-md cursor-pointer';
                imageContainer.onclick = () => window.jarvis.openImageModal(faq.imageUrls, 0);
                
                const loaderContainer = document.createElement('div');
                loaderContainer.className = 'img-loader-container';
                const loader = document.createElement('div');
                loader.className = 'img-loader';
                loaderContainer.appendChild(loader);
                
                const image = document.createElement('img');
                image.src = faq.imageUrls[0];
                image.alt = faq.imageTitle;
                image.className = 'w-full rounded-lg hidden'; // Start hidden
                
                imageContainer.appendChild(loaderContainer);
                imageContainer.appendChild(image);
                cardContainer.appendChild(imageContainer);

                // Answer text container
                const answerP = document.createElement('p');
                answerP.className = 'text-gray-700 mt-3';
                cardContainer.appendChild(answerP);

                // Append the whole card structure to the chat
                appendRichMessage(cardContainer.outerHTML, 'bot');
                // We need to get a reference to the elements we just added to the DOM
                const lastMessageBubble = chatBox.querySelectorAll('.message .p-4')[chatBox.querySelectorAll('.message .p-4').length - 1];
                const liveImage = lastMessageBubble.querySelector('img');
                const liveLoader = lastMessageBubble.querySelector('.img-loader-container');
                const liveAnswerP = lastMessageBubble.querySelector('.text-gray-700');

                // Start typing animation for the answer
                let i = 0;
                const textToType = faq.answer || '';
                liveAnswerP.innerHTML = "▋";
                const typingInterval = setInterval(() => {
                    if (i < textToType.length) {
                        liveAnswerP.innerHTML = processLinks(textToType.substring(0, i + 1)) + "▋";
                        chatBox.scrollTop = chatBox.scrollHeight;
                        i++;
                    } else {
                        clearInterval(typingInterval);
                        liveAnswerP.innerHTML = processLinks(textToType);
                        chatBox.scrollTop = chatBox.scrollHeight;
                    }
                }, 25);

                // Show image once it's loaded
                liveImage.onload = () => {
                    liveLoader.style.display = 'none';
                    liveImage.style.display = 'block';
                    liveImage.classList.add('image-faq-img');
                };
                liveImage.onerror = () => { // Handle image load error
                    liveLoader.innerHTML = 'Image not found';
                };
            }

            function renderComparisonChart(data, type) {
                const chartId = `chart-${Date.now()}`;
                const chartContainer = document.createElement('div');
                chartContainer.className = 'chart-container';
                chartContainer.innerHTML = `<canvas id="${chartId}"></canvas>`;
                
                if (type === 'totalReturn') {
                    const notification = document.createElement('p');
                    notification.className = 'text-center text-xs text-gray-500 mt-2';
                    notification.innerHTML = '<b>Note:</b> Return amount ka 10% Bank wallet mein chala jaata hai.';
                    chartContainer.appendChild(notification);
                }
                
                appendRichMessage(chartContainer.outerHTML, 'bot');
                
                const titles = { totalSip: 'Total SIP Comparison', totalLoan: 'Total Loan Comparison', totalReturn: 'Total Return Comparison' };
                const colors = { totalSip: ['#36A2EB', '#4BC0C0', '#E5E7EB'], totalLoan: ['#FF6384', '#FF9F40', '#E5E7EB'], totalReturn: ['#9966FF', '#FFCD56', '#E5E7EB'] };
                
                const { totalValue, currentUser, topUser } = data;
                const chartLabels = [];
                const chartDataPoints = [];

                chartLabels.push(currentUser.name);
                chartDataPoints.push(currentUser.value);

                if (topUser && topUser.name !== currentUser.name) {
                    chartLabels.push(topUser.name);
                    chartDataPoints.push(topUser.value);
                }
                
                const othersValue = Math.max(0, totalValue - chartDataPoints.reduce((a,b) => a+b, 0));
                if (othersValue > 0.01) {
                    chartLabels.push('Other Members');
                    chartDataPoints.push(othersValue);
                }

                const chartConfig = {
                    type: 'doughnut',
                    data: { labels: chartLabels, datasets: [{ data: chartDataPoints, backgroundColor: colors[type], borderWidth: 1 }] },
                    options: { responsive: true, plugins: { legend: { position: 'top' }, title: { display: true, text: titles[type] }, tooltip: { callbacks: { label: function(context) { const label = context.label || ''; const value = context.raw; const total = context.chart.getDatasetMeta(0).total; const percentage = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%'; return `${label}: ₹${value.toLocaleString('en-IN')} (${percentage})`; } } } }, cutout: '60%' }
                };
                
                setTimeout(() => {
                    const ctx = document.getElementById(chartId)?.getContext('2d');
                    if (ctx) new Chart(ctx, chartConfig);
                }, 100);
            }

            async function displayCapitalKings(showAll = false) {
                if (!capitalKingsData) {
                    capitalKingsData = calculateCapitalScores().sort((a, b) => b.score - a.score);
                }
                
                const itemsToShow = showAll ? capitalKingsData : capitalKingsData.slice(0, 3);
                
                if (!showAll) {
                    await typeMessage("Pesh hain hamare Capital Kings - wo sadasya jinhone sabse lambe samay tak sabse zyada poonji (capital) hold ki hai:", "bot");
                }

                const rankIcons = ['🥇', '🥈', '🥉'];
                const rankColors = ['border-yellow-400', 'border-gray-400', 'border-orange-400'];
                
                const listContainer = showAll ? document.getElementById('capital-kings-list') : null;
                if(listContainer) listContainer.innerHTML = '';

                itemsToShow.forEach((member, index) => {
                    const cardHtml = `<div class="capital-king-card bg-white p-4 rounded-lg shadow-md mt-2 ${rankColors[index] || 'border-gray-200'}" onclick="window.jarvis.openCapitalDetailModal(${index})">
                        <div class="flex items-center">
                            <span class="text-3xl mr-4">${rankIcons[index] || `#${index + 1}`}</span>
                            <div>
                                <h3 class="font-bold text-lg">${member.name}</h3>
                                <div class="text-sm text-gray-600 mt-1">
                                    <p><strong>Capital:</strong> ₹${member.capital.toLocaleString('en-IN')}</p>
                                    <p><strong>Holding:</strong> ${member.holdingDays} days</p>
                                    <p><strong>Score:</strong> ${member.score.toFixed(0)}</p>
                                </div>
                            </div>
                        </div>
                    </div>`;
                    if(showAll) {
                        listContainer.innerHTML += cardHtml;
                    } else {
                        appendRichMessage(cardHtml, 'bot');
                    }
                });
                
                if (!showAll && capitalKingsData.length > 3) {
                    const viewMoreBtn = `<button onclick="window.jarvis.displayCapitalKings(true)" class="mt-2 w-full text-center text-blue-600 font-semibold p-2">View Full Ranking</button>`;
                    appendRichMessage(viewMoreBtn, 'bot');
                }
            }

            // --- Utility & Helper Functions ---
            function convertWordsToNumbers(text) { const numberWords = { 'ek': '1', 'one': '1', 'do': '2', 'two': '2', 'teen': '3', 'three': '3', 'char': '4', 'four': '4', 'panch': '5', 'five': '5', 'chhah': '6', 'chhe': '6', 'six': '6', 'saat': '7', 'seven': '7', 'aath': '8', 'eight': '8', 'nau': '9', 'nine': '9', 'das': '10', 'ten': '10' }; let processedText = text; for (const word in numberWords) { const regex = new RegExp(`\\b${word}\\b`, 'gi'); processedText = processedText.replace(regex, numberWords[word]); } return processedText; }
            function superCalculator(query, cache, memberName) { const lowerQuery = convertWordsToNumbers(query.toLowerCase()); const s = cache.summary; const tx = cache.transactions; let text = null; let chartData = null; const formatDate = (dateStr) => { const d = new Date(dateStr); const day = String(d.getDate()).padStart(2, '0'); const month = String(d.getMonth() + 1).padStart(2, '0'); const year = d.getFullYear(); return `${day}-${month}-${year}`; }; const rangeMatch = lowerQuery.match(/(first|pehla|last|aakhiri)\s*(\d+)\s*(sip|loan|return|payment|transaction|len den)/); if (rangeMatch) { const direction = rangeMatch[1]; const count = parseInt(rangeMatch[2], 10); const type = rangeMatch[3]; let relevantTxs = []; let field = ''; let typeName = ''; if (type === 'sip') { relevantTxs = tx.filter(t => (parseFloat(t['SIP Payment']) || 0) > 0); field = 'SIP Payment'; typeName = 'SIP bhugtaan'; } else if (type === 'loan') { relevantTxs = tx.filter(t => (parseFloat(t.Loan) || 0) > 0); field = 'Loan'; typeName = 'Loan'; } else if (type === 'return') { relevantTxs = tx.filter(t => (parseFloat(t['Return amount']) || 0) > 0); field = 'Return amount'; typeName = 'Return'; } else if (type === 'payment') { relevantTxs = tx.filter(t => (parseFloat(t['Loan Payment']) || 0) > 0); field = 'Loan Payment'; typeName = 'Loan bhugtaan'; } else if (type.includes('transaction') || type.includes('len den')) { relevantTxs = tx; typeName = 'transaction'; } if (relevantTxs.length > 0) { const sortedTxs = [...relevantTxs].sort((a, b) => new Date(a.Date) - new Date(b.Date)); const selectedTxs = direction.startsWith('first') || direction.startsWith('pehla') ? sortedTxs.slice(0, count) : sortedTxs.slice(-count).reverse(); if (selectedTxs.length > 0) { if(typeName === 'transaction'){ let responseLines = selectedTxs.map((t, i) => { const sip = parseFloat(t['SIP Payment']) || 0; const loanPay = parseFloat(t['Loan Payment']) || 0; const loan = parseFloat(t.Loan) || 0; const ret = parseFloat(t['Return amount']) || 0; let desc = sip > 0 ? `SIP: ₹${sip}` : loanPay > 0 ? `Loan Payment: ₹${loanPay}` : ret > 0 ? `Return: ₹${ret}` : loan > 0 ? `Loan: ₹${loan}` : 'Other'; return `${i+1}. ${formatDate(t.Date)} - ${desc}`; }); text = `Aapke ${direction === 'first' || direction === 'pehla' ? 'pehle' : 'aakhiri'} ${selectedTxs.length} transactions is prakaar hain:\n${responseLines.join('\n')}`; } else { const total = selectedTxs.reduce((sum, t) => sum + (parseFloat(t[field]) || 0), 0); let responseLines = selectedTxs.map((t, i) => `${i+1}. ${formatDate(t.Date)}: ₹${(parseFloat(t[field]) || 0).toLocaleString('en-IN')}`); text = `Aapke ${direction === 'first' || direction === 'pehla' ? 'pehle' : 'aakhiri'} ${selectedTxs.length} ${typeName} ka kul yog ₹${total.toLocaleString('en-IN')} hai. Vivaran is prakaar hai:\n${responseLines.join('\n')}`; } return { text, chartData: null }; } } text = `Aapke koi ${typeName} nahi mile.`; return { text, chartData: null }; } if (lowerQuery.includes('total sip') || lowerQuery.includes('kul sip')) { text = `${memberName} ji, aapke kul SIP ka yog ₹${s.totalSIP.toLocaleString('en-IN')} hai.`; const topData = findTopContributors(); chartData = { type: 'totalSip', data: { totalValue: calculateAllTimeTotals().sip, currentUser: { name: memberName, value: s.totalSIP }, topUser: topData.totalSipUser } }; } else if (lowerQuery.includes('total loan') || lowerQuery.includes('kul loan')) { text = `${memberName} ji, aapne ab tak kul ₹${s.totalLoan.toLocaleString('en-IN')} ka loan liya hai.`; if (s.netLoanOutstanding > 0) { text += ` Jismein se abhi ₹${s.netLoanOutstanding.toLocaleString('en-IN')} bakaaya hai.`; } const topData = findTopContributors(); chartData = { type: 'totalLoan', data: { totalValue: calculateAllTimeTotals().loan, currentUser: { name: memberName, value: s.totalLoan }, topUser: topData.totalLoanUser } }; } else if (lowerQuery.includes('total return') || lowerQuery.includes('kul return')) { text = `${memberName} ji, aapko ab tak kul ₹${s.totalReturn.toLocaleString('en-IN')} ka return mila hai.`; const topData = findTopContributors(); chartData = { type: 'totalReturn', data: { totalValue: calculateAllTimeTotals().return, currentUser: { name: memberName, value: s.totalReturn }, topUser: topData.totalReturnUser } }; } else if (lowerQuery.includes('outstanding') || lowerQuery.includes('bakaya')) { text = s.netLoanOutstanding > 0 ? `${memberName} ji, aapka kul bakaaya loan ₹${s.netLoanOutstanding.toLocaleString('en-IN')} hai.` : `${memberName} ji, aapka koi loan bakaaya nahi hai. Shandaar!`; } else if (lowerQuery.includes('net balance') || lowerQuery.includes('kul balance')) { text = `${memberName} ji, aapka net balance (kul jama - kul nikaasi) ₹${s.netBalance.toLocaleString('en-IN')} hai.`; } else if (lowerQuery.includes('total deposit') || lowerQuery.includes('kul jama')) { text = `${memberName} ji, aapki kul jama raashi (SIP + Loan Payment + Return) ₹${s.totalDeposits.toLocaleString('en-IN')} hai.`; } else if (lowerQuery.includes('total withdrawal') || lowerQuery.includes('kul nikasi')) { text = `${memberName} ji, aapki kul nikaasi (Loan + Penalty) ₹${s.totalWithdrawals.toLocaleString('en-IN')} hai.`; } else if (lowerQuery.match(/loan.*?sip.*?antar|difference/)) { const diff = Math.abs(s.totalSIP - s.totalLoan); text = `Aapke kul SIP (₹${s.totalSIP.toLocaleString('en-IN')}) aur kul Loan (₹${s.totalLoan.toLocaleString('en-IN')}) ke beech ka antar ₹${diff.toLocaleString('en-IN')} hai.`; } else if (lowerQuery.match(/jama.*?nikasi.*?antar|difference/)) { const diff = Math.abs(s.totalDeposits - s.totalWithdrawals); text = `Aapki kul jama (₹${s.totalDeposits.toLocaleString('en-IN')}) aur kul nikaasi (₹${s.totalWithdrawals.toLocaleString('en-IN')}) ke beech ka antar ₹${diff.toLocaleString('en-IN')} hai.`; } else if (lowerQuery.includes('sabse jyada sip') || lowerQuery.includes('highest sip')) { const data = cache.highestSip; text = data ? `Aapka sabse zyada SIP payment ₹${data.amount.toLocaleString('en-IN')} ka tha, jo aapne ${data.date} ko kiya tha.` : "Aapke SIP payment ka koi record nahi mila."; } else if (lowerQuery.includes('pehla sip') || lowerQuery.includes('first sip')) { const data = cache.firstSip; text = data ? `Aapka pehla SIP payment ₹${data.amount.toLocaleString('en-IN')} ka tha, jo aapne ${data.date} ko kiya tha.` : "Aapke SIP payment ka koi record nahi mila."; } else if (lowerQuery.includes('recent loan payment') || lowerQuery.includes('aakhiri loan payment')) { const data = cache.recentLoanPayment; text = data ? `Aapka haal hi ka loan payment ₹${data.amount.toLocaleString('en-IN')} ka tha, jo aapne ${data.date} ko kiya tha.` : "Aapke loan payment ka koi record nahi mila."; } else if (lowerQuery.includes('pehla loan') || lowerQuery.includes('first loan')) { const data = cache.firstLoan; text = data ? `Aapne apna pehla loan (${data.daysAgo} din pehle) ${data.date} ko ₹${data.amount.toLocaleString('en-IN')} ka liya tha.` : "Aapke loan lene ka koi record nahi mila."; } if (text) { return { text, chartData }; } return null; }
            function createSuggestionPill(text, type) { const pill = document.createElement('button'); pill.className = 'suggestion-pill px-3 py-1 rounded-full text-sm'; if (type === 'member') { pill.classList.add('bg-gray-200', 'text-gray-700'); pill.innerHTML = `<i class="fas fa-user mr-2"></i>${text}`; } else { pill.classList.add('bg-blue-100', 'text-blue-700'); pill.innerHTML = `<i class="fas fa-question-circle mr-2"></i>${text}`; } pill.onclick = () => { inputBox.value = text; handleSend(); }; return pill; }
            function showDefaultSuggestions() { suggestionsBox.innerHTML = ''; const suggestions = ['बैंक कम्युनिटी लोन क्या है?', 'SIP kab jama karna hota hai?', 'Capital Kings कौन हैं?', 'KYC ke liye kya documents chahiye?']; suggestions.forEach(text => { const pill = createSuggestionPill(text, 'faq'); suggestionsBox.appendChild(pill); }); }
            function showSuggestions(query) { suggestionsBox.innerHTML = ''; if (!query || query.length < 2 || lockMode.active) { if (!lockMode.active) showDefaultSuggestions(); return; } const memberSuggestions = findMatchingMembers(query).slice(0, 2); const faqSuggestions = findMatchingFaqs(query, 2); const allSuggestions = [...memberSuggestions, ...faqSuggestions]; if (allSuggestions.length === 0) { showDefaultSuggestions(); return; } allSuggestions.forEach(s => { const text = s.id ? s.name : s.questions[0]; const type = s.id ? 'member' : 'faq'; const pill = createSuggestionPill(text, type); suggestionsBox.appendChild(pill); }); }
            function showPostAnswerSuggestions(answeredFaq) { let relatedFaqs = cachedFaqs.filter(f => f.answer !== answeredFaq.answer).slice(0, 3); if (relatedFaqs.length === 0) return; const container = document.createElement('div'); container.className = 'p-2'; container.innerHTML = '<p class="text-sm font-semibold text-gray-600 mb-2">Anya Sawaal:</p>'; const buttonContainer = document.createElement('div'); buttonContainer.className = 'flex flex-wrap justify-start'; relatedFaqs.forEach(faq => { const btn = document.createElement('button'); btn.className = 'post-answer-suggestion'; btn.textContent = faq.questions[0]; btn.onclick = () => handleSend(faq.questions[0]); buttonContainer.appendChild(btn); }); container.appendChild(buttonContainer); appendRichMessage(container.outerHTML, 'bot'); }
            function getWordMatchScore(query, text) { const queryWords = new Set(query.toLowerCase().split(/\s+/).filter(w => w.length > 2)); const textWords = new Set(text.toLowerCase().split(/\s+/)); let score = 0; for (const word of queryWords) { if (textWords.has(word)) score++; } return score; }
            function findMatchingMembers(query) { if (!cachedMemberIndex) return []; const lowerQuery = String(query).toLowerCase().trim(); if (lowerQuery.length < 1) return []; return cachedMemberIndex.filter(m => m.name && m.name.toLowerCase().includes(lowerQuery)); }
            function findMatchingFaqs(query, limit) { if (!cachedFaqs) return []; const lowerQuery = String(query).toLowerCase().trim(); if (lowerQuery.length < 2) return []; return cachedFaqs.map(faq => { let searchText = ''; if (faq.type === 'image') { searchText = `${faq.imageTitle || ''} ${faq.questions.join(' ')} ${faq.answer || ''}`; } else { searchText = `${faq.answer || ''} ${faq.questions.join(' ')} ${faq.category || ''}`; } return { ...faq, score: getWordMatchScore(lowerQuery, searchText.toLowerCase()) }; }).filter(faq => faq.score > 0).sort((a, b) => b.score - a.score).slice(0, limit); }
            function aggregateMemberData(data) { const transactions = data.transactions ? Object.values(data.transactions) : []; let totalSIP = 0, totalLoan = 0, totalLoanPayment = 0, totalPenalty = 0, totalReturn = 0, totalExtraWithdraw = 0, totalExtraBalance = 0; transactions.forEach(tx => { totalSIP += parseFloat(tx['SIP Payment']) || 0; totalLoan += parseFloat(tx.Loan) || 0; totalLoanPayment += parseFloat(tx['Loan Payment']) || 0; totalPenalty += parseFloat(tx['Penalty amount']) || 0; totalReturn += parseFloat(tx['Return amount']) || 0; totalExtraWithdraw += parseFloat(tx['Extra Withdraw']) || 0; totalExtraBalance += parseFloat(tx['Extra Balance']) || 0; }); const totalDeposits = totalSIP + totalLoanPayment + totalReturn + totalExtraBalance; const totalWithdrawals = totalLoan + totalPenalty + totalExtraWithdraw; const sipStatus = getSipStatus(transactions, new Date()); return { name: data.fullName, profilePicUrl: data.profilePicUrl, signatureUrl: data.signatureUrl, joinDate: new Date(data.joiningDate).toLocaleDateString('en-GB'), totalSIP, totalLoan, totalLoanPayment, totalPenalty, totalReturn, totalDeposits, totalWithdrawals, netBalance: totalDeposits - totalWithdrawals, netLoanOutstanding: Math.max(0, totalLoan - totalLoanPayment), sipStatus }; }
            function getSipStatus(transactions, date) { const currentMonth = date.getMonth(); const currentYear = date.getFullYear(); const currentMonthSipTx = transactions.find(tx => { if (!tx.Date) return false; const txDate = new Date(tx.Date); return (parseFloat(tx['SIP Payment']) || 0) > 0 && txDate.getMonth() === currentMonth && txDate.getFullYear() === currentYear; }); if (currentMonthSipTx) return { text: 'Paid', class: 'text-green-600', amount: parseFloat(currentMonthSipTx['SIP Payment']) }; if (date.getDate() > 10) return { text: 'Pending', class: 'text-red-600', amount: 0 }; return { text: 'Due', class: 'text-yellow-600', amount: 0 }; }
            function findTopContributors() { let totalSipUser = { name: 'N/A', value: 0 }, totalLoanUser = { name: 'N/A', value: 0 }, totalReturnUser = { name: 'N/A', value: 0 }; if (!allMembersFullData) return { totalSipUser, totalLoanUser, totalReturnUser }; for (const memberId in allMembersFullData) { const member = allMembersFullData[memberId]; if(!member.fullName) continue; const summary = aggregateMemberData(member); if (summary.totalSIP > totalSipUser.value) totalSipUser = { name: member.fullName, value: summary.totalSIP }; if (summary.totalLoan > totalLoanUser.value) totalLoanUser = { name: member.fullName, value: summary.totalLoan }; if (summary.totalReturn > totalReturnUser.value) totalReturnUser = { name: member.fullName, value: summary.totalReturn }; } return { totalSipUser, totalLoanUser, totalReturnUser }; }
            function calculateAllTimeTotals() { let totalSIP = 0, totalLoan = 0, totalReturn = 0; if (!allMembersFullData) return { sip: 0, loan: 0, return: 0 }; for (const memberId in allMembersFullData) { const summary = aggregateMemberData(allMembersFullData[memberId]); totalSIP += summary.totalSIP; totalLoan += summary.totalLoan; totalReturn += summary.totalReturn; } return { sip: totalSIP, loan: totalLoan, return: totalReturn }; }
            function calculateCapitalScores() { const results = []; const today = new Date(); if (!allMembersFullData) return []; for (const memberId in allMembersFullData) { const member = allMembersFullData[memberId]; if (!member.transactions || !member.joiningDate || !member.fullName) continue; const finalCapital = aggregateMemberData(member).netBalance; if (finalCapital <= 0) continue; const transactions = Object.values(member.transactions).sort((a, b) => new Date(a.Date) - new Date(b.Date)); let capitalDays = 0; let currentCapital = 0; let lastDate = new Date(member.joiningDate); transactions.forEach(tx => { const txDate = new Date(tx.Date); const daysDifference = (txDate - lastDate) / (1000 * 3600 * 24); if (daysDifference > 0) { capitalDays += currentCapital * daysDifference; } const sip = parseFloat(tx['SIP Payment']) || 0; const payment = parseFloat(tx['Loan Payment']) || 0; const loan = parseFloat(tx.Loan) || 0; const ret = parseFloat(tx['Return amount']) || 0; currentCapital += sip + payment + ret - loan; lastDate = txDate; }); const daysSinceLastTx = (today - lastDate) / (1000 * 3600 * 24); capitalDays += currentCapital * daysSinceLastTx; const holdingDays = Math.floor((today - new Date(member.joiningDate)) / (1000 * 3600 * 24)); if (holdingDays > 0) { results.push({ id: memberId, name: member.fullName, capital: finalCapital, holdingDays, score: capitalDays }); } } return results; }
            function preAnalyzeMemberData(memberId) { const memberData = allMembersFullData[memberId]; if (!memberData) return null; const transactions = memberData.transactions ? Object.values(memberData.transactions).filter(tx => tx.Date) : []; if (transactions.length === 0) { return { summary: aggregateMemberData(memberData), transactions: [] }; } const today = new Date(); const formatDate = (dateStr) => { const d = new Date(dateStr); const day = String(d.getDate()).padStart(2, '0'); const month = String(d.getMonth() + 1).padStart(2, '0'); const year = d.getFullYear(); return `${day}-${month}-${year}`; }; const daysBetween = (date1, date2) => Math.round(Math.abs((date1 - date2) / (1000 * 60 * 60 * 24))); const sortedTransactions = [...transactions].sort((a, b) => new Date(a.Date) - new Date(b.Date)); const sipPayments = sortedTransactions.filter(t => (parseFloat(t['SIP Payment']) || 0) > 0); const loanPayments = sortedTransactions.filter(t => (parseFloat(t['Loan Payment']) || 0) > 0); const loansTaken = sortedTransactions.filter(t => (parseFloat(t.Loan) || 0) > 0); let highestSip = null; if (sipPayments.length > 0) { const topSip = sipPayments.reduce((max, t) => (parseFloat(t['SIP Payment']) > parseFloat(max['SIP Payment'])) ? t : max, sipPayments[0]); highestSip = { amount: parseFloat(topSip['SIP Payment']), date: formatDate(topSip.Date) }; } let firstSip = null; if (sipPayments.length > 0) { firstSip = { amount: parseFloat(sipPayments[0]['SIP Payment']), date: formatDate(sipPayments[0].Date) }; } let recentLoanPayment = null; if (loanPayments.length > 0) { const lastLoanPayment = loanPayments[loanPayments.length - 1]; recentLoanPayment = { amount: parseFloat(lastLoanPayment['Loan Payment']), date: formatDate(lastLoanPayment.Date) }; } let firstLoan = null; if (loansTaken.length > 0) { const firstLoanTx = loansTaken[0]; firstLoan = { amount: parseFloat(firstLoanTx.Loan), date: formatDate(firstLoanTx.Date), daysAgo: daysBetween(today, new Date(firstLoanTx.Date)) }; } return { summary: aggregateMemberData(memberData), transactions: sortedTransactions, highestSip, firstSip, recentLoanPayment, firstLoan }; }
            
            // NEW: Function to update modal navigation buttons visibility
            function updateModalNav() {
                prevBtn.disabled = currentImageIndex === 0;
                nextBtn.disabled = currentImageIndex === currentImageUrls.length - 1;
            }

            window.jarvis = { 
                activateLockMode: (member) => { lockMode = { active: true, member }; preAnalyzedCache = preAnalyzeMemberData(member.id); chatHistory = []; lockedMemberNameEl.textContent = `Focused on ${member.name}`; lockBanner.classList.remove('hidden'); appendRichMessage(`🔒 Lock Mode activated for **${member.name}**. Ab aap inke data se jude koi bhi sawaal pooch sakte hain.`, "bot"); suggestionsBox.innerHTML = ''; }, 
                deactivateLockMode: () => { appendRichMessage(`🔓 Lock Mode deactivated.`, "bot"); lockMode = { active: false, member: null }; preAnalyzedCache = null; chatHistory = []; lockBanner.classList.add('hidden'); showDefaultSuggestions(); }, 
                
                // UPDATED: Image modal functions for gallery
                openImageModal: (urls, startIndex = 0) => { 
                    if (!urls || urls.length === 0 || urls[0].includes('placehold.co')) return;
                    currentImageUrls = urls;
                    currentImageIndex = startIndex;
                    modalImage.src = currentImageUrls[currentImageIndex];
                    imageModal.classList.add('active'); 
                    updateModalNav();
                }, 
                closeImageModal: () => { 
                    imageModal.classList.remove('active'); 
                    currentImageUrls = []; // Clear the array
                },
                showNextImage: () => {
                    if (currentImageIndex < currentImageUrls.length - 1) {
                        currentImageIndex++;
                        modalImage.src = currentImageUrls[currentImageIndex];
                        updateModalNav();
                    }
                },
                showPrevImage: () => {
                     if (currentImageIndex > 0) {
                        currentImageIndex--;
                        modalImage.src = currentImageUrls[currentImageIndex];
                        updateModalNav();
                    }
                },

                displayMemberDetails: displayMemberDetails, 
                displayCapitalKings: (showAll) => { const modal = document.getElementById('capitalKingsModal'); if (showAll) { modal.classList.add('active'); displayCapitalKings(true); } else { displayCapitalKings(false); } }, 
                closeCapitalModal: () => document.getElementById('capitalKingsModal').classList.remove('active'), 
                openCapitalDetailModal: (index) => { if (!capitalKingsData) return; const member = capitalKingsData[index]; const prevMember = index > 0 ? capitalKingsData[index - 1] : null; const nextMember = index < capitalKingsData.length - 1 ? capitalKingsData[index + 1] : null; const contentEl = document.getElementById('capital-detail-content'); contentEl.innerHTML = ''; let html = `<div class="text-center mb-6"><h3 class="text-3xl font-bold">${member.name}</h3><p class="text-xl text-gray-600">Rank #${index + 1}</p><p class="text-4xl font-extrabold text-green-600 mt-2">${member.score.toFixed(0)} <span class="text-lg font-medium text-gray-500">Score</span></p><div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 text-left"><div class="bg-gray-100 p-4 rounded-lg"><strong>Current Capital:</strong> ₹${member.capital.toLocaleString('en-IN')}</div><div class="bg-gray-100 p-4 rounded-lg"><strong>Holding Period:</strong> ${member.holdingDays} days</div></div><p class="text-sm text-gray-500 mt-4 italic">Score is calculated based on the amount of capital held over time. Higher capital for a longer duration results in a higher score.</p></div><div class="my-6"><canvas id="capitalCompareChart"></canvas></div>`; contentEl.innerHTML = html; const chartLabels = []; const chartData = []; const chartColors = []; if (prevMember) { chartLabels.push(`#${index} ${prevMember.name}`); chartData.push(prevMember.score); chartColors.push('rgba(255, 99, 132, 0.7)'); } chartLabels.push(`#${index + 1} ${member.name}`); chartData.push(member.score); chartColors.push('rgba(75, 192, 192, 0.7)'); if (nextMember) { chartLabels.push(`#${index + 2} ${nextMember.name}`); chartData.push(nextMember.score); chartColors.push('rgba(255, 206, 86, 0.7)'); } const ctx = document.getElementById('capitalCompareChart').getContext('2d'); new Chart(ctx, { type: 'bar', data: { labels: chartLabels, datasets: [{ label: 'Capital Score', data: chartData, backgroundColor: chartColors, borderColor: chartColors.map(c => c.replace('0.7', '1')), borderWidth: 1 }] }, options: { indexAxis: 'y', responsive: true, plugins: { legend: { display: false }, title: { display: true, text: 'Score Comparison with Nearby Ranks' } }, scales: { x: { beginAtZero: true } } } }); document.getElementById('capitalDetailModal').classList.add('active'); }, 
                closeCapitalDetailModal: () => document.getElementById('capitalDetailModal').classList.remove('active'), 
            };
            async function callGemini(prompt) { try { const response = await fetch('/api/getAiExplanation', { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ promptText: prompt }) }); if (!response.ok) { const errorData = await response.json().catch(() => null); const statusText = response.statusText; const statusCode = response.status; console.error("AI Backend Error:", statusCode, statusText, errorData); return `AI se jawaab nahi mil pa raha hai. (Error: ${statusCode})`; } const data = await response.json(); return data.explanation; } catch (e) { console.error("Network error calling AI backend:", e); return "AI backend se connect nahi ho pa raha hai. Kripya apna internet connection jaanchein."; } }
            sendBtn.addEventListener('click', () => handleSend(null));
            inputBox.addEventListener('keyup', (e) => { if (e.key === 'Enter') handleSend(null); });
            inputBox.addEventListener('input', () => showSuggestions(inputBox.value));
            unlockBtn.addEventListener('click', window.jarvis.deactivateLockMode);
            initializeBot();
        }
        checkAuthAndInitialize();
    </script>
</body>
</html>

