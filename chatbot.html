<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bank Jarvis - The Ultimate AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" />
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <!-- Chart.js for Data Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --secondary-color: #f8fafc; --user-message-bg: #DCF8C6; --bot-message-bg: #ffffff;
            --text-dark: #1C1C1E; --highlight-color: #111827; 
            --shadow-md: 0 4px 10px -2px rgb(0 0 0 / 0.1), 0 2px 6px -4px rgb(0 0 0 / 0.1);
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes image-fade-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        body { font-family: 'Inter', 'Segoe UI', sans-serif; background-color: var(--secondary-color); }
        .chat-container { animation: fadeIn 0.5s ease-out; }
        .chat-messages { padding: 1rem 0.5rem; }

        .message { display: flex; margin-bottom: 1rem; }
        .message.user { justify-content: flex-end; }
        .message.bot { justify-content: flex-start; }
        .bubble { padding: 0.75rem 1rem; border-radius: 1.25rem; box-shadow: var(--shadow-md); max-width: 85%; }
        .bubble.user-bubble { background-color: var(--user-message-bg); color: #303030; border-bottom-right-radius: 0.5rem; }
        .bubble.bot-bubble { background-color: var(--bot-message-bg); border-bottom-left-radius: 0.5rem; width: 95%; max-width: none; }
        
        /* UPDATED: Styles for formatted lists */
        .bubble.bot-bubble ul, .bubble.bot-bubble ol { padding-left: 20px; margin-top: 8px; margin-bottom: 8px; }
        .bubble.bot-bubble li { margin-bottom: 5px; }

        .chat-messages::-webkit-scrollbar { width: 6px; }
        .chat-messages::-webkit-scrollbar-track { background: transparent; }
        .chat-messages::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        
        .suggestion-pill { transition: all 0.2s ease-in-out; background-color: #f1f5f9; border: 1px solid #e2e8f0; }
        .suggestion-pill:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); background-color: #e2e8f0; }

        .clickable-link { color: #2563eb; font-weight: 600; text-decoration: underline; word-break: break-all; }
        
        .modal { display: none; } .modal.active { display: flex; }
        .modal-content { animation: fadeIn 0.3s; }

        /* UPDATED: Image Gallery Modal Styles */
        #imageModal .modal-content { background: transparent; box-shadow: none; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 0; }
        #gallery-container { position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        #modalImageContent { max-width: 90vw; max-height: 80vh; object-fit: contain; border-radius: 10px; }
        .gallery-nav { position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 44px; height: 44px; font-size: 24px; cursor: pointer; z-index: 60; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; }
        .gallery-nav:hover { background-color: rgba(0,0,0,0.8); }
        #prev-btn { left: 10px; }
        #next-btn { right: 10px; }
        #gallery-counter { position: absolute; bottom: 20px; background-color: rgba(0,0,0,0.7); color: white; padding: 5px 15px; border-radius: 15px; font-size: 14px; z-index: 60; }
        .modal-close-btn { position: absolute; top: 15px; right: 15px; z-index: 60; color: white; font-size: 36px; cursor: pointer; text-shadow: 0 0 8px black; }

        /* UPDATED: Image counter on thumbnail */
        .image-preview-container { position: relative; display: inline-block; }
        .image-counter { position: absolute; top: 8px; right: 8px; background-color: rgba(0,0,0,0.7); color: white; padding: 3px 8px; border-radius: 10px; font-size: 12px; font-weight: 500; }
    </style>
</head>
<body class="antialiased">

    <div class="chat-container flex flex-col h-screen max-w-4xl mx-auto bg-white shadow-2xl">
        <header class="relative flex items-center justify-center p-4 bg-gray-800 text-white shadow-lg z-10">
            <h1 class="text-xl font-bold tracking-wider">Bank Jarvis</h1>
        </header>

        <div id="lock-mode-banner" class="hidden"></div>

        <div id="chat" class="chat-messages flex-1 overflow-y-auto bg-secondary-color"></div>

        <div class="bg-white p-4 border-t border-gray-200 shadow-inner">
            <div id="suggestions" class="mb-2 flex flex-wrap gap-2"></div>
            <div class="relative">
                <input type="text" id="input" class="w-full pl-4 pr-12 py-3 bg-gray-100 rounded-full focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Jarvis se apna sawaal likhein...">
                <button id="send-btn" class="absolute right-2 top-1/2 -translate-y-1/2 bg-green-600 hover:bg-green-700 text-white w-10 h-10 rounded-full flex items-center justify-center transition-transform duration-200 hover:scale-110">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- UPDATED: Image Modal is now a gallery -->
    <div id="imageModal" class="modal fixed inset-0 bg-black bg-opacity-90 z-50 items-center justify-center">
        <span class="modal-close-btn" onclick="window.jarvis.closeImageModal()">&times;</span>
        <div id="gallery-container">
            <img id="modalImageContent" src="">
            <button id="prev-btn" class="gallery-nav" onclick="window.jarvis.navigateGallery(-1)">&#10094;</button>
            <button id="next-btn" class="gallery-nav" onclick="window.jarvis.navigateGallery(1)">&#10095;</button>
            <div id="gallery-counter">1 / 1</div>
        </div>
    </div>
    
    <!-- Other modals remain unchanged -->
    <div id="capitalKingsModal" class="modal"></div>
    <div id="capitalDetailModal" class="modal"></div>


    <script>
        // --- Step 1: Authentication & Initialization ---
        async function checkAuthAndInitialize() {
            try {
                const response = await fetch('/api/config');
                if (!response.ok) throw new Error('Configuration failed to load.');
                const config = await response.json();
                firebase.initializeApp(config.firebase);
                firebase.auth().onAuthStateChanged(user => {
                    if (user) {
                        runJarvisLogic();
                    } else {
                        window.location.href = `/login.html?redirect=${window.location.pathname}`;
                    }
                });
            } catch (error) {
                document.getElementById('chat').innerHTML = `<div class="p-4 text-red-600 text-center">Application failed to initialize: ${error.message}</div>`;
            }
        }

        // --- Step 2: Main Application Logic ---
        function runJarvisLogic() {
            const database = firebase.database();
            const faqsRef = database.ref('admin/faqs');
            const membersRef = database.ref('members');

            let isBotInitialized = false;
            let cachedFaqs = null;
            let allMembersFullData = null;
            
            // NEW: Global state for the image gallery
            let currentGalleryImages = [];
            let currentGalleryIndex = 0;

            const chatBox = document.getElementById('chat');
            const inputBox = document.getElementById('input');
            const sendBtn = document.getElementById('send-btn');
            const suggestionsBox = document.getElementById('suggestions');

            async function initializeBot() {
                await typeMessage("Namaste! Main aapka smart financial assistant, Jarvis hoon.", "bot");
                const typing = appendRichMessage("...", "bot typing");
                try {
                    const [memberSnapshot, faqsSnapshot] = await Promise.all([ membersRef.once('value'), faqsRef.once('value') ]);
                    
                    if (memberSnapshot.exists()) {
                        allMembersFullData = memberSnapshot.val();
                    }

                    cachedFaqs = [];
                    if (faqsSnapshot.exists()) {
                        const faqsData = faqsSnapshot.val();
                        for(const key in faqsData) { 
                            if(faqsData[key].questions && (faqsData[key].answer || faqsData[key].imageUrl)) { 
                                cachedFaqs.push(faqsData[key]); 
                            } 
                        }
                    } 
                    
                    if (cachedFaqs.length === 0) {
                        cachedFaqs = [
                            { type: "text", questions: ["बैंक कम्युनिटी लोन क्या है?", "लोन कैसे मिलता है", "community loan kya hai"], answer: "Bank Community Loan एक सामुदायिक financial संस्था है, जहाँ सभी सदस्य हर माह ₹500 की SIP के रूप में जमा करते हैं। यह राशि एक community fund बनाती है, जिससे जरूरतमंद members को minimum interest rate पर, पूरी transparency और तय नियमों के अनुसार loan प्रदान किया जाता है।" },
                            { type: "text", questions: ["SIP kab jama karna hota hai?", "SIP ki date kya hai"], answer: "हर महीने 1 से 10 तारीख के बीच SIP भुगतान किया जाता है।" }
                        ];
                    }

                    typing.remove();
                    await typeMessage("Aap kisi sadasya ka naam type kar sakte hain ya koi niyam pooch sakte hain.", "bot");
                    isBotInitialized = true;
                    showDefaultSuggestions();

                } catch (error) { console.error("Initialization failed:", error); typing.innerHTML = "त्रुटि: डेटाबेस से कनेक्ट नहीं हो सका।"; }
            }
            
            async function handleSend(simulatedQuery = null) {
                if (!isBotInitialized) return;
                const originalQuery = simulatedQuery || inputBox.value.trim();
                if (!originalQuery) return;

                appendRichMessage(originalQuery, "user");
                inputBox.value = '';
                suggestionsBox.innerHTML = '';
                
                await processGeneralQuery(originalQuery); 
            }

            async function processGeneralQuery(query) {
                const matchingFaqs = findMatchingFaqs(query, 1);
                
                if (matchingFaqs.length > 0) {
                    const topFaq = matchingFaqs[0];
                    if (topFaq.type === 'image') {
                        await displayImageFaq(topFaq);
                    } else {
                        await typeMessage(topFaq.answer, "bot");
                    }
                    showPostAnswerSuggestions(topFaq);
                } else {
                    await typeMessage(`Maaf kijiye, main is sawaal ko samajh nahi paaya. Aap koi doosra sawaal pooch sakte hain.`, "bot");
                    showDefaultSuggestions();
                }
            }
            
            // --- Response Rendering ---
            
            // UPDATED: This function now also handles list formatting
            function formatBotAnswer(content) {
                if (!content) return '';
                let processedContent = content;

                // Keyword highlighting
                const keywords = ['लोन', 'loan', 'ब्याज', 'interest', 'SIP', 'पेनल्टी', 'penalty', 'रिटर्न', 'return', 'बाउंस', 'bounced', 'capital', 'पूँजी'];
                const keywordRegex = new RegExp(`\\b(${keywords.join('|')})\\b`, 'gi');
                processedContent = processedContent.replace(keywordRegex, `<strong style="color: var(--highlight-color); font-weight: 700;">$1</strong>`);
                
                // Number highlighting
                processedContent = processedContent.replace(/(\d{1,3}(,\d{3})*(\.\d+)?%?)/g, '<strong>$1</strong>');

                // List formatting
                // Matches lines starting with number+dot or hyphen
                const listRegex = /((?:\d+\.\s|[-*]\s).+(?:\n|$))+/g;
                processedContent = processedContent.replace(listRegex, (match) => {
                    const items = match.trim().split('\n');
                    const listType = /^\d+\./.test(items[0]) ? 'ol' : 'ul';
                    let listHtml = `<${listType}>`;
                    items.forEach(item => {
                        // Remove the number/hyphen prefix before wrapping in <li>
                        const cleanItem = item.replace(/^\d+\.\s|[-*]\s/, '');
                        listHtml += `<li>${cleanItem}</li>`;
                    });
                    listHtml += `</${listType}>`;
                    return listHtml;
                });

                return processedContent;
            }

            function processLinks(content) {
                if (!content) return '';
                const urlRegex = /(https?:\/\/[^\s"'<>`]+)/g;
                return content.replace(urlRegex, (url) => `<a href="${url}" target="_blank" class="clickable-link">${url}</a>`);
            }

            function appendRichMessage(content, type) {
                const messageEl = document.createElement('div');
                messageEl.className = `message ${type}`;
                const bubbleEl = document.createElement('div');
                bubbleEl.className = `bubble ${type}-bubble`;
                
                if (type === 'bot typing') {
                    bubbleEl.innerHTML = `<div class="flex items-center space-x-2"><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.2s;"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.4s;"></div></div>`;
                } else {
                    bubbleEl.innerHTML = content;
                }
                messageEl.appendChild(bubbleEl);
                chatBox.appendChild(messageEl);
                chatBox.scrollTop = chatBox.scrollHeight;
                return bubbleEl;
            }

            function typeMessage(text, type) {
                return new Promise(resolve => {
                    const finalHtml = processLinks(formatBotAnswer(text));
                    const messageEl = document.createElement('div');
                    messageEl.className = `message ${type}`;
                    const bubbleEl = document.createElement('div');
                    bubbleEl.className = `bubble ${type}-bubble`;
                    messageEl.appendChild(bubbleEl);
                    chatBox.appendChild(messageEl);
                    
                    let i = 0;
                    bubbleEl.innerHTML = "▋";
                    const interval = setInterval(() => {
                        if (i < text.length) {
                            bubbleEl.innerHTML = processLinks(formatBotAnswer(text.substring(0, i + 1))) + "▋";
                            chatBox.scrollTop = chatBox.scrollHeight;
                            i++;
                        } else {
                            clearInterval(interval);
                            bubbleEl.innerHTML = finalHtml;
                            chatBox.scrollTop = chatBox.scrollHeight;
                            resolve(bubbleEl);
                        }
                    }, 25);
                });
            }

            // UPDATED: Image FAQ display logic
            async function displayImageFaq(faq) {
                const imageUrls = Array.isArray(faq.imageUrl) ? faq.imageUrl : [faq.imageUrl].filter(Boolean);
                if (imageUrls.length === 0) return;

                // Create the HTML for the first image with a counter if multiple exist
                let imageHtml = `
                    <div class="image-preview-container">
                        <img src="${imageUrls[0]}" alt="${faq.imageTitle || 'Image'}" class="image-faq-img w-full rounded-lg border-2 border-gray-200 cursor-pointer shadow-md" 
                             onclick="window.jarvis.openImageGallery(JSON.parse(decodeURIComponent('${encodeURIComponent(JSON.stringify(imageUrls))}')))">
                        ${imageUrls.length > 1 ? `<div class="image-counter">1 / ${imageUrls.length}</div>` : ''}
                    </div>`;

                const initialContent = `
                    <div class="p-1">
                        <p class="font-bold text-lg text-gray-800 mb-2">${faq.imageTitle || ''}</p>
                        ${imageHtml}
                        <div class="description-container mt-3"></div>
                    </div>`;

                const bubbleEl = appendRichMessage(initialContent, "bot");
                const descriptionContainer = bubbleEl.querySelector('.description-container');

                if (faq.answer && descriptionContainer) {
                    await typeMessageIntoElement(faq.answer, descriptionContainer);
                }
            }

            function typeMessageIntoElement(text, element) {
                return new Promise(resolve => {
                    const finalHtml = processLinks(formatBotAnswer(text));
                    let i = 0;
                    element.innerHTML = "▋";
                    const interval = setInterval(() => {
                        if (i < text.length) {
                            element.innerHTML = processLinks(formatBotAnswer(text.substring(0, i + 1))) + "▋";
                            chatBox.scrollTop = chatBox.scrollHeight;
                            i++;
                        } else {
                            clearInterval(interval);
                            element.innerHTML = finalHtml;
                            chatBox.scrollTop = chatBox.scrollHeight;
                            resolve();
                        }
                    }, 25);
                });
            }

            function showDefaultSuggestions() {
                suggestionsBox.innerHTML = '';
                const suggestions = ['बैंक कम्युनिटी लोन क्या है?', 'Smart slab system', 'Community picture'];
                suggestions.forEach(text => {
                    const pill = document.createElement('button');
                    pill.className = 'suggestion-pill px-3 py-1 rounded-full text-sm text-gray-700';
                    pill.textContent = text;
                    pill.onclick = () => handleSend(text);
                    suggestionsBox.appendChild(pill);
                });
            }
            
            function showPostAnswerSuggestions(answeredFaq) {
                let relatedFaqs = cachedFaqs.filter(f => f.answer !== answeredFaq.answer).slice(0, 3);
                if (relatedFaqs.length === 0) return;
                const container = document.createElement('div');
                container.className = 'p-2';
                container.innerHTML = '<p class="text-sm font-semibold text-gray-600 mb-2">Anya Sawaal:</p>';
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'flex flex-wrap justify-start';
                relatedFaqs.forEach(faq => {
                    const btn = document.createElement('button');
                    btn.className = 'post-answer-suggestion';
                    btn.textContent = faq.questions[0];
                    btn.onclick = () => handleSend(faq.questions[0]);
                    buttonContainer.appendChild(btn);
                });
                container.appendChild(buttonContainer);
                appendRichMessage(container.outerHTML, 'bot');
            }
            
            function getWordMatchScore(query, text) { const queryWords = new Set(query.toLowerCase().split(/\s+/).filter(w => w.length > 1)); const textWords = new Set(text.toLowerCase().split(/\s+/)); let score = 0; for (const word of queryWords) { if (textWords.has(word)) score++; } return score; }
            function findMatchingFaqs(query, limit) { if (!cachedFaqs) return []; const lowerQuery = String(query).toLowerCase().trim(); if (lowerQuery.length < 2) return []; return cachedFaqs.map(faq => { let searchText = `${faq.answer || ''} ${faq.questions.join(' ')} ${faq.imageTitle || ''} ${faq.category || ''}`; return { ...faq, score: getWordMatchScore(lowerQuery, searchText.toLowerCase()) }; }).filter(faq => faq.score > 0).sort((a, b) => b.score - a.score).slice(0, limit); }

            // --- Global Functions & Event Listeners ---
            window.jarvis = {
                openImageGallery: (imageUrls, startIndex = 0) => {
                    currentGalleryImages = imageUrls;
                    document.getElementById('imageModal').classList.add('active');
                    window.jarvis.showGalleryImage(startIndex);
                },
                closeImageModal: () => {
                    document.getElementById('imageModal').classList.remove('active');
                    currentGalleryImages = [];
                    currentGalleryIndex = 0;
                },
                navigateGallery: (direction) => {
                    const newIndex = currentGalleryIndex + direction;
                    if (newIndex >= 0 && newIndex < currentGalleryImages.length) {
                        window.jarvis.showGalleryImage(newIndex);
                    }
                },
                showGalleryImage: (index) => {
                    currentGalleryIndex = index;
                    document.getElementById('modalImageContent').src = currentGalleryImages[index];
                    document.getElementById('gallery-counter').textContent = `${index + 1} / ${currentGalleryImages.length}`;
                    document.getElementById('prev-btn').style.display = index > 0 ? 'flex' : 'none';
                    document.getElementById('next-btn').style.display = index < currentGalleryImages.length - 1 ? 'flex' : 'none';
                }
            };
            
            sendBtn.addEventListener('click', () => handleSend(null));
            inputBox.addEventListener('keyup', (e) => { if (e.key === 'Enter') handleSend(null); });
            
            initializeBot();
        }

        checkAuthAndInitialize();
    </script>
</body>
</html>

