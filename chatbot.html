<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bank Jarvis - The Ultimate AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" />
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <!-- Marked.js for rendering Markdown tables -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #2E7D32, #4CAF50);
            --secondary-color: #f0f4f8;
            --user-message-bg: #DCF8C6;
            --bot-message-bg: #ffffff;
            --text-dark: #1C1C1E;
            --text-light: #6C757D;
            --border-color: #e5e7eb;
            --highlight-color: #111827; 
            --shadow-light: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
            --shadow-md: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        
        @keyframes image-fade-in {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .image-faq-img { animation: image-fade-in 0.5s ease-out; }

        body { font-family: 'Inter', 'Segoe UI', sans-serif; background-color: var(--secondary-color); }
        .chat-container { animation: fadeIn 0.5s ease-out; }
        .message { animation: fadeIn 0.3s ease-out; }
        
        .chat-messages::-webkit-scrollbar { width: 6px; }
        .chat-messages::-webkit-scrollbar-track { background: transparent; }
        .chat-messages::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        .chat-messages::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        .suggestion-pill { transition: all 0.2s ease-in-out; }
        .suggestion-pill:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }

        #lock-mode-banner { animation: fadeIn 0.5s ease; }
        .lock-icon-pulse { animation: pulse 2s infinite ease-in-out; }

        .clickable-link { color: #2563eb; font-weight: 600; text-decoration: underline; word-break: break-all; }
        .clickable-link:hover { color: #1d4ed8; }
        
        .capital-king-card { border-left: 4px solid; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .capital-king-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }

        .modal { display: none; } .modal.active { display: flex; }
        .modal-content { animation: fadeIn 0.3s; }

        .post-answer-suggestion {
            background-color: #eef2ff; color: #4338ca; border: 1px solid #c7d2fe;
            padding: 8px 12px; margin: 4px; border-radius: 16px; font-size: 0.9em;
            cursor: pointer; transition: all 0.2s ease;
        }
        .post-answer-suggestion:hover { background-color: #e0e7ff; border-color: #a5b4fc; }

        /* Styles for Markdown tables */
        .bot-message table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
            font-size: 0.9em;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .bot-message th, .bot-message td {
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            text-align: left;
        }
        .bot-message th {
            background-color: #f2f2f2;
            font-weight: 600;
        }
        .bot-message tr:nth-child(even) {
            background-color: #fafafa;
        }
    </style>
</head>
<body class="antialiased">

    <div class="chat-container flex flex-col h-screen max-w-4xl mx-auto bg-white shadow-2xl">
        <header class="relative flex items-center justify-center p-4 bg-gray-800 text-white shadow-lg z-10">
            <h1 class="text-xl font-bold tracking-wider">Bank Jarvis</h1>
        </header>

        <div id="lock-mode-banner" class="hidden flex items-center justify-between p-3 bg-yellow-100 border-b-2 border-yellow-300">
            <div class="flex items-center">
                <i class="fas fa-lock text-yellow-600 text-xl mr-3 lock-icon-pulse"></i>
                <div>
                    <p class="font-bold text-yellow-800">Lock Mode Active</p>
                    <p id="locked-member-name" class="text-sm text-yellow-700"></p>
                </div>
            </div>
            <button id="unlock-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded-full text-sm">Unlock</button>
        </div>

        <div id="chat" class="chat-messages flex-1 p-6 overflow-y-auto bg-secondary-color"></div>

        <div class="bg-white p-4 border-t border-gray-200 shadow-inner">
            <div id="suggestions" class="mb-2 flex flex-wrap gap-2"></div>
            <div class="relative">
                <input type="text" id="input" class="w-full pl-4 pr-12 py-3 bg-gray-100 rounded-full focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Jarvis se apna sawaal likhein...">
                <button id="send-btn" class="absolute right-2 top-1/2 -translate-y-1/2 bg-green-600 hover:bg-green-700 text-white w-10 h-10 rounded-full flex items-center justify-center transition-transform duration-200 hover:scale-110">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="imageModal" class="modal fixed inset-0 bg-black bg-opacity-75 z-50 items-center justify-center" onclick="window.jarvis.closeImageModal()">
        <span class="absolute top-4 right-6 text-white text-4xl font-bold cursor-pointer" onclick="window.jarvis.closeImageModal()">&times;</span>
        <img id="modalImageContent" class="max-w-[90%] max-h-[90%] rounded-lg">
    </div>

    <script>
        // --- Step 1: Authentication & Initialization ---
        async function checkAuthAndInitialize() {
            try {
                const response = await fetch('/api/config');
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Configuration failed to load: ${errorText}`);
                }
                const config = await response.json();
                firebase.initializeApp(config.firebase);
                firebase.auth().onAuthStateChanged(user => {
                    if (user) {
                        runJarvisLogic();
                    } else {
                        window.location.href = `/login.html?redirect=${window.location.pathname}`;
                    }
                });
            } catch (error) {
                document.getElementById('chat').innerHTML = `<div class="p-4 text-red-600 text-center">Application failed to initialize: ${error.message}</div>`;
            }
        }

        // --- Step 2: Main Application Logic ---
        function runJarvisLogic() {
            const database = firebase.database();
            const faqsRef = database.ref('admin/faqs');
            const membersRef = database.ref('members');

            let isBotInitialized = false;
            let cachedMemberIndex = null;
            let cachedFaqs = null;
            let allMembersFullData = null;
            let lockMode = { active: false, member: null };
            let chatHistory = [];
            
            // NEW: Profit System Engine
            let profitSystem = null;

            const chatBox = document.getElementById('chat');
            const inputBox = document.getElementById('input');
            const sendBtn = document.getElementById('send-btn');
            const suggestionsBox = document.getElementById('suggestions');
            const lockBanner = document.getElementById('lock-mode-banner');
            const lockedMemberNameEl = document.getElementById('locked-member-name');
            const unlockBtn = document.getElementById('unlock-btn');

            async function initializeBot() {
                await typeMessage("Namaste! Main aapka smart financial assistant, Jarvis hoon.", "bot");
                const typing = appendRichMessage("...", "bot typing");
                try {
                    const [memberSnapshot, faqsSnapshot] = await Promise.all([ membersRef.once('value'), faqsRef.once('value') ]);
                    
                    if (memberSnapshot.exists()) {
                        allMembersFullData = memberSnapshot.val();
                        cachedMemberIndex = Object.keys(allMembersFullData)
                            .filter(key => allMembersFullData[key].fullName)
                            .map(key => ({ id: key, name: allMembersFullData[key].fullName }))
                            .sort((a,b) => a.name.localeCompare(b.name));
                        
                        // Initialize the profit system with all member data
                        profitSystem = initializeProfitSystem(allMembersFullData);

                    } else {
                        cachedMemberIndex = [];
                    }

                    cachedFaqs = [];
                    if (faqsSnapshot.exists()) {
                        const faqsData = faqsSnapshot.val();
                        for(const key in faqsData) { 
                            if(faqsData[key].questions && (faqsData[key].answer || faqsData[key].imageUrl)) { 
                                cachedFaqs.push(faqsData[key]); 
                            } 
                        }
                    } 
                    
                    if (cachedFaqs.length === 0) {
                        cachedFaqs = [
                            { questions: ["बैंक कम्युनिटी लोन क्या है?", "लोन कैसे मिलता है", "community loan kya hai"], answer: "Bank Community Loan एक सामुदायिक financial संस्था है, जहाँ सभी सदस्य हर माह ₹500 की SIP के रूप में जमा करते हैं। यह राशि एक community fund बनाती है, जिससे जरूरतमंद members को minimum interest rate पर, पूरी transparency और तय नियमों के अनुसार loan प्रदान किया जाता है।" },
                            { questions: ["SIP kab jama karna hota hai?", "SIP ki date kya hai"], answer: "हर महीने 1 से 10 तारीख के बीच SIP भुगतान किया जाता है।" },
                            { questions: ["Performance Score kya hai?", "Mera score kaise calculate hota hai?"], answer: "Performance Score aapke financial behavior ko mapne ka ek tarika hai. Yeh teen cheezon par nirbhar karta hai: 1. **Capital Score** (Aap kitna paisa kitne samay tak rakhte hain), 2. **Consistency Score** (Aap samay par SIP jama karte hain ya nahi), aur 3. **Credit Score** (Aap loan samay par chukate hain ya nahi). Accha score aapko bhavishya mein zyada munafa aur behtar loan eligibility dilata hai." }
                        ];
                    }

                    typing.remove();
                    await typeMessage("Aap kisi sadasya ka naam type kar sakte hain ya koi niyam pooch sakte hain.", "bot");
                    isBotInitialized = true;
                    showDefaultSuggestions();

                } catch (error) { console.error("Initialization failed:", error); typing.innerHTML = "त्रुटि: डेटाबेस से कनेक्ट नहीं हो सका।"; }
            }
            
            async function handleSend(simulatedQuery = null) {
                if (!isBotInitialized) { await typeMessage("Jarvis abhi shuru ho raha hai, kripya prateeksha karein...", "bot"); return; }
                const originalQuery = simulatedQuery || inputBox.value.trim();
                const query = originalQuery.replace(/^jarvis/i, '').trim();
                if (!query) return;

                appendRichMessage(originalQuery, "user");
                chatHistory.push({ role: 'user', parts: [{ text: query }]});
                inputBox.value = '';
                suggestionsBox.innerHTML = '';
                
                if (lockMode.active) { 
                    await processLockedQuery(query, lockMode.member); 
                } else { 
                    await processGeneralQuery(query); 
                }
            }

            async function processGeneralQuery(query) {
                const matchingMembers = findMatchingMembers(query);
                const matchingFaqs = findMatchingFaqs(query, 1);
                
                if (matchingMembers.length === 1 && !query.match(/list|sabhi|all/i)) {
                    await displayMemberDetails(matchingMembers[0].id);
                } else if (matchingMembers.length > 1) {
                    await typeMessage("Mujhe is naam se milte-julte kai sadasya mile. Aap kiske baare mein janna chahte hain?", "bot");
                    matchingMembers.forEach(m => appendMemberClarification(m));
                } else if (matchingFaqs.length > 0) {
                    const topFaq = matchingFaqs[0];
                    await typeMessage(topFaq.answer, "bot");
                    showPostAnswerSuggestions(topFaq);
                } else {
                    await typeMessage(`Maaf kijiye, main keval bank community se jude sawalon ka jawab de sakta hoon.`, "bot");
                    showDefaultSuggestions();
                }
            }

            async function processLockedQuery(query, member) {
                const typing = appendRichMessage("...", "bot typing");
                try {
                    const lowerQuery = query.toLowerCase();
                    let responseText = null;

                    // --- Direct Query Handlers for Profit System ---
                    if (lowerQuery.includes('score') && (lowerQuery.includes('breakdown') || lowerQuery.includes('details') || lowerQuery.includes('kaise') || lowerQuery.includes('kyun'))) {
                        responseText = profitSystem.getScoreBreakdownAsMarkdown(member.id);
                    } else if (lowerQuery.includes('score')) {
                        const score = profitSystem.calculatePerformanceScore(member.id, new Date()).totalScore;
                        responseText = `${member.name} ji, aapka current performance score **${score.toFixed(2)}** hai. Iska breakdown dekhne ke liye, 'score breakdown' type karein.`;
                    } else if (lowerQuery.includes('eligibility') || lowerQuery.includes('loan le sakta')) {
                        responseText = profitSystem.getEligibilityAsMarkdown(member.id);
                    } else if (lowerQuery.includes('profit') && (lowerQuery.includes('breakdown') || lowerQuery.includes('details'))) {
                        responseText = profitSystem.getTotalProfitBreakdownAsMarkdown(member.id);
                    } else if (lowerQuery.includes('profit')) {
                         const totalProfit = profitSystem.calculateTotalProfitForMember(member.id);
                         responseText = `${member.name} ji, aapka ab tak ka kul munafa **₹${totalProfit.toFixed(2)}** hai. Iska breakdown dekhne ke liye, 'profit breakdown' type karein.`;
                    }
                    
                    if (responseText) {
                        await typeMessage(responseText, "bot", responseText);
                    } else {
                        // Fallback to Gemini for complex analytical queries
                        const transactions = allMembersFullData[member.id].transactions ? Object.values(allMembersFullData[member.id].transactions) : [];
                        const prompt = `You are Jarvis, a super-intelligent financial AI assistant for a bank community. Your current focus is solely on a member named **${member.name}**. **PRIMARY DIRECTIVE:** Your main role is to ANALYZE financial data and EXPLAIN it in simple, conversational Hinglish. You are NOT a calculator. All calculations are pre-computed. Your job is to present the information clearly. **CRITICAL RULES:** 1. **Scope:** ONLY answer questions related to the provided "MEMBER'S TRANSACTION HISTORY". If the user asks about anything else (general knowledge, small talk, etc.), you MUST respond with EXACTLY this sentence: "माफ़ कीजिए, मैं अभी लॉक मोड में हूँ और सिर्फ ${member.name} से जुड़े वित्तीय सवालों का जवाब दे सकता हूँ।" 2. **Language & Formatting:** * Respond in simple, helpful Hinglish. * ALWAYS use numerals (e.g., 1500, 2000) for numbers. NEVER write them in words (e.g., "पंद्रह सौ"). * Format dates as DD-MM-YYYY. 3. **Context is Key:** The "CONVERSATION HISTORY" provides the last few messages. Use it to understand follow-up questions. For example, if the user asks "why?", refer to the previous answer to understand what "why" is about. **CONVERSATION HISTORY (for context):** ${JSON.stringify(chatHistory.slice(-4))} **MEMBER'S ENTIRE TRANSACTION HISTORY (for analysis):** \`\`\`json ${JSON.stringify(transactions, null, 2)} \`\`\` **User's Current Query:** "${query}"`;
                        
                        const aiResponse = await callGemini(prompt);
                        await typeMessage(aiResponse, "bot", aiResponse);
                    }

                } finally {
                    typing.remove();
                }
            }
            
            // --- Response Rendering ---
            function appendRichMessage(content, type) {
                const messageEl = document.createElement('div');
                messageEl.className = `message max-w-lg mb-4 clear-both ${type === 'user' ? 'ml-auto' : 'mr-auto'}`;
                const bubbleEl = document.createElement('div');
                bubbleEl.className = `p-4 rounded-2xl shadow-md ${type === 'user' ? 'bg-user-message-bg text-gray-800 rounded-br-none' : 'bg-bot-message-bg rounded-bl-none'}`;
                
                if (type === 'bot') {
                    messageEl.classList.add('bot-message');
                }

                if (type === 'bot typing') {
                    bubbleEl.innerHTML = `<div class="flex items-center space-x-2"><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.2s;"></div><div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay: 0.4s;"></div></div>`;
                } else {
                    bubbleEl.innerHTML = content;
                }
                messageEl.appendChild(bubbleEl);
                chatBox.appendChild(messageEl);
                chatBox.scrollTop = chatBox.scrollHeight;
                return bubbleEl;
            }

            function typeMessage(text, type, rawTextForHistory = null) {
                return new Promise(resolve => {
                    if (type === 'bot' && rawTextForHistory) {
                        chatHistory.push({ role: 'model', parts: [{ text: rawTextForHistory }] });
                    }
                    
                    const finalHtml = marked.parse(text);
                    
                    const messageEl = document.createElement('div');
                    messageEl.className = `message max-w-lg mb-4 clear-both ${type === 'user' ? 'ml-auto' : 'mr-auto'}`;
                    if (type === 'bot') {
                         messageEl.classList.add('bot-message');
                    }
                    const bubbleEl = document.createElement('div');
                    bubbleEl.className = `p-4 rounded-2xl shadow-md ${type === 'user' ? 'bg-user-message-bg text-gray-800 rounded-br-none' : 'bg-bot-message-bg rounded-bl-none'}`;
                    messageEl.appendChild(bubbleEl);
                    chatBox.appendChild(messageEl);
                    
                    let i = 0;
                    bubbleEl.innerHTML = "▋";
                    const interval = setInterval(() => {
                        if (i < text.length) {
                            bubbleEl.innerHTML = marked.parse(text.substring(0, i + 1)) + "▋";
                            chatBox.scrollTop = chatBox.scrollHeight;
                            i++;
                        } else {
                            clearInterval(interval);
                            bubbleEl.innerHTML = finalHtml;
                            chatBox.scrollTop = chatBox.scrollHeight;
                            resolve(bubbleEl);
                        }
                    }, 25);
                });
            }

            function appendMemberClarification(member) {
                const html = `<p class="font-semibold">${member.name}</p>
                    <div class="flex items-center space-x-2 mt-2">
                        <button onclick="window.jarvis.displayMemberDetails('${member.id}')" class="bg-blue-500 hover:bg-blue-600 text-white w-8 h-8 rounded-full transition-transform hover:scale-110" title="View Details"><i class="fas fa-eye"></i></button>
                        <button onclick="window.jarvis.activateLockMode({id: '${member.id}', name: '${member.name}'})" class="bg-gray-500 hover:bg-gray-600 text-white w-8 h-8 rounded-full transition-transform hover:scale-110" title="Activate Lock Mode"><i class="fas fa-lock"></i></button>
                    </div>`;
                const messageEl = document.createElement('div');
                messageEl.className = 'message bg-white p-3 rounded-lg shadow-md flex items-center justify-between';
                messageEl.innerHTML = html;
                chatBox.appendChild(messageEl);
                chatBox.scrollTop = chatBox.scrollHeight;
            }

            async function displayMemberDetails(memberId) {
                const typing = appendRichMessage("...", "bot typing");
                const memberData = allMembersFullData[memberId];
                await new Promise(resolve => setTimeout(resolve, 500));
                typing.remove();
                if (!memberData) { await typeMessage("त्रुटि: सदस्य का डेटा नहीं मिला।", "bot"); return; }
                const data = aggregateMemberData(memberData);
                const profileImageUrl = data.profilePicUrl || `https://placehold.co/100x100/E2E8F0/4A5568?text=${data.name.charAt(0)}`;
                const signatureImageUrl = data.signatureUrl || `https://placehold.co/150x75/E2E8F0/4A5568?text=No+Sign`;
                const cardHtml = `<div class="p-1"><div class="flex items-center justify-between pb-4 border-b"><div class="flex items-center"><img src="${profileImageUrl}" class="w-16 h-16 rounded-full mr-4 border-2 border-green-500 cursor-pointer" onclick="window.jarvis.openImageModal('${profileImageUrl}')"><div><h3 class="text-xl font-bold text-gray-800">${data.name}</h3><p class="text-sm text-gray-500">Joined: ${data.joinDate}</p></div></div><button onclick="window.jarvis.activateLockMode({id: '${memberId}', name: '${data.name}'})" class="text-gray-400 hover:text-green-600 transition-transform hover:scale-125" title="Lock on this member"><i class="fas fa-lock text-2xl"></i></button></div><div class="grid grid-cols-2 gap-4 text-center py-4"><div class="bg-green-50 p-3 rounded-lg"><p class="text-sm text-green-700">Net Balance</p><p class="font-bold text-lg text-green-900">₹${data.netBalance.toLocaleString('en-IN')}</p></div><div class="bg-red-50 p-3 rounded-lg"><p class="text-sm text-red-700">Outstanding Loan</p><p class="font-bold text-lg text-red-900">₹${data.netLoanOutstanding.toLocaleString('en-IN')}</p></div></div><div class="flex items-center justify-between pt-4 border-t"><div><p class="text-sm text-gray-500">SIP Status (This Month)</p><p class="font-bold text-lg ${data.sipStatus.class}">${data.sipStatus.text}</p></div><img src="${signatureImageUrl}" class="h-10 rounded border cursor-pointer" onclick="window.jarvis.openImageModal('${signatureImageUrl}')" alt="Signature"></div></div>`;
                appendRichMessage(cardHtml, "bot");
            }
            
            // --- Utility & Helper Functions ---
            function createSuggestionPill(text, type) { const pill = document.createElement('button'); pill.className = 'suggestion-pill px-3 py-1 rounded-full text-sm'; if (type === 'member') { pill.classList.add('bg-gray-200', 'text-gray-700'); pill.innerHTML = `<i class="fas fa-user mr-2"></i>${text}`; } else { pill.classList.add('bg-blue-100', 'text-blue-700'); pill.innerHTML = `<i class="fas fa-question-circle mr-2"></i>${text}`; } pill.onclick = () => { inputBox.value = text; handleSend(); }; return pill; }
            function showDefaultSuggestions() { suggestionsBox.innerHTML = ''; const suggestions = ['बैंक कम्युनिटी लोन क्या है?', 'SIP kab jama karna hota hai?', 'Performance Score kya hai?']; suggestions.forEach(text => { const pill = createSuggestionPill(text, 'faq'); suggestionsBox.appendChild(pill); }); }
            function showSuggestions(query) { suggestionsBox.innerHTML = ''; if (!query || query.length < 2 || lockMode.active) { if (!lockMode.active) showDefaultSuggestions(); return; } const memberSuggestions = findMatchingMembers(query).slice(0, 2); const faqSuggestions = findMatchingFaqs(query, 2); const allSuggestions = [...memberSuggestions, ...faqSuggestions]; if (allSuggestions.length === 0) { showDefaultSuggestions(); return; } allSuggestions.forEach(s => { const text = s.id ? s.name : s.questions[0]; const type = s.id ? 'member' : 'faq'; const pill = createSuggestionPill(text, type); suggestionsBox.appendChild(pill); }); }
            function showPostAnswerSuggestions(answeredFaq) { let relatedFaqs = cachedFaqs.filter(f => f.answer !== answeredFaq.answer).slice(0, 3); if (relatedFaqs.length === 0) return; const container = document.createElement('div'); container.className = 'p-2'; container.innerHTML = '<p class="text-sm font-semibold text-gray-600 mb-2">Anya Sawaal:</p>'; const buttonContainer = document.createElement('div'); buttonContainer.className = 'flex flex-wrap justify-start'; relatedFaqs.forEach(faq => { const btn = document.createElement('button'); btn.className = 'post-answer-suggestion'; btn.textContent = faq.questions[0]; btn.onclick = () => handleSend(faq.questions[0]); buttonContainer.appendChild(btn); }); container.appendChild(buttonContainer); appendRichMessage(container.outerHTML, 'bot'); }
            function getWordMatchScore(query, text) { const queryWords = new Set(query.toLowerCase().split(/\s+/).filter(w => w.length > 2)); const textWords = new Set(text.toLowerCase().split(/\s+/)); let score = 0; for (const word of queryWords) { if (textWords.has(word)) score++; } return score; }
            function findMatchingMembers(query) { if (!cachedMemberIndex) return []; const lowerQuery = String(query).toLowerCase().trim(); if (lowerQuery.length < 1) return []; return cachedMemberIndex.filter(m => m.name && m.name.toLowerCase().includes(lowerQuery)); }
            function findMatchingFaqs(query, limit) { if (!cachedFaqs) return []; const lowerQuery = String(query).toLowerCase().trim(); if (lowerQuery.length < 2) return []; return cachedFaqs.map(faq => { let searchText = `${faq.answer || ''} ${faq.questions.join(' ')} ${faq.category || ''}`; return { ...faq, score: getWordMatchScore(lowerQuery, searchText.toLowerCase()) }; }).filter(faq => faq.score > 0).sort((a, b) => b.score - a.score).slice(0, limit); }
            function aggregateMemberData(data) { const transactions = data.transactions ? Object.values(data.transactions) : []; let totalSIP = 0, totalLoan = 0, totalLoanPayment = 0, totalPenalty = 0, totalReturn = 0, totalExtraWithdraw = 0, totalExtraBalance = 0; transactions.forEach(tx => { totalSIP += parseFloat(tx['SIP Payment']) || 0; totalLoan += parseFloat(tx.Loan) || 0; totalLoanPayment += parseFloat(tx['Loan Payment']) || 0; totalPenalty += parseFloat(tx['Penalty amount']) || 0; totalReturn += parseFloat(tx['Return amount']) || 0; totalExtraWithdraw += parseFloat(tx['Extra Withdraw']) || 0; totalExtraBalance += parseFloat(tx['Extra Balance']) || 0; }); const totalDeposits = totalSIP + totalLoanPayment + totalReturn + totalExtraBalance; const totalWithdrawals = totalLoan + totalPenalty + totalExtraWithdraw; const sipStatus = getSipStatus(transactions, new Date()); return { name: data.fullName, profilePicUrl: data.profilePicUrl, signatureUrl: data.signatureUrl, joinDate: new Date(data.joiningDate).toLocaleDateString('en-GB'), totalSIP, totalLoan, totalLoanPayment, totalPenalty, totalReturn, totalDeposits, totalWithdrawals, netBalance: totalDeposits - totalWithdrawals, netLoanOutstanding: Math.max(0, totalLoan - totalLoanPayment), sipStatus }; }
            function getSipStatus(transactions, date) { const currentMonth = date.getMonth(); const currentYear = date.getFullYear(); const currentMonthSipTx = transactions.find(tx => { if (!tx.Date) return false; const txDate = new Date(tx.Date); return (parseFloat(tx['SIP Payment']) || 0) > 0 && txDate.getMonth() === currentMonth && txDate.getFullYear() === currentYear; }); if (currentMonthSipTx) return { text: 'Paid', class: 'text-green-600', amount: parseFloat(currentMonthSipTx['SIP Payment']) }; if (date.getDate() > 10) return { text: 'Pending', class: 'text-red-600', amount: 0 }; return { text: 'Due', class: 'text-yellow-600', amount: 0 }; }
            
            // --- PROFIT SYSTEM ENGINE ---
            function initializeProfitSystem(allMembersData) {
                const CONFIG = {
                    CAPITAL_WEIGHT: 0.40, CONSISTENCY_WEIGHT: 0.30, CREDIT_BEHAVIOR_WEIGHT: 0.30,
                    LOAN_LIMIT_TIER1_SCORE: 50, LOAN_LIMIT_TIER2_SCORE: 60, LOAN_LIMIT_TIER3_SCORE: 80,
                    LOAN_LIMIT_TIER1_MAX: 1.0, LOAN_LIMIT_TIER2_MAX: 1.5, LOAN_LIMIT_TIER3_MAX: 1.8, LOAN_LIMIT_TIER4_MAX: 2.0,
                    MINIMUM_MEMBERSHIP_DAYS: 60, SIP_ON_TIME_LIMIT: 10,
                    LOAN_TERM_TIER3: 90, LOAN_TERM_LATE_FEE: 100,
                    INACTIVE_MEMBER_DAYS_LIMIT: 365, INACTIVE_MEMBER_PROFIT_MULTIPLIER: 0.75
                };
                
                const allTransactions = Object.values(allMembersData).flatMap(member => 
                    member.transactions ? Object.values(member.transactions).map(tx => ({...tx, Name: member.fullName, Date: new Date(tx.Date)})) : []
                ).sort((a, b) => a.Date - b.Date);

                function calculatePerformanceScore(memberId, untilDate) {
                    const memberData = allTransactions.filter(r => r.Name === allMembersData[memberId].fullName && r.Date <= untilDate);
                    if (memberData.length === 0) return { totalScore: 0, capitalScore: 0, consistencyScore: 0, creditScore: 0 };
                    const totalDays = 180;
                    const startDate = new Date(untilDate.getTime() - totalDays * 24 * 3600 * 1000);
                    let weightedCapitalSum = 0, currentBalance = 0;
                    const relevantTransactions = memberData.filter(r => r.Date >= startDate);
                    if (relevantTransactions.length > 0) {
                        let lastDate = startDate;
                        relevantTransactions.forEach(t => {
                            const daysDifference = (t.Date - lastDate) / (1000 * 3600 * 24);
                            weightedCapitalSum += currentBalance * daysDifference;
                            currentBalance += (parseFloat(t['SIP Payment']) || 0) + (parseFloat(t['Loan Payment']) || 0) - (parseFloat(t.Loan) || 0);
                            lastDate = t.Date;
                        });
                        weightedCapitalSum += currentBalance * ((untilDate - lastDate) / (1000 * 3600 * 24));
                    }
                    const capitalScore = Math.max(0, weightedCapitalSum / totalDays);
                    const normalizedCapitalScore = Math.min(100, (capitalScore / 50000) * 100);
                    const sipHistory = {};
                    memberData.filter(r => (parseFloat(r['SIP Payment']) || 0) > 0).forEach(r => {
                        const monthKey = `${r.Date.getFullYear()}-${r.Date.getMonth()}`;
                        if (!sipHistory[monthKey]) sipHistory[monthKey] = r.Date.getDate() <= CONFIG.SIP_ON_TIME_LIMIT ? 10 : 5;
                    });
                    const consistencyPoints = Object.values(sipHistory).reduce((a, b) => a + b, 0);
                    const monthsConsidered = Math.max(1, Object.keys(sipHistory).length);
                    const consistencyScore = (consistencyPoints / (monthsConsidered * 10)) * 100;
                    let creditPoints = 0;
                    const memberLoans = memberData.filter(r => (parseFloat(r.Loan) || 0) > 0);
                    memberLoans.forEach(loanRecord => {
                        const repayment = memberData.find(r => (parseFloat(r['Loan Payment']) || 0) >= (parseFloat(loanRecord.Loan) || 0) && r.Date > loanRecord.Date);
                        if (repayment) {
                            const daysToRepay = (repayment.Date - loanRecord.Date) / (1000 * 3600 * 24);
                            if (daysToRepay <= CONFIG.LOAN_TERM_TIER3) creditPoints += 20; else creditPoints -= 30;
                        } else { creditPoints -= 40; }
                    });
                    const creditScore = memberLoans.length > 0 ? Math.max(0, (creditPoints / (memberLoans.length * 20)) * 100) : 70;
                    const totalScore = (normalizedCapitalScore * CONFIG.CAPITAL_WEIGHT) + (consistencyScore * CONFIG.CONSISTENCY_WEIGHT) + (creditScore * CONFIG.CREDIT_BEHAVIOR_WEIGHT);
                    return { totalScore, capitalScore: normalizedCapitalScore, consistencyScore, creditScore };
                }

                function getLoanEligibility(memberId) {
                    const memberName = allMembersData[memberId].fullName;
                    const memberData = allTransactions.filter(r => r.Name === memberName);
                    const totalLoan = memberData.reduce((sum, r) => sum + (parseFloat(r.Loan) || 0), 0);
                    const totalPayment = memberData.reduce((sum, r) => sum + (parseFloat(r['Loan Payment']) || 0) + (parseFloat(r['SIP Payment']) || 0), 0);
                    if (totalLoan > totalPayment) return { eligible: false, reason: 'Aapka pichhla loan abhi bakaaya hai.' };
                    const firstSip = memberData.find(r => (parseFloat(r['SIP Payment']) || 0) > 0);
                    if (!firstSip) return { eligible: false, reason: 'Aapne abhi tak koi SIP jama nahi ki hai.' };
                    const daysSinceFirstSip = (new Date() - firstSip.Date) / (1000 * 3600 * 24);
                    if (daysSinceFirstSip < CONFIG.MINIMUM_MEMBERSHIP_DAYS) {
                        const daysLeft = Math.ceil(CONFIG.MINIMUM_MEMBERSHIP_DAYS - daysSinceFirstSip);
                        return { eligible: false, reason: `Aapko sadasya bane hue abhi ${CONFIG.MINIMUM_MEMBERSHIP_DAYS} din nahi hue hain. ${daysLeft} din baaki hain.` };
                    }
                    const score = calculatePerformanceScore(memberId, new Date()).totalScore;
                    const { LOAN_LIMIT_TIER1_SCORE, LOAN_LIMIT_TIER2_SCORE, LOAN_LIMIT_TIER3_SCORE, LOAN_LIMIT_TIER1_MAX, LOAN_LIMIT_TIER2_MAX, LOAN_LIMIT_TIER3_MAX, LOAN_LIMIT_TIER4_MAX } = CONFIG;
                    let multiplier = LOAN_LIMIT_TIER1_MAX;
                    if (score < LOAN_LIMIT_TIER1_SCORE) multiplier = LOAN_LIMIT_TIER1_MAX;
                    else if (score < LOAN_LIMIT_TIER2_SCORE) multiplier = LOAN_LIMIT_TIER1_MAX + ((score - LOAN_LIMIT_TIER1_SCORE) / (LOAN_LIMIT_TIER2_SCORE - LOAN_LIMIT_TIER1_SCORE)) * (LOAN_LIMIT_TIER2_MAX - LOAN_LIMIT_TIER1_MAX);
                    else if (score < LOAN_LIMIT_TIER3_SCORE) multiplier = LOAN_LIMIT_TIER2_MAX + ((score - LOAN_LIMIT_TIER2_SCORE) / (LOAN_LIMIT_TIER3_SCORE - LOAN_LIMIT_TIER2_SCORE)) * (LOAN_LIMIT_TIER3_MAX - LOAN_LIMIT_TIER2_MAX);
                    else multiplier = LOAN_LIMIT_TIER3_MAX + ((score - LOAN_LIMIT_TIER3_SCORE) / (100 - LOAN_LIMIT_TIER3_SCORE)) * (LOAN_LIMIT_TIER4_MAX - LOAN_LIMIT_TIER3_MAX);
                    const capital = memberData.reduce((sum, r) => sum + (parseFloat(r['SIP Payment']) || 0) + (parseFloat(r['Loan Payment']) || 0) - (parseFloat(r.Loan) || 0), 0);
                    return { eligible: true, multiplier: Math.max(LOAN_LIMIT_TIER1_MAX, multiplier), maxLoan: capital * multiplier, capital };
                }
                
                function calculateProfitDistribution(paymentRecord) {
                    const profit = (parseFloat(paymentRecord['Return amount']) || 0) * 0.90;
                    if (profit <= 0) return null;
                    const userLoansBeforePayment = allTransactions.filter(r => r.Name === paymentRecord.Name && (parseFloat(r.Loan) || 0) > 0 && r.Date < paymentRecord.Date);
                    if (userLoansBeforePayment.length === 0) return null;
                    const relevantLoan = userLoansBeforePayment[userLoansBeforePayment.length - 1];
                    const loanDate = relevantLoan.Date;
                    const snapshotScores = {};
                    let totalScoreInSnapshot = 0;
                    const membersInSystemAtLoanDate = [...new Set(allTransactions.filter(r => r.Date <= loanDate).map(r => r.Name))];
                    
                    Object.keys(allMembersData).forEach(memberId => {
                        const memberName = allMembersData[memberId].fullName;
                        if(membersInSystemAtLoanDate.includes(memberName)) {
                            const scoreObject = calculatePerformanceScore(memberId, loanDate);
                            if (scoreObject.totalScore > 0) {
                                snapshotScores[memberId] = scoreObject;
                                totalScoreInSnapshot += scoreObject.totalScore;
                            }
                        }
                    });

                    if (totalScoreInSnapshot <= 0) return null;
                    const distribution = [];
                    for (const memberId in snapshotScores) {
                        const memberName = allMembersData[memberId].fullName;
                        let memberShare = (snapshotScores[memberId].totalScore / totalScoreInSnapshot) * profit;
                        const lastLoanDate = allTransactions.filter(r => r.Name === memberName && (parseFloat(r.Loan) || 0) > 0 && r.Date <= loanDate).pop()?.Date;
                        const daysSinceLastLoan = lastLoanDate ? (loanDate - lastLoanDate) / (1000 * 3600 * 24) : Infinity;
                        if (daysSinceLastLoan > CONFIG.INACTIVE_MEMBER_DAYS_LIMIT) {
                            memberShare *= CONFIG.INACTIVE_MEMBER_PROFIT_MULTIPLIER;
                        }
                        if (memberShare > 0) distribution.push({ name: memberName, id: memberId, share: memberShare });
                    }
                    return { profit, relevantLoan, distribution: distribution.sort((a, b) => b.share - a.share) };
                }

                function calculateTotalProfitForMember(memberId) {
                    const memberName = allMembersData[memberId].fullName;
                    return allTransactions.reduce((totalProfit, transaction) => {
                        if ((parseFloat(transaction['Return amount']) || 0) > 0) {
                            const result = calculateProfitDistribution(transaction);
                            const memberShare = result?.distribution.find(d => d.id === memberId);
                            if (memberShare) totalProfit += memberShare.share;
                        }
                        return totalProfit;
                    }, 0);
                }

                return {
                    calculatePerformanceScore,
                    getLoanEligibility,
                    calculateTotalProfitForMember,
                    getScoreBreakdownAsMarkdown: (memberId) => {
                        const scores = calculatePerformanceScore(memberId, new Date());
                        const memberName = allMembersData[memberId].fullName;
                        let text = `${memberName} ji, aapke Performance Score (**${scores.totalScore.toFixed(2)}**) ki ganana is prakaar hai:\n\n`;
                        text += `| Component | Score (0-100) | Weight | Final Contribution |\n`;
                        text += `| :--- | :--- | :--- | :--- |\n`;
                        text += `| Capital Score | ${scores.capitalScore.toFixed(2)} | ${CONFIG.CAPITAL_WEIGHT * 100}% | **${(scores.capitalScore * CONFIG.CAPITAL_WEIGHT).toFixed(2)}** |\n`;
                        text += `| Consistency Score | ${scores.consistencyScore.toFixed(2)} | ${CONFIG.CONSISTENCY_WEIGHT * 100}% | **${(scores.consistencyScore * CONFIG.CONSISTENCY_WEIGHT).toFixed(2)}** |\n`;
                        text += `| Credit Score | ${scores.creditScore.toFixed(2)} | ${CONFIG.CREDIT_BEHAVIOR_WEIGHT * 100}% | **${(scores.creditScore * CONFIG.CREDIT_BEHAVIOR_WEIGHT).toFixed(2)}** |\n\n`;
                        text += `In sabhi ko jodkar aapka antim score banta hai.`;
                        return text;
                    },
                    getEligibilityAsMarkdown: (memberId) => {
                        const eligibility = getLoanEligibility(memberId);
                        const memberName = allMembersData[memberId].fullName;
                        if (eligibility.eligible) {
                            return `${memberName} ji, aap loan ke liye **eligible** hain. Aapki poonji (₹${eligibility.capital.toFixed(2)}) aur score ke aadhar par, aap **${eligibility.multiplier.toFixed(2)}x** guna tak, yaani lagbhag **₹${eligibility.maxLoan.toFixed(2)}** tak ka loan le sakte hain.`;
                        } else {
                            return `${memberName} ji, aap abhi loan ke liye **eligible nahi hain**. Kaaran: ${eligibility.reason}`;
                        }
                    },
                    getTotalProfitBreakdownAsMarkdown: (memberId) => {
                        const memberName = allMembersData[memberId].fullName;
                        let breakdownText = `${memberName} ji, aapko mile kul munafey ka breakdown yahan hai:\n\n| Munafa Kis Loan Se Mila | Aapka Hissa |\n| :--- | :--- |\n`;
                        let totalProfit = 0;
                        const profitEvents = allTransactions.filter(r => (parseFloat(r['Return amount']) || 0) > 0);
                        if(profitEvents.length === 0) return "Abhi tak koi munafa vitrit nahi hua hai.";
                        
                        let profitCount = 0;
                        profitEvents.forEach(event => {
                            const result = calculateProfitDistribution(event);
                            const share = result?.distribution.find(d => d.id === memberId);
                            if (share) {
                                totalProfit += share.share;
                                breakdownText += `| ${event.Name} (${new Date(event.Date).toLocaleDateString('en-GB')}) | ₹${share.share.toFixed(2)} |\n`;
                                profitCount++;
                            }
                        });

                        if(profitCount === 0) return `${memberName} ji, aapko abhi tak kisi bhi event se munafa nahi mila hai.`;

                        breakdownText += `\n**Kul Munafa: ₹${totalProfit.toFixed(2)}**`;
                        return breakdownText;
                    }
                };
            }

            window.jarvis = { 
                activateLockMode: (member) => { 
                    lockMode = { active: true, member }; 
                    chatHistory = []; 
                    lockedMemberNameEl.textContent = `Focused on ${member.name}`; 
                    lockBanner.classList.remove('hidden'); 
                    appendRichMessage(`🔒 Lock Mode activated for **${member.name}**. Ab aap inke score, profit, aur eligibility se jude koi bhi sawaal pooch sakte hain.`, "bot"); 
                    suggestionsBox.innerHTML = ''; 
                    const lockSuggestions = ['Mera score kya hai?', 'Score breakdown batao', 'Meri loan eligibility kya hai?', 'Mera profit breakdown dikhao'];
                    lockSuggestions.forEach(text => {
                        const pill = createSuggestionPill(text, 'faq');
                        suggestionsBox.appendChild(pill);
                    });
                }, 
                deactivateLockMode: () => { 
                    appendRichMessage(`🔓 Lock Mode deactivated.`, "bot"); 
                    lockMode = { active: false, member: null }; 
                    chatHistory = []; 
                    lockBanner.classList.add('hidden'); 
                    showDefaultSuggestions(); 
                }, 
                openImageModal: (imageUrl) => { if (!imageUrl || imageUrl.includes('placehold.co')) return; document.getElementById('modalImageContent').src = imageUrl; document.getElementById('imageModal').classList.add('active'); }, 
                closeImageModal: () => { document.getElementById('imageModal').classList.remove('active'); }, 
                displayMemberDetails: displayMemberDetails 
            };
            
            async function callGemini(prompt) { try { const response = await fetch('/api/getAiExplanation', { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ promptText: prompt }) }); if (!response.ok) { const errorData = await response.json().catch(() => null); const statusText = response.statusText; const statusCode = response.status; console.error("AI Backend Error:", statusCode, statusText, errorData); return `AI se jawaab nahi mil pa raha hai. (Error: ${statusCode})`; } const data = await response.json(); return data.explanation; } catch (e) { console.error("Network error calling AI backend:", e); return "AI backend se connect nahi ho pa raha hai. Kripya apna internet connection jaanchein."; } }
            
            sendBtn.addEventListener('click', () => handleSend(null));
            inputBox.addEventListener('keyup', (e) => { if (e.key === 'Enter') handleSend(null); });
            inputBox.addEventListener('input', () => showSuggestions(inputBox.value));
            unlockBtn.addEventListener('click', window.jarvis.deactivateLockMode);
            
            initializeBot();
        }
        checkAuthAndInitialize();
    </script>
</body>
</html>

