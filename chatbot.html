<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bank Jarvis - The Ultimate AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" />
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <!-- Chart.js for Data Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --secondary-color: #f8fafc; --user-message-bg: #DCF8C6; --bot-message-bg: #ffffff;
            --text-dark: #1C1C1E; --highlight-color: #111827; 
            --shadow-md: 0 4px 10px -2px rgb(0 0 0 / 0.08);
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes image-fade-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        body { font-family: 'Inter', 'Segoe UI', sans-serif; background-color: var(--secondary-color); }
        .chat-container { animation: fadeIn 0.5s ease-out; }
        .chat-messages { padding: 1rem 0.5rem; }

        .message { display: flex; margin-bottom: 1rem; }
        .message.user { justify-content: flex-end; }
        .message.bot { justify-content: flex-start; }
        
        .bubble { padding: 0.75rem 1rem; border-radius: 1.25rem; box-shadow: var(--shadow-md); max-width: 85%; }
        .bubble.user-bubble { background-color: var(--user-message-bg); color: #303030; border-bottom-right-radius: 0.5rem; }
        .bubble.bot-bubble { background-color: var(--bot-message-bg); border-bottom-left-radius: 0.5rem; width: 95%; max-width: none; }

        .chat-messages::-webkit-scrollbar { width: 6px; }
        .chat-messages::-webkit-scrollbar-track { background: transparent; }
        .chat-messages::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        
        .suggestion-pill { transition: all 0.2s ease-in-out; }
        .suggestion-pill:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }

        .clickable-link { color: #2563eb; font-weight: 600; text-decoration: underline; word-break: break-all; }
        
        .modal { display: none; } .modal.active { display: flex; }
        .modal-content { animation: fadeIn 0.3s; }

        /* NEW: Image Gallery Modal Styles */
        #imageGalleryModal .modal-content { background: transparent; box-shadow: none; width: 100%; height: 100%; padding: 0; }
        #galleryContainer { position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        #galleryImage { max-width: 90%; max-height: 85%; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .gallery-nav {
            position: absolute; top: 50%; transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5); color: white;
            border: none; border-radius: 50%;
            width: 44px; height: 44px; font-size: 24px;
            cursor: pointer; transition: background-color 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .gallery-nav:hover { background-color: rgba(0, 0, 0, 0.8); }
        #prevImageBtn { left: 10px; }
        #nextImageBtn { right: 10px; }
        #galleryCounter {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7); color: white;
            padding: 5px 15px; border-radius: 20px; font-size: 14px;
        }
        .gallery-close-btn { position: absolute; top: 15px; right: 15px; font-size: 36px; color: white; text-shadow: 0 0 5px black; cursor: pointer; }
        
        /* NEW: Image preview in chat */
        .image-preview-container { position: relative; cursor: pointer; }
        .image-more-indicator {
            position: absolute; bottom: 8px; right: 8px;
            background-color: rgba(0, 0, 0, 0.7); color: white;
            padding: 4px 8px; border-radius: 10px; font-size: 12px; font-weight: bold;
        }
    </style>
</head>
<body class="antialiased">

    <div class="chat-container flex flex-col h-screen max-w-4xl mx-auto bg-white shadow-2xl">
        <header class="relative flex items-center justify-center p-4 bg-gray-800 text-white shadow-lg z-10">
            <h1 class="text-xl font-bold tracking-wider">Bank Jarvis</h1>
        </header>

        <div id="lock-mode-banner" class="hidden"></div>

        <div id="chat" class="chat-messages flex-1 overflow-y-auto bg-secondary-color"></div>

        <div class="bg-white p-4 border-t border-gray-200 shadow-inner">
            <div id="suggestions" class="mb-2 flex flex-wrap gap-2"></div>
            <div class="relative">
                <input type="text" id="input" class="w-full pl-4 pr-12 py-3 bg-gray-100 rounded-full focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Jarvis se apna sawaal likhein...">
                <button id="send-btn" class="absolute right-2 top-1/2 -translate-y-1/2 bg-green-600 hover:bg-green-700 text-white w-10 h-10 rounded-full flex items-center justify-center transition-transform duration-200 hover:scale-110">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- UPDATED: This is now the Image Gallery Modal -->
    <div id="imageGalleryModal" class="modal fixed inset-0 bg-black bg-opacity-80 z-50 items-center justify-center">
        <div class="modal-content">
            <span class="gallery-close-btn" onclick="window.jarvis.closeImageGallery()">&times;</span>
            <div id="galleryContainer">
                <img id="galleryImage" src="" alt="Gallery View">
                <button id="prevImageBtn" class="gallery-nav">&#10094;</button>
                <button id="nextImageBtn" class="gallery-nav">&#10095;</button>
                <div id="galleryCounter">1 / 1</div>
            </div>
        </div>
    </div>
    
    <!-- Other modals remain the same -->
    <div id="capitalKingsModal" class="modal"></div>
    <div id="capitalDetailModal" class="modal"></div>


    <script>
        // --- Step 1: Authentication & Initialization ---
        async function checkAuthAndInitialize() {
            try {
                const response = await fetch('/api/config');
                if (!response.ok) throw new Error('Configuration failed to load.');
                const config = await response.json();
                firebase.initializeApp(config.firebase);
                firebase.auth().onAuthStateChanged(user => {
                    if (user) {
                        runJarvisLogic();
                    } else {
                        window.location.href = `/login.html?redirect=${window.location.pathname}`;
                    }
                });
            } catch (error) {
                document.getElementById('chat').innerHTML = `<div class="p-4 text-red-600 text-center">Application failed to initialize: ${error.message}</div>`;
            }
        }

        // --- Step 2: Main Application Logic ---
        function runJarvisLogic() {
            const database = firebase.database();
            const faqsRef = database.ref('admin/faqs');
            const membersRef = database.ref('members');

            let isBotInitialized = false;
            let cachedFaqs = null;
            let cachedMemberIndex = null;
            let allMembersFullData = null;
            
            // NEW: Gallery state variables
            let galleryImages = [];
            let currentGalleryIndex = 0;

            const chatBox = document.getElementById('chat');
            const inputBox = document.getElementById('input');
            const sendBtn = document.getElementById('send-btn');
            const suggestionsBox = document.getElementById('suggestions');

            async function initializeBot() {
                await typeMessage("Namaste! Main aapka smart financial assistant, Jarvis hoon.", "bot");
                const typing = appendRichMessage("...", "bot typing");
                try {
                    const [memberSnapshot, faqsSnapshot] = await Promise.all([ membersRef.once('value'), faqsRef.once('value') ]);
                    
                    cachedMemberIndex = [];
                    if (memberSnapshot.exists()) {
                        allMembersFullData = memberSnapshot.val();
                        for (const key in allMembersFullData) {
                            if (allMembersFullData[key].fullName) {
                                cachedMemberIndex.push({ id: key, name: allMembersFullData[key].fullName });
                            }
                        }
                        cachedMemberIndex.sort((a,b) => a.name.localeCompare(b.name));
                    }

                    cachedFaqs = [];
                    if (faqsSnapshot.exists()) {
                        const faqsData = faqsSnapshot.val();
                        for(const key in faqsData) { 
                            if(faqsData[key].questions && (faqsData[key].answer || faqsData[key].imageUrl)) { 
                                cachedFaqs.push(faqsData[key]); 
                            } 
                        }
                    } 
                    
                    if (cachedFaqs.length === 0) {
                        cachedFaqs = [
                            { type: "text", questions: ["बैंक कम्युनिटी लोन क्या है?", "लोन कैसे मिलता है", "community loan kya hai", "Bank community loan kya hai", "बैंक कम्युनिटी क्या है"], answer: "Bank Community Loan एक सामुदायिक financial संस्था है, जहाँ सभी सदस्य हर माह ₹500 की SIP के रूप में जमा करते हैं। यह राशि एक community fund बनाती है, जिससे जरूरतमंद members को minimum interest rate पर, पूरी transparency और तय नियमों के अनुसार loan प्रदान किया जाता है।" },
                            { type: "text", questions: ["SIP kab jama karna hota hai?", "SIP ki date kya hai"], answer: "हर महीने 1 से 10 तारीख के बीच SIP भुगतान किया जाता है।" },
                            { type: "text", questions: ["Capital Kings कौन हैं?"], answer: "Capital Kings वे सदस्य हैं जिन्होंने सबसे लंबे समय तक सबसे अधिक पूंजी रखी है।" }
                        ];
                    }

                    typing.remove();
                    await typeMessage("Aap kisi sadasya ka naam type kar sakte hain ya koi niyam pooch sakte hain.", "bot");
                    isBotInitialized = true;
                    showDefaultSuggestions();
                } catch (error) { console.error("Initialization failed:", error); typing.innerHTML = "त्रुटि: डेटाबेस से कनेक्ट नहीं हो सका।"; }
            }
            
            async function handleSend(simulatedQuery = null) {
                if (!isBotInitialized) return;
                const originalQuery = simulatedQuery || inputBox.value.trim();
                const query = originalQuery.replace(/^jarvis/i, '').trim();
                if (!query) return;

                appendRichMessage(originalQuery, "user");
                inputBox.value = '';
                suggestionsBox.innerHTML = '';
                
                await processGeneralQuery(query); 
            }

            async function processGeneralQuery(query) {
                const matchingMembers = findMatchingMembers(query);
                const matchingFaqs = findMatchingFaqs(query, 1);
                
                if (matchingMembers.length === 1 && !query.match(/list|sabhi|all/i)) {
                    await displayMemberDetails(matchingMembers[0].id);
                } else if (matchingMembers.length > 1) {
                    await typeMessage("Mujhe is naam se milte-julte kai sadasya mile. Aap kiske baare mein janna chahte hain?", "bot");
                    matchingMembers.forEach(m => appendMemberClarification(m));
                } else if (matchingFaqs.length > 0) {
                    const topFaq = matchingFaqs[0];
                    if (topFaq.type === 'image') {
                        await displayImageFaq(topFaq);
                    } else {
                        await typeMessage(topFaq.answer, "bot");
                    }
                    showPostAnswerSuggestions(topFaq);
                } else {
                    await typeMessage(`Maaf kijiye, main keval bank community se jude sawalon ka jawab de sakta hoon.`, "bot");
                    showDefaultSuggestions();
                }
            }
            
            // --- Response Rendering ---
            // NEW: Formats text with line breaks for readability
            function formatStructuredText(text) {
                if (!text) return '';
                // Regex to find patterns like "31-60 din", "1.", or a word followed by ":"
                // and add a line break after them.
                return text.replace(/(\d+-\d+\s+\w+)|(\d+\.\s)|(\w+:) /g, '$&\n');
            }
            
            function formatBotAnswer(content) {
                if (!content) return '';
                const keywords = ['लोन', 'loan', 'ब्याज', 'interest', 'SIP', 'पेनल्टी', 'penalty', 'रिटर्न', 'return', 'बाउंस', 'bounced', 'capital', 'पूँजी'];
                const keywordRegex = new RegExp(`\\b(${keywords.join('|')})\\b`, 'gi');
                let processedContent = content.replace(keywordRegex, `<strong style="color: var(--highlight-color); font-weight: 700;">$1</strong>`);
                processedContent = processedContent.replace(/(\d{1,3}(,\d{3})*(\.\d+)?%?)/g, '<strong>$1</strong>');
                return processedContent;
            }

            function processLinks(content) {
                if (!content) return '';
                const urlRegex = /(https?:\/\/[^\s"'<>`]+)/g;
                return content.replace(urlRegex, (url) => `<a href="${url}" target="_blank" class="clickable-link">${url}</a>`);
            }

            function appendRichMessage(content, type) {
                const messageEl = document.createElement('div');
                messageEl.className = `message ${type}`;
                const bubbleEl = document.createElement('div');
                bubbleEl.className = `bubble ${type}-bubble`;
                bubbleEl.innerHTML = content;
                messageEl.appendChild(bubbleEl);
                chatBox.appendChild(messageEl);
                chatBox.scrollTop = chatBox.scrollHeight;
                return bubbleEl;
            }

            function typeMessage(text, type) {
                // Apply the new structured text formatting first
                const structuredText = formatStructuredText(text);
                const finalHtml = processLinks(formatBotAnswer(structuredText)).replace(/\n/g, '<br>');
                
                const messageEl = document.createElement('div');
                messageEl.className = `message ${type}`;
                const bubbleEl = document.createElement('div');
                bubbleEl.className = `bubble ${type}-bubble`;
                messageEl.appendChild(bubbleEl);
                chatBox.appendChild(messageEl);
                
                let i = 0;
                bubbleEl.innerHTML = "▋";
                const interval = setInterval(() => {
                    if (i < structuredText.length) {
                        const currentText = structuredText.substring(0, i + 1);
                        bubbleEl.innerHTML = processLinks(formatBotAnswer(currentText)).replace(/\n/g, '<br>') + "▋";
                        chatBox.scrollTop = chatBox.scrollHeight;
                        i++;
                    } else {
                        clearInterval(interval);
                        bubbleEl.innerHTML = finalHtml;
                        chatBox.scrollTop = chatBox.scrollHeight;
                    }
                }, 25);
            }
            
            // UPDATED: New animated image FAQ display
            async function displayImageFaq(faq) {
                const imageUrls = Array.isArray(faq.imageUrl) ? faq.imageUrl : [faq.imageUrl];
                if (imageUrls.length === 0) return;

                let moreIndicator = '';
                if (imageUrls.length > 1) {
                    moreIndicator = `<div class="image-more-indicator">+${imageUrls.length - 1} more</div>`;
                }

                const initialContent = `
                    <div class="p-1">
                        <p class="font-bold text-lg text-gray-800 mb-2">${faq.imageTitle || ''}</p>
                        <div class="image-preview-container" onclick="window.jarvis.openImageGallery(JSON.parse(decodeURIComponent('${encodeURIComponent(JSON.stringify(imageUrls))}')))">
                            <img src="${imageUrls[0]}" alt="${faq.imageTitle || 'Image'}" class="image-faq-img w-full rounded-lg border-2 border-gray-200 shadow-md">
                            ${moreIndicator}
                        </div>
                        <div class="description-container mt-3"></div>
                    </div>`;

                const bubbleEl = appendRichMessage(initialContent, "bot");
                const descriptionContainer = bubbleEl.querySelector('.description-container');

                if (faq.answer && descriptionContainer) {
                    await typeMessageIntoElement(faq.answer, descriptionContainer);
                }
            }

            function typeMessageIntoElement(text, element) {
                return new Promise(resolve => {
                    const structuredText = formatStructuredText(text);
                    const finalHtml = processLinks(formatBotAnswer(structuredText)).replace(/\n/g, '<br>');
                    let i = 0;
                    element.innerHTML = "▋";
                    const interval = setInterval(() => {
                        if (i < structuredText.length) {
                            const currentText = structuredText.substring(0, i + 1);
                            element.innerHTML = processLinks(formatBotAnswer(currentText)).replace(/\n/g, '<br>') + "▋";
                            chatBox.scrollTop = chatBox.scrollHeight;
                            i++;
                        } else {
                            clearInterval(interval);
                            element.innerHTML = finalHtml;
                            chatBox.scrollTop = chatBox.scrollHeight;
                            resolve();
                        }
                    }, 25);
                });
            }

            // --- All other functions remain unchanged ---
            function findMatchingMembers(query) { if (!cachedMemberIndex) return []; const lowerQuery = String(query).toLowerCase().trim(); if (lowerQuery.length < 1) return []; return cachedMemberIndex.filter(m => m.name && m.name.toLowerCase().includes(lowerQuery)); }
            function findMatchingFaqs(query, limit) { if (!cachedFaqs) return []; const lowerQuery = String(query).toLowerCase().trim(); if (lowerQuery.length < 2) return []; return cachedFaqs.map(faq => { let searchText = ''; if (faq.type === 'image') { searchText = `${faq.imageTitle || ''} ${faq.questions.join(' ')} ${faq.answer || ''}`; } else { searchText = `${faq.answer || ''} ${faq.questions.join(' ')} ${faq.category || ''}`; } return { ...faq, score: getWordMatchScore(lowerQuery, searchText.toLowerCase()) }; }).filter(faq => faq.score > 0).sort((a, b) => b.score - a.score).slice(0, limit); }
            function getWordMatchScore(query, text) { const queryWords = new Set(query.toLowerCase().split(/\s+/).filter(w => w.length > 2)); const textWords = new Set(text.toLowerCase().split(/\s+/)); let score = 0; for (const word of queryWords) { if (textWords.has(word)) score++; } return score; }
            function showDefaultSuggestions() { suggestionsBox.innerHTML = ''; const suggestions = ['बैंक कम्युनिटी लोन क्या है?', 'SIP kab jama karna hota hai?', 'Smart slab system']; suggestions.forEach(text => { const pill = document.createElement('button'); pill.className = 'suggestion-pill bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm'; pill.innerHTML = `<i class="fas fa-question-circle mr-2"></i>${text}`; pill.onclick = () => { inputBox.value = text; handleSend(); }; suggestionsBox.appendChild(pill); }); }
            function showSuggestions(query) { suggestionsBox.innerHTML = ''; if (!query || query.length < 2) { showDefaultSuggestions(); return; } const memberSuggestions = findMatchingMembers(query).slice(0, 2); const faqSuggestions = findMatchingFaqs(query, 2); const allSuggestions = [...memberSuggestions, ...faqSuggestions]; if (allSuggestions.length === 0) { showDefaultSuggestions(); return; } allSuggestions.forEach(s => { const text = s.id ? s.name : s.questions[0]; const type = s.id ? 'member' : 'faq'; const pill = document.createElement('button'); pill.className = `suggestion-pill px-3 py-1 rounded-full text-sm ${type === 'member' ? 'bg-gray-200 text-gray-700' : 'bg-blue-100 text-blue-700'}`; pill.innerHTML = `<i class="fas ${type === 'member' ? 'fa-user' : 'fa-question-circle'} mr-2"></i>${text}`; pill.onclick = () => { inputBox.value = text; handleSend(); }; suggestionsBox.appendChild(pill); }); }
            function showPostAnswerSuggestions(answeredFaq) { let relatedFaqs = cachedFaqs.filter(f => f.answer !== answeredFaq.answer).slice(0, 3); if (relatedFaqs.length === 0) return; const container = document.createElement('div'); container.className = 'p-2'; container.innerHTML = '<p class="text-sm font-semibold text-gray-600 mb-2">Anya Sawaal:</p>'; const buttonContainer = document.createElement('div'); buttonContainer.className = 'flex flex-wrap justify-start'; relatedFaqs.forEach(faq => { const btn = document.createElement('button'); btn.className = 'post-answer-suggestion'; btn.textContent = faq.questions[0]; btn.onclick = () => handleSend(faq.questions[0]); buttonContainer.appendChild(btn); }); container.appendChild(buttonContainer); appendRichMessage(container.outerHTML, 'bot'); }
            
            // --- NEW: Image Gallery Functions ---
            function updateGalleryView() {
                const galleryImage = document.getElementById('galleryImage');
                const galleryCounter = document.getElementById('galleryCounter');
                galleryImage.src = galleryImages[currentGalleryIndex];
                galleryCounter.textContent = `${currentGalleryIndex + 1} / ${galleryImages.length}`;
            }

            window.jarvis = {
                openImageGallery: (urls, startIndex = 0) => {
                    galleryImages = urls;
                    currentGalleryIndex = startIndex;
                    const modal = document.getElementById('imageGalleryModal');
                    modal.classList.add('active');
                    updateGalleryView();
                },
                closeImageGallery: () => {
                    const modal = document.getElementById('imageGalleryModal');
                    modal.classList.remove('active');
                }
            };
            
            document.getElementById('nextImageBtn').addEventListener('click', () => {
                currentGalleryIndex = (currentGalleryIndex + 1) % galleryImages.length;
                updateGalleryView();
            });

            document.getElementById('prevImageBtn').addEventListener('click', () => {
                currentGalleryIndex = (currentGalleryIndex - 1 + galleryImages.length) % galleryImages.length;
                updateGalleryView();
            });

            // Event listeners
            sendBtn.addEventListener('click', () => handleSend(null));
            inputBox.addEventListener('keyup', (e) => { if (e.key === 'Enter') handleSend(null); });
            inputBox.addEventListener('input', () => showSuggestions(inputBox.value));
            
            initializeBot();
        }

        checkAuthAndInitialize();
    </script>
</body>
</html>

