<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ultimate Lock-Mode Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" />
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <!-- Chart.js for Data Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #2E7D32, #4CAF50);
            --secondary-color: #f0f4f8;
            --user-message-bg: #DCF8C6;
            --bot-message-bg: #ffffff;
            --text-dark: #1C1C1E;
            --text-light: #6C757D;
            --border-color: #e5e7eb;
            --highlight-color: #2563eb;
            --shadow-light: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
            --shadow-md: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        
        body { font-family: 'Inter', 'Segoe UI', sans-serif; background-color: var(--secondary-color); }
        .chat-container { animation: fadeIn 0.5s ease-out; }
        .message { animation: fadeIn 0.3s ease-out; }
        
        .chat-messages::-webkit-scrollbar { width: 6px; }
        .chat-messages::-webkit-scrollbar-track { background: transparent; }
        .chat-messages::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        .chat-messages::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        .suggestion-pill { transition: all 0.2s ease-in-out; }
        .suggestion-pill:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }

        #lock-mode-banner { animation: fadeIn 0.5s ease; }
        .lock-icon-pulse { animation: pulse 2s infinite ease-in-out; }

        .clickable-link { color: var(--highlight-color); font-weight: 600; text-decoration: underline; word-break: break-all; }
        .clickable-link:hover { color: #1d4ed8; }
        .chart-container { padding: 10px; margin-top: 10px; background-color: #f9fafb; border-radius: 8px; max-width: 320px; margin-left: auto; margin-right: auto; }
        
        .capital-king-card { border-left: 4px solid; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .capital-king-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .gold { border-color: #ffd700; } .silver { border-color: #c0c0c0; } .bronze { border-color: #cd7f32; }

        .modal { display: none; position: fixed; inset: 0; background-color: rgba(0,0,0,0.6); z-index: 50; align-items: center; justify-content: center; padding: 1rem; }
        .modal.active { display: flex; }
        .modal-content { background-color: white; border-radius: 0.5rem; box-shadow: var(--shadow-md); padding: 1.5rem; width: 100%; max-width: 40rem; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-body { overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    </style>
</head>
<body class="antialiased">

    <div class="chat-container flex flex-col h-screen max-w-4xl mx-auto bg-white shadow-2xl">
        <header class="relative flex items-center justify-center p-4 bg-gray-800 text-white shadow-lg z-10">
            <h1 class="text-xl font-bold tracking-wider">Ultimate Bank Commity Bot</h1>
        </header>

        <div id="lock-mode-banner" class="hidden flex items-center justify-between p-3 bg-yellow-100 border-b-2 border-yellow-300">
            <div class="flex items-center">
                <i class="fas fa-lock text-yellow-600 text-xl mr-3 lock-icon-pulse"></i>
                <div>
                    <p class="font-bold text-yellow-800">Lock Mode Active</p>
                    <p id="locked-member-name" class="text-sm text-yellow-700"></p>
                </div>
            </div>
            <button id="unlock-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded-full text-sm">Unlock</button>
        </div>

        <div id="chat" class="chat-messages flex-1 p-6 overflow-y-auto bg-secondary-color"></div>

        <div class="bg-white p-4 border-t border-gray-200 shadow-inner">
            <div id="suggestions" class="mb-3 flex flex-wrap gap-2"></div>
            <div class="relative">
                <input type="text" id="input" class="w-full pl-4 pr-12 py-3 bg-gray-100 rounded-full focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Yahan apna sawaal likhein...">
                <button id="send-btn" class="absolute right-2 top-1/2 -translate-y-1/2 bg-green-600 hover:bg-green-700 text-white w-10 h-10 rounded-full flex items-center justify-center transition-transform duration-200 hover:scale-110">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="imageModal" class="modal" onclick="window.chatbot.closeImageModal()">
        <div class="modal-content !p-0 !max-w-[90%] !max-h-[90%]" onclick="event.stopPropagation()">
            <img id="modalImageContent" class="rounded-lg object-contain h-full w-full">
            <span class="absolute top-4 right-6 text-white text-4xl font-bold cursor-pointer" onclick="window.chatbot.closeImageModal()">×</span>
        </div>
    </div>

    <div id="capitalKingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-2xl font-bold">Capital Kings Ranking</h2>
                <button onclick="window.chatbot.closeCapitalModal()" class="text-gray-500 hover:text-black text-3xl">×</button>
            </div>
            <div class="modal-body">
                <p class="text-sm text-gray-600 mb-4">यह रैंकिंग 'स्कोर' पर आधारित है, जिसकी गणना सदस्य द्वारा रखी गई पूँजी (Capital) और उसे रखने की अवधि (Holding Days) के आधार पर की जाती है। केवल सकारात्मक (positive) कैपिटल वाले सदस्य ही इस सूची में शामिल हैं।</p>
                <div id="capital-kings-list" class="space-y-3"></div>
            </div>
        </div>
    </div>
    
    <div id="capitalDetailModal" class="modal">
         <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-2xl font-bold">Capital Score Analysis</h2>
                <button onclick="window.chatbot.closeCapitalDetailModal()" class="text-gray-500 hover:text-black text-3xl">×</button>
            </div>
            <div id="capital-detail-body" class="modal-body">
                <!-- Dynamic content will be injected here -->
            </div>
        </div>
    </div>


    <script>
        // --- Authentication & Initialization ---
        async function checkAuthAndInitialize() {
            try {
                // In a real app, this would fetch from a secure endpoint
                const firebaseConfig = {
                    apiKey: "YOUR_API_KEY",
                    authDomain: "YOUR_AUTH_DOMAIN",
                    databaseURL: "YOUR_DATABASE_URL",
                    projectId: "YOUR_PROJECT_ID",
                    storageBucket: "YOUR_STORAGE_BUCKET",
                    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
                    appId: "YOUR_APP_ID"
                };
                
                firebase.initializeApp(firebaseConfig);
                runChatbotLogic(); // For demo, directly run logic.

            } catch (error) {
                document.getElementById('chat').innerHTML = `<div class="p-4 text-red-600 text-center">Application failed to initialize: ${error.message}</div>`;
            }
        }

        function runChatbotLogic() {
            const database = firebase.database();
            const faqsRef = database.ref('admin/faqs');
            const membersRef = database.ref('members');

            let isBotInitialized = false;
            let cachedMemberIndex = null;
            let cachedFaqs = null;
            let allMembersFullData = null;
            let lockMode = { active: false, member: null };
            let capitalRankings = []; // Cache for capital rankings

            const chatBox = document.getElementById('chat');
            const inputBox = document.getElementById('input');
            const sendBtn = document.getElementById('send-btn');
            const suggestionsBox = document.getElementById('suggestions');
            const lockBanner = document.getElementById('lock-mode-banner');
            const lockedMemberNameEl = document.getElementById('locked-member-name');
            const unlockBtn = document.getElementById('unlock-btn');
            
            // Modals
            const imageModal = document.getElementById('imageModal');
            const capitalKingsModal = document.getElementById('capitalKingsModal');
            const capitalDetailModal = document.getElementById('capitalDetailModal');
            const capitalKingsList = document.getElementById('capital-kings-list');
            const capitalDetailBody = document.getElementById('capital-detail-body');


            async function initializeBot() {
                await typeMessage("नमस्ते! मैं आपका स्मार्ट बैंक असिस्टेंट हूँ।", "bot");
                const typing = appendRichMessage("...", "bot typing");
                try {
                    const [memberSnapshot, faqsSnapshot] = await Promise.all([ membersRef.once('value'), faqsRef.once('value') ]);
                    
                    cachedMemberIndex = [];
                    if (memberSnapshot.exists()) {
                        allMembersFullData = memberSnapshot.val();
                        for (const key in allMembersFullData) {
                            if (allMembersFullData[key].fullName) {
                                cachedMemberIndex.push({ id: key, name: allMembersFullData[key].fullName });
                            }
                        }
                        cachedMemberIndex.sort((a,b) => a.name.localeCompare(b.name));
                        // Pre-calculate capital rankings
                        capitalRankings = calculateCapitalScores().sort((a, b) => b.score - a.score);
                    }

                    cachedFaqs = [];
                    if (faqsSnapshot.exists()) {
                        const faqsData = faqsSnapshot.val();
                        for(const key in faqsData) { if(faqsData[key].questions && faqsData[key].answer) { cachedFaqs.push(faqsData[key]); } }
                    }

                    typing.remove();
                    await typeMessage("आप किसी सदस्य का नाम टाइप कर सकते हैं या कोई नियम पूछ सकते हैं।", "bot");
                    isBotInitialized = true;
                    showPostAnswerSuggestions(); // Show default suggestions

                } catch (error) { console.error("Initialization failed:", error); typing.innerHTML = "त्रुटि: डेटाबेस से कनेक्ट नहीं हो सका।"; }
            }
            
            // --- Core Message Handling ---
            async function handleSend(simulatedQuery = null) {
                if (!isBotInitialized) { await typeMessage("बॉट अभी शुरू हो रहा है, कृपया प्रतीक्षा करें...", "bot"); return; }
                const query = simulatedQuery || inputBox.value.trim();
                if (!query) return;
                
                if (!simulatedQuery) { appendRichMessage(query, "user"); }
                
                inputBox.value = '';
                suggestionsBox.innerHTML = '';
                
                if (lockMode.active) { await processLockedQuery(query, lockMode.member); } 
                else { await processGeneralQuery(query); }
            }

            async function processGeneralQuery(query) {
                const matchingMembers = findMatchingMembers(query);
                const matchingFaqs = findMatchingFaqs(query, 1);
                
                if (query.match(/capital king|capital hold|sabse zyada capital/i)) {
                    await displayCapitalKings();
                    return;
                }

                if (matchingMembers.length === 1 && !query.match(/list|sabhi|all/i)) {
                    await displayMemberDetails(matchingMembers[0].id);
                } else if (matchingMembers.length > 1) {
                    await typeMessage("मुझे इस नाम से मिलते-जुलते कई सदस्य मिले। आप किसके बारे में जानना चाहते हैं?", "bot");
                    matchingMembers.forEach(m => appendMemberClarification(m));
                } else if (matchingFaqs.length > 0) {
                    const topFaq = matchingFaqs[0];
                    await typeMessage(topFaq.answer, "bot");
                    showPostAnswerSuggestions(topFaq);
                } else {
                    await typeMessage(`माफ़ कीजिए, मुझे "${query}" से संबंधित कोई सदस्य या नियम नहीं मिला।`, "bot");
                    showPostAnswerSuggestions();
                }
            }

            async function processLockedQuery(query, member) {
                const memberData = allMembersFullData[member.id];
                if (!memberData) { await typeMessage("त्रुटि: सदस्य का डेटा नहीं मिला।", "bot"); return; }
                
                const summaryData = aggregateMemberData(memberData);
                const topData = findTopContributors(new Date());
                const allTimeTotals = calculateAllTimeTotals();

                const lowerQuery = query.toLowerCase();
                let chartType = null;
                
                if (lowerQuery.includes('sip')) chartType = 'sip';
                else if (lowerQuery.includes('loan')) chartType = 'loan';
                else if (lowerQuery.includes('return')) chartType = 'return';

                if (chartType) {
                    let chartData; let textResponse;
                    
                    if (chartType === 'sip') {
                         if (lowerQuery.includes('total') || lowerQuery.includes('kul')) {
                            // Total SIP query
                            chartData = { totalValue: allTimeTotals.sip, currentUser: { name: member.name, value: summaryData.totalSIP }, topUser: { name: topData.sip_total.name, value: topData.sip_total.amount } };
                            textResponse = `${member.name} का अब तक का कुल SIP योगदान ₹${summaryData.totalSIP.toLocaleString('en-IN')} है। इसकी तुलना आप पूरी कम्युनिटी से नीचे दिए गए चार्ट में देख सकते हैं।`;
                        } else {
                            // Monthly SIP query
                            chartData = { totalValue: topData.sip_monthly.total, currentUser: { name: member.name, value: summaryData.sipStatus.amount }, topUser: { name: topData.sip_monthly.name, value: topData.sip_monthly.amount } };
                            textResponse = `इस महीने ${member.name} का SIP योगदान ₹${summaryData.sipStatus.amount.toLocaleString('en-IN')} है। इसकी तुलना आप पूरी कम्युनिटी से नीचे दिए गए चार्ट में देख सकते हैं।`;
                        }
                    } else if (chartType === 'loan') {
                        chartData = { totalValue: allTimeTotals.loan, currentUser: { name: member.name, value: summaryData.totalLoan }, topUser: { name: topData.loan.name, value: topData.loan.amount } };
                        textResponse = `${member.name} ने अब तक कुल ₹${summaryData.totalLoan.toLocaleString('en-IN')} का लोन लिया है।`;
                        if (summaryData.netLoanOutstanding > 0) {
                            textResponse += ` जिसमें से अभी ₹${summaryData.netLoanOutstanding.toLocaleString('en-IN')} बकाया है।`;
                        }
                        textResponse += ' इसकी तुलना आप पूरी कम्युनिटी से नीचे दिए गए चार्ट में देख सकते हैं।';
                    } else if (chartType === 'return') {
                        chartData = { totalValue: allTimeTotals.return, currentUser: { name: member.name, value: summaryData.totalReturn }, topUser: { name: topData.return.name, value: topData.return.amount } };
                        textResponse = `${member.name} को अब तक कुल ₹${summaryData.totalReturn.toLocaleString('en-IN')} का रिटर्न मिला है। इसकी तुलना आप पूरी कम्युनिटी से नीचे दिए गए चार्ट में देख सकते हैं।`;
                    }
                    await typeMessage(textResponse, "bot");
                    renderComparisonChart(chartData, chartType);
                    return;
                }
                
                // Fallback to Gemini for other queries
                const prompt = `You are a financial analyst AI for a community bank. You are in "Lock Mode" for a member named ${member.name}.
                **CRITICAL RULE:** ONLY answer questions that can be answered using the provided data for ${member.name}. If the user asks a general question, you MUST respond with: "मैं अभी लॉक मोड में हूँ और सिर्फ ${member.name} से जुड़े सवालों का जवाब दे सकता हूँ।"
                **User's Query:** "${query}"
                **Data for ${member.name}:** \`\`\`json ${JSON.stringify({ summary: summaryData, raw: memberData }, null, 2)} \`\`\`
                Provide a conversational, helpful answer in simple Hindi.`;
                
                const responseText = await callGemini(prompt); // Assuming callGemini exists
                await typeMessage(responseText, "bot");
            }

            
            // --- Response Rendering ---
            function formatBotAnswer(content) {
                const keywords = ['लोन', 'loan', 'ब्याज', 'interest', 'SIP', 'पेनल्टी', 'penalty', 'रिटर्न', 'return', 'बाउंस', 'bounced', 'capital', 'पूँजी', 'बकाया'];
                const keywordRegex = new RegExp(`\\b(${keywords.join('|')})\\b`, 'gi');
                // Highlight keywords and numbers with blue bold style
                content = content.replace(keywordRegex, '<strong style="color: var(--highlight-color);">$1</strong>');
                content = content.replace(/(\₹?[\d,]+(\.\d{1,2})?%?)/g, '<strong style="color: var(--highlight-color);">$1</strong>');
                return content;
            }

            function processLinks(content) {
                const urlRegex = /(https?:\/\/[^\s"'<>`]+)/g;
                return content.replace(urlRegex, (url) => `<a href="${url}" target="_blank" class="clickable-link">${url}</a>`);
            }
            
            function appendRichMessage(content, type) { /* ... (same as before) ... */ }
            async function typeMessage(text, type) { /* ... (same as before) ... */ }
            function appendMemberClarification(member) { /* ... (same as before) ... */ }
            async function displayMemberDetails(memberId) { /* ... (same as before) ... */ }
            function renderComparisonChart(data, type) { /* ... (same as before) ... */ }
            
            async function displayCapitalKings(showAll = false) {
                const itemsToShow = showAll ? capitalRankings : capitalRankings.slice(0, 3);
                
                if (!showAll) {
                    await typeMessage("पेश हैं हमारे Capital Kings - वो सदस्य जिन्होंने सबसे लंबे समय तक सबसे ज़्यादा पूँजी (capital) hold की है:", "bot");
                }

                const rankIcons = ['🥇', '🥈', '🥉'];
                const rankColors = ['gold', 'silver', 'bronze'];
                
                if(showAll) capitalKingsList.innerHTML = '';

                itemsToShow.forEach((member, index) => {
                    const cardHtml = `<div class="capital-king-card bg-white p-4 rounded-lg shadow-md mt-2 ${rankColors[index] || ''}" onclick="window.chatbot.showCapitalDetailsModal('${member.id}')">
                        <div class="flex items-center">
                            <span class="text-3xl mr-4">${rankIcons[index] || `<span class="text-lg font-bold">#${index + 1}</span>`}</span>
                            <div>
                                <h3 class="font-bold text-lg">${member.name}</h3>
                                <div class="text-sm text-gray-600 mt-1">
                                    <p><strong>Capital:</strong> ₹${member.capital.toLocaleString('en-IN')}</p>
                                    <p><strong>Score:</strong> ${member.score.toFixed(0)}</p>
                                </div>
                            </div>
                        </div>
                    </div>`;
                    if(showAll) {
                        capitalKingsList.innerHTML += cardHtml;
                    } else {
                        appendRichMessage(cardHtml, 'bot');
                    }
                });
                
                if (!showAll && capitalRankings.length > 3) {
                    const viewMoreBtn = `<button onclick="window.chatbot.displayCapitalKings(true)" class="mt-2 w-full text-center text-blue-600 font-semibold p-2">पूरी रैंकिंग देखें</button>`;
                    appendRichMessage(viewMoreBtn, 'bot');
                }
            }
            
            async function showCapitalDetailsModal(memberId) {
                const memberIndex = capitalRankings.findIndex(m => m.id === memberId);
                if (memberIndex === -1) return;

                const currentMember = capitalRankings[memberIndex];
                const prevMember = memberIndex > 0 ? capitalRankings[memberIndex - 1] : null;
                const nextMember = memberIndex < capitalRankings.length - 1 ? capitalRankings[memberIndex + 1] : null;

                let comparisonHtml = `<div class="text-center mb-6">
                    <div class="text-6xl">${['🥇', '🥈', '🥉'][memberIndex] || `#${memberIndex + 1}`}</div>
                    <h3 class="text-2xl font-bold mt-2">${currentMember.name}</h3>
                    <p class="text-gray-500">Rank ${memberIndex + 1}</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <p class="text-sm text-blue-800 font-semibold">Net Capital</p>
                        <p class="text-2xl font-bold text-blue-900">₹${currentMember.capital.toLocaleString('en-IN')}</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <p class="text-sm text-green-800 font-semibold">Holding Period</p>
                        <p class="text-2xl font-bold text-green-900">${currentMember.holdingDays} <span class="text-base">days</span></p>
                    </div>
                     <div class="bg-purple-50 p-4 rounded-lg">
                        <p class="text-sm text-purple-800 font-semibold">Final Score</p>
                        <p class="text-2xl font-bold text-purple-900">${currentMember.score.toFixed(0)}</p>
                    </div>
                </div>

                <div class="mb-4">
                    <canvas id="capitalComparisonChart"></canvas>
                </div>
                
                <p class="text-sm text-gray-600 text-center">आपका स्कोर, आपकी जमा की गई पूँजी और उसे जमा रखने की अवधि को गुणा करके निकाला जाता है।</p>`;

                capitalDetailBody.innerHTML = comparisonHtml;
                capitalDetailModal.classList.add('active');

                const chartLabels = [];
                const chartData = [];

                if(prevMember) { chartLabels.push(`#${memberIndex} ${prevMember.name}`); chartData.push(prevMember.score); }
                chartLabels.push(`#${memberIndex + 1} ${currentMember.name}`); chartData.push(currentMember.score);
                if(nextMember) { chartLabels.push(`#${memberIndex + 2} ${nextMember.name}`); chartData.push(nextMember.score); }

                const ctx = document.getElementById('capitalComparisonChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: chartLabels,
                        datasets: [{
                            label: 'Capital Score',
                            data: chartData,
                            backgroundColor: [ 'rgba(255, 205, 86, 0.5)', 'rgba(75, 192, 192, 0.5)', 'rgba(255, 99, 132, 0.5)' ],
                            borderColor: [ 'rgb(255, 205, 86)', 'rgb(75, 192, 192)', 'rgb(255, 99, 132)' ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        scales: { x: { beginAtZero: true } },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // --- Utility & Helper Functions ---
            function createSuggestionPill(text) {
                const pill = document.createElement('button');
                pill.className = 'suggestion-pill bg-blue-100 text-blue-700 px-3 py-1.5 rounded-full text-sm font-medium';
                pill.innerHTML = `<i class="fas fa-question-circle mr-2"></i>${text}`;
                pill.onclick = () => { appendRichMessage(text, 'user'); handleSend(text); };
                suggestionsBox.appendChild(pill);
            }
            
            function showTypingSuggestions(query) {
                suggestionsBox.innerHTML = '';
                if (!query || query.length < 2 || lockMode.active) return;

                const memberSuggestions = findMatchingMembers(query).slice(0, 2);
                const faqSuggestions = findMatchingFaqs(query, 2);

                if (memberSuggestions.length === 0 && faqSuggestions.length === 0) return;

                const typingSuggBox = document.createElement('div');
                typingSuggBox.className = "flex flex-wrap gap-2";
                
                memberSuggestions.forEach(s => {
                    const pill = document.createElement('button');
                    pill.className = 'suggestion-pill bg-gray-200 text-gray-700 px-3 py-1.5 rounded-full text-sm';
                    pill.innerHTML = `<i class="fas fa-user mr-2"></i>${s.name}`;
                    pill.onclick = () => { appendRichMessage(s.name, 'user'); handleSend(s.name); };
                    typingSuggBox.appendChild(pill);
                });
                
                faqSuggestions.forEach(s => {
                    const pill = document.createElement('button');
                    pill.className = 'suggestion-pill bg-blue-100 text-blue-700 px-3 py-1.5 rounded-full text-sm';
                    pill.innerHTML = `<i class="fas fa-question-circle mr-2"></i>${s.questions[0]}`;
                    pill.onclick = () => { appendRichMessage(s.questions[0], 'user'); handleSend(s.questions[0]); };
                    typingSuggBox.appendChild(pill);
                });
                suggestionsBox.appendChild(typingSuggBox);
            }

            function showPostAnswerSuggestions(answeredFaq = null) {
                suggestionsBox.innerHTML = '';
                const defaultQuestions = [
                    'बैंक कम्युनिटी लोन क्या है?',
                    'SIP पेनल्टी के नियम क्या हैं?',
                    'Capital Kings कौन हैं?',
                    'लोन पर कितना ब्याज लगता है?'
                ];
                
                let suggestions = defaultQuestions.filter(q => answeredFaq ? !answeredFaq.questions.includes(q) : true);
                
                suggestions.slice(0, 4).forEach(q => createSuggestionPill(q));
            }

            function getWordMatchScore(query, text) { /* ... (same as before) ... */ }
            function findMatchingMembers(query) { /* ... (same as before) ... */ }
            function findMatchingFaqs(query, limit) { /* ... (same as before) ... */ }
            function aggregateMemberData(data) { /* ... (same as before) ... */ }
            function getSipStatus(transactions, date) { /* ... (same as before) ... */ }
            
            function findTopContributors(date) {
                let topSipMonthly = { name: 'N/A', amount: 0, total: 0 },
                    topSipTotal = { name: 'N/A', amount: 0 },
                    topLoan = { name: 'N/A', amount: 0 },
                    topReturn = { name: 'N/A', amount: 0 };
                
                if (!allMembersFullData) return { sip_monthly: topSipMonthly, sip_total: topSipTotal, loan: topLoan, return: topReturn };

                let totalSipThisMonth = 0;
                for (const memberId in allMembersFullData) {
                    const member = allMembersFullData[memberId];
                    if(!member.fullName) continue;
                    
                    const summary = aggregateMemberData(member);
                    const sipStatus = getSipStatus(member.transactions ? Object.values(member.transactions) : [], date);
                    
                    totalSipThisMonth += sipStatus.amount;
                    if (sipStatus.amount > topSipMonthly.amount) {
                        topSipMonthly = { name: member.fullName, amount: sipStatus.amount };
                    }
                    if (summary.totalSIP > topSipTotal.amount) {
                        topSipTotal = { name: member.fullName, amount: summary.totalSIP };
                    }
                    if (summary.totalLoan > topLoan.amount) {
                        topLoan = { name: member.fullName, amount: summary.totalLoan };
                    }
                    if (summary.totalReturn > topReturn.amount) {
                        topReturn = { name: member.fullName, amount: summary.totalReturn };
                    }
                }
                topSipMonthly.total = totalSipThisMonth;
                return { sip_monthly: topSipMonthly, sip_total: topSipTotal, loan: topLoan, return: topReturn };
            }

            function calculateAllTimeTotals() { /* ... (same as before) ... */ }
            
            function calculateCapitalScores() {
                const results = []; const today = new Date();
                for (const memberId in allMembersFullData) {
                    const member = allMembersFullData[memberId];
                    if (!member.transactions || !member.joiningDate || !member.fullName) continue;
                    
                    const transactions = Object.values(member.transactions).sort((a, b) => new Date(a.Date) - new Date(b.Date));
                    let capitalDays = 0; let currentCapital = 0; let lastDate = new Date(member.joiningDate);
                    
                    transactions.forEach(tx => {
                        const txDate = new Date(tx.Date);
                        const daysDifference = (txDate - lastDate) / (1000 * 3600 * 24);
                        if (daysDifference > 0) { capitalDays += currentCapital * daysDifference; }
                        const sip = parseFloat(tx['SIP Payment']) || 0;
                        const payment = parseFloat(tx['Loan Payment']) || 0;
                        const loan = parseFloat(tx.Loan) || 0;
                        const returns = parseFloat(tx['Return amount']) || 0;
                        const penalty = parseFloat(tx['Penalty amount']) || 0;
                        
                        currentCapital += sip + payment + returns - loan - penalty;
                        lastDate = txDate;
                    });
                    
                    const finalCapital = aggregateMemberData(member).netBalance;
                    const daysSinceLastTx = (today - lastDate) / (1000 * 3600 * 24);
                    if(daysSinceLastTx > 0) capitalDays += currentCapital * daysSinceLastTx;
                    
                    const holdingDays = Math.floor((today - new Date(member.joiningDate)) / (1000 * 3600 * 24));

                    if (finalCapital > 0 && holdingDays > 0) {
                        // The score is an integration of capital over time.
                        const score = capitalDays / 1000; // Dividing by 1000 to keep numbers manageable
                        results.push({ id: memberId, name: member.fullName, capital: finalCapital, holdingDays, score: score });
                    }
                }
                return results;
            }

            // --- Global Functions & Event Listeners ---
            window.chatbot = {
                activateLockMode: (member) => { lockMode = { active: true, member }; lockedMemberNameEl.textContent = `Focused on ${member.name}`; lockBanner.classList.remove('hidden'); suggestionsBox.innerHTML = ''; appendRichMessage(`🔒 Lock Mode **${member.name}** के लिए सक्रिय हो गया है। अब आप सिर्फ़ इनसे जुड़े सवाल पूछ सकते हैं।`, "bot"); },
                deactivateLockMode: () => { appendRichMessage(`🔓 Lock Mode बंद कर दिया गया है।`, "bot"); lockMode = { active: false, member: null }; lockBanner.classList.add('hidden'); showPostAnswerSuggestions(); },
                openImageModal: (imageUrl) => { if (!imageUrl || imageUrl.includes('placehold.co')) return; document.getElementById('modalImageContent').src = imageUrl; imageModal.classList.add('active'); },
                closeImageModal: () => { imageModal.classList.remove('active'); },
                displayMemberDetails: displayMemberDetails,
                displayCapitalKings: (showAll) => {
                    if (showAll) {
                        capitalKingsModal.classList.add('active');
                        displayCapitalKings(true);
                    } else {
                        displayCapitalKings(false);
                    }
                },
                showCapitalDetailsModal: showCapitalDetailsModal,
                closeCapitalModal: () => { capitalKingsModal.classList.remove('active'); },
                closeCapitalDetailModal: () => { capitalDetailModal.classList.remove('active'); }
            };
            
            async function callGemini(prompt) { /* ... (same as before) ... */ }

            sendBtn.addEventListener('click', () => handleSend(null));
            inputBox.addEventListener('keyup', (e) => { if (e.key === 'Enter') { handleSend(null); } else { showTypingSuggestions(inputBox.value); } });
            inputBox.addEventListener('input', () => showTypingSuggestions(inputBox.value));
            unlockBtn.addEventListener('click', window.chatbot.deactivateLockMode);
            
            initializeBot();
        }

        // --- Dummy callGemini for demonstration ---
        async function callGemini(prompt) {
            console.log("Calling Gemini with prompt:", prompt);
            return new Promise(resolve => {
                setTimeout(() => {
                    resolve("यह एक AI द्वारा उत्पन्न उत्तर है। विस्तृत जानकारी के लिए कृपया व्यवस्थापक से संपर्क करें।");
                }, 500);
            });
        }
        
        // --- Dummy Authentication ---
        // For a real app, replace this with your actual Firebase configuration and auth flow.
        (function() {
            console.warn("Running with dummy Firebase config and no authentication.");
            runChatbotLogic();
        })();
    </script>
</body>
</html>