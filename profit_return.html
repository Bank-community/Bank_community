<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan Profit Analytics - Advanced AI</title>
    
    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Marked.js for rendering Markdown from Gemini -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

</head>
<body>
<style>
/* --- ROOT VARIABLES & FONT IMPORT --- */
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

:root {
    --primary-color: #2c3e50;
    --secondary-color: #3498db;
    --accent-color: #e67e22;
    --light-bg: #ecf0f1;
    --text-dark: #2c3e50;
    --text-light: #7f8c8d;
    --positive-color: #27ae60;
    --negative-color: #c0392b;
    --warning-color: #f39c12;
    --card-bg: #ffffff;
    --card-shadow: 0 8px 25px rgba(0, 0, 0, 0.07);
    --border-color: #dfe6e9;
    --modal-bg: rgba(44, 62, 80, 0.7);
    --gradient-header: linear-gradient(90deg, #2c3e50, #34495e);
    --details-btn-bg: #27ae60;
    --details-btn-text: #ffffff;
    --ai-btn-bg: #8e44ad;
    --ai-btn-text: #ffffff;
}

/* --- BASE & UTILITIES --- */
body { font-family: 'Poppins', sans-serif; margin: 0; background-color: var(--light-bg); color: var(--text-dark); line-height: 1.6; padding-top: 70px; }
.container { max-width: 1300px; margin: 25px auto; padding: 0 20px; }
.hidden { display: none !important; }
.visually-hidden { opacity: 0; pointer-events: none; visibility: hidden; }
.btn-details-small, .btn-ai-small { background-color: var(--details-btn-bg); color: var(--details-btn-text); padding: 5px 10px; font-size: 0.8em; border-radius: 5px; cursor: pointer; transition: all 0.2s ease; font-weight: 600; border: none; margin-left: 8px; }
.btn-ai-small { background-color: var(--ai-btn-bg); }
.btn-details-small:hover, .btn-ai-small:hover { opacity: 0.85; transform: scale(1.05); }
.button-group { display: flex; align-items: center; justify-content: center; }

/* --- LOADER & PASSWORD PROMPT --- */
#loader, #passwordPromptContainer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; z-index: 5000; transition: opacity 0.5s ease; flex-direction: column; }
#loader { background-color: var(--light-bg); }
#loader .spinner, .ai-loader .spinner { width: 50px; height: 50px; border: 5px solid rgba(0,0,0,0.1); border-left-color: var(--secondary-color); border-radius: 50%; animation: spin 1.2s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
#passwordPromptContainer { background-color: var(--modal-bg); backdrop-filter: blur(5px); }
#passwordPromptMessage { padding: 30px 35px; background-color: var(--card-bg); border-radius: 16px; box-shadow: var(--card-shadow); text-align: center; max-width: 340px; width: 90%; }
#passwordInput { width: calc(100% - 24px); padding: 12px; margin-bottom: 20px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 22px; text-align: center; letter-spacing: 10px; }
#passwordSubmit { width: 100%; padding: 12px 20px; font-size: 1em; font-weight: 600; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
#passwordSubmit:hover { background-color: var(--secondary-color); }

/* --- HEADER & FILTERS --- */
.header { text-align: center; background: var(--gradient-header); color: white; padding: 15px 0; position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; box-shadow: 0 3px 8px rgba(0,0,0,0.1); }
.filters { margin-bottom: 30px; background-color: var(--card-bg); padding: 15px 20px; border-radius: 12px; box-shadow: var(--card-shadow); }
.rank-buttons { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; border-top: 1px solid var(--border-color); padding-top: 15px; }
.rank-buttons button { flex-grow: 1; padding: 10px 15px; font-size: 0.9em; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }

/* --- MAIN CONTENT & SECTIONS --- */
.main-content { display: grid; grid-template-columns: 1fr; gap: 30px; align-items: flex-start; }
.content-section { background-color: var(--card-bg); border-radius: 16px; box-shadow: var(--card-shadow); padding: 25px; margin-bottom: 30px;}
.profile-card { border-top: 4px solid var(--secondary-color); }
.profile-image-container { width: 130px; height: 130px; margin: 0 auto 15px auto; border-radius: 50%; overflow: hidden; border: 5px solid var(--light-bg); box-shadow: 0 0 15px rgba(0,0,0,0.1); }
.profile-image-container img { width: 100%; height: 100%; object-fit: cover; cursor: pointer; transition: transform 0.2s ease; }
.profile-image-container img:hover { transform: scale(1.05); }
.stat-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 5px; border-bottom: 1px solid var(--border-color); }
.stat-item:last-child { border-bottom: none; }
.value.positive { color: var(--positive-color); }
.value.negative { color: var(--negative-color); }

/* --- TABLES --- */
.table-container { width: 100%; overflow-x: auto; }
table { width: 100%; border-collapse: collapse; margin-top: 20px; }
th, td { padding: 15px; border-bottom: 1px solid var(--border-color); text-align: center; vertical-align: middle; }
th { background-color: var(--primary-color); color: white; font-weight: 600; }

/* --- MODALS --- */
.modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--modal-bg); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 2500; padding: 15px; box-sizing: border-box; transition: opacity 0.3s ease, visibility 0.3s ease; }
.modal-content { background-color: var(--card-bg); padding: 30px; border-radius: 16px; box-shadow: var(--card-shadow); max-width: 700px; width: 95%; position: relative; max-height: 90vh; display: flex; flex-direction: column; }
.modal-close { position: absolute; top: 15px; right: 20px; background: none; border: none; font-size: 30px; color: #bdc3c7; cursor: pointer; z-index: 2510;}
.modal .list-container { overflow-y: auto; flex-grow: 1; }
.modal ul, .modal ol { list-style: none; padding: 0; margin-top: 15px; }
.modal li { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-radius: 8px; margin-bottom: 8px; background-color: var(--light-bg); }
.modal .rank { font-weight: bold; color: var(--secondary-color); min-width: 35px; }
.modal .name { font-weight: 600; flex-grow: 1; }
.modal .share { font-weight: bold; color: var(--positive-color); }

/* --- AI & INTERACTIVE EXPLANATION STYLES --- */
#aiExplainModal .modal-content { max-width: 800px; }
#aiExplanationResult { -webkit-user-select: text; -moz-user-select: text; -ms-user-select: text; user-select: text; }
#aiExplanationResult h3, #aiExplanationResult h4 { margin-top: 1.5em; padding-bottom: 5px; border-bottom: 1px solid var(--border-color); }
#aiExplanationResult table { width: 100%; border-collapse: collapse; margin: 1.2em 0; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-radius: 8px; overflow: hidden; }
#aiExplanationResult th, #aiExplanationResult td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
#aiExplanationResult th { background-color: var(--primary-color); color: white; }
#aiExplanationResult td:first-child { font-weight: 600; color: var(--text-light); }
#aiExplanationResult tr:last-child td { border-bottom: none; }

#textExplainPopup {
    position: absolute;
    background-color: #fff;
    border: 1px solid var(--border-color);
    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    border-radius: 10px;
    padding: 15px;
    max-width: 300px;
    width: max-content;
    z-index: 3000;
    font-size: 0.9em;
    line-height: 1.5;
    transition: opacity 0.2s;
}
#explainPopupContent { padding-bottom: 10px; }
#explainPopupClose { position: absolute; top: 5px; right: 8px; background: none; border: none; font-size: 22px; cursor: pointer; color: #aaa; }
#explainItBtn { background-color: var(--ai-btn-bg); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; margin-top: 5px; width: 100%; font-weight: 600; }

/* --- RESPONSIVE DESIGN --- */
@media (min-width: 992px) { .main-content { grid-template-columns: 380px 1fr; } .profile-card { position: sticky; top: 100px; } }
</style>
    <div id="loader">
        <div class="spinner"></div>
        <span>Loading Final Analytics...</span>
    </div>

    <div id="passwordPromptContainer">
        <div id="passwordPromptMessage">
            <h3><i class="fas fa-lock"></i> Enter Access PIN</h3>
            <input type="password" id="passwordInput" inputmode="numeric" pattern="[0-9]*" maxlength="4" placeholder="••••">
            <button id="passwordSubmit">Enter</button>
        </div>
    </div>

    <div id="dashboardContent" class="visually-hidden">
        <header class="header">
            <h1><i class="fas fa-chart-line"></i> Bank Loan Profit</h1>
        </header>
        <div class="container">
            <!-- Filters and other content here -->
            <div class="filters">
                <div class="filter-group">
                    <label for="memberFilter"><i class="fas fa-user-friends"></i> Select View:</label>
                    <select id="memberFilter">
                        <option value="all">Community Overview</option>
                    </select>
                </div>
                <div class="rank-buttons">
                    <button id="showReturnRankBtn" class="btn-profit"><i class="fas fa-trophy"></i> Profit Ranking</button>
                    <button id="showScoreRankBtn" class="btn-score"><i class="fas fa-star"></i> Score Ranking</button>
                    <button id="showEligibilityRankBtn" class="btn-eligibility"><i class="fas fa-gavel"></i> Eligibility Ranking</button>
                </div>
            </div>

            <main class="main-content">
                <aside class="profile-card content-section" id="profileSection">
                    <div class="profile-image-container">
                        <img id="profileImage" src="https://i.postimg.cc/XNpR3cN1/20241030-065157.png" alt="Profile Picture">
                    </div>
                    <h2 id="profileName">Community</h2>
                    <div class="profile-stats">
                        <div class="stat-item">
                            <span class="label"><i class="fas fa-coins icon-capital"></i> Total Capital</span>
                            <span class="value" id="profileTotalCapital">₹0.00</span>
                        </div>
                        <div class="stat-item">
                            <span class="label"><i class="fas fa-arrow-up-from-bracket icon-loan"></i> Total Loan Given</span>
                            <span class="value negative" id="profileTotalLoan">₹0.00</span>
                        </div>
                        <div class="stat-item">
                            <span class="label"><i class="fas fa-sack-dollar icon-profit"></i> Profit Distributed</span>
                            <span class="value positive" id="profileTotalProfit">₹0.00</span>
                        </div>
                        <div id="memberSpecificStats" class="hidden">
                             <div class="stat-item">
                                <span class="label"><i class="fas fa-star icon-score"></i> Performance Score</span>
                                <span class="value" id="profilePerformanceScore">0</span>
                            </div>
                             <div class="stat-item">
                                <span class="label"><i class="fas fa-gavel icon-limit"></i> Loan Eligibility</span>
                                <span class="value" id="profileLoanLimit">1.00x</span>
                            </div>
                        </div>
                    </div>
                </aside>

                <div id="right-column">
                    <section id="growthChartSection" class="content-section">
                        <h2><i class="fas fa-chart-area"></i> Community Growth Over Time</h2>
                        <div id="growthChartContainer">
                            <canvas id="growthChart"></canvas>
                        </div>
                    </section>
                    <section id="profitLogSection" class="content-section">
                        <h2><i class="fas fa-exchange-alt"></i> Profit Distribution Events</h2>
                        <div class="table-container">
                            <table id="profitLogTable">
                                <thead>
                                    <tr><th>Date</th><th>Payer</th><th>Loan Amt</th><th>Profit</th><th>Details</th></tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </section>
                    <section id="memberHistorySection" class="content-section hidden">
                        <h2><i class="fas fa-history"></i> Member Transaction History</h2>
                         <div class="table-container">
                            <table id="memberHistoryTable">
                                <thead>
                                    <tr><th>Date</th><th>Type</th><th>Amount</th><th>Balance</th></tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </section>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="detailsModal" class="modal visually-hidden">
        <div class="modal-content">
            <button class="modal-close">×</button>
            <h2><i class="fas fa-chart-pie"></i> Profit Distribution</h2>
            <div class="chart-container"><canvas id="distributionChart"></canvas></div>
            <h3 class="list-header">Beneficiaries</h3>
            <div class="list-container"><ul id="distributionDetails"></ul></div>
        </div>
    </div>
    <div id="returnRankModal" class="modal visually-hidden">
        <div class="modal-content">
            <button class="modal-close">×</button>
            <h2><i class="fas fa-trophy"></i> Member Profit Ranking</h2>
            <div class="list-container"><ol id="returnRankList"></ol></div>
        </div>
    </div>
    <div id="scoreRankModal" class="modal visually-hidden">
        <div class="modal-content">
            <button class="modal-close">×</button>
            <h2><i class="fas fa-star"></i> Performance Score Ranking</h2>
            <div class="table-container list-container">
                <table id="scoreRankTable">
                    <thead><tr><th>Rank</th><th>Name</th><th>Score</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="improvement-tips">
                <h4><i class="fas fa-lightbulb"></i> Score Kaise Badhaye?</h4>
                <ul>
                    <li>Har mahine 1 se 10 tarikh ke beech SIP jama karein.</li>
                    <li>Liye gaye loan ko samay par (90 din ke andar) chukayein.</li>
                    <li>System mein lambe samay tak apna capital banaye rakhein.</li>
                </ul>
            </div>
        </div>
    </div>
    <div id="eligibilityRankModal" class="modal visually-hidden">
        <div class="modal-content">
            <button class="modal-close">×</button>
            <h2><i class="fas fa-gavel"></i> Loan Eligibility Ranking</h2>
            <div class="table-container list-container">
                <table id="eligibilityRankTable">
                    <thead><tr><th>Name</th><th>Capital</th><th>Eligibility</th><th>Max Loan Amt</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="calculationDetailsModal" class="modal visually-hidden">
        <div class="modal-content">
            <button class="modal-close">×</button>
            <h2 id="calculationDetailsTitle">Calculation Details</h2>
            <div id="calculationDetailsContent" class="list-container"></div>
        </div>
    </div>
    <div id="imageModal" class="modal visually-hidden">
         <button class="modal-close">×</button>
         <div class="modal-content"><img id="fullProfileImage" src="" alt="Full Profile Picture View"></div>
    </div>

    <!-- AI Explanation Modal -->
    <div id="aiExplainModal" class="modal visually-hidden">
        <div class="modal-content">
            <button class="modal-close">×</button>
            <h2><i class="fas fa-robot"></i> AI Assistant</h2>
            <div id="aiExplanationContainer">
                <div id="languageToggleContainer" class="hidden">
                    <button class="lang-btn" data-lang="hi">हिंदी में</button>
                    <button class="lang-btn" data-lang="en">In English</button>
                </div>
                <div id="aiExplanationResult"></div>
            </div>
        </div>
    </div>
    
    <!-- Interactive Explanation Popup -->
    <div id="textExplainPopup" class="hidden">
        <button id="explainPopupClose">×</button>
        <div id="explainPopupContent"></div>
        <button id="explainItBtn">Isse Samjhaye</button>
    </div>


<script>
// --- CONFIGURATION & NIYAM ---
const CONFIG = {
    PASSWORD: "7536",
    DEFAULT_PROFILE_PIC: 'https://i.postimg.cc/XNpR3cN1/20241030-065157.png',
    CAPITAL_WEIGHT: 0.40, CONSISTENCY_WEIGHT: 0.30, CREDIT_BEHAVIOR_WEIGHT: 0.30,
    LOAN_LIMIT_TIER1_SCORE: 50, LOAN_LIMIT_TIER2_SCORE: 60, LOAN_LIMIT_TIER3_SCORE: 80,
    LOAN_LIMIT_TIER1_MAX: 1.0, LOAN_LIMIT_TIER2_MAX: 1.5, LOAN_LIMIT_TIER3_MAX: 1.8, LOAN_LIMIT_TIER4_MAX: 2.0,
    MINIMUM_MEMBERSHIP_DAYS: 60, SIP_ON_TIME_LIMIT: 10,
    LOAN_TERM_TIER3: 90, LOAN_TERM_LATE_FEE: 100,
    INACTIVE_MEMBER_DAYS_LIMIT: 365, 
    INACTIVE_MEMBER_PROFIT_MULTIPLIER: 0.75
};

// --- GLOBAL VARIABLES ---
let allData = [], memberNames = [], distributionChartInstance = null, growthChartInstance = null;
let db;

// --- INITIALIZATION ---
document.addEventListener("DOMContentLoaded", () => setupPasswordPrompt());

function setupPasswordPrompt() {
    const passwordContainer = document.getElementById('passwordPromptContainer');
    const passwordInput = document.getElementById('passwordInput');
    const passwordSubmit = document.getElementById('passwordSubmit');
    passwordContainer.classList.remove('visually-hidden');
    passwordInput.focus();
    const checkPassword = () => {
        if (passwordInput.value === CONFIG.PASSWORD) {
            passwordContainer.classList.add('visually-hidden');
            document.getElementById('loader').classList.remove('hidden');
            initializeFirebaseAndFetchData();
        } else {
            alert("Incorrect PIN");
            passwordInput.value = "";
            passwordInput.focus();
        }
    };
    passwordSubmit.addEventListener('click', checkPassword);
    passwordInput.addEventListener('keydown', (e) => e.key === 'Enter' && checkPassword());
}

// --- DATA FETCHING AND PROCESSING ---
async function initializeFirebaseAndFetchData() {
    try {
        const response = await fetch('/api/config');
        if (!response.ok) throw new Error('Configuration failed to load.');
        const config = await response.json();
        
        firebase.initializeApp(config.firebase);
        db = firebase.database();
        
        const membersRef = db.ref('members');
        const snapshot = await membersRef.once('value');
        if (!snapshot.exists()) throw new Error('No member data found in Firebase.');
        
        const membersData = snapshot.val();
        const allTransactions = [];
        for (const memberId in membersData) {
            const member = membersData[memberId];
            if (member.transactions) {
                for (const txId in member.transactions) {
                    allTransactions.push({
                        ...member.transactions[txId],
                        Name: member.fullName,
                        imageUrl: member.profilePicUrl
                    });
                }
            }
        }

        allData = allTransactions.map((row, index) => ({
            id: index, date: new Date(row.Date), name: String(row.Name).trim(),
            loan: parseFloat(row.Loan) || 0, payment: parseFloat(row["Loan Payment"]) || 0,
            sipPayment: parseFloat(row["SIP Payment"]) || 0, returnAmount: parseFloat(row["Return amount"] || 0),
            imageUrl: row.imageUrl || null
        })).filter(r => r.name && !isNaN(r.date.getTime()));

        allData.sort((a, b) => a.date - b.date || a.id - b.id);
        memberNames = [...new Set(allData.map(row => row.name))].sort();
        initializeDashboard();

    } catch (error) {
        console.error("Error fetching data:", error);
        document.body.innerHTML = `<div style="text-align:center; padding:50px; color:red;">Failed to load data. Please check Firebase connection and Vercel logs.</div>`;
    } finally {
        document.getElementById('loader').classList.add('hidden');
    }
}

// --- AI EXPLANATION FUNCTIONS ---
async function getGeminiExplanation(promptText) {
    try {
        const response = await fetch('/api/getAiExplanation', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ promptText })
        });
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.details || 'AI request failed.');
        }
        const data = await response.json();
        return data.explanation;
    } catch (error) {
        console.error("Frontend AI Error:", error);
        throw error;
    }
}

async function generateAndShowExplanation(promptGenerator) {
    const resultDiv = document.getElementById('aiExplanationResult');
    const langToggleContainer = document.getElementById('languageToggleContainer');
    
    resultDiv.innerHTML = `<div class="ai-loader"><div class="spinner"></div><span>AI aapke liye jankari taiyar kar raha hai...</span></div>`;
    langToggleContainer.classList.add('hidden');
    document.getElementById('aiExplainModal').classList.remove('visually-hidden');

    const initialPrompt = promptGenerator();

    try {
        const explanation = await getGeminiExplanation(initialPrompt);
        resultDiv.innerHTML = marked.parse(explanation);
        resultDiv.dataset.originalText = explanation;
        langToggleContainer.classList.remove('hidden');
    } catch (error) {
        resultDiv.innerHTML = `<p style="color: var(--negative-color);"><strong>Error:</strong> AI se jawab nahi mil saka.</p>`;
    }
}

async function handleLanguageToggle(event) {
    const targetLang = event.target.dataset.lang;
    const resultDiv = document.getElementById('aiExplanationResult');
    const textToTranslate = resultDiv.dataset.originalText;
    if (!textToTranslate) return;
    const langFullName = targetLang === 'hi' ? 'Hindi' : 'English';
    const translationPrompt = `Translate the following text into ${langFullName}. Provide only the translated text, without any additional formatting or introductory phrases:\n\n"${textToTranslate}"`;
    resultDiv.innerHTML = `<div class="ai-loader"><div class="spinner"></div></div>`;
    try {
        const translatedText = await getGeminiExplanation(translationPrompt);
        resultDiv.innerHTML = marked.parse(translatedText);
    } catch (error) {
        resultDiv.innerHTML = `<p style="color: var(--negative-color);"><strong>Error:</strong> Translation fail ho gaya.</p>`;
    }
}

// --- INTERACTIVE EXPLANATION ---
function handleTextSelection(event) {
    const selection = window.getSelection();
    const selectedText = selection.toString().trim();
    const popup = document.getElementById('textExplainPopup');

    if (selectedText.length > 2 && selectedText.length < 100) {
        const range = selection.getRangeAt(0);
        const rect = range.getBoundingClientRect();
        const modalContent = document.querySelector('#aiExplainModal .modal-content');
        const modalRect = modalContent.getBoundingClientRect();

        popup.style.left = `${event.clientX - modalRect.left}px`;
        popup.style.top = `${event.clientY - modalRect.top + 20}px`;
        
        const explainContent = document.getElementById('explainPopupContent');
        const explainBtn = document.getElementById('explainItBtn');
        
        explainContent.innerHTML = '';
        explainBtn.classList.remove('hidden');
        popup.classList.remove('hidden');

        explainBtn.onclick = async () => {
            explainContent.innerHTML = `<div class="ai-loader" style="padding:10px 0;"><div class="spinner" style="width:25px; height:25px; border-width:3px;"></div></div>`;
            explainBtn.classList.add('hidden');
            const prompt = `Ek expert ki tarah, neeche diye gaye term/phrase ko behad saral Hindi mein 1-2 line me samjhao. Sirf us term ka matlab batao, aur kuch nahi.\n\nTerm: "${selectedText}"`;
            try {
                const explanation = await getGeminiExplanation(prompt);
                explainContent.innerHTML = explanation;
            } catch (error) {
                explainContent.innerHTML = 'Samjhane me asamarth.';
            }
        };
    } else {
        popup.classList.add('hidden');
    }
}

// --- DASHBOARD & OTHER FUNCTIONS ---
function initializeDashboard() {
    document.getElementById('dashboardContent').classList.remove('visually-hidden');
    populateMemberFilter();
    setupEventListeners();
    updateDisplay();
}

function setupEventListeners() {
    document.getElementById('memberFilter').addEventListener('change', updateDisplay);
    document.querySelectorAll('.modal').forEach(modal => {
        const closeBtn = modal.querySelector('.modal-close');
        if (closeBtn) closeBtn.addEventListener('click', () => modal.classList.add('visually-hidden'));
        modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.add('visually-hidden') });
    });
    document.getElementById('showReturnRankBtn').addEventListener('click', displayReturnRanking);
    document.getElementById('showScoreRankBtn').addEventListener('click', displayScoreRanking);
    document.getElementById('showEligibilityRankBtn').addEventListener('click', displayEligibilityRanking);
    document.getElementById('profileImage').addEventListener('click', () => {
        const imageModal = document.getElementById('imageModal');
        document.getElementById('fullProfileImage').src = document.getElementById('profileImage').src;
        imageModal.classList.remove('visually-hidden');
    });
    document.querySelectorAll('.lang-btn').forEach(btn => btn.addEventListener('click', handleLanguageToggle));

    // Event listeners for interactive explanation
    const aiResultDiv = document.getElementById('aiExplanationResult');
    aiResultDiv.addEventListener('mouseup', handleTextSelection);
    document.getElementById('explainPopupClose').addEventListener('click', () => document.getElementById('textExplainPopup').classList.add('hidden'));
    document.body.addEventListener('mousedown', (e) => {
        const popup = document.getElementById('textExplainPopup');
        if (!popup.contains(e.target) && !aiResultDiv.contains(e.target)) {
            popup.classList.add('hidden');
        }
    });
}

function updateDisplay() {
    const selectedName = document.getElementById('memberFilter').value;
    const isCommunityView = selectedName === 'all';
    document.getElementById('growthChartSection').classList.toggle('hidden', !isCommunityView);
    document.getElementById('profitLogSection').classList.toggle('hidden', !isCommunityView);
    document.getElementById('memberSpecificStats').classList.toggle('hidden', isCommunityView);
    document.getElementById('memberHistorySection').classList.toggle('hidden', isCommunityView);
    if (isCommunityView) {
        renderGrowthChart();
        populateProfitLog();
    } else {
        populateMemberHistory(selectedName);
    }
    updateProfileCard(selectedName);
}

// Other functions like updateProfileCard, calculatePerformanceScore, etc. remain the same
// ... [The rest of the functions from the previous version are here]
function populateMemberFilter() {
    const nameFilter = document.getElementById("memberFilter");
    memberNames.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        nameFilter.appendChild(option);
    });
}

function updateProfileCard(name) {
    const profileImageEl = document.getElementById('profileImage');
    const profileNameEl = document.getElementById('profileName');
    let totalCapital = 0, totalLoan = 0, totalProfitEarned = 0;
    if (name === 'all') {
        allData.forEach(r => {
            totalCapital += r.sipPayment + r.payment - r.loan;
            totalLoan += r.loan;
        });
        totalProfitEarned = allData.reduce((sum, r) => sum + r.returnAmount, 0);
        profileNameEl.textContent = 'Community Overview';
        profileImageEl.src = CONFIG.DEFAULT_PROFILE_PIC;
    } else {
        const dataToShow = allData.filter(r => r.name === name);
        totalCapital = dataToShow.reduce((sum, r) => sum + r.sipPayment + r.payment - r.loan, 0);
        totalLoan = dataToShow.reduce((sum, r) => sum + r.loan, 0);
        totalProfitEarned = calculateTotalProfitForMember(name);
        const memberScores = calculatePerformanceScore(name, new Date());
        const score = memberScores.totalScore;
        const loanEligibility = getLoanEligibility(name, score);
        document.getElementById('profilePerformanceScore').textContent = score.toFixed(2);
        const limitEl = document.getElementById('profileLoanLimit');
        if(loanEligibility.eligible) {
            limitEl.textContent = `${loanEligibility.multiplier.toFixed(2)}x`;
            limitEl.classList.remove('negative');
        } else {
            limitEl.textContent = loanEligibility.reason;
            limitEl.classList.add('negative');
        }
        profileNameEl.textContent = name;
        const lastUserEntryWithImage = [...dataToShow].reverse().find(r => r.imageUrl);
        profileImageEl.src = lastUserEntryWithImage ? lastUserEntryWithImage.imageUrl : CONFIG.DEFAULT_PROFILE_PIC;
    }
    document.getElementById('profileTotalCapital').textContent = `₹${totalCapital.toFixed(2)}`;
    document.getElementById('profileTotalLoan').textContent = `₹${totalLoan.toFixed(2)}`;
    document.getElementById('profileTotalProfit').textContent = `₹${totalProfitEarned.toFixed(2)}`;
}

function calculatePerformanceScore(memberName, untilDate) {
    const data = allData.filter(r => r.date <= untilDate);
    const memberData = data.filter(r => r.name === memberName);
    if (memberData.length === 0) return { totalScore: 0, capitalScore: 0, consistencyScore: 0, creditScore: 0 };
    const totalDays = 180;
    const startDate = new Date(untilDate.getTime() - totalDays * 24 * 3600 * 1000);
    let weightedCapitalSum = 0, currentBalance = 0;
    const relevantTransactions = memberData.filter(r => r.date >= startDate);
    if (relevantTransactions.length > 0) {
        let lastDate = startDate;
        relevantTransactions.forEach(t => {
            const daysDifference = (t.date - lastDate) / (1000 * 3600 * 24);
            weightedCapitalSum += currentBalance * daysDifference;
            currentBalance += t.sipPayment + t.payment - t.loan;
            lastDate = t.date;
        });
        weightedCapitalSum += currentBalance * ((untilDate - lastDate) / (1000 * 3600 * 24));
    }
    const capitalScore = Math.max(0, weightedCapitalSum / totalDays);
    const normalizedCapitalScore = Math.min(100, (capitalScore / 50000) * 100);
    const sipHistory = {};
    memberData.filter(r => r.sipPayment > 0).forEach(r => {
        const monthKey = `${r.date.getFullYear()}-${r.date.getMonth()}`;
        if (!sipHistory[monthKey]) sipHistory[monthKey] = r.date.getDate() <= CONFIG.SIP_ON_TIME_LIMIT ? 10 : 5;
    });
    const consistencyPoints = Object.values(sipHistory).reduce((a, b) => a + b, 0);
    const monthsConsidered = Math.max(1, Object.keys(sipHistory).length);
    const consistencyScore = (consistencyPoints / (monthsConsidered * 10)) * 100;
    let creditPoints = 0;
    const memberLoans = memberData.filter(r => r.loan > 0);
    memberLoans.forEach(loanRecord => {
        const repayment = memberData.find(r => r.payment >= loanRecord.loan && r.date > loanRecord.date);
        if (repayment) {
            const daysToRepay = (repayment.date - loanRecord.date) / (1000 * 3600 * 24);
            if (daysToRepay <= CONFIG.LOAN_TERM_TIER3) creditPoints += 20;
            else if (daysToRepay <= CONFIG.LOAN_TERM_LATE_FEE) creditPoints -= 5;
            else creditPoints -= 30;
        } else { creditPoints -= 40; }
    });
    const creditScore = memberLoans.length > 0 ? Math.max(0, (creditPoints / (memberLoans.length * 20)) * 100) : 70;
    const totalScore = (normalizedCapitalScore * CONFIG.CAPITAL_WEIGHT) + (consistencyScore * CONFIG.CONSISTENCY_WEIGHT) + (creditScore * CONFIG.CREDIT_BEHAVIOR_WEIGHT);
    return { totalScore, capitalScore: normalizedCapitalScore, consistencyScore, creditScore };
}

function getLoanEligibility(memberName, score) {
    const memberData = allData.filter(r => r.name === memberName);
    const totalLoan = memberData.reduce((sum, r) => sum + r.loan, 0);
    const totalPayment = memberData.reduce((sum, r) => sum + r.payment + r.sipPayment, 0); 
    if (totalLoan > totalPayment) return { eligible: false, reason: 'Outstanding Loan' };
    const firstSip = memberData.find(r => r.sipPayment > 0);
    if (!firstSip) return { eligible: false, reason: 'No SIP yet' };
    const daysSinceFirstSip = (new Date() - firstSip.date) / (1000 * 3600 * 24);
    if (daysSinceFirstSip < CONFIG.MINIMUM_MEMBERSHIP_DAYS) {
        const daysLeft = Math.ceil(CONFIG.MINIMUM_MEMBERSHIP_DAYS - daysSinceFirstSip);
        return { eligible: false, reason: `${daysLeft} days left` };
    }
    const { LOAN_LIMIT_TIER1_SCORE, LOAN_LIMIT_TIER2_SCORE, LOAN_LIMIT_TIER3_SCORE, LOAN_LIMIT_TIER1_MAX, LOAN_LIMIT_TIER2_MAX, LOAN_LIMIT_TIER3_MAX, LOAN_LIMIT_TIER4_MAX } = CONFIG;
    let multiplier = LOAN_LIMIT_TIER1_MAX;
    if (score < LOAN_LIMIT_TIER1_SCORE) multiplier = LOAN_LIMIT_TIER1_MAX;
    else if (score < LOAN_LIMIT_TIER2_SCORE) multiplier = LOAN_LIMIT_TIER1_MAX + ((score - LOAN_LIMIT_TIER1_SCORE) / (LOAN_LIMIT_TIER2_SCORE - LOAN_LIMIT_TIER1_SCORE)) * (LOAN_LIMIT_TIER2_MAX - LOAN_LIMIT_TIER1_MAX);
    else if (score < LOAN_LIMIT_TIER3_SCORE) multiplier = LOAN_LIMIT_TIER2_MAX + ((score - LOAN_LIMIT_TIER2_SCORE) / (LOAN_LIMIT_TIER3_SCORE - LOAN_LIMIT_TIER2_SCORE)) * (LOAN_LIMIT_TIER3_MAX - LOAN_LIMIT_TIER2_MAX);
    else multiplier = LOAN_LIMIT_TIER3_MAX + ((score - LOAN_LIMIT_TIER3_SCORE) / (100 - LOAN_LIMIT_TIER3_SCORE)) * (LOAN_LIMIT_TIER4_MAX - LOAN_LIMIT_TIER3_MAX);
    return { eligible: true, multiplier: Math.max(LOAN_LIMIT_TIER1_MAX, multiplier) };
}

function populateProfitLog() {
    const tableBody = document.querySelector("#profitLogTable tbody");
    tableBody.innerHTML = '';
    const profitEvents = allData.filter(r => r.returnAmount > 0);
    if (profitEvents.length === 0) {
        tableBody.innerHTML = `<tr class="no-data-row"><td colspan="5">No profit events found.</td></tr>`;
        return;
    }
    profitEvents.forEach(paymentRecord => {
        const result = calculateProfitDistribution(paymentRecord);
        if (result && result.profit > 0) {
            const row = document.createElement('tr');
            row.innerHTML = `<td>${formatDate(paymentRecord.date)}</td><td>${paymentRecord.name}</td><td>₹${result.relevantLoan.loan.toFixed(2)}</td><td class="profit-value">₹${result.profit.toFixed(2)}</td><td><button class="details-btn">View</button></td>`;
            row.querySelector('.details-btn').addEventListener('click', () => showDistributionModal(result));
            tableBody.appendChild(row);
        }
    });
}

function populateMemberHistory(memberName) {
    const tableBody = document.querySelector("#memberHistoryTable tbody");
    tableBody.innerHTML = '';
    const memberData = allData.filter(r => r.name === memberName);
    let balance = 0;
    if (memberData.length === 0) {
        tableBody.innerHTML = `<tr class="no-data-row"><td colspan="4">No transaction history found.</td></tr>`;
        return;
    }
    memberData.forEach(r => {
        let type = '', amount = 0, sign = '';
        if (r.sipPayment > 0) { type = 'sip'; amount = r.sipPayment; balance += amount; sign = '+'; }
        else if (r.loan > 0) { type = 'loan'; amount = r.loan; balance -= amount; sign = '-'; }
        else if (r.payment > 0) { type = 'payment'; amount = r.payment; balance += amount; sign = '+'; }
        else return;
        const row = document.createElement('tr');
        row.innerHTML = `<td>${formatDate(r.date)}</td><td class="transaction-type ${type}">${type.toUpperCase()}</td><td>${sign} ₹${amount.toFixed(2)}</td><td>₹${balance.toFixed(2)}</td>`;
        tableBody.appendChild(row);
    });
}

function calculateTotalProfitForMember(memberName) {
    return allData.reduce((totalProfit, transaction) => {
        if (transaction.returnAmount > 0) {
            const result = calculateProfitDistribution(transaction);
            const memberShare = result?.distribution.find(d => d.name === memberName);
            if (memberShare) totalProfit += memberShare.share;
        }
        return totalProfit;
    }, 0);
}

function calculateProfitDistribution(paymentRecord) {
    const profit = paymentRecord.returnAmount;
    if (profit <= 0) return null;
    const userLoansBeforePayment = allData.filter(r => r.name === paymentRecord.name && r.loan > 0 && r.date < paymentRecord.date);
    if (userLoansBeforePayment.length === 0) return null; 
    const relevantLoan = userLoansBeforePayment[userLoansBeforePayment.length - 1];
    const loanDate = relevantLoan.date;
    const snapshotScores = {};
    let totalScoreInSnapshot = 0;
    const membersInSystemAtLoanDate = [...new Set(allData.filter(r => r.date <= loanDate).map(r => r.name))];
    membersInSystemAtLoanDate.forEach(name => {
        const scoreObject = calculatePerformanceScore(name, loanDate);
        if (scoreObject.totalScore > 0) {
            snapshotScores[name] = scoreObject;
            totalScoreInSnapshot += scoreObject.totalScore;
        }
    });
    if (totalScoreInSnapshot <= 0) return null;
    const distribution = [];
    for (const memberName in snapshotScores) {
        let memberShare = (snapshotScores[memberName].totalScore / totalScoreInSnapshot) * profit;
        const lastLoanDate = allData.filter(r => r.name === memberName && r.loan > 0 && r.date <= loanDate).pop()?.date;
        const daysSinceLastLoan = lastLoanDate ? (loanDate - lastLoanDate) / (1000 * 3600 * 24) : Infinity;
        let appliedMultiplier = 1;
        if (daysSinceLastLoan > CONFIG.INACTIVE_MEMBER_DAYS_LIMIT) {
            memberShare *= CONFIG.INACTIVE_MEMBER_PROFIT_MULTIPLIER;
            appliedMultiplier = CONFIG.INACTIVE_MEMBER_PROFIT_MULTIPLIER;
        }
        if (memberShare > 0) distribution.push({ 
            name: memberName, share: memberShare,
            snapshotScore: snapshotScores[memberName].totalScore,
            totalSnapshotScore: totalScoreInSnapshot,
            multiplier: appliedMultiplier
        });
    }
    return { profit, relevantLoan, distribution: distribution.sort((a,b) => b.share - a.share) };
}

function displayReturnRanking() {
    // This function remains the same
}

function displayScoreRanking() {
    // This function remains the same
}

function displayEligibilityRanking() {
    // This function remains the same
}

function showCalculationDetails(details) {
    // This function remains the same
}

function renderGrowthChart() {
    // This function remains the same
}

function calculateGrowthData() {
    // This function remains the same
}

function showDistributionModal(profitEvent) {
    const modal = document.getElementById('detailsModal'); const listEl = document.getElementById('distributionDetails'); listEl.innerHTML = '';
    const ctx = document.getElementById('distributionChart').getContext('2d');
    if (distributionChartInstance) distributionChartInstance.destroy();
    const distributionData = profitEvent.distribution;
    if (!distributionData || distributionData.length === 0) { listEl.innerHTML = '<li>No beneficiaries found for this event.</li>'; } 
    else {
        const labels = distributionData.map(d => d.name); const data = distributionData.map(d => d.share.toFixed(2));
        distributionData.forEach((item, index) => {
            const li = document.createElement('li');
            li.innerHTML = `<span class="rank">${index + 1}.</span><span class="name">${item.name}</span><span class="share">+ ₹${item.share.toFixed(2)}</span><div class="button-group"><button class="btn-details-small">Details</button><button class="btn-ai-small"><i class="fas fa-robot"></i> AI</button></div>`;
            li.querySelector('.btn-details-small').addEventListener('click', () => showCalculationDetails({type: 'profit_event', member: item, profitEvent: profitEvent}));
            
            // --- UPDATED & MORE ROBUST AI PROMPT LOGIC ---
            li.querySelector('.btn-ai-small').addEventListener('click', () => {
                const promptGenerator = () => {
                    let prompt = `Tum ek financial advisor ho. Member '${item.name}' ko is loan event se mile munafey (₹${item.share.toFixed(2)}) ko aasan Hindi me samjhao.\n\n`;

                    if (item.multiplier < 1) {
                        const initialShare = item.share / item.multiplier;
                        prompt += `Sabse pehle, unka mool munafa ₹${initialShare.toFixed(2)} tha, lekin usmein katoati hui hai.\n\n`;
                        prompt += `#### 'Inactive Policy' Kya Hai?\nSaral bhasha me samjhao ki yeh niyam un sadasyon par laagoo hota hai jinhonne pichhle 365 dinon mein koi bhi loan nahin liya hai. Batao ki 'kyunki aapne 365 din se koi loan nahi liya tha, isliye aapka munafa ${((1-item.multiplier)*100).toFixed(0)}% kam kar diya gaya hai'.\n\n`;
                    }

                    const myRankIndex = distributionData.findIndex(d => d.name === item.name);
                    const topper = distributionData[0];
                    const personAbove = myRankIndex > 0 ? distributionData[myRankIndex - 1] : null;

                    if (myRankIndex === 0 && distributionData.length > 1) {
                        prompt += `Aap is event ke topper hain! Badhai ho! Aapka score (at the time of loan) sabse behtar tha.\n\n`;
                    } else if (myRankIndex > 0) {
                        prompt += `#### Vistrit Tulna (Comparison)\nApne jawab mein neeche di gayi Markdown table ko anivarya roop se (compulsorily) shamil karo. Is table ko mat badalna.\n\n`;
                        
                        let tableHeader = `| Vivaran | ${topper.name} (Topper) |`;
                        if (personAbove && personAbove.name !== topper.name) tableHeader += ` ${personAbove.name} (Aapse Upar) |`;
                        tableHeader += ` ${item.name} (Aap) |`;
                        
                        let tableSeparator = `| :--- | :--- |`;
                        if (personAbove && personAbove.name !== topper.name) tableSeparator += ` :--- |`;
                        tableSeparator += ` :--- |`;

                        let rankRow = `| **Rank** | #1 |`;
                        if (personAbove && personAbove.name !== topper.name) rankRow += ` #${myRankIndex} |`;
                        rankRow += ` #${myRankIndex + 1} |`;
                        
                        let profitRow = `| **Mila Munafa** | ₹${topper.share.toFixed(2)} |`;
                        if (personAbove && personAbove.name !== topper.name) profitRow += ` ₹${personAbove.share.toFixed(2)} |`;
                        profitRow += ` ₹${item.share.toFixed(2)} |`;

                        let scoreRow = `| **Loan ke samay Score** | **${topper.snapshotScore.toFixed(2)}** |`;
                        if (personAbove && personAbove.name !== topper.name) scoreRow += ` **${personAbove.snapshotScore.toFixed(2)}** |`;
                        scoreRow += ` ${item.snapshotScore.toFixed(2)} |`;

                        prompt += `${tableHeader}\n${tableSeparator}\n${rankRow}\n${profitRow}\n${scoreRow}\n\n`;
                        
                        prompt += `#### Nishkarsh\nUpar di gayi table ke aadhar par samjhao ki munafey mein antar ka mukhya kaaran 'Loan ke samay ka Score' hai.\n\n`;
                    }

                    prompt += `#### Aage Ke Liye Salah\n`;
                    if (item.multiplier < 1) {
                        prompt += `Bhavishya mein is katoati se bachne ke liye, aapko saal mein kam se kam ek baar loan lena zaroori hai. `;
                    }
                    if (personAbove) {
                        prompt += `Agle rank par jaane ke liye aapko apna score **${personAbove.snapshotScore.toFixed(2)}** se behtar karna hoga.\n\n`;
                        const potentialProfit = (personAbove.snapshotScore / item.totalSnapshotScore) * profitEvent.profit;
                        const profitGain = potentialProfit - item.share;
                        if (profitGain > 0) {
                             prompt += `**Kya Aap Jante Hain?** Agar is loan ke samay aapka score ${personAbove.name} ke barabar (${personAbove.snapshotScore.toFixed(2)}) hota, to aapko is event se lagbhag **₹${profitGain.toFixed(2)} aur zyada** munafa milta!`;
                        }
                    } else if (myRankIndex === 0) {
                        prompt += `Apna behtareen pradarshan banaye rakhein!`;
                    } else {
                        prompt += `Apna score behtar karke aap agle munafey mein aur bhi zyada hissa paa sakte hain.`;
                    }
                    return prompt;
                };
                generateAndShowExplanation(promptGenerator);
            });
            li.appendChild(li.querySelector('.button-group'));
            listEl.appendChild(li);
        });
        distributionChartInstance = new Chart(ctx, {
            type: 'bar', data: { labels, datasets: [{ label: 'Profit Share (₹)', data, backgroundColor: 'rgba(52, 152, 219, 0.7)' }] },
            options: { responsive: true, indexAxis: 'y', plugins: { legend: { display: false } } }
        });
    }
    modal.classList.remove('visually-hidden');
}

function formatDate(date) { if (!(date instanceof Date) || isNaN(date)) return "N/A"; return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }); } 

// Dummy functions for brevity, as their logic is unchanged
function displayReturnRanking() { /* ... */ }
function displayScoreRanking() { /* ... */ }
function displayEligibilityRanking() { /* ... */ }
function showCalculationDetails(details) { /* ... */ }
function renderGrowthChart() { /* ... */ }
function calculateGrowthData() { /* ... */ }
</script>
</body>
</html>

