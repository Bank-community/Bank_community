<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Loan Form - Trust Community Fund</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  
  <!-- Font Setup: Serif for Headings, Sans for Body -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <style>
    :root {
        --royal-blue: #002366;
        --deep-blue: #001233;
        --royal-gold: #D4AF37;
        --gold-light: #F8E71C;
        --gold-gradient: linear-gradient(135deg, #FFD700 0%, #D4AF37 100%);
        --glass-bg: rgba(255, 255, 255, 0.1);
        --glass-border: 1px solid rgba(212, 175, 55, 0.3);
        --text-white: #ffffff;
        --text-gold: #D4AF37;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(160deg, var(--royal-blue) 0%, var(--deep-blue) 100%);
      color: var(--text-white);
      min-height: 100vh;
      background-attachment: fixed;
    }

    /* === LUXURY FORM CONTAINER === */
    .form-container {
      background: rgba(0, 35, 102, 0.4);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(212, 175, 55, 0.5); /* Gold Border */
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5), 
                  inset 0 0 20px rgba(212, 175, 55, 0.1);
      border-radius: 20px;
    }

    h1.main-title {
        font-family: 'Playfair Display', serif;
        color: var(--royal-gold);
        text-transform: uppercase;
        letter-spacing: 2px;
        text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        border-bottom: 2px solid var(--royal-gold);
        padding-bottom: 10px;
        display: inline-block;
    }

    /* === PREMIUM INPUT FIELDS === */
    label {
        color: #e0e0e0;
        font-weight: 500;
        letter-spacing: 0.5px;
    }

    select, input[type="text"], input[type="number"], input[type="file"] {
        background: rgba(255, 255, 255, 0.05) !important;
        border: 1px solid rgba(255, 255, 255, 0.2) !important;
        color: #fff !important;
        border-radius: 10px !important;
        transition: all 0.3s ease;
    }

    select:focus, input:focus {
        border-color: var(--royal-gold) !important;
        box-shadow: 0 0 15px rgba(212, 175, 55, 0.3) !important;
        outline: none;
        background: rgba(0, 0, 0, 0.2) !important;
    }

    /* Fix for Select Options (Browser handles dropdowns differently) */
    option {
        background-color: var(--deep-blue);
        color: white;
    }

    /* === GOLD BUTTONS === */
    .btn {
      background: var(--gold-gradient);
      color: var(--deep-blue);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      border: none;
      box-shadow: 0 5px 15px rgba(212, 175, 55, 0.3);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(212, 175, 55, 0.5);
      filter: brightness(1.1);
    }
    
    .btn:disabled {
        background: #555;
        color: #888;
        box-shadow: none;
        cursor: not-allowed;
    }

    /* === ROYAL NOTIFICATION BOX === */
    #loanInfoNotification {
        background: rgba(0, 20, 50, 0.6);
        border: 1px solid var(--royal-gold);
        border-radius: 12px;
        color: #e0e0e0;
    }
    
    #loanInfoNotification h3 {
        color: var(--royal-gold);
        border-bottom: 1px solid rgba(212, 175, 55, 0.3);
        padding-bottom: 5px;
        font-family: 'Playfair Display', serif;
    }

    #loanInfoNotification .table th {
        background-color: rgba(212, 175, 55, 0.2);
        color: var(--royal-gold);
        border-color: rgba(212, 175, 55, 0.2);
    }
    
    #loanInfoNotification .table td {
        border-color: rgba(255, 255, 255, 0.1);
    }

    #loanInfoNotification .note {
        background: rgba(255, 215, 0, 0.1);
        border-left: 4px solid var(--royal-gold);
        color: #fff;
    }

    /* === LETTER PREVIEW (CERTIFICATE STYLE) === */
    #capture {
      width: 210mm;
      min-height: 290mm;
      background: #fff; /* Paper color */
      color: #333; /* Ink color */
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
      position: relative;
      border: 10px double #002366; /* Double Border */
      padding: 15mm;
      /* Background Pattern/Watermark */
      background-image: radial-gradient(#002366 0.5px, transparent 0.5px), radial-gradient(#002366 0.5px, #fff 0.5px);
      background-size: 20px 20px;
      background-position: 0 0, 10px 10px;
      background-color: #fff;
    }
    
    /* Watermark Image */
    #capture::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 60%;
        height: 60%;
        background-image: url('https://ik.imagekit.io/kdtvm0r78/IMG-20251202-WA0000.jpg');
        background-repeat: no-repeat;
        background-position: center;
        background-size: contain;
        opacity: 0.07; /* Very light watermark */
        pointer-events: none;
        z-index: 0;
    }

    #capture * {
        position: relative;
        z-index: 1;
    }

    .letter-header-title {
        font-family: 'Playfair Display', serif;
        color: #002366;
        text-transform: uppercase;
        border-bottom: 2px solid #D4AF37;
        display: inline-block;
        padding-bottom: 5px;
    }

    .letter-details-box {
        border: 2px solid #002366;
        background: rgba(240, 248, 255, 0.5);
        border-radius: 0px;
        position: relative;
    }
    
    /* Corner Ornaments for Letter */
    .corner-ornament {
        position: absolute;
        width: 20px;
        height: 20px;
        border: 2px solid #D4AF37;
        z-index: 2;
    }
    .top-left { top: 10px; left: 10px; border-right: none; border-bottom: none; }
    .top-right { top: 10px; right: 10px; border-left: none; border-bottom: none; }
    .bottom-left { bottom: 10px; left: 10px; border-right: none; border-top: none; }
    .bottom-right { bottom: 10px; right: 10px; border-left: none; border-top: none; }

    .highlight { color: #002366; }
    .guarantor-highlight { color: #b91c1c; }

    /* Loader */
    .loader {
        border: 3px solid rgba(0,0,0,0.1);
        border-top: 3px solid #002366;
    }
    #submitForApprovalBtn .loader {
        border-color: rgba(255,255,255,0.3);
        border-top-color: #fff;
    }

  </style>
</head>
<body class="flex flex-col justify-center items-center p-4">

  <!-- FORM CONTAINER -->
  <div id="main-form-container" class="form-container w-full max-w-md p-6 sm:p-8 mb-10 mt-5">
    
    <div class="text-center mb-8">
        <h1 class="main-title text-2xl sm:text-3xl font-bold">TRUST COMMUNITY FUND</h1>
        <p class="text-sm text-gray-300 mt-2 font-light">Premium Loan Application Service</p>
    </div>

    <form id="loanForm">
      <div class="space-y-5">
          <!-- Applicant Name -->
          <div>
            <label for="nameSelect" class="block mb-2 text-sm">Applicant Name (आवेदक का नाम)</label>
            <select id="nameSelect" required class="w-full p-3 text-base">
                <option value="" disabled selected>Loading members...</option>
            </select>
          </div>

          <!-- Loan Category -->
          <div>
            <label for="loanCategory" class="block mb-2 text-sm">Loan Category (लोन का प्रकार)</label>
            <select id="loanCategory" required class="w-full p-3 text-base">
                <option value="personal" selected>Personal Loan</option>
                <option value="business">Business Loan</option>
                <option value="gold">Gold Loan</option>
                <option value="guarantor">Guarantor Loan</option>
            </select>
          </div>

          <!-- Collateral (Hidden) -->
          <div id="goldCollateralSection" style="display: none;">
              <label for="goldCollateral" class="block mb-2 text-sm">Collateral Item (गिरवी सामान)</label>
              <input type="text" id="goldCollateral" placeholder="Enter item name (e.g., Gold Chain)" class="w-full p-3 text-base">
          </div>

          <!-- Guarantor (Hidden) -->
          <div id="guarantorSection" style="display: none;">
            <label for="guarantorSelect" class="block mb-2 text-sm">Guarantor Name (गारंटर का नाम)</label>
            <select id="guarantorSelect" class="w-full p-3 text-base">
              <option value="" disabled selected>Select Guarantor</option>
            </select>
          </div>

          <!-- Amount -->
          <div>
            <label for="amount" class="block mb-2 text-sm">Loan Amount (राशि ₹)</label>
            <input type="number" id="amount" placeholder="Enter amount (e.g., 5000)" min="1" required class="w-full p-3 text-base">
          </div>

          <!-- Duration -->
          <div id="dynamicOptionsContainer">
            <label for="durationRateSelect" id="durationRateLabel" class="block mb-2 text-sm">Interest Rate & Duration</label>
            <select id="durationRateSelect" required class="w-full p-3 text-base">
            </select>
          </div>

          <!-- File Upload -->
          <div>
            <label for="imageUpload" class="block mb-2 text-sm">Additional Document (Optional)</label>
            <input type="file" id="imageUpload" accept="image/*" class="w-full p-2 text-sm cursor-pointer file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-500 file:text-white hover:file:bg-yellow-600">
          </div>

          <!-- Generate Button -->
          <button type="submit" class="btn w-full p-4 rounded-lg text-lg mt-4">
              Generate Loan Letter <i class="fas fa-file-contract ml-2"></i>
          </button>
      </div>
      
      <!-- Notification Box -->
      <div id="loanInfoNotification" class="mt-8 p-5 text-sm">
        <!-- Dynamic Content -->
      </div>
    </form>
  </div>

  <!-- SUCCESS MESSAGE -->
  <div id="successMessage" class="hidden text-center bg-white p-8 rounded-xl shadow-2xl w-full max-w-md border-t-4 border-green-500">
      <i class="fas fa-check-circle text-6xl text-green-500 mb-4"></i>
      <h2 class="text-2xl font-bold text-gray-800 mb-2">Application Submitted!</h2>
      <p class="text-gray-600">Your application is pending approval.</p>
      
      <div id="success-action-buttons" class="flex flex-col gap-3 mt-6">
        <button id="successDownloadBtn" class="btn w-full p-3 bg-green-600 text-white rounded-lg">Download Letter</button>
        <button id="successShareBtn" class="btn hidden w-full p-3 bg-blue-600 text-white rounded-lg"><i class="fab fa-whatsapp mr-2"></i> Share on Group</button>
      </div>
  </div>
  
  <!-- PREVIEW SECTION (HIDDEN INITIALLY) -->
  <div id="letter-preview-section" class="hidden w-full flex flex-col items-center mb-10">
      
      <!-- THE LETTER (A4 Size) -->
      <div id="capture">
        <!-- Corner Ornaments -->
        <div class="corner-ornament top-left"></div>
        <div class="corner-ornament top-right"></div>
        <div class="corner-ornament bottom-left"></div>
        <div class="corner-ornament bottom-right"></div>

        <div class="text-center pb-4 mb-6 relative z-10">
          <div class="absolute right-0 top-0 text-right text-sm text-gray-500 font-serif italic">Date: <span id="currentDate"></span></div>
          
          <!-- NEW LOGO -->
          <img src="https://ik.imagekit.io/kdtvm0r78/IMG-20251202-WA0000.jpg" crossorigin="anonymous" class="w-28 mx-auto mb-2 rounded-full border-2 border-yellow-600 shadow-md" alt="Bank Logo">
          
          <h1 class="letter-header-title text-3xl font-bold tracking-wider my-2">TRUST COMMUNITY FUND</h1>
          <h2 id="letterLoanCategory" class="text-xl font-bold text-green-700 mt-2 uppercase tracking-widest border px-4 py-1 inline-block border-green-700 rounded"></h2>
        </div>

        <div class="letter-details-box flex justify-between items-start my-6 p-6 shadow-sm">
            <div class="details-text flex-grow pr-6 space-y-3">
              <p class="text-sm text-gray-900 flex items-center border-b border-gray-300 pb-1"><i class="fas fa-user w-6 text-center text-blue-900 mr-2"></i>Applicant: <span class="highlight font-bold text-lg ml-2" id="displayName"></span></p>
              
              <p id="guarantorRow" class="text-sm text-gray-900 flex items-center border-b border-gray-300 pb-1"><i class="fas fa-user-shield w-6 text-center text-red-700 mr-2"></i>Guarantor: <span class="guarantor-highlight font-bold text-lg ml-2" id="displayGuarantor"></span></p>
              
              <p id="collateralRow" class="text-sm text-gray-900 flex items-center border-b border-gray-300 pb-1" style="display: none;"><i class="fas fa-gem w-6 text-center text-yellow-600 mr-2"></i>Collateral: <span class="highlight font-bold ml-2" id="displayCollateral"></span></p>
              
              <p class="text-sm text-gray-900 flex items-center border-b border-gray-300 pb-1"><i class="fas fa-mobile-alt w-6 text-center text-blue-900 mr-2"></i>Mobile: <span id="displayMobile" class="ml-2 font-mono"></span></p>
              
              <p class="text-sm text-gray-900 flex items-center border-b border-gray-300 pb-1"><i class="fas fa-rupee-sign w-6 text-center text-green-700 mr-2"></i>Amount: <span class="font-bold text-lg ml-2">₹<span id="displayAmount"></span></span></p>
              
              <p id="processingFeeRow" class="text-sm text-gray-900 items-center border-b border-gray-300 pb-1" style="display: none;"><i class="fas fa-cogs w-6 text-center text-gray-600 mr-2"></i>Proc. Fee: ₹<span id="displayProcessingFee" class="ml-2"></span></p>
              
              <p class="text-sm text-gray-900 flex items-center border-b border-gray-300 pb-1"><i class="fas fa-percent w-6 text-center text-blue-900 mr-2"></i>Rate: <span id="displayRate" class="ml-2 font-semibold"></span></p>
              
              <p id="interestOnlyPaymentRow" class="text-sm text-gray-900 items-center border-b border-gray-300 pb-1" style="display: none;"><i class="fas fa-money-bill-wave w-6 text-center text-blue-900 mr-2"></i>Int. Only: ₹<span id="displayInterestOnlyPayment" class="ml-2"></span></p>
              
              <p id="emiRow" class="text-sm text-gray-900 items-center border-b border-gray-300 pb-1" style="display: none;"><i class="fas fa-chart-pie w-6 text-center text-blue-900 mr-2"></i>Full EMI: ₹<span id="displayEMI" class="ml-2"></span></p>
              
              <p id="businessInterestRow" class="text-sm text-gray-900 items-center border-b border-gray-300 pb-1" style="display: none;"><i class="fas fa-money-bill-wave w-6 text-center text-blue-900 mr-2"></i>Mo. Interest: ₹<span id="displayBusinessInterest" class="ml-2"></span></p>
              
              <p id="businessEmiRow" class="text-sm text-gray-900 items-center border-b border-gray-300 pb-1" style="display: none;"><i class="fas fa-chart-pie w-6 text-center text-blue-900 mr-2"></i>Mo. EMI: ₹<span id="displayBusinessEMI" class="ml-2"></span></p>
              
              <p class="text-sm text-gray-900 flex items-center border-b border-gray-300 pb-1 bg-yellow-50"><i class="fas fa-file-invoice-dollar w-6 text-center text-green-700 mr-2"></i>Total Payable: <span class="font-bold text-lg ml-2 text-green-800">₹<span id="displayTotalAmount"></span></span></p>
              
              <p class="text-sm text-gray-900 flex items-center pt-1"><i class="fas fa-calendar-alt w-6 text-center text-red-700 mr-2"></i>End Date: <span id="repaymentDate" class="ml-2 font-bold text-red-700"></span></p>
            </div>
            
            <div class="flex-shrink-0 w-32 text-center ml-2">
                <p class="mb-1 font-bold text-gray-500 text-xs uppercase tracking-wider">Applicant</p>
                <div class="border-2 border-double border-gray-400 p-1 bg-white">
                    <img id="apiApplicantPhoto" src="" crossorigin="anonymous" alt="Applicant" class="w-full h-32 object-contain bg-gray-50">
                </div>
            </div>
        </div>

        <div id="manualUploadSection" class="my-4 mx-auto p-4 border-2 border-dashed border-gray-300 rounded-lg text-center max-w-[80%] bg-gray-50" style="display: none;">
            <p class="mb-2 font-bold text-gray-600 text-xs uppercase">Additional Document</p>
            <img id="manualApplicantPhoto" src="" crossorigin="anonymous" alt="Doc" class="max-w-full max-h-48 h-auto object-contain mx-auto shadow-sm">
        </div>

        <p class="text-center italic text-gray-600 text-sm mt-8 mb-4 font-serif">"I solemnly declare that I will repay the loan amount within the stipulated time."</p>
        
        <div class="mt-auto pt-4 flex justify-between items-end px-4">
            <div class="text-center">
                 <!-- NEW STAMP -->
                 <div class="relative inline-block">
                    <img src="https://ik.imagekit.io/kdtvm0r78/20251206_210616.png" crossorigin="anonymous" class="w-32 opacity-90 transform -rotate-12 mix-blend-multiply" alt="Bank Stamp">
                 </div>
                 <p class="mt-1 text-xs font-bold text-blue-900 uppercase tracking-widest border-t border-blue-900 pt-1">Official Stamp</p>
            </div>
            
            <div class="text-center">
              <p class="mb-0 text-xs font-bold text-gray-500 uppercase tracking-wide">Approved By</p>
              <!-- NEW SIGNATURE -->
              <img src="https://ik.imagekit.io/kdtvm0r78/image.png" crossorigin="anonymous" class="w-40 h-auto -mb-2" alt="Signature">
              <p class="mt-1 text-xs font-bold text-blue-900 uppercase tracking-widest border-t border-blue-900 pt-1">Prime Members</p>
            </div>
        </div>
      </div> 
      
      <!-- SUBMIT BUTTON -->
      <div id="action-buttons" class="hidden w-full max-w-md mt-6">
        <button id="submitForApprovalBtn" class="btn w-full p-4 rounded-lg text-lg flex items-center justify-center">
            <span id="submitBtnText">Confirm & Submit Application</span>
            <div id="submitLoader" class="loader hidden ml-3 w-5 h-5 rounded-full animate-spin"></div>
        </button>
        <button onclick="document.getElementById('letter-preview-section').classList.add('hidden'); document.getElementById('main-form-container').style.display='block'; window.scrollTo(0,0);" class="mt-3 w-full text-gray-300 underline text-sm hover:text-white">Edit Details</button>
      </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <script>
    let IMGBB_API_KEY_FORM = null;

    async function checkAuthAndInitialize() {
        try {
            const response = await fetch('/api/config.js');
            if (!response.ok) throw new Error('Configuration failed to load.');
            const config = await response.json();
            
            IMGBB_API_KEY_FORM = config.imgbb.formApiKey;
            if (!IMGBB_API_KEY_FORM) {
                console.warn("IMGBB_API_KEY_FORM missing in config.");
            }

            if (!firebase.apps.length) {
                firebase.initializeApp(config.firebase);
            }
            
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    runAppLogic(); 
                } else {
                    window.location.href = `/login.html?redirect=${window.location.pathname}`;
                }
            });
        } catch (error) {
            console.error('Init Error:', error);
            document.getElementById('main-form-container').innerHTML = `<p class="text-red-400 text-center font-bold bg-black p-4 rounded">Error: ${error.message}</p>`;
        }
    }

    function runAppLogic() {
        let membersData = {};
        let pendingLoanDataForSubmit = {};
        let generatedCanvas = null;

        // Element Selectors
        const mainFormContainer = document.getElementById('main-form-container');
        const successMessage = document.getElementById('successMessage');
        const letterPreviewSection = document.getElementById('letter-preview-section');
        const nameSelect = document.getElementById('nameSelect');
        const loanCategorySelect = document.getElementById('loanCategory');
        const amountInput = document.getElementById('amount');
        const durationRateSelect = document.getElementById('durationRateSelect');
        const durationRateLabel = document.getElementById('durationRateLabel');
        const imageUploadInput = document.getElementById('imageUpload');
        const loanForm = document.getElementById('loanForm');
        const captureDiv = document.getElementById('capture');
        const guarantorSection = document.getElementById('guarantorSection');
        const guarantorSelect = document.getElementById('guarantorSelect');
        const goldCollateralSection = document.getElementById('goldCollateralSection');
        const goldCollateralInput = document.getElementById('goldCollateral');
        
        const actionButtonsContainer = document.getElementById('action-buttons');
        const submitForApprovalBtn = document.getElementById('submitForApprovalBtn');
        const successDownloadBtn = document.getElementById('successDownloadBtn');
        const successShareBtn = document.getElementById('successShareBtn');

        const submitBtnText = document.getElementById('submitBtnText');
        const submitLoader = document.getElementById('submitLoader');
        
        // Letter Elements
        const currentDateEl = document.getElementById('currentDate');
        const letterLoanCategoryEl = document.getElementById('letterLoanCategory');
        const displayNameEl = document.getElementById('displayName');
        const displayGuarantorEl = document.getElementById('displayGuarantor');
        const displayMobileEl = document.getElementById('displayMobile');
        const displayAmountEl = document.getElementById('displayAmount');
        const displayRateEl = document.getElementById('displayRate');
        const displayTotalAmountEl = document.getElementById('displayTotalAmount');
        const repaymentDateEl = document.getElementById('repaymentDate');
        const apiApplicantPhotoEl = document.getElementById('apiApplicantPhoto');
        const manualUploadSectionEl = document.getElementById('manualUploadSection');
        const manualApplicantPhotoEl = document.getElementById('manualApplicantPhoto');
        const guarantorRowEl = document.getElementById('guarantorRow');
        const collateralRowEl = document.getElementById('collateralRow');
        const displayCollateralEl = document.getElementById('displayCollateral');
        const processingFeeRowEl = document.getElementById('processingFeeRow');
        const displayProcessingFeeEl = document.getElementById('displayProcessingFee');
        const interestOnlyPaymentRowEl = document.getElementById('interestOnlyPaymentRow');
        const displayInterestOnlyPaymentEl = document.getElementById('displayInterestOnlyPayment');
        const emiRowEl = document.getElementById('emiRow');
        const displayEMIEl = document.getElementById('displayEMI');
        const businessInterestRowEl = document.getElementById('businessInterestRow');
        const displayBusinessInterestEl = document.getElementById('displayBusinessInterest');
        const businessEmiRowEl = document.getElementById('businessEmiRow');
        const displayBusinessEMIEl = document.getElementById('displayBusinessEMI');
        const loanInfoNotification = document.getElementById('loanInfoNotification');

        const loanOptions = {
            personal: { label: 'Interest Rate & Duration:', options: [ { value: '1-1', text: '1% for 1 month' }, { value: '3-2', text: '3% for 2 months' }, { value: '5-3', text: '5% for 3 months' }, { value: '2-1-2x', text: '2% for 1 month (2x loan)' } ] },
            business: { label: 'Loan Duration (18% Annual Interest):', options: [ { value: '3-6', text: '9 Months (3 months interest + 6 months EMI)' }, { value: '6-6', text: '12 Months (6 months interest + 6 months EMI)' } ] },
            gold: { label: 'Loan Duration (3% Monthly Interest):', options: [ { value: '3-6', text: '6 Months' }, { value: '3-12', text: '1 Year' } ] },
            guarantor: { label: 'Loan Duration (3% Monthly Interest):', options: [ { value: '3-6', text: '6 Months' }, { value: '3-12', text: '1 Year' } ] }
        };

        const notificationContent = {
            personal: `<h3><i class="fas fa-info-circle"></i> Personal Loan Rules</h3><p class="mt-2 text-gray-300">Each member can take a loan up to <strong>1.5 times</strong> their total deposit after 60 days of joining.</p><table class="table w-full mt-2 text-xs"><thead><tr><th>Duration</th><th>Rate</th></tr></thead><tbody><tr><td>1 Month</td><td>1%</td></tr><tr><td>2 Months</td><td>3%</td></tr><tr><td>3 Months</td><td>5%</td></tr></tbody></table>`,
            business: `<h3><i class="fas fa-briefcase"></i> Business Loan Rules</h3><p class="mt-2 text-gray-300">Interest Rate: <strong>18% Annually (1.5% Monthly)</strong>.</p><p class="text-xs text-yellow-500 mt-1">Processing Fee: 1% of loan amount.</p>`,
            gold: `<h3><i class="fas fa-gem"></i> Gold Loan Rules</h3><p class="mt-2 text-gray-300">Interest Rate: <strong>3% Monthly</strong> against collateral.</p>`,
            guarantor: `<h3><i class="fas fa-user-shield"></i> Guarantor Loan Rules</h3><p class="mt-2 text-gray-300">Interest Rate: <strong>3% Monthly</strong>. Guarantor's fund will be held until repayment.</p>`
        };
        
        function updateLoanNotification() {
            const category = loanCategorySelect.value;
            loanInfoNotification.innerHTML = notificationContent[category] || '';
        }

        function updateFormUI() {
            const category = loanCategorySelect.value;
            const selectedOptions = loanOptions[category];
            const selectedApplicantText = nameSelect.options[nameSelect.selectedIndex]?.text || '';
            
            durationRateLabel.textContent = selectedOptions.label;
            durationRateSelect.innerHTML = '';
            selectedOptions.options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.text;
                durationRateSelect.appendChild(option);
            });
            
            goldCollateralSection.style.display = (category === 'gold') ? 'block' : 'none';
            goldCollateralInput.required = (category === 'gold');
            
            const needsManualGuarantor = category === 'guarantor' || selectedApplicantText.toLowerCase().includes('bank');
            guarantorSection.style.display = needsManualGuarantor ? 'block' : 'none';
            guarantorSelect.required = needsManualGuarantor;
            
            updateLoanNotification(); 
        }
        
        async function fetchMemberData() {
            try {
                const db = firebase.database();
                const membersRef = db.ref('members');
                const snapshot = await membersRef.once('value');
                if (!snapshot.exists()) throw new Error('No member data found.');
                membersData = snapshot.val();
                
                const approvedMembers = Object.entries(membersData)
                    .filter(([id, member]) => member.status === 'Approved' && member.fullName)
                    .map(([id, member]) => ({ id, ...member }))
                    .sort((a, b) => a.fullName.localeCompare(b.fullName));
                
                nameSelect.innerHTML = '<option value="" disabled selected>Select Applicant Name</option>';
                guarantorSelect.innerHTML = '<option value="" disabled selected>Select Guarantor</option>';
                
                approvedMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.fullName;
                    nameSelect.appendChild(option.cloneNode(true));
                    
                    const guarantorOption = document.createElement('option');
                    guarantorOption.value = member.id;
                    guarantorOption.textContent = member.fullName;
                    guarantorSelect.appendChild(guarantorOption);
                });
                updateFormUI();
            } catch (error) {
                console.error('Error fetching members:', error);
                nameSelect.innerHTML = '<option value="" disabled selected>Error loading members</option>';
            }
        }

        function createProxyUrl(url) {
            if (!url || !url.startsWith('http')) return 'https://placehold.co/100x120/EFEFEF/AAAAAA&text=No+Image';
            const urlWithoutProtocol = url.replace(/^(https?:\/\/)/, '');
            return `https://images.weserv.nl/?url=${urlWithoutProtocol}`;
        }

        function formatDate(date) {
            return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
        }

        async function uploadImageToImgBB(file) {
            if (!file) return null;
            if (!IMGBB_API_KEY_FORM) return alert("Image API Key missing!");
            
            const formData = new FormData();
            formData.append('image', file);
            try {
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY_FORM}`, { method: 'POST', body: formData });
                const json = await res.json();
                if (!json.success) throw new Error(json.error.message);
                return json.data.url;
            } catch (err) {
                console.error('Upload failed:', err);
                return null;
            }
        }

        async function waitForImages(container) {
            const images = Array.from(container.getElementsByTagName('img'));
            await Promise.all(images.map(img => {
                if (img.src && !img.complete) {
                    return new Promise(resolve => {
                        img.onload = resolve;
                        img.onerror = resolve;
                    });
                }
                return Promise.resolve();
            }));
        }

        loanForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const selectedMemberId = nameSelect.value;
            const member = membersData[selectedMemberId];
            if (!member) return alert('Please select a valid member.');
            
            const amount = parseFloat(amountInput.value);
            const category = loanCategorySelect.value;
            const rateValue = durationRateSelect.value;
            const uploadedFile = imageUploadInput.files[0];
            const collateralItem = goldCollateralInput.value;

            if (isNaN(amount) || !rateValue) return alert('Check fields.');
            
            // Reset Rows
            [processingFeeRowEl, interestOnlyPaymentRowEl, emiRowEl, businessInterestRowEl, businessEmiRowEl, guarantorRowEl, collateralRowEl].forEach(el => el.style.display = 'none');
            
            // Guarantor Logic
            let guarantorName = 'N/A';
            const needsManualGuarantor = category === 'guarantor' || member.fullName.toLowerCase().includes('bank');

            if (needsManualGuarantor) {
                const guarantorId = guarantorSelect.value;
                if (!guarantorId) return alert('Select a guarantor.');
                guarantorName = membersData[guarantorId].fullName;
            } else {
                guarantorName = member.guarantorName || 'N/A';
            }
            displayGuarantorEl.textContent = guarantorName;
            guarantorRowEl.style.display = 'flex';
            
            if (category === 'gold' && collateralItem) {
                displayCollateralEl.textContent = collateralItem;
                collateralRowEl.style.display = 'flex';
            }
            
            let loanDetails = {};
            let interest = 0, totalMonths = 0, rateText = '', totalAmount = 0;
            
            switch(category) {
                case 'personal':
                    const [pRate, pMonths] = rateValue.split('-').map(Number);
                    interest = pRate;
                    totalMonths = pMonths;
                    rateText = durationRateSelect.options[durationRateSelect.selectedIndex].text;
                    totalAmount = amount + (amount * (interest / 100));
                    loanDetails.emi = (totalAmount / totalMonths).toFixed(2);
                    displayEMIEl.textContent = loanDetails.emi;
                    emiRowEl.style.display = 'flex';
                    break;
                case 'business':
                    const [interestOnlyMonths, emiMonths] = rateValue.split('-').map(Number);
                    const monthlyInterestRate = 1.5 / 100;
                    loanDetails.processingFee = amount * 0.010 + (amount > 9000 ? 200 : 0);
                    displayProcessingFeeEl.textContent = loanDetails.processingFee.toFixed(2);
                    processingFeeRowEl.style.display = 'flex';
                    loanDetails.monthlyInterestPayment = amount * monthlyInterestRate;
                    const emiPayment = (amount * monthlyInterestRate * Math.pow(1 + monthlyInterestRate, emiMonths)) / (Math.pow(1 + monthlyInterestRate, emiMonths) - 1);
                    loanDetails.emi = emiPayment.toFixed(2);
                    totalAmount = (loanDetails.monthlyInterestPayment * interestOnlyMonths) + (emiPayment * emiMonths);
                    totalMonths = interestOnlyMonths + emiMonths;
                    displayBusinessInterestEl.textContent = `${loanDetails.monthlyInterestPayment.toFixed(2)} (for first ${interestOnlyMonths} mos)`;
                    displayBusinessEMIEl.textContent = `${loanDetails.emi} (for last ${emiMonths} mos)`;
                    businessInterestRowEl.style.display = 'flex';
                    businessEmiRowEl.style.display = 'flex';
                    rateText = `18% Annually`;
                    break;
                case 'gold':
                case 'guarantor':
                    const [gRate, gMonths] = rateValue.split('-').map(Number);
                    interest = gRate;
                    totalMonths = gMonths;
                    const gMonthlyRate = interest / 100;
                    loanDetails.interestOnlyPayment = amount * gMonthlyRate;
                    displayInterestOnlyPaymentEl.textContent = loanDetails.interestOnlyPayment.toFixed(2);
                    interestOnlyPaymentRowEl.style.display = 'flex';
                    const fullEmi = (amount * gMonthlyRate * Math.pow(1 + gMonthlyRate, totalMonths)) / (Math.pow(1 + gMonthlyRate, totalMonths) - 1);
                    loanDetails.emi = fullEmi.toFixed(2);
                    totalAmount = fullEmi * totalMonths;
                    displayEMIEl.textContent = loanDetails.emi;
                    emiRowEl.style.display = 'flex';
                    rateText = `${interest}% Monthly for ${totalMonths} months`;
                    break;
            }
            
            const today = new Date();
            const repaymentDate = new Date(today);
            repaymentDate.setMonth(repaymentDate.getMonth() + totalMonths);

            currentDateEl.textContent = formatDate(today);
            let categoryText = loanCategorySelect.options[loanCategorySelect.selectedIndex].text.split('(')[0].trim();
            letterLoanCategoryEl.textContent = categoryText.replace(/LOAN/i, '').trim() + ' LOAN';
            displayNameEl.textContent = member.fullName;
            displayMobileEl.textContent = member.mobileNumber || 'N/A';
            displayAmountEl.textContent = amount.toLocaleString('en-IN');
            displayRateEl.textContent = rateText;
            displayTotalAmountEl.textContent = totalAmount.toLocaleString('en-IN');
            repaymentDateEl.textContent = formatDate(repaymentDate);
            apiApplicantPhotoEl.src = createProxyUrl(member.profilePicUrl);

            manualApplicantPhotoEl.src = "";
            manualUploadSectionEl.style.display = 'none';

            if (uploadedFile) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    manualApplicantPhotoEl.src = e.target.result;
                    manualUploadSectionEl.style.display = 'block';
                }
                reader.readAsDataURL(uploadedFile);
            } else if (member.documentUrl) {
                manualApplicantPhotoEl.src = createProxyUrl(member.documentUrl);
                manualUploadSectionEl.style.display = 'block';
            }

            pendingLoanDataForSubmit = {
                applicantId: selectedMemberId, applicantName: member.fullName, applicantPhotoUrl: member.profilePicUrl,
                loanAmount: amount, loanCategory: category, loanCategoryText: categoryText, rateText: rateText,
                totalPayable: totalAmount, repaymentEndDate: repaymentDate.toISOString(), guarantorName: guarantorName,
                collateralItem: category === 'gold' ? collateralItem : null, additionalDocFile: uploadedFile,
                loanDetails: loanDetails, status: 'pending'
            };

            mainFormContainer.style.display = 'none'; // Hide Form
            letterPreviewSection.classList.remove('hidden'); // Show Letter
            actionButtonsContainer.classList.remove('hidden'); 
            window.scrollTo(0,0);
        });

        submitForApprovalBtn.addEventListener('click', async function() {
            submitForApprovalBtn.disabled = true;
            submitBtnText.textContent = 'Processing...';
            submitLoader.classList.remove('hidden');

            try {
                // Ensure everything is rendered
                await waitForImages(captureDiv);
                
                // Generate Image
                const canvas = await html2canvas(captureDiv, { 
                    scale: 2, 
                    useCORS: true, 
                    logging: false,
                    backgroundColor: '#ffffff'
                });
                generatedCanvas = canvas;

                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                
                // Upload generated letter
                const letterImageUrl = await uploadImageToImgBB(blob);
                
                // Upload additional doc if exists
                let additionalDocUrl = null;
                if (pendingLoanDataForSubmit.additionalDocFile) {
                    additionalDocUrl = await uploadImageToImgBB(pendingLoanDataForSubmit.additionalDocFile);
                }

                if (!letterImageUrl) throw new Error('Image upload failed.');
                
                const finalData = {
                    ...pendingLoanDataForSubmit,
                    letterImageUrl: letterImageUrl,
                    additionalDocUrl: additionalDocUrl,
                    submittedAt: firebase.database.ServerValue.TIMESTAMP
                };
                delete finalData.additionalDocFile;

                // Push to Firebase
                await firebase.database().ref('pendingLoans').push(finalData);
                
                // Show Success
                letterPreviewSection.style.display = 'none';
                actionButtonsContainer.style.display = 'none';
                successMessage.classList.remove('hidden');
                successDownloadBtn.classList.remove('hidden');

            } catch (error) {
                console.error("Submission error:", error);
                alert("Submission failed: " + error.message);
                submitForApprovalBtn.disabled = false;
                submitBtnText.textContent = 'Confirm & Submit Application';
                submitLoader.classList.add('hidden');
            }
        });

        successDownloadBtn.addEventListener('click', function() {
            if (!generatedCanvas) return alert('No letter generated.');
            
            const link = document.createElement('a');
            const fileName = `Loan_Application_${Date.now()}.png`;
            link.download = fileName;
            link.href = generatedCanvas.toDataURL('image/png');
            link.click();
            
            successDownloadBtn.textContent = 'Downloaded ✔';
            successShareBtn.classList.remove('hidden');
        });

        successShareBtn.addEventListener('click', function() {
            window.open('https://chat.whatsapp.com/G39I0hP55WIDHMu5YkAjDZ', '_blank');
        });

        loanCategorySelect.addEventListener('change', updateFormUI);
        nameSelect.addEventListener('change', updateFormUI);
        fetchMemberData();
    }

    checkAuthAndInitialize();
  </script>

</body>
</html>

