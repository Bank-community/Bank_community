<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trust Community Fund Loan Form</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            bank: {
              primary: '#0f766e', /* Teal-700 */
              secondary: '#134e4a', /* Teal-900 */
              accent: '#f59e0b', /* Amber-500 */
              light: '#f0fdfa', /* Teal-50 */
            }
          },
          animation: {
            'fade-in': 'fadeIn 0.3s ease-out',
            'slide-up': 'slideUp 0.4s ease-out',
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            },
            slideUp: {
              '0%': { transform: 'translateY(20px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' },
            }
          }
        }
      }
    }
  </script>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f3f4f6;
    }
    /* Input View Styling */
    .form-card {
      background: white;
      box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1);
      border-top: 6px solid #0f766e;
    }
    input:focus, select:focus {
      border-color: #0f766e;
      ring: 2px solid #0f766e;
      outline: none;
      box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.1);
    }
    
    /* Preview View Styling */
    #preview-view {
        background-color: #e5e7eb; /* Darker grey for contrast */
        min-height: 100vh;
        width: 100%;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 50;
    }

    /* A4 Paper Styling */
    #capture {
      width: 210mm;
      min-height: 297mm; /* Exact A4 Height */
      padding: 15mm;
      background-color: white;
      margin: 0 auto;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      position: relative;
    }
    
    /* Responsive A4 for Mobile */
    @media screen and (max-width: 768px) {
        #capture {
            width: 100%; /* Fit screen width */
            min-height: auto; /* Allow height to grow */
            padding: 15px;
            box-shadow: none; /* Flat on mobile preview for clarity */
        }
        #preview-container {
            padding: 10px;
        }
    }

    .letter-header {
      border-bottom: 3px solid #0f766e;
      color: #0f766e;
    }
    .table-row-custom {
      border-bottom: 1px solid #f1f5f9;
    }
    
    /* Transition Utilities */
    .hidden-view {
        display: none !important;
    }
  </style>
</head>
<body class="text-gray-800">

  <!-- ================= INPUT PAGE ================= -->
  <div id="input-view" class="min-h-screen flex flex-col items-center py-8 px-4 animate-fade-in">
    
    <div class="form-card p-8 rounded-2xl w-full max-w-lg mb-8">
        <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-bank-light text-bank-primary mb-3">
                <i class="fas fa-landmark text-xl"></i>
            </div>
            <h1 class="text-2xl font-bold text-bank-secondary">Loan Application</h1>
            <p class="text-gray-500 text-sm">Trust Community Fund</p>
        </div>

        <form id="loanForm" class="space-y-5">
            <!-- Applicant Name -->
            <div>
                <label class="block mb-1.5 font-semibold text-gray-700 text-sm">Applicant Name</label>
                <div class="relative">
                    <select id="nameSelect" required class="w-full pl-3 p-3 border border-gray-300 rounded-lg bg-gray-50 focus:bg-white appearance-none">
                        <option value="" disabled selected>Loading members...</option>
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-gray-500">
                        <i class="fas fa-chevron-down text-xs"></i>
                    </div>
                </div>
            </div>
          
            <!-- Loan Category -->
            <div>
                <label class="block mb-1.5 font-semibold text-gray-700 text-sm">Loan Type</label>
                <div class="relative">
                    <select id="loanCategory" required class="w-full pl-3 p-3 border border-gray-300 rounded-lg bg-gray-50 focus:bg-white appearance-none">
                        <option value="personal" selected>Personal Loan (Cash)</option>
                        <option value="product">Product Loan (Item/Asset)</option>
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-gray-500">
                        <i class="fas fa-chevron-down text-xs"></i>
                    </div>
                </div>
            </div>

            <!-- Product Name Input -->
            <div id="productCollateralSection" class="hidden animate-slide-up">
                <label class="block mb-1.5 font-semibold text-gray-700 text-sm">Product Name</label>
                <input type="text" id="productInput" placeholder="Ex: Samsung Mobile, Laptop..." class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 focus:bg-white">
            </div>

            <!-- Loan Amount -->
            <div>
                <label class="block mb-1.5 font-semibold text-gray-700 text-sm">Loan Amount (₹)</label>
                <input type="number" id="amount" placeholder="Enter amount (Max 50,000)" min="1" max="50000" required class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 text-lg font-semibold text-bank-secondary focus:bg-white">
                <p id="limit-msg" class="text-xs text-red-500 mt-1 hidden"><i class="fas fa-info-circle mr-1"></i>Max limit is ₹50,000</p>
            </div>

            <!-- Dynamic Options -->
            <div id="dynamicOptionsContainer">
                <label class="block mb-1.5 font-semibold text-gray-700 text-sm">Duration & Interest</label>
                <div class="relative">
                    <select id="durationRateSelect" required class="w-full pl-3 p-3 border border-gray-300 rounded-lg bg-gray-50 focus:bg-white appearance-none">
                    <option value="" disabled selected>Enter amount first...</option>
                    </select>
                    <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-gray-500">
                        <i class="fas fa-chevron-down text-xs"></i>
                    </div>
                </div>
            </div>

            <!-- Image Upload -->
            <div>
                <label class="block mb-1.5 font-semibold text-gray-700 text-sm">Additional Document (Optional)</label>
                <input type="file" id="imageUpload" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-bank-light file:text-bank-primary hover:file:bg-teal-100 cursor-pointer border border-gray-200 rounded-lg">
            </div>

            <!-- Rules Image -->
            <div class="mt-4 rounded-lg overflow-hidden border border-gray-200">
                <img src="https://ik.imagekit.io/kdtvm0r78/1000119828-optimized_C4_53shzy.jpg" alt="Loan Rules" class="w-full h-auto object-cover">
            </div>

            <!-- Generate Button -->
            <button type="submit" class="w-full py-4 bg-bank-secondary text-white font-bold rounded-xl shadow-lg hover:shadow-xl hover:bg-teal-800 transition-all duration-200 flex items-center justify-center text-lg mt-6">
                Generate Letter <i class="fas fa-arrow-right ml-2"></i>
            </button>
        </form>
    </div>
  </div>

  <!-- ================= PREVIEW PAGE (Hidden Initially) ================= -->
  <div id="preview-view" class="hidden-view flex flex-col animate-slide-up">
      
      <!-- Sticky Action Bar -->
      <div class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b border-gray-200 shadow-sm p-4 flex justify-between items-center">
          <button id="backToEditBtn" class="text-gray-600 font-semibold hover:text-bank-secondary flex items-center px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors">
              <i class="fas fa-arrow-left mr-2"></i> Edit
          </button>
          
          <button id="downloadBtn" class="bg-bank-accent text-white font-bold py-2 px-6 rounded-full shadow-md hover:bg-yellow-600 flex items-center transition-transform hover:scale-105">
              <i class="fas fa-download mr-2"></i> Download
          </button>
      </div>

      <!-- Scrollable Preview Area -->
      <div id="preview-container" class="flex-grow flex justify-center p-4 md:p-8 overflow-y-auto">
          
          <!-- THE A4 PAPER -->
          <div id="capture">
            
            <!-- Header -->
            <div class="text-center pb-4 mb-6 relative letter-header">
              <div class="absolute right-0 top-0 text-right text-xs text-gray-500 font-medium">
                  Date: <span id="currentDate" class="text-bank-secondary"></span>
              </div>
              <img src="https://ik.imagekit.io/kdtvm0r78/IMG-20251202-WA0000.jpg" crossorigin="anonymous" class="w-24 mx-auto mb-2" alt="Bank Logo">
              <!-- UPDATED HEADLINE -->
              <h1 class="text-3xl font-bold text-bank-secondary tracking-wide uppercase">Trust Community Fund</h1>
              <div class="h-1 w-24 bg-bank-accent mx-auto my-2 rounded-full"></div>
              <h2 id="letterLoanCategory" class="text-xl font-bold text-bank-primary mt-1 uppercase tracking-wider"></h2>
            </div>
            
            <!-- Content Box -->
            <div class="flex flex-col md:flex-row justify-between items-start my-4 p-6 border border-gray-200 rounded-xl bg-slate-50 shadow-sm">
                <div class="flex-grow w-full md:pr-6 space-y-3">
                  <!-- Name -->
                  <div class="flex items-center text-sm table-row-custom pb-2">
                      <div class="w-8 text-center text-bank-primary"><i class="fas fa-user"></i></div>
                      <div class="w-32 font-semibold text-gray-600">Applicant:</div>
                      <div class="font-bold text-gray-800 text-lg" id="displayName"></div>
                  </div>
                  
                  <!-- Product (Conditional) -->
                  <div id="productRow" class="flex items-center text-sm table-row-custom pb-2 hidden">
                      <div class="w-8 text-center text-bank-primary"><i class="fas fa-box-open"></i></div>
                      <div class="w-32 font-semibold text-gray-600">Product:</div>
                      <div class="font-bold text-bank-secondary" id="displayProduct"></div>
                  </div>

                  <!-- Mobile -->
                  <div class="flex items-center text-sm table-row-custom pb-2">
                      <div class="w-8 text-center text-bank-primary"><i class="fas fa-mobile-alt"></i></div>
                      <div class="w-32 font-semibold text-gray-600">Mobile:</div>
                      <div class="font-medium text-gray-800" id="displayMobile"></div>
                  </div>

                  <!-- Amount -->
                  <div class="flex items-center text-sm table-row-custom pb-2">
                      <div class="w-8 text-center text-bank-primary"><i class="fas fa-rupee-sign"></i></div>
                      <div class="w-32 font-semibold text-gray-600">Amount:</div>
                      <div class="font-bold text-2xl text-bank-primary">₹<span id="displayAmount"></span></div>
                  </div>
                  
                  <!-- Processing Fee -->
                  <div id="processingFeeRow" class="flex items-center text-sm table-row-custom pb-2 hidden">
                      <div class="w-8 text-center text-gray-400"><i class="fas fa-cogs"></i></div>
                      <div class="w-32 font-semibold text-gray-600">Proc. Fee:</div>
                      <div class="font-medium text-gray-800">₹<span id="displayProcessingFee"></span></div>
                  </div>
                  
                  <!-- Interest Rate -->
                  <div class="flex items-center text-sm table-row-custom pb-2">
                      <div class="w-8 text-center text-bank-primary"><i class="fas fa-percent"></i></div>
                      <div class="w-32 font-semibold text-gray-600">Interest:</div>
                      <div class="font-medium text-gray-800" id="displayRate"></div>
                  </div>
                  
                  <!-- EMI -->
                  <div id="emiRow" class="flex items-center text-sm table-row-custom pb-2">
                      <div class="w-8 text-center text-bank-accent"><i class="fas fa-chart-pie"></i></div>
                      <div class="w-32 font-bold text-bank-secondary">Monthly EMI:</div>
                      <div class="font-bold text-xl text-bank-accent">₹<span id="displayEMI"></span></div>
                  </div>
                  
                  <!-- Total -->
                  <div class="flex items-center text-sm table-row-custom pb-2">
                      <div class="w-8 text-center text-bank-primary"><i class="fas fa-file-invoice-dollar"></i></div>
                      <div class="w-32 font-semibold text-gray-600">Total Pay:</div>
                      <div class="font-bold text-gray-800">₹<span id="displayTotalAmount"></span></div>
                  </div>

                  <!-- Date -->
                  <div class="flex items-center text-sm pt-1">
                      <div class="w-8 text-center text-bank-primary"><i class="fas fa-calendar-alt"></i></div>
                      <div class="w-32 font-semibold text-gray-600">End Date:</div>
                      <div class="font-medium text-gray-800" id="repaymentDate"></div>
                  </div>
                </div>
                
                <!-- Photo -->
                <div class="mt-4 md:mt-0 flex-shrink-0 w-28 mx-auto md:mx-0 text-center bg-white p-2 rounded border border-gray-200 shadow-sm">
                    <img id="apiApplicantPhoto" src="" crossorigin="anonymous" alt="Applicant" class="w-full h-24 object-contain rounded mb-1">
                    <p class="text-[10px] text-gray-500 uppercase font-bold">Applicant</p>
                </div>
            </div>

            <!-- Important Notice -->
            <div class="mx-auto w-full mb-6">
                <div class="border-l-4 border-red-500 bg-red-50 p-3 rounded-r-md">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-circle text-red-500 mt-1"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-bold text-red-800">Important Notice (महत्वपूर्ण सूचना)</h3>
                            <p class="text-xs text-red-700 mt-1 font-medium leading-relaxed">
                                EMI every month 1 to 10 tarikh tak jama karein. Yadi late hua to loan amount ka 1% extra charges lagega.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Manual Upload -->
            <div id="manualUploadSection" class="my-2 mx-auto p-2 border border-dashed border-gray-300 rounded text-center max-w-[80%] hidden">
                <p class="mb-1 font-bold text-gray-500 text-xs">Additional Document</p>
                <img id="manualApplicantPhoto" src="" crossorigin="anonymous" alt="Doc" class="max-w-full max-h-48 h-auto object-contain mx-auto">
            </div>

            <p class="text-center italic text-bank-secondary text-sm mt-8 font-semibold opacity-80">
                "I request the bank community members to please approve this loan application."
            </p>
            
            <!-- Footer -->
            <div class="mt-auto pt-10 flex justify-between items-end border-t border-gray-100">
                <div class="text-center">
                     <img src="https://ik.imagekit.io/kdtvm0r78/20251206_210616.png" crossorigin="anonymous" class="w-32 opacity-90 mix-blend-multiply" alt="Stamp">
                     <p class="text-[10px] text-gray-500 uppercase tracking-wider font-bold mt-1">Community Stamp</p>
                </div>
                <div class="text-center">
                  <p class="text-[10px] text-gray-500 uppercase tracking-wider font-bold mb-1">Authorized Signature</p>
                  <img src="https://ik.imagekit.io/kdtvm0r78/image.png" crossorigin="anonymous" class="w-40" alt="Signature">
                  <p class="text-[10px] text-bank-primary font-bold mt-1">Prime Members</p>
                </div>
            </div>
          </div> 
      </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <script>
    async function checkAuthAndInitialize() {
        try {
            const response = await fetch('/api/config.js');
            if (!response.ok) throw new Error('Configuration failed to load.');
            const config = await response.json();
            
            firebase.initializeApp(config.firebase);
            
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    runAppLogic(); 
                } else {
                    window.location.href = `/login.html?redirect=${window.location.pathname}`;
                }
            });
        } catch (error) {
            console.error('Initialization Error:', error);
            document.body.innerHTML = `<p class="text-red-500 text-center font-bold p-10">Error: ${error.message}</p>`;
        }
    }

    function runAppLogic() {
        let membersData = {};

        // Views
        const inputView = document.getElementById('input-view');
        const previewView = document.getElementById('preview-view');
        
        // Buttons
        const backToEditBtn = document.getElementById('backToEditBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        
        // Form Inputs
        const nameSelect = document.getElementById('nameSelect');
        const loanCategorySelect = document.getElementById('loanCategory');
        const amountInput = document.getElementById('amount');
        const durationRateSelect = document.getElementById('durationRateSelect');
        const imageUploadInput = document.getElementById('imageUpload');
        const loanForm = document.getElementById('loanForm');
        
        // Product Logic
        const productCollateralSection = document.getElementById('productCollateralSection');
        const productInput = document.getElementById('productInput');
        
        // Letter Elements
        const captureDiv = document.getElementById('capture');
        const currentDateEl = document.getElementById('currentDate');
        const letterLoanCategoryEl = document.getElementById('letterLoanCategory');
        const displayNameEl = document.getElementById('displayName');
        const displayMobileEl = document.getElementById('displayMobile');
        const displayAmountEl = document.getElementById('displayAmount');
        const displayRateEl = document.getElementById('displayRate');
        const displayTotalAmountEl = document.getElementById('displayTotalAmount');
        const repaymentDateEl = document.getElementById('repaymentDate');
        const apiApplicantPhotoEl = document.getElementById('apiApplicantPhoto');
        const manualUploadSectionEl = document.getElementById('manualUploadSection');
        const manualApplicantPhotoEl = document.getElementById('manualApplicantPhoto');
        const productRowEl = document.getElementById('productRow');
        const displayProductEl = document.getElementById('displayProduct');
        const processingFeeRowEl = document.getElementById('processingFeeRow');
        const displayProcessingFeeEl = document.getElementById('displayProcessingFee');
        const displayEMIEl = document.getElementById('displayEMI');

        function updateOptions() {
            const category = loanCategorySelect.value;
            let amount = parseFloat(amountInput.value) || 0;
            const select = durationRateSelect;
            select.innerHTML = ''; 

            if(amount > 50000) {
                document.getElementById('limit-msg').classList.remove('hidden');
            } else {
                document.getElementById('limit-msg').classList.add('hidden');
            }

            if (category === 'product') {
                productCollateralSection.classList.remove('hidden');
                productInput.required = true;
            } else {
                productCollateralSection.classList.add('hidden');
                productInput.required = false;
            }

            if (amount === 0) {
                const opt = document.createElement('option');
                opt.text = "Enter amount to see options";
                select.add(opt);
                return;
            }

            let options = [];

            if (category === 'personal') {
                if (amount < 15000) {
                    options = [
                        { value: '1-1.0-0', text: '1 Month (1% Interest)' },
                        { value: '2-1.5-0', text: '2 Months (1.5% Interest)' },
                        { value: '3-1.66-0', text: '3 Months (1.66% Interest)' }
                    ];
                } 
                else if (amount >= 15000 && amount < 30000) {
                    options = [
                        { value: '1-1.0-0', text: '1 Month (1% Interest)' },
                        { value: '2-1.5-0', text: '2 Months (1.5% Interest)' },
                        { value: '3-1.66-0', text: '3 Months (1.66% Interest)' },
                        { value: '4-1.66-0', text: '4 Months (1.66% Interest)' },
                        { value: '5-1.66-0', text: '5 Months (1.66% Interest)' }
                    ];
                }
                else {
                    // >= 30k
                    options = [
                        { value: '6-0.66-0.5', text: '6 Months (0.66% Int. + 0.5% Fee)' },
                        { value: '9-0.66-0.5', text: '9 Months (0.66% Int. + 0.5% Fee)' },
                        { value: '12-0.66-0.5', text: '12 Months (0.66% Int. + 0.5% Fee)' }
                    ];
                }
            } 
            else if (category === 'product') {
                if (amount >= 30000) {
                    options = [
                        { value: '6-0.5-100', text: '6 Months (0.5% Int + ₹100 Fee)' },
                        { value: '9-0.5-100', text: '9 Months (0.5% Int + ₹100 Fee)' },
                        { value: '12-0.5-100', text: '12 Months (0.5% Int + ₹100 Fee)' }
                    ];
                } else {
                    const fee = amount > 5000 ? 100 : 0;
                    const feeText = fee > 0 ? '+ ₹100 Fee' : '';
                    options = [
                        { value: `1-1.0-${fee}`, text: `1 Month (1% Int ${feeText})` },
                        { value: `2-1.0-${fee}`, text: `2 Months (1% Int ${feeText})` },
                        { value: `3-1.0-${fee}`, text: `3 Months (1% Int ${feeText})` },
                        { value: `4-1.0-${fee}`, text: `4 Months (1% Int ${feeText})` },
                        { value: `5-1.0-${fee}`, text: `5 Months (1% Int ${feeText})` }
                    ];
                }
            }

            options.forEach(opt => {
                const el = document.createElement('option');
                el.value = opt.value;
                el.textContent = opt.text;
                select.appendChild(el);
            });
        }

        async function fetchMemberData() {
            try {
                const db = firebase.database();
                const membersRef = db.ref('members');
                const snapshot = await membersRef.once('value');
                if (!snapshot.exists()) throw new Error('No member data found.');
                membersData = snapshot.val();
                
                nameSelect.innerHTML = '<option value="" disabled selected>Select Applicant Name</option>';
                const approvedMembers = Object.entries(membersData)
                    .filter(([id, member]) => member.status === 'Approved' && member.fullName)
                    .map(([id, member]) => ({ id, ...member }))
                    .sort((a, b) => a.fullName.localeCompare(b.fullName));

                approvedMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.fullName;
                    nameSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching member data:', error);
                nameSelect.innerHTML = '<option value="" disabled selected>Error loading members</option>';
            }
        }

        function createProxyUrl(url) {
            if (!url || typeof url !== 'string' || !url.startsWith('http')) {
                return 'https://placehold.co/100x120/EFEFEF/AAAAAA&text=No+Image';
            }
            const urlWithoutProtocol = url.replace(/^(https?:\/\/)/, '');
            return `https://images.weserv.nl/?url=${urlWithoutProtocol}`;
        }

        function formatDate(date) {
            const day = date.getDate();
            const month = date.toLocaleString('default', { month: 'long' });
            const year = date.getFullYear();
            return `${day} ${month} ${year}`;
        }

        async function waitForImages(containerElement) {
            const images = Array.from(containerElement.getElementsByTagName('img'));
            const promises = images.map(img => {
                if (img.src && !img.complete) {
                    return new Promise((resolve) => {
                        img.onload = resolve;
                        img.onerror = () => { resolve(); };
                    });
                }
                return Promise.resolve();
            });
            return Promise.all(promises);
        }

        // --- CORE NAVIGATION & GENERATION ---

        loanForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const selectedMemberId = nameSelect.value;
            const member = membersData[selectedMemberId];
            if (!member) { alert('Please select a valid member.'); return; }
            
            const amount = parseFloat(amountInput.value);
            const category = loanCategorySelect.value;
            const rateString = durationRateSelect.value;
            const uploadedFile = imageUploadInput.files[0];
            const productItemName = productInput.value;

            if (isNaN(amount) || !rateString) { alert('Please fill in all required fields.'); return; }
            
            const [months, interestRate, feeRaw] = rateString.split('-').map(Number);
            
            let processingFee = 0;
            if (category === 'personal' && amount >= 30000) {
                 processingFee = amount * (feeRaw / 100); 
            } else if (category === 'product' && amount >= 30000) {
                 processingFee = feeRaw;
            } else if (category === 'product' && amount < 30000) {
                 processingFee = feeRaw;
            }

            const monthlyInterestAmount = amount * (interestRate / 100);
            const totalInterest = monthlyInterestAmount * months;
            const totalPayable = amount + totalInterest;
            let emi = Math.ceil(totalPayable / months);

            const today = new Date();
            const endDate = new Date(today);
            endDate.setMonth(endDate.getMonth() + months);

            // Populate Letter
            currentDateEl.textContent = formatDate(today);
            letterLoanCategoryEl.textContent = category === 'personal' ? 'PERSONAL LOAN' : 'PRODUCT LOAN';
            displayNameEl.textContent = member.fullName;
            displayMobileEl.textContent = member.mobileNumber || 'N/A';
            displayAmountEl.textContent = amount.toFixed(2);
            
            if (processingFee > 0) {
                displayProcessingFeeEl.textContent = processingFee.toFixed(2);
                processingFeeRowEl.classList.remove('hidden');
                processingFeeRowEl.classList.add('flex');
            } else {
                processingFeeRowEl.classList.add('hidden');
                processingFeeRowEl.classList.remove('flex');
            }

            if (category === 'product') {
                displayProductEl.textContent = productItemName;
                productRowEl.classList.remove('hidden');
                productRowEl.classList.add('flex');
            } else {
                productRowEl.classList.add('hidden');
                productRowEl.classList.remove('flex');
            }

            displayRateEl.textContent = `${interestRate}% Monthly for ${months} Months`;
            displayEMIEl.textContent = emi.toFixed(2);
            displayTotalAmountEl.textContent = totalPayable.toFixed(2);
            repaymentDateEl.textContent = formatDate(endDate);
            apiApplicantPhotoEl.src = createProxyUrl(member.profilePicUrl);

            if (uploadedFile) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    manualApplicantPhotoEl.src = event.target.result;
                    manualUploadSectionEl.classList.remove('hidden');
                }
                reader.readAsDataURL(uploadedFile);
            } else if (member.documentUrl) {
                manualApplicantPhotoEl.src = createProxyUrl(member.documentUrl);
                manualUploadSectionEl.classList.remove('hidden');
            } else {
                manualUploadSectionEl.classList.add('hidden');
            }

            // SWITCH VIEW (Simulate Navigation)
            inputView.classList.add('hidden-view');
            previewView.classList.remove('hidden-view');
            window.scrollTo(0, 0); // Reset scroll
        });

        // --- BACK BUTTON LOGIC ---
        backToEditBtn.addEventListener('click', function() {
            previewView.classList.add('hidden-view');
            inputView.classList.remove('hidden-view');
            window.scrollTo(0, 0);
        });

        // --- DOWNLOAD LOGIC ---
        downloadBtn.addEventListener('click', async function() {
            downloadBtn.disabled = true;
            const originalText = downloadBtn.innerHTML;
            downloadBtn.innerHTML = '<div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div> Generating...';
            
            try {
                await waitForImages(captureDiv);
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Adjust scale for better quality
                const canvas = await html2canvas(captureDiv, { 
                    scale: 2, 
                    useCORS: true, 
                    logging: false,
                    backgroundColor: '#ffffff'
                });

                const link = document.createElement('a');
                const cleanName = displayNameEl.textContent.replace(/\s+/g, '_') || 'Loan_Letter';
                link.download = `${cleanName}_${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                downloadBtn.innerHTML = '<i class="fas fa-check mr-2"></i> Done!';
                
                // Reset button after delay
                setTimeout(() => {
                    downloadBtn.disabled = false;
                    downloadBtn.innerHTML = originalText;
                }, 3000);

            } catch (err) {
                console.error(err);
                alert('Error generating image. Try again.');
                downloadBtn.disabled = false;
                downloadBtn.innerHTML = originalText;
            }
        });

        loanCategorySelect.addEventListener('change', updateOptions);
        amountInput.addEventListener('input', updateOptions);

        fetchMemberData();
    }

    checkAuthAndInitialize();
  </script>
</body>
</html>

