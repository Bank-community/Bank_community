<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Loan Application - Trust Community Fund</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Professional Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <style>
    :root {
        --royal-blue: #002366;
        --royal-gold: #D4AF37;
        --deep-blue: #001233;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      color: #1f2937;
    }

    /* === FORM UI (Mobile Friendly) === */
    .form-wrapper {
        background: white;
        border-top: 5px solid var(--royal-blue);
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    
    .input-field {
        background-color: #f9fafb;
        border: 1px solid #d1d5db;
        color: #111827;
        transition: all 0.3s;
    }
    .input-field:focus {
        border-color: var(--royal-blue);
        ring: 2px solid rgba(0, 35, 102, 0.2);
    }

    .btn-submit {
        background: linear-gradient(to right, var(--royal-blue), #003399);
        color: white;
        transition: transform 0.2s;
    }
    .btn-submit:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 35, 102, 0.3);
    }

    /* === A4 PAPER LAYOUT (Professional Print Style) === */
    #capture {
      width: 210mm;
      min-height: 290mm; /* A4 Height */
      background-color: #ffffff;
      margin: 0 auto;
      position: relative;
      /* Professional Double Border */
      border: 2px solid var(--royal-blue);
      outline: 5px solid white;
      outline-offset: -10px;
      padding: 15mm;
      box-sizing: border-box; 
      display: flex;
      flex-direction: column;
    }
    
    /* Inner Gold Border for Luxury Touch */
    #capture::after {
        content: '';
        position: absolute;
        top: 10mm; left: 10mm; right: 10mm; bottom: 10mm;
        border: 1px solid var(--royal-gold);
        pointer-events: none;
        z-index: 1;
    }

    /* Watermark */
    .watermark {
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        width: 300px;
        opacity: 0.04;
        pointer-events: none;
        z-index: 0;
    }

    /* Header */
    .doc-header {
        text-align: center;
        margin-bottom: 20px;
        position: relative;
        z-index: 2;
    }
    
    .brand-logo {
        width: 80px;
        height: 80px;
        margin: 0 auto 10px;
        display: block;
    }

    .brand-title {
        font-family: 'Playfair Display', serif;
        color: var(--royal-blue);
        font-size: 26px;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin: 0;
        font-weight: 700;
        border-bottom: 2px solid var(--royal-gold);
        display: inline-block;
        padding-bottom: 5px;
    }
    
    .loan-badge {
        background: white;
        color: #166534; /* Green Text */
        border: 1px solid #166534;
        padding: 4px 12px;
        border-radius: 4px;
        font-weight: bold;
        text-transform: uppercase;
        font-size: 14px;
        margin-top: 10px;
        display: inline-block;
    }

    .date-tag {
        position: absolute;
        top: 0;
        right: 0;
        font-size: 12px;
        color: #555;
    }

    /* Main Content Box (Like Bank Community) */
    .details-container {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 20px;
        margin-top: 10px;
        background-color: #f8fafc; /* Very light blue/gray */
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        position: relative;
        z-index: 2;
    }

    .details-list {
        flex: 1;
        padding-right: 20px;
    }

    .detail-item {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
        font-size: 14px;
        color: #374151;
        border-bottom: 1px dashed #e5e7eb;
        padding-bottom: 4px;
    }
    
    .detail-item:last-child {
        border-bottom: none;
    }

    .detail-icon {
        width: 20px;
        text-align: center;
        margin-right: 10px;
        color: var(--royal-blue);
    }

    .detail-label {
        width: 130px;
        font-weight: 500;
        color: #4b5563;
    }

    .detail-value {
        font-weight: 700;
        color: #111827;
        flex: 1;
    }

    .photo-box {
        width: 100px;
        text-align: center;
        background: white;
        padding: 5px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .photo-label {
        font-size: 10px;
        color: #6b7280;
        font-weight: bold;
        text-transform: uppercase;
        margin-bottom: 4px;
    }

    .applicant-img {
        width: 90px;
        height: 110px;
        object-fit: cover;
        background-color: #e5e7eb;
        display: block;
        margin: 0 auto;
    }

    /* Additional Doc */
    .doc-section {
        margin-top: 20px;
        text-align: center;
        border: 1px dashed #9ca3af;
        padding: 10px;
        border-radius: 8px;
        position: relative;
        z-index: 2;
        background: rgba(255,255,255,0.8);
    }

    /* Footer */
    .doc-footer {
        margin-top: auto;
        padding-top: 20px;
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        position: relative;
        z-index: 2;
    }

    .stamp-box {
        text-align: center;
    }
    
    .signature-box {
        text-align: center;
    }

    .stamp-img {
        width: 100px;
        opacity: 0.9;
        mix-blend-mode: multiply;
    }

    .sign-img {
        width: 140px;
        margin-bottom: -10px;
    }

    .footer-label {
        font-size: 12px;
        color: var(--royal-blue);
        font-weight: bold;
        text-transform: uppercase;
        border-top: 1px solid var(--royal-blue);
        padding-top: 4px;
        display: inline-block;
        min-width: 120px;
    }
    
    /* Loader */
    .loader {
        border: 3px solid rgba(255,255,255,0.3);
        border-top: 3px solid #fff;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        display: inline-block;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  </style>
</head>
<body class="p-4">

  <!-- === STEP 1: INPUT FORM === -->
  <div id="main-form-container" class="form-wrapper w-full max-w-lg mx-auto p-6 mb-10">
    <div class="text-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800" style="color: var(--royal-blue);">Trust Community Fund</h1>
        <p class="text-sm text-gray-500">Loan Application Form</p>
    </div>

    <form id="loanForm" class="space-y-4">
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Applicant Name</label>
            <select id="nameSelect" required class="input-field w-full p-3 rounded-lg"><option>Loading...</option></select>
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Loan Category</label>
            <select id="loanCategory" required class="input-field w-full p-3 rounded-lg">
                <option value="personal">Personal Loan</option>
                <option value="business">Business Loan</option>
                <option value="gold">Gold Loan</option>
                <option value="guarantor">Guarantor Loan</option>
            </select>
        </div>

        <div id="goldCollateralSection" class="hidden">
            <label class="block text-sm font-medium text-gray-700 mb-1">Collateral Item Name</label>
            <input type="text" id="goldCollateral" class="input-field w-full p-3 rounded-lg" placeholder="Item Name">
        </div>

        <div id="guarantorSection" class="hidden">
            <label class="block text-sm font-medium text-gray-700 mb-1">Guarantor Name</label>
            <select id="guarantorSelect" class="input-field w-full p-3 rounded-lg"><option>Select Guarantor</option></select>
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Loan Amount (₹)</label>
            <input type="number" id="amount" required class="input-field w-full p-3 rounded-lg" placeholder="5000">
        </div>

        <div>
            <label id="durationRateLabel" class="block text-sm font-medium text-gray-700 mb-1">Interest & Duration</label>
            <select id="durationRateSelect" required class="input-field w-full p-3 rounded-lg"></select>
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Additional Document (Optional)</label>
            <input type="file" id="imageUpload" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
        </div>

        <button type="submit" class="btn-submit w-full p-4 rounded-lg font-bold text-lg mt-4 shadow-lg">
            Generate Application Letter
        </button>
        
        <!-- Info Box -->
        <div id="loanInfoNotification" class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg text-sm text-gray-700 hidden"></div>
    </form>
  </div>

  <!-- === SUCCESS SCREEN === -->
  <div id="successMessage" class="hidden w-full max-w-md mx-auto bg-white p-8 rounded-xl shadow-xl text-center">
      <div class="w-16 h-16 bg-green-100 text-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-check text-3xl"></i>
      </div>
      <h2 class="text-2xl font-bold text-gray-800">Submitted!</h2>
      <p class="text-gray-500 mt-2 mb-6">Loan application created successfully.</p>
      
      <button id="successDownloadBtn" class="w-full p-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold mb-3 shadow">Download Letter</button>
      <button id="successShareBtn" class="hidden w-full p-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-bold shadow">Share on WhatsApp</button>
  </div>

  <!-- === STEP 2: PREVIEW & GENERATION (A4 CANVAS) === -->
  <div id="letter-preview-section" class="hidden w-full flex flex-col items-center mb-20">
      
      <!-- A4 CANVAS START -->
      <div id="capture">
        <!-- Watermark -->
        <img src="https://ik.imagekit.io/kdtvm0r78/IMG-20251202-WA0000.jpg" class="watermark" crossorigin="anonymous">

        <!-- Header -->
        <div class="doc-header">
            <span class="date-tag">Date: <span id="currentDate"></span></span>
            <img src="https://ik.imagekit.io/kdtvm0r78/IMG-20251202-WA0000.jpg" class="brand-logo" crossorigin="anonymous">
            <h1 class="brand-title">TRUST COMMUNITY FUND</h1>
            <br>
            <div class="loan-badge" id="letterLoanCategory">PERSONAL LOAN</div>
        </div>

        <!-- Main Body (Split Layout) -->
        <div class="details-container">
            <!-- Left: Details -->
            <div class="details-list">
                
                <div class="detail-item">
                    <div class="detail-icon"><i class="fas fa-user"></i></div>
                    <div class="detail-label">Applicant:</div>
                    <div class="detail-value highlight" id="displayName">--</div>
                </div>

                <div class="detail-item" id="guarantorRow">
                    <div class="detail-icon"><i class="fas fa-user-shield text-red-600"></i></div>
                    <div class="detail-label">Guarantor:</div>
                    <div class="detail-value text-red-700" id="displayGuarantor">--</div>
                </div>

                <div class="detail-item" id="collateralRow" style="display: none;">
                    <div class="detail-icon"><i class="fas fa-gem text-yellow-600"></i></div>
                    <div class="detail-label">Collateral:</div>
                    <div class="detail-value" id="displayCollateral">--</div>
                </div>

                <div class="detail-item">
                    <div class="detail-icon"><i class="fas fa-mobile-alt"></i></div>
                    <div class="detail-label">Mobile:</div>
                    <div class="detail-value" id="displayMobile">--</div>
                </div>

                <div class="detail-item">
                    <div class="detail-icon"><i class="fas fa-rupee-sign text-green-600"></i></div>
                    <div class="detail-label">Loan Amount:</div>
                    <div class="detail-value text-green-700 text-lg">₹<span id="displayAmount">0</span></div>
                </div>

                <div class="detail-item">
                    <div class="detail-icon"><i class="fas fa-percent"></i></div>
                    <div class="detail-label">Interest Rate:</div>
                    <div class="detail-value" id="displayRate">--</div>
                </div>

                <!-- Business/Gold Fields Hidden Initially -->
                <div class="detail-item" id="processingFeeRow" style="display: none;">
                    <div class="detail-icon"><i class="fas fa-cog"></i></div>
                    <div class="detail-label">Proc. Fee:</div>
                    <div class="detail-value">₹<span id="displayProcessingFee"></span></div>
                </div>

                <div class="detail-item" id="emiRow" style="display: none;">
                    <div class="detail-icon"><i class="fas fa-calendar-check"></i></div>
                    <div class="detail-label">Monthly EMI:</div>
                    <div class="detail-value">₹<span id="displayEMI"></span></div>
                </div>

                <div class="detail-item" style="background: #f0fdf4; margin-top: 5px;">
                    <div class="detail-icon"><i class="fas fa-money-bill-wave text-green-600"></i></div>
                    <div class="detail-label">Total Payable:</div>
                    <div class="detail-value text-green-800">₹<span id="displayTotalAmount">0</span></div>
                </div>

                <div class="detail-item">
                    <div class="detail-icon"><i class="fas fa-clock text-red-500"></i></div>
                    <div class="detail-label">End Date:</div>
                    <div class="detail-value text-red-600" id="repaymentDate">--</div>
                </div>
            </div>

            <!-- Right: Photo -->
            <div class="photo-box">
                <div class="photo-label">Applicant</div>
                <img id="apiApplicantPhoto" src="" class="applicant-img" crossorigin="anonymous">
            </div>
        </div>

        <!-- Additional Document (If any) -->
        <div id="manualUploadSection" class="doc-section" style="display: none;">
            <div class="photo-label" style="font-size: 12px; margin-bottom: 5px;">Additional Document / ID Proof</div>
            <img id="manualApplicantPhoto" src="" style="max-height: 200px; max-width: 100%; display: inline-block;" crossorigin="anonymous">
        </div>

        <p class="text-center text-xs text-gray-500 italic mt-8">"I solemnly declare that I will repay the loan amount within the stipulated time mentioned above."</p>

        <!-- Footer -->
        <div class="doc-footer">
            <div class="stamp-box">
                <img src="https://ik.imagekit.io/kdtvm0r78/20251206_210616.png" class="stamp-img" crossorigin="anonymous">
                <div class="footer-label">Official Stamp</div>
            </div>

            <div class="signature-box">
                <img src="https://ik.imagekit.io/kdtvm0r78/image.png" class="sign-img" crossorigin="anonymous">
                <div class="footer-label">Prime Members</div>
            </div>
        </div>
      </div>
      <!-- A4 CANVAS END -->

      <!-- Action Buttons -->
      <div id="action-buttons" class="w-full max-w-md mt-6 space-y-3">
        <button id="submitForApprovalBtn" class="w-full p-4 bg-blue-900 text-white rounded-lg font-bold shadow-lg flex justify-center items-center hover:bg-blue-800">
            <span id="submitBtnText">Confirm & Submit</span>
            <div id="submitLoader" class="loader ml-3 hidden"></div>
        </button>
        <button onclick="location.reload()" class="w-full text-gray-500 text-sm underline">Cancel & Edit</button>
      </div>

  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <script>
    let IMGBB_API_KEY_FORM = null;
    let pendingLoanData = {};
    let generatedCanvas = null;

    // --- INITIALIZATION ---
    async function init() {
        try {
            const res = await fetch('/api/config.js');
            const config = await res.json();
            IMGBB_API_KEY_FORM = config.imgbb.formApiKey;
            
            if (!firebase.apps.length) firebase.initializeApp(config.firebase);
            
            firebase.auth().onAuthStateChanged(user => {
                if(user) loadData();
                else window.location.href = `/login.html?redirect=${window.location.pathname}`;
            });
        } catch(e) {
            alert('Initialization Error');
        }
    }

    async function loadData() {
        const db = firebase.database();
        const snap = await db.ref('members').once('value');
        const members = snap.val() || {};
        
        const select = document.getElementById('nameSelect');
        const gSelect = document.getElementById('guarantorSelect');
        select.innerHTML = '<option value="" disabled selected>Select Applicant</option>';
        gSelect.innerHTML = '<option value="" disabled selected>Select Guarantor</option>';

        Object.values(members)
            .filter(m => m.status === 'Approved')
            .sort((a,b) => a.fullName.localeCompare(b.fullName))
            .forEach(m => {
                const opt = `<option value="${m.id}">${m.fullName}</option>`;
                select.innerHTML += opt;
                gSelect.innerHTML += opt;
            });
            
        updateFormUI(); // Initial UI State
    }

    // --- UI UPDATES ---
    const loanOptions = {
        personal: { label: 'Interest & Duration', opts: [{v:'1-1', t:'1% - 1 Month'}, {v:'3-2', t:'3% - 2 Months'}, {v:'5-3', t:'5% - 3 Months'}] },
        business: { label: 'Duration (18% Annual)', opts: [{v:'3-6', t:'9 Months (3 Int + 6 EMI)'}, {v:'6-6', t:'12 Months (6 Int + 6 EMI)'}] },
        gold: { label: 'Duration (3% Monthly)', opts: [{v:'3-6', t:'6 Months'}, {v:'3-12', t:'1 Year'}] },
        guarantor: { label: 'Duration (3% Monthly)', opts: [{v:'3-6', t:'6 Months'}, {v:'3-12', t:'1 Year'}] }
    };

    function updateFormUI() {
        const cat = document.getElementById('loanCategory').value;
        const conf = loanOptions[cat];
        
        // Update Options
        const durSelect = document.getElementById('durationRateSelect');
        durSelect.innerHTML = '';
        conf.opts.forEach(o => durSelect.innerHTML += `<option value="${o.v}">${o.t}</option>`);
        document.getElementById('durationRateLabel').innerText = conf.label;

        // Toggle Sections
        document.getElementById('goldCollateralSection').style.display = (cat === 'gold') ? 'block' : 'none';
        
        const applicantName = document.getElementById('nameSelect').options[document.getElementById('nameSelect').selectedIndex]?.text || '';
        const needsGuarantor = cat === 'guarantor' || applicantName.toLowerCase().includes('bank');
        document.getElementById('guarantorSection').style.display = needsGuarantor ? 'block' : 'none';
        document.getElementById('guarantorSelect').required = needsGuarantor;
        
        // Show Info Box
        const infoBox = document.getElementById('loanInfoNotification');
        infoBox.style.display = 'block';
        if(cat === 'personal') infoBox.innerHTML = '<strong>Personal Loan:</strong> 1.5x Limit of Deposit. 1-3 Months duration.';
        else if(cat === 'business') infoBox.innerHTML = '<strong>Business Loan:</strong> 18% Annual Interest + 1% Processing Fee.';
        else infoBox.innerHTML = '<strong>Secured Loan:</strong> 3% Monthly Interest.';
    }

    // --- GENERATE PREVIEW ---
    document.getElementById('loanForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // 1. Gather Data
        const uid = document.getElementById('nameSelect').value;
        const amount = parseFloat(document.getElementById('amount').value);
        const cat = document.getElementById('loanCategory').value;
        const rateVal = document.getElementById('durationRateSelect').value;
        
        const db = firebase.database();
        const snap = await db.ref(`members/${uid}`).once('value');
        const member = snap.val();
        
        // 2. Calculate Logic (Simplified for brevity, logic remains same)
        let interest = 0, months = 0, total = 0, emi = 0, procFee = 0, endLabel = '';
        
        if(cat === 'personal') {
            const [r, m] = rateVal.split('-').map(Number);
            total = amount + (amount * r / 100);
            endLabel = `${r}% for ${m} Months`;
            months = m;
        } else if(cat === 'business') {
            const [intMos, emiMos] = rateVal.split('-').map(Number);
            procFee = amount * 0.01 + (amount>9000?200:0);
            const rate = 0.015; // 1.5% monthly
            // Business Logic Approximation for preview
            const monthlyInt = amount * rate;
            const emiVal = (amount * rate * Math.pow(1+rate, emiMos))/(Math.pow(1+rate, emiMos)-1);
            total = (monthlyInt * intMos) + (emiVal * emiMos);
            endLabel = '18% Annual';
            months = intMos + emiMos;
            
            document.getElementById('processingFeeRow').style.display = 'flex';
            document.getElementById('displayProcessingFee').innerText = procFee.toFixed(0);
            document.getElementById('emiRow').style.display = 'flex';
            document.getElementById('displayEMI').innerText = emiVal.toFixed(0);
        } else {
            // Gold/Guarantor
            const [r, m] = rateVal.split('-').map(Number);
            const rate = r/100;
            const fullEmi = (amount * rate * Math.pow(1+rate, m))/(Math.pow(1+rate, m)-1);
            total = fullEmi * m;
            endLabel = `${r}% Monthly`;
            months = m;
            document.getElementById('emiRow').style.display = 'flex';
            document.getElementById('displayEMI').innerText = fullEmi.toFixed(0);
        }

        // 3. Fill Preview
        const date = new Date();
        document.getElementById('currentDate').innerText = date.toLocaleDateString('en-GB');
        date.setMonth(date.getMonth() + months);
        document.getElementById('repaymentDate').innerText = date.toLocaleDateString('en-GB');
        
        document.getElementById('displayName').innerText = member.fullName;
        document.getElementById('displayMobile').innerText = member.mobileNumber || 'N/A';
        document.getElementById('displayAmount').innerText = amount.toLocaleString();
        document.getElementById('displayRate').innerText = endLabel;
        document.getElementById('displayTotalAmount').innerText = total.toLocaleString('en-IN', {maximumFractionDigits: 0});
        document.getElementById('letterLoanCategory').innerText = cat.toUpperCase() + ' LOAN';
        
        // Guarantor
        const gRow = document.getElementById('guarantorRow');
        let gName = member.guarantorName || 'N/A';
        if(document.getElementById('guarantorSection').style.display === 'block') {
             const gid = document.getElementById('guarantorSelect').value;
             const gSnap = await db.ref(`members/${gid}`).once('value');
             gName = gSnap.val().fullName;
        }
        document.getElementById('displayGuarantor').innerText = gName;
        gRow.style.display = (cat === 'personal' && !gName) ? 'none' : 'flex'; // Hide if no guarantor for personal

        // Collateral
        const cRow = document.getElementById('collateralRow');
        const colItem = document.getElementById('goldCollateral').value;
        if(cat === 'gold') {
            document.getElementById('displayCollateral').innerText = colItem;
            cRow.style.display = 'flex';
        } else {
            cRow.style.display = 'none';
        }

        // Images
        const proxy = url => url ? `https://images.weserv.nl/?url=${url.replace(/^https?:\/\//, '')}` : 'https://placehold.co/100x100?text=No+Img';
        document.getElementById('apiApplicantPhoto').src = proxy(member.profilePicUrl);
        
        // Manual Upload
        const file = document.getElementById('imageUpload').files[0];
        const manualSec = document.getElementById('manualUploadSection');
        if(file) {
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById('manualApplicantPhoto').src = e.target.result;
                manualSec.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            manualSec.style.display = 'none';
        }

        // Store Data
        pendingLoanData = {
            applicantId: uid,
            applicantName: member.fullName,
            amount, category: cat, total,
            docFile: file,
            date: new Date().toISOString()
        };

        // Switch View
        document.getElementById('main-form-container').style.display = 'none';
        document.getElementById('letter-preview-section').classList.remove('hidden');
        window.scrollTo(0,0);
    });

    // --- SUBMIT ---
    document.getElementById('submitForApprovalBtn').addEventListener('click', async () => {
        const btn = document.getElementById('submitForApprovalBtn');
        const loader = document.getElementById('submitLoader');
        btn.disabled = true;
        loader.classList.remove('hidden');

        try {
            // Wait for images
            const imgs = document.querySelectorAll('#capture img');
            await Promise.all([...imgs].map(img => {
                if(img.complete) return;
                return new Promise(r => { img.onload=r; img.onerror=r; });
            }));

            // Capture
            const canvas = await html2canvas(document.getElementById('capture'), {
                scale: 2, 
                useCORS: true,
                backgroundColor: '#ffffff' 
            });
            generatedCanvas = canvas;
            
            // Upload Letter
            const blob = await new Promise(r => canvas.toBlob(r));
            const formData = new FormData();
            formData.append('image', blob);
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY_FORM}`, {method:'POST', body:formData});
            const json = await res.json();
            const letterUrl = json.data.url;
            
            // Upload Extra Doc
            let docUrl = null;
            if(pendingLoanData.docFile) {
                const fd = new FormData();
                fd.append('image', pendingLoanData.docFile);
                const r2 = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY_FORM}`, {method:'POST', body:fd});
                const j2 = await r2.json();
                docUrl = j2.data.url;
            }

            // Save to DB
            await firebase.database().ref('pendingLoans').push({
                ...pendingLoanData,
                letterUrl, docUrl,
                status: 'pending'
            });

            // Show Success
            document.getElementById('letter-preview-section').classList.add('hidden');
            document.getElementById('successMessage').classList.remove('hidden');
            document.getElementById('successDownloadBtn').classList.remove('hidden');

        } catch(e) {
            alert('Error: ' + e.message);
            btn.disabled = false;
            loader.classList.add('hidden');
        }
    });

    // --- DOWNLOAD ---
    document.getElementById('successDownloadBtn').addEventListener('click', () => {
        const link = document.createElement('a');
        link.download = `Loan_App_${Date.now()}.png`;
        link.href = generatedCanvas.toDataURL();
        link.click();
        document.getElementById('successShareBtn').classList.remove('hidden');
    });

    document.getElementById('successShareBtn').addEventListener('click', () => {
        window.open('https://chat.whatsapp.com/G39I0hP55WIDHMu5YkAjDZ', '_blank');
    });

    document.getElementById('nameSelect').addEventListener('change', updateFormUI);
    document.getElementById('loanCategory').addEventListener('change', updateFormUI);
    
    init();
  </script>
</body>
</html>


