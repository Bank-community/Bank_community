<meta name='viewport' content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no'/><!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <title>Trust Community Fund</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              teal: '#0f766e',
              gold: '#f59e0b',
              dark: '#111827'
            }
          }
        }
      }
    }
  </script>

  <style>
    body { font-family: 'Poppins', sans-serif; background: #f3f4f6; overflow-x: hidden; }
    
    /* Input Section Styles */
    .form-card {
      background: white;
      border-top: 5px solid #0f766e;
      box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
    }
    input:focus, select:focus {
      border-color: #0f766e;
      ring: 2px solid #0f766e;
      outline: none;
    }

    /* PREVIEW SECTION STYLES (The Real Fix) */
    #preview-overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: #1f2937; /* Dark Grey Background */
        z-index: 9999;
        overflow-y: auto;
        display: none; /* Hidden by default */
        flex-direction: column;
        align-items: center;
        padding-bottom: 50px;
    }

    /* Fixed Action Header */
    .action-header {
        position: sticky;
        top: 0;
        width: 100%;
        background: rgba(31, 41, 55, 0.95);
        backdrop-filter: blur(5px);
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 100;
        border-bottom: 1px solid #374151;
    }

    /* The A4 Paper Container - This scales down visually */
    #paper-scaler {
        margin-top: 20px;
        transform-origin: top center;
        /* Width will be set by JS or default to width of capture */
        transition: transform 0.3s ease;
    }

    /* The Actual A4 Paper */
    #capture {
        width: 210mm; /* Fixed A4 Width */
        min-height: 297mm; /* Fixed A4 Height */
        background: white;
        padding: 15mm;
        box-shadow: 0 0 50px rgba(0,0,0,0.5);
        position: relative;
        /* Ensure fonts look right on canvas */
        font-variant-ligatures: no-common-ligatures;
        line-height: 1.5;
    }

    .letter-title { color: #0f766e; border-bottom: 3px solid #0f766e; }
    
    /* Table like rows in letter */
    .info-row {
        display: flex;
        align-items: center;
        padding-bottom: 8px;
        margin-bottom: 8px;
        border-bottom: 1px solid #f3f4f6;
    }
    .info-label { width: 140px; font-weight: 600; color: #4b5563; font-size: 14px; }
    .info-val { flex: 1; font-weight: 700; color: #111827; font-size: 16px; }
    .info-icon { width: 30px; text-align: center; color: #0f766e; margin-right: 10px; }

  </style>
</head>
<body>

  <!-- ==================== INPUT PAGE ==================== -->
  <div id="input-page" class="min-h-screen flex flex-col items-center py-6 px-4">
    <div class="form-card p-6 rounded-xl w-full max-w-lg mb-8">
        <div class="text-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800">Trust Community Fund</h1>
            <p class="text-xs text-gray-500 uppercase tracking-widest mt-1">Loan Application Portal</p>
        </div>

        <form id="loanForm" class="space-y-4">
            <div>
                <label class="text-sm font-semibold text-gray-700">Applicant Name</label>
                <select id="nameSelect" required class="w-full p-3 border rounded-lg bg-gray-50 mt-1">
                    <option value="" disabled selected>Loading members...</option>
                </select>
            </div>
          
            <div>
                <label class="text-sm font-semibold text-gray-700">Loan Type</label>
                <select id="loanCategory" required class="w-full p-3 border rounded-lg bg-gray-50 mt-1">
                    <option value="personal">Personal Loan (Cash)</option>
                    <option value="product">Product Loan (Item/Asset)</option>
                </select>
            </div>

            <div id="productSection" class="hidden">
                <label class="text-sm font-semibold text-gray-700">Product Name</label>
                <input type="text" id="productInput" placeholder="Ex: Mobile, Laptop..." class="w-full p-3 border rounded-lg bg-gray-50 mt-1">
            </div>

            <div>
                <label class="text-sm font-semibold text-gray-700">Loan Amount (₹)</label>
                <input type="number" id="amount" placeholder="Max 50,000" min="1" max="50000" required class="w-full p-3 border rounded-lg bg-gray-50 text-lg font-bold text-brand-teal mt-1">
                <p id="limit-msg" class="text-xs text-red-500 mt-1 hidden">Maximum limit is ₹50,000</p>
            </div>

            <div id="dynamicOptions">
                <label class="text-sm font-semibold text-gray-700">Duration & Interest</label>
                <select id="durationRateSelect" required class="w-full p-3 border rounded-lg bg-gray-50 mt-1">
                   <option value="" disabled selected>Enter amount first...</option>
                </select>
            </div>

            <div>
                <label class="text-sm font-semibold text-gray-700">Additional Document (Optional)</label>
                <input type="file" id="imageUpload" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:bg-teal-50 file:text-teal-700 border rounded-lg mt-1">
            </div>

            <!-- Rules Image -->
            <div class="mt-4 rounded-lg overflow-hidden border">
                <img src="https://ik.imagekit.io/kdtvm0r78/1000119828-optimized_C4_53shzy.jpg" alt="Rules" class="w-full h-auto">
            </div>

            <button type="submit" class="w-full py-4 bg-brand-teal text-white font-bold rounded-xl shadow-lg hover:bg-teal-800 transition mt-4 flex justify-center items-center">
                GENERATE FORM <i class="fas fa-arrow-right ml-2"></i>
            </button>
        </form>
    </div>
  </div>

  <!-- ==================== PREVIEW PAGE (A4 Full Screen) ==================== -->
  <div id="preview-overlay">
      
      <!-- Top Bar -->
      <div class="action-header">
          <button id="closePreviewBtn" class="text-gray-300 hover:text-white font-medium flex items-center bg-gray-700 px-4 py-2 rounded-lg">
              <i class="fas fa-arrow-left mr-2"></i> Edit
          </button>
          <button id="downloadBtn" class="bg-brand-gold text-white font-bold px-6 py-2 rounded-lg shadow-lg hover:bg-yellow-600 flex items-center">
              <i class="fas fa-download mr-2"></i> Download A4
          </button>
      </div>

      <!-- Scaler Wrapper (This handles the Zoom) -->
      <div id="paper-scaler">
          
          <!-- THE ACTUAL A4 PAPER (Fixed Dimensions) -->
          <div id="capture">
              
              <!-- Letter Header -->
              <div class="text-center pb-4 mb-6 relative letter-title">
                  <div class="absolute right-0 top-0 text-right text-xs text-gray-500">
                      Date: <span id="currentDate"></span>
                  </div>
                  <img src="https://ik.imagekit.io/kdtvm0r78/IMG-20251202-WA0000.jpg" crossorigin="anonymous" class="w-24 mx-auto mb-2">
                  <h1 class="text-3xl font-bold text-gray-800 tracking-wide uppercase">TRUST COMMUNITY FUND</h1>
                  <div class="h-1 w-20 bg-brand-gold mx-auto my-2 rounded-full"></div>
                  <h2 id="letterLoanCategory" class="text-xl font-bold text-brand-teal uppercase tracking-wider"></h2>
              </div>

              <!-- Content Box -->
              <div class="flex flex-row justify-between items-start my-6 p-6 border border-gray-200 rounded-xl bg-slate-50">
                  <div class="flex-grow pr-4">
                      <!-- Rows -->
                      <div class="info-row">
                          <div class="info-icon"><i class="fas fa-user"></i></div>
                          <div class="info-label">Applicant Name:</div>
                          <div class="info-val" id="displayName"></div>
                      </div>

                      <div id="productRow" class="info-row hidden">
                          <div class="info-icon"><i class="fas fa-box-open"></i></div>
                          <div class="info-label">Product Name:</div>
                          <div class="info-val text-brand-teal" id="displayProduct"></div>
                      </div>

                      <div class="info-row">
                          <div class="info-icon"><i class="fas fa-mobile-alt"></i></div>
                          <div class="info-label">Mobile Number:</div>
                          <div class="info-val" id="displayMobile"></div>
                      </div>

                      <div class="info-row">
                          <div class="info-icon"><i class="fas fa-rupee-sign"></i></div>
                          <div class="info-label">Loan Amount:</div>
                          <div class="info-val text-2xl text-brand-teal">₹<span id="displayAmount"></span></div>
                      </div>

                      <div id="feeRow" class="info-row hidden">
                          <div class="info-icon"><i class="fas fa-cogs"></i></div>
                          <div class="info-label">Processing Fee:</div>
                          <div class="info-val">₹<span id="displayFee"></span></div>
                      </div>

                      <div class="info-row">
                          <div class="info-icon"><i class="fas fa-percent"></i></div>
                          <div class="info-label">Interest Rate:</div>
                          <div class="info-val text-sm" id="displayRate"></div>
                      </div>

                      <div class="info-row">
                          <div class="info-icon"><i class="fas fa-chart-pie"></i></div>
                          <div class="info-label">Monthly EMI:</div>
                          <div class="info-val text-xl text-brand-gold">₹<span id="displayEMI"></span></div>
                      </div>

                      <div class="info-row" style="border:none;">
                          <div class="info-icon"><i class="fas fa-calendar-alt"></i></div>
                          <div class="info-label">End Date:</div>
                          <div class="info-val" id="repaymentDate"></div>
                      </div>
                  </div>

                  <!-- Photo Box -->
                  <div class="flex-shrink-0 w-32 text-center bg-white p-2 rounded border border-gray-200 shadow-sm">
                      <img id="apiApplicantPhoto" src="" crossorigin="anonymous" class="w-full h-32 object-contain rounded mb-1">
                      <p class="text-[10px] text-gray-500 uppercase font-bold">Applicant Photo</p>
                  </div>
              </div>
              
              <div class="info-row" style="border-top:1px solid #eee; padding-top:10px;">
                  <div class="info-icon"><i class="fas fa-file-invoice-dollar"></i></div>
                  <div class="info-label">Total Payable:</div>
                  <div class="info-val">₹<span id="displayTotal"></span></div>
              </div>

              <!-- Notice -->
              <div class="mx-auto w-full my-6">
                  <div class="border-l-4 border-red-500 bg-red-50 p-4 rounded-r-md flex items-start">
                      <i class="fas fa-exclamation-circle text-red-500 mt-1 mr-3 text-lg"></i>
                      <div>
                          <h3 class="text-sm font-bold text-red-800 uppercase">Important Notice (महत्वपूर्ण सूचना)</h3>
                          <p class="text-sm text-red-700 mt-1 font-medium">
                              EMI every month 1 to 10 tarikh tak jama karein. Yadi late hua to loan amount ka 1% extra charges lagega.
                          </p>
                      </div>
                  </div>
              </div>

              <!-- Extra Doc -->
              <div id="manualDocBox" class="my-4 mx-auto p-2 border border-dashed border-gray-300 rounded text-center max-w-[80%] hidden">
                  <p class="mb-1 font-bold text-gray-500 text-xs">Additional Document</p>
                  <img id="manualDocImg" src="" crossorigin="anonymous" class="max-w-full max-h-48 h-auto object-contain mx-auto">
              </div>

              <p class="text-center italic text-brand-teal text-base mt-10 font-medium">
                  "I request the bank community members to please approve this loan application."
              </p>
              
              <!-- Footer -->
              <div class="absolute bottom-10 left-0 right-0 px-14 flex justify-between items-end">
                  <div class="text-center">
                       <img src="https://ik.imagekit.io/kdtvm0r78/20251206_210616.png" crossorigin="anonymous" class="w-32 opacity-80" style="mix-blend-mode: multiply;">
                       <p class="text-xs text-gray-500 uppercase font-bold mt-1">Community Stamp</p>
                  </div>
                  <div class="text-center">
                    <p class="text-xs text-gray-500 uppercase font-bold mb-2">Authorized Signature</p>
                    <img src="https://ik.imagekit.io/kdtvm0r78/image.png" crossorigin="anonymous" class="w-40">
                    <p class="text-xs text-brand-teal font-bold mt-1">Prime Members</p>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <script>
    async function checkAuthAndInitialize() {
        try {
            const response = await fetch('/api/config.js');
            if (!response.ok) throw new Error('Config load failed');
            const config = await response.json();
            
            firebase.initializeApp(config.firebase);
            firebase.auth().onAuthStateChanged(user => {
                if (user) runAppLogic();
                else window.location.href = `/login.html?redirect=${window.location.pathname}`;
            });
        } catch (error) {
            document.body.innerHTML = `<h3 class="text-center p-10 text-red-500">Error: ${error.message}</h3>`;
        }
    }

    function runAppLogic() {
        let membersData = {};

        // Inputs
        const nameSelect = document.getElementById('nameSelect');
        const loanCategory = document.getElementById('loanCategory');
        const amountInp = document.getElementById('amount');
        const durationSelect = document.getElementById('durationRateSelect');
        const imageUp = document.getElementById('imageUpload');
        const productInp = document.getElementById('productInput');
        const productSec = document.getElementById('productSection');

        // Logic
        function updateUI() {
            const cat = loanCategory.value;
            const amt = parseFloat(amountInp.value) || 0;
            
            // Toggle Product Input
            if(cat === 'product') {
                productSec.classList.remove('hidden');
                productInp.required = true;
            } else {
                productSec.classList.add('hidden');
                productInp.required = false;
            }

            // Limit warning
            document.getElementById('limit-msg').classList.toggle('hidden', amt <= 50000);

            // Populate Dropdown
            durationSelect.innerHTML = '';
            if(amt === 0) {
                durationSelect.innerHTML = '<option>Enter amount first...</option>';
                return;
            }

            let opts = [];
            
            if(cat === 'personal') {
                if(amt < 15000) {
                    opts = [
                        {val: '1-1.0-0', txt: '1 Month (1% Interest)'},
                        {val: '2-1.5-0', txt: '2 Months (1.5% Interest)'},
                        {val: '3-1.66-0', txt: '3 Months (1.66% Interest)'}
                    ];
                } else if(amt < 30000) {
                    opts = [
                        {val: '1-1.0-0', txt: '1 Month (1% Interest)'},
                        {val: '2-1.5-0', txt: '2 Months (1.5% Interest)'},
                        {val: '3-1.66-0', txt: '3 Months (1.66% Interest)'},
                        {val: '4-1.66-0', txt: '4 Months (1.66% Interest)'},
                        {val: '5-1.66-0', txt: '5 Months (1.66% Interest)'}
                    ];
                } else {
                    opts = [
                        {val: '6-0.66-0.5', txt: '6 Months (0.66% Int + 0.5% Fee)'},
                        {val: '9-0.66-0.5', txt: '9 Months (0.66% Int + 0.5% Fee)'},
                        {val: '12-0.66-0.5', txt: '12 Months (0.66% Int + 0.5% Fee)'}
                    ];
                }
            } else {
                // Product
                if(amt >= 30000) {
                    opts = [
                        {val: '6-0.5-100', txt: '6 Months (0.5% Int + ₹100 Fee)'},
                        {val: '9-0.5-100', txt: '9 Months (0.5% Int + ₹100 Fee)'},
                        {val: '12-0.5-100', txt: '12 Months (0.5% Int + ₹100 Fee)'}
                    ];
                } else {
                    const fee = amt > 5000 ? 100 : 0;
                    opts = [
                        {val: `1-1.0-${fee}`, txt: `1 Month (1% Int${fee?'+₹100 Fee':''})`},
                        {val: `2-1.0-${fee}`, txt: `2 Months (1% Int${fee?'+₹100 Fee':''})`},
                        {val: `3-1.0-${fee}`, txt: `3 Months (1% Int${fee?'+₹100 Fee':''})`},
                        {val: `4-1.0-${fee}`, txt: `4 Months (1% Int${fee?'+₹100 Fee':''})`},
                        {val: `5-1.0-${fee}`, txt: `5 Months (1% Int${fee?'+₹100 Fee':''})`}
                    ];
                }
            }

            opts.forEach(o => {
                const el = document.createElement('option');
                el.value = o.val;
                el.innerText = o.txt;
                durationSelect.appendChild(el);
            });
        }

        loanCategory.addEventListener('change', updateUI);
        amountInp.addEventListener('input', updateUI);

        // Fetch Members
        firebase.database().ref('members').once('value').then(snap => {
            membersData = snap.val() || {};
            nameSelect.innerHTML = '<option value="" disabled selected>Select Applicant</option>';
            Object.entries(membersData)
                .filter(([_, m]) => m.status === 'Approved')
                .sort((a,b) => a[1].fullName.localeCompare(b[1].fullName))
                .forEach(([id, m]) => {
                    const opt = document.createElement('option');
                    opt.value = id; opt.text = m.fullName;
                    nameSelect.appendChild(opt);
                });
        });

        // GENERATE & PREVIEW LOGIC
        const inputPage = document.getElementById('input-page');
        const previewOverlay = document.getElementById('preview-overlay');
        const paperScaler = document.getElementById('paper-scaler');
        const capture = document.getElementById('capture');

        document.getElementById('loanForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const member = membersData[nameSelect.value];
            if(!member) return alert('Select member');

            const amt = parseFloat(amountInp.value);
            const [months, intRate, feeRaw] = durationSelect.value.split('-').map(Number);
            
            // Calculate
            let fee = 0;
            if(loanCategory.value === 'personal' && amt >= 30000) fee = amt * (feeRaw/100);
            else if(loanCategory.value === 'product' || (amt >= 30000 && loanCategory.value === 'product')) fee = feeRaw;
            
            const monthlyInt = amt * (intRate/100);
            const totalPay = amt + (monthlyInt * months);
            const emi = Math.ceil(totalPay / months);
            
            const endD = new Date();
            endD.setMonth(endD.getMonth() + months);

            // Fill Letter
            document.getElementById('currentDate').innerText = new Date().toLocaleDateString('en-GB', {day:'numeric', month:'long', year:'numeric'});
            document.getElementById('letterLoanCategory').innerText = loanCategory.value === 'personal' ? 'PERSONAL LOAN' : 'PRODUCT LOAN';
            document.getElementById('displayName').innerText = member.fullName;
            document.getElementById('displayMobile').innerText = member.mobileNumber || 'N/A';
            document.getElementById('displayAmount').innerText = amt.toFixed(2);
            document.getElementById('displayRate').innerText = `${intRate}% Monthly for ${months} Months`;
            document.getElementById('displayEMI').innerText = emi.toFixed(2);
            document.getElementById('displayTotal').innerText = totalPay.toFixed(2);
            document.getElementById('repaymentDate').innerText = endD.toLocaleDateString('en-GB', {day:'numeric', month:'short', year:'numeric'});

            // Product & Fee Rows
            const prodRow = document.getElementById('productRow');
            if(loanCategory.value === 'product') {
                prodRow.classList.remove('hidden');
                prodRow.style.display = 'flex';
                document.getElementById('displayProduct').innerText = productInp.value;
            } else {
                prodRow.classList.add('hidden');
                prodRow.style.display = 'none';
            }

            const feeRow = document.getElementById('feeRow');
            if(fee > 0) {
                feeRow.classList.remove('hidden');
                feeRow.style.display = 'flex';
                document.getElementById('displayFee').innerText = fee.toFixed(2);
            } else {
                feeRow.classList.add('hidden');
                feeRow.style.display = 'none';
            }

            // Images
            const setImg = (id, url) => {
                const img = document.getElementById(id);
                if(url) {
                    // Proxy for CORS
                    img.src = `https://images.weserv.nl/?url=${url.replace(/^https?:\/\//,'')}`;
                } else img.src = ''; 
            };
            setImg('apiApplicantPhoto', member.profilePicUrl);
            
            const manFile = imageUp.files[0];
            const manBox = document.getElementById('manualDocBox');
            if(manFile) {
                const reader = new FileReader();
                reader.onload = e => {
                    document.getElementById('manualDocImg').src = e.target.result;
                    manBox.classList.remove('hidden');
                };
                reader.readAsDataURL(manFile);
            } else if(member.documentUrl) {
                setImg('manualDocImg', member.documentUrl);
                manBox.classList.remove('hidden');
            } else {
                manBox.classList.add('hidden');
            }

            // SHOW PREVIEW (Zoom Out Logic)
            inputPage.classList.add('hidden');
            previewOverlay.style.display = 'flex';
            
            // Auto Scale to fit mobile screen
            // A4 width is approx 794px at 96DPI (210mm).
            // We want 20px margin on sides.
            const screenW = window.innerWidth;
            const paperW = capture.offsetWidth; // ~794px
            
            if(screenW < paperW + 40) {
                const scale = (screenW - 20) / paperW;
                paperScaler.style.transform = `scale(${scale})`;
                // Adjust margin bottom to compensate for scale shrinking height visually
                // (Optional fine tuning)
            } else {
                paperScaler.style.transform = `scale(1)`;
            }
            window.scrollTo(0,0);
        });

        document.getElementById('closePreviewBtn').onclick = () => {
            previewOverlay.style.display = 'none';
            inputPage.classList.remove('hidden');
        };

        // DOWNLOAD A4
        document.getElementById('downloadBtn').onclick = async function() {
            const btn = this;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Generating...';

            // Wait for images
            const imgs = Array.from(capture.getElementsByTagName('img'));
            await Promise.all(imgs.map(img => {
                if(img.complete) return Promise.resolve();
                return new Promise(r => { img.onload=r; img.onerror=r; });
            }));

            // Capture at Scale 1 (High Quality)
            // We grab the #capture element directly, ignoring the preview scale
            html2canvas(capture, {
                scale: 2, // 2x Quality
                useCORS: true,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Loan_${document.getElementById('displayName').innerText.replace(/\s/g,'_')}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check mr-2"></i> Downloaded';
                setTimeout(() => btn.innerHTML = '<i class="fas fa-download mr-2"></i> Download A4', 3000);
            });
        };
    }

    checkAuthAndInitialize();
  </script>
</body>
</html>

