<meta name='viewport' content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no'/><!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <title>Trust Community Fund</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              teal: '#0f766e',
              gold: '#f59e0b',
              dark: '#111827'
            }
          }
        }
      }
    }
  </script>

  <style>
    body { font-family: 'Poppins', sans-serif; background: #f3f4f6; overflow-x: hidden; }
    
    .form-card {
      background: white;
      border-top: 5px solid #0f766e;
      box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
    }
    input:focus, select:focus {
      border-color: #0f766e;
      ring: 2px solid #0f766e;
      outline: none;
    }

    #preview-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: #1f2937; z-index: 9999;
        overflow-y: scroll; display: none;
        flex-direction: column; align-items: center;
        padding-bottom: 50px;
    }

    .action-header {
        position: sticky; top: 0; width: 100%;
        background: rgba(31, 41, 55, 0.95);
        backdrop-filter: blur(5px);
        padding: 15px 20px;
        display: flex; justify-content: space-between;
        align-items: center; z-index: 100;
        border-bottom: 1px solid #374151;
    }

    #paper-scaler {
        margin-top: 20px; transform-origin: top center;
        transition: transform 0.3s ease;
        display: flex; justify-content: center;
    }

    #capture {
        width: 210mm; min-height: 297mm;
        background: white; padding: 12mm;
        box-shadow: 0 0 50px rgba(0,0,0,0.5);
        position: relative; flex-shrink: 0;
        -webkit-font-smoothing: antialiased;
        display: flex; flex-direction: column;
    }

    .letter-title { color: #0f766e; border-bottom: 3px solid #0f766e; margin-bottom: 15px; padding-bottom: 10px; }
    
    .info-row {
        display: flex; align-items: center;
        padding-bottom: 6px; margin-bottom: 6px;
        border-bottom: 1px solid #e5e7eb;
    }
    .info-label { width: 130px; font-weight: 600; color: #4b5563; font-size: 14px; }
    .info-val { flex: 1; font-weight: 700; color: #111827; font-size: 16px; }
    .info-icon { width: 25px; text-align: center; color: #0f766e; margin-right: 8px; font-size: 14px; }

    .main-info-box {
        background-color: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 15px;
    }
  </style>
</head>
<body>

  <div id="input-page" class="min-h-screen flex flex-col items-center py-6 px-4">
    <div class="form-card p-6 rounded-xl w-full max-w-lg mb-8">
        <div class="text-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800">Trust Community Fund</h1>
            <p class="text-xs text-gray-500 uppercase tracking-widest mt-1">Loan Application Portal</p>
        </div>

        <form id="loanForm" class="space-y-4">
            <div>
                <label class="text-sm font-semibold text-gray-700">Applicant Name</label>
                <select id="nameSelect" required class="w-full p-3 border rounded-lg bg-gray-50 mt-1">
                    <option value="" disabled selected>Loading members...</option>
                </select>
            </div>
            <div>
                <label class="text-sm font-semibold text-gray-700">Loan Type</label>
                <select id="loanCategory" required class="w-full p-3 border rounded-lg bg-gray-50 mt-1">
                    <option value="personal">Personal Loan (Cash)</option>
                    <option value="product">Product Loan (Item/Asset)</option>
                </select>
            </div>
            <div id="productSection" class="hidden">
                <label class="text-sm font-semibold text-gray-700">Product Name</label>
                <input type="text" id="productInput" placeholder="Ex: Mobile, Laptop..." class="w-full p-3 border rounded-lg bg-gray-50 mt-1">
            </div>
            <div>
                <label class="text-sm font-semibold text-gray-700">Loan Amount (₹)</label>
                <input type="number" id="amount" placeholder="Max 50,000" min="1" max="50000" required class="w-full p-3 border rounded-lg bg-gray-50 text-lg font-bold text-brand-teal mt-1">
                <p id="limit-msg" class="text-xs text-red-500 mt-1 hidden">Maximum limit is ₹50,000</p>
            </div>
            <div id="dynamicOptions">
                <label class="text-sm font-semibold text-gray-700">Duration & Interest</label>
                <select id="durationRateSelect" required class="w-full p-3 border rounded-lg bg-gray-50 mt-1">
                   <option value="" disabled selected>Enter amount first...</option>
                </select>
            </div>
            <div>
                <label class="text-sm font-semibold text-gray-700">Additional Document (Use if not in profile)</label>
                <input type="file" id="imageUpload" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:bg-teal-50 file:text-teal-700 border rounded-lg mt-1">
            </div>
            <div class="mt-4 rounded-lg overflow-hidden border">
                <img src="https://ik.imagekit.io/kdtvm0r78/1000119828-optimized_C4_53shzy.jpg" alt="Rules" class="w-full h-auto">
            </div>
            <button type="submit" class="w-full py-4 bg-brand-teal text-white font-bold rounded-xl shadow-lg hover:bg-teal-800 transition mt-4 flex justify-center items-center">
                GENERATE FORM <i class="fas fa-arrow-right ml-2"></i>
            </button>
        </form>
    </div>
  </div>

  <div id="preview-overlay">
      <div class="action-header">
          <button id="closePreviewBtn" class="text-gray-300 hover:text-white font-medium flex items-center bg-gray-700 px-4 py-2 rounded-lg">
              <i class="fas fa-arrow-left mr-2"></i> Edit
          </button>
          <button id="downloadBtn" class="bg-brand-gold text-white font-bold px-6 py-2 rounded-lg shadow-lg hover:bg-yellow-600 flex items-center">
              <i class="fas fa-download mr-2"></i> Download A4
          </button>
      </div>

      <div id="paper-scaler">
          <div id="capture">
              <div class="text-center relative letter-title">
                  <div class="absolute right-0 top-0 text-right text-xs text-gray-500">
                      Date: <span id="currentDate"></span>
                  </div>
                  <img src="https://ik.imagekit.io/kdtvm0r78/IMG-20251202-WA0000.jpg" crossorigin="anonymous" class="w-20 mx-auto mb-1">
                  <h1 class="text-3xl font-bold text-gray-800 tracking-wide uppercase">TRUST COMMUNITY FUND</h1>
                  <h2 id="letterLoanCategory" class="text-lg font-bold text-brand-teal uppercase tracking-wider mt-1"></h2>
              </div>

              <div class="main-info-box relative">
                  <div class="absolute top-4 right-4 text-center bg-white p-1 rounded border border-gray-200 shadow-sm z-10">
                      <img id="apiApplicantPhoto" src="" crossorigin="anonymous" class="w-24 h-24 object-contain rounded">
                  </div>

                  <div style="padding-right: 120px;"> 
                      <div class="info-row">
                          <div class="info-icon"><i class="fas fa-user"></i></div>
                          <div class="info-label">Applicant:</div>
                          <div class="info-val" id="displayName"></div>
                      </div>

                      <div id="guarantorRow" class="info-row hidden">
                          <div class="info-icon"><i class="fas fa-user-shield"></i></div>
                          <div class="info-label">Guarantor:</div>
                          <div class="info-val text-brand-teal" id="displayGuarantor"></div>
                      </div>

                      <div class="info-row">
                          <div class="info-icon"><i class="fas fa-mobile-alt"></i></div>
                          <div class="info-label">Mobile:</div>
                          <div class="info-val" id="displayMobile"></div>
                      </div>

                      <div id="productRow" class="info-row hidden">
                          <div class="info-icon"><i class="fas fa-box-open"></i></div>
                          <div class="info-label">Product:</div>
                          <div class="info-val text-brand-teal" id="displayProduct"></div>
                      </div>

                      <div class="info-row">
                          <div class="info-icon"><i class="fas fa-rupee-sign"></i></div>
                          <div class="info-label">Loan Amount:</div>
                          <div class="info-val text-xl text-brand-teal">₹<span id="displayAmount"></span></div>
                      </div>

                      <div id="feeRow" class="info-row hidden">
                          <div class="info-icon"><i class="fas fa-cogs"></i></div>
                          <div class="info-label">Proc. Fee:</div>
                          <div class="info-val">₹<span id="displayFee"></span></div>
                      </div>

                      <div class="info-row">
                          <div class="info-icon"><i class="fas fa-percent"></i></div>
                          <div class="info-label">Interest:</div>
                          <div class="info-val text-sm" id="displayRate"></div>
                      </div>

                      <div class="info-row">
                          <div class="info-icon"><i class="fas fa-chart-pie"></i></div>
                          <div class="info-label">EMI:</div>
                          <div class="info-val text-lg text-brand-gold">₹<span id="displayEMI"></span></div>
                      </div>

                      <div class="info-row" style="border:none;">
                          <div class="info-icon"><i class="fas fa-calendar-alt"></i></div>
                          <div class="info-label">End Date:</div>
                          <div class="info-val" id="repaymentDate"></div>
                      </div>
                  </div>
                  
                  <div style="border-top: 2px dashed #cbd5e1; margin-top: 10px; padding-top: 10px; display: flex; justify-content: space-between; align-items: flex-end;">
                      <div class="flex items-center">
                          <div class="info-icon"><i class="fas fa-file-invoice-dollar"></i></div>
                          <div class="info-label text-brand-teal">Total Payable:</div>
                          <div class="info-val text-xl font-bold text-gray-800">₹<span id="displayTotal"></span></div>
                      </div>
                      
                      <div class="text-center" style="min-width: 100px;">
                           <img id="displaySignature" src="" crossorigin="anonymous" class="h-10 object-contain mx-auto mb-1 hidden">
                           <div id="noSignatureText" class="text-[10px] text-gray-300 hidden">No Digital Sig</div>
                           <div class="text-[9px] text-gray-400 border-t border-gray-300 px-2">Applicant Signature</div>
                      </div>
                  </div>
              </div>

              <div class="mx-auto w-full mb-4">
                  <div class="border-l-4 border-red-500 bg-red-50 p-3 rounded-r-md flex items-start">
                      <i class="fas fa-exclamation-circle text-red-500 mt-1 mr-3"></i>
                      <div>
                          <h3 class="text-xs font-bold text-red-800 uppercase">Important Notice (महत्वपूर्ण सूचना)</h3>
                          <p class="text-xs text-red-700 mt-1 font-medium">
                              EMI every month 1 to 10 tarikh tak jama karein. Yadi late hua to loan amount ka 0.5% extra charges lagega.
                          </p>
                      </div>
                  </div>
              </div>

              <div id="docSection" class="mb-4 mx-auto w-full px-2 hidden">
                  <p class="text-center font-bold text-gray-500 text-xs mb-2">Attached Documents (Aadhaar/ID)</p>
                  <div class="flex justify-between gap-4">
                       <div class="border border-dashed border-gray-300 p-2 rounded bg-gray-50 w-1/2 flex flex-col items-center justify-center h-40">
                            <p class="text-[10px] text-gray-400 mb-1 font-semibold uppercase">Front Side</p>
                            <img id="docFrontImg" src="" crossorigin="anonymous" class="max-h-full max-w-full object-contain">
                       </div>
                       <div class="border border-dashed border-gray-300 p-2 rounded bg-gray-50 w-1/2 flex flex-col items-center justify-center h-40">
                            <p class="text-[10px] text-gray-400 mb-1 font-semibold uppercase">Back Side</p>
                            <img id="docBackImg" src="" crossorigin="anonymous" class="max-h-full max-w-full object-contain">
                       </div>
                  </div>
              </div>

              <div style="margin-top: auto;">
                  <p class="text-center italic text-brand-teal text-sm font-medium mb-8">
                      "I request the bank community members to please approve this loan application."
                  </p>
                  <div class="flex justify-between items-end px-10 pb-4 border-t border-gray-100 pt-4">
                      <div class="text-center">
                           <img src="https://ik.imagekit.io/kdtvm0r78/20251206_210616.png" crossorigin="anonymous" class="w-28 opacity-80" style="mix-blend-mode: multiply;">
                           <p class="text-[10px] text-gray-500 uppercase font-bold mt-1">Community Stamp</p>
                      </div>
                      <div class="text-center">
                        <p class="text-[10px] text-gray-500 uppercase font-bold mb-1">Authorized Signature</p>
                        <img src="https://ik.imagekit.io/kdtvm0r78/image.png" crossorigin="anonymous" class="w-36">
                        <p class="text-[10px] text-brand-teal font-bold mt-1">Prime Members</p>
                      </div>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
<script>
    async function checkAuthAndInitialize() {
        try {
            const response = await fetch('/api/config.js');
            if (!response.ok) throw new Error('Config load failed');
            const config = await response.json();
            firebase.initializeApp(config.firebase);
            firebase.auth().onAuthStateChanged(user => {
                if (user) runAppLogic();
                else window.location.href = `/login.html?redirect=${window.location.pathname}`;
            });
        } catch (error) {
            document.body.innerHTML = `<h3 class="text-center p-10 text-red-500">Error: ${error.message}</h3>`;
        }
    }

    function runAppLogic() {
        let membersData = {};

        const nameSelect = document.getElementById('nameSelect');
        const loanCategory = document.getElementById('loanCategory');
        const amountInp = document.getElementById('amount');
        const durationSelect = document.getElementById('durationRateSelect');
        const imageUp = document.getElementById('imageUpload');
        const productInp = document.getElementById('productInput');
        const productSec = document.getElementById('productSection');

        function updateUI() {
            const cat = loanCategory.value;
            const amt = parseFloat(amountInp.value) || 0;
            
            if(cat === 'product') {
                productSec.classList.remove('hidden');
                productInp.required = true;
            } else {
                productSec.classList.add('hidden');
                productInp.required = false;
            }
            
            document.getElementById('limit-msg').classList.toggle('hidden', amt <= 50000);
            
            durationSelect.innerHTML = '';
            if(amt === 0) {
                durationSelect.innerHTML = '<option>Enter amount first...</option>';
                return;
            }

            let opts = [];
            if(cat === 'personal') {
                if(amt < 25000) {
                    opts.push({val: '1-1.0-0', txt: '1 Month (1% Total Interest)'});
                    opts.push({val: '2-1.5-0', txt: '2 Months (3% Total Interest)'});
                    opts.push({val: '3-1.666666667-0', txt: '3 Months (5% Total Interest)'});
                    for(let m = 4; m <= 12; m++) opts.push({val: `${m}-1.0-0`, txt: `${m} Months (1% Monthly Interest)`});
                } else {
                    opts = [
                        {val: '6-0.7-0', txt: '6 Months (0.7% Monthly Interest)'},
                        {val: '9-0.7-0', txt: '9 Months (0.7% Monthly Interest)'},
                        {val: '12-0.7-0', txt: '12 Months (0.7% Monthly Interest)'}
                    ];
                }
            } else {
                if(amt >= 30000) {
                    opts = [
                        {val: '6-0.5-100', txt: '6 Months (0.5% Int + ₹100 Fee)'},
                        {val: '9-0.5-100', txt: '9 Months (0.5% Int + ₹100 Fee)'},
                        {val: '12-0.5-100', txt: '12 Months (0.5% Int + ₹100 Fee)'}
                    ];
                } else {
                    const fee = amt > 5000 ? 100 : 0;
                    for(let m=1; m<=5; m++) opts.push({val: `${m}-1.0-${fee}`, txt: `${m} Months (1% Int${fee?'+₹100 Fee':''})`});
                }
            }

            opts.forEach(o => {
                const el = document.createElement('option');
                el.value = o.val;
                el.innerText = o.txt;
                durationSelect.appendChild(el);
            });
        }

        loanCategory.addEventListener('change', updateUI);
        amountInp.addEventListener('input', updateUI);

        firebase.database().ref('members').once('value').then(snap => {
            membersData = snap.val() || {};
            nameSelect.innerHTML = '<option value="" disabled selected>Select Applicant</option>';
            Object.entries(membersData)
                .filter(([_, m]) => m.status === 'Approved')
                .sort((a,b) => a[1].fullName.localeCompare(b[1].fullName))
                .forEach(([id, m]) => {
                    const opt = document.createElement('option');
                    opt.value = id; opt.text = m.fullName;
                    nameSelect.appendChild(opt);
                });
        });

        const inputPage = document.getElementById('input-page');
        const previewOverlay = document.getElementById('preview-overlay');
        const paperScaler = document.getElementById('paper-scaler');
        const capture = document.getElementById('capture');

        document.getElementById('loanForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const member = membersData[nameSelect.value];
            if(!member) return alert('Select member');
            const amt = parseFloat(amountInp.value);
            const [months, intRate, feeRaw] = durationSelect.value.split('-').map(Number);
            let fee = 0;
            if(loanCategory.value === 'personal' && amt >= 30000) fee = amt * (feeRaw/100);
            else if(loanCategory.value === 'product' || (amt >= 30000 && loanCategory.value === 'product')) fee = feeRaw;
            
            const monthlyInt = amt * (intRate/100);
            const totalPay = amt + (monthlyInt * months);
            const emi = Math.ceil(totalPay / months);
            const endD = new Date();
            endD.setMonth(endD.getMonth() + months);

            document.getElementById('currentDate').innerText = new Date().toLocaleDateString('en-GB', {day:'numeric', month:'long', year:'numeric'});
            document.getElementById('letterLoanCategory').innerText = loanCategory.value === 'personal' ? 'PERSONAL LOAN' : 'PRODUCT LOAN';
            document.getElementById('displayName').innerText = member.fullName;
            document.getElementById('displayMobile').innerText = member.mobileNumber || 'N/A';
            document.getElementById('displayAmount').innerText = amt.toFixed(2);
            document.getElementById('displayRate').innerText = `${intRate.toFixed(2)}% Monthly for ${months} Months`;
            document.getElementById('displayEMI').innerText = emi.toFixed(2);
            document.getElementById('displayTotal').innerText = totalPay.toFixed(2);
            document.getElementById('repaymentDate').innerText = endD.toLocaleDateString('en-GB', {day:'numeric', month:'short', year:'numeric'});

            // Guarantor & Product Logic...
            const guarRow = document.getElementById('guarantorRow');
            if(member.guarantorName && member.guarantorName !== 'N/A') {
                document.getElementById('displayGuarantor').innerText = member.guarantorName;
                guarRow.classList.remove('hidden'); guarRow.style.display = 'flex';
            } else { guarRow.classList.add('hidden'); }

            const prodRow = document.getElementById('productRow');
            if(loanCategory.value === 'product') {
                prodRow.classList.remove('hidden'); prodRow.style.display = 'flex';
                document.getElementById('displayProduct').innerText = productInp.value;
            } else { prodRow.classList.add('hidden'); }

            const feeRow = document.getElementById('feeRow');
            if(fee > 0) {
                feeRow.classList.remove('hidden'); feeRow.style.display = 'flex';
                document.getElementById('displayFee').innerText = fee.toFixed(2);
            } else { feeRow.classList.add('hidden'); }

            // IMAGE LOGIC (Helper)
            const setImg = (id, url) => {
                const img = document.getElementById(id);
                if(url) {
                    img.src = `https://images.weserv.nl/?url=${url.replace(/^https?:\/\//,'')}`;
                    img.classList.remove('hidden');
                } else {
                    img.src = ''; 
                    img.classList.add('hidden');
                }
            };
            
            setImg('apiApplicantPhoto', member.profilePicUrl);
            
            // --- NEW: Signature Logic ---
            const sigImg = document.getElementById('displaySignature');
            const noSig = document.getElementById('noSignatureText');
            if(member.signatureUrl) {
                sigImg.src = `https://images.weserv.nl/?url=${member.signatureUrl.replace(/^https?:\/\//,'')}`;
                sigImg.classList.remove('hidden');
                noSig.classList.add('hidden');
            } else {
                sigImg.classList.add('hidden');
                noSig.classList.remove('hidden');
            }

            // --- NEW: Documents Logic (Front & Back) ---
            const docSection = document.getElementById('docSection');
            const manFile = imageUp.files[0];
            
            // Determine Front URL: Use manual upload if present, otherwise stored DB data
            let frontUrl = member.documentFrontUrl || member.documentUrl; // fallback to old 'documentUrl'
            let backUrl = member.documentBackUrl;

            // Manual Upload Override for FRONT only (if user uploads something in generating form)
            if(manFile) {
                const reader = new FileReader();
                reader.onload = e => {
                    document.getElementById('docFrontImg').src = e.target.result;
                    if(backUrl) setImg('docBackImg', backUrl);
                    docSection.classList.remove('hidden');
                };
                reader.readAsDataURL(manFile);
            } else {
                // Using only Database Data
                if(frontUrl || backUrl) {
                    setImg('docFrontImg', frontUrl);
                    setImg('docBackImg', backUrl);
                    docSection.classList.remove('hidden');
                } else {
                    docSection.classList.add('hidden');
                }
            }

            inputPage.classList.add('hidden');
            previewOverlay.style.display = 'flex';
            const screenW = window.innerWidth;
            const paperW = capture.offsetWidth; 
            if(screenW < paperW + 40) {
                const scale = (screenW - 20) / paperW;
                paperScaler.style.transform = `scale(${scale})`;
            } else {
                paperScaler.style.transform = `scale(1)`;
            }
            window.scrollTo(0,0);
        });

        document.getElementById('closePreviewBtn').onclick = () => {
            previewOverlay.style.display = 'none';
            inputPage.classList.remove('hidden');
        };

        document.getElementById('downloadBtn').onclick = async function() {
            const btn = this;
            btn.disabled = true;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Generating...';
            try {
                const imgs = Array.from(capture.getElementsByTagName('img'));
                await Promise.all(imgs.map(img => {
                    if(img.complete) return Promise.resolve();
                    return new Promise(r => { img.onload=r; img.onerror=r; });
                }));
                await new Promise(r => setTimeout(r, 500));
                const currentTransform = paperScaler.style.transform;
                paperScaler.style.transform = 'none'; 
                window.scrollTo(0, 0);
                const canvas = await html2canvas(capture, {
                    scale: 2, 
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    scrollY: -window.scrollY 
                });
                paperScaler.style.transform = currentTransform;
                const link = document.createElement('a');
                link.download = `Loan_${document.getElementById('displayName').innerText.replace(/\s/g,'_')}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                btn.innerHTML = '<i class="fas fa-check mr-2"></i> Done';
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }, 2000);
            } catch(e) {
                alert('Download error: ' + e.message);
                paperScaler.style.transform = `scale(${ (window.innerWidth - 20) / capture.offsetWidth })`;
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        };
    }

    checkAuthAndInitialize();
</script>

</body>
</html>
