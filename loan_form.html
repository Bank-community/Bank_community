<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Loan Application - Trust Community Fund</title>
  
  <!-- Icons & Fonts -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400;500;600&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  
  <!-- HTML2Canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root {
        --royal-blue: #002366;
        --deep-blue: #001233;
        --royal-gold: #D4AF37;
        --gold-light: #F8E71C;
        --gold-gradient: linear-gradient(135deg, #FFD700 0%, #D4AF37 100%);
    }

    body {
        font-family: 'Poppins', sans-serif;
        background: linear-gradient(160deg, #002366 0%, #00102e 100%); /* Premium Dark Background */
        min-height: 100vh;
        margin: 0;
        color: white;
    }

    /* ==============================
       1. LUXURY INPUT FORM (User Interface)
       ============================== */
    .form-wrapper {
        background: rgba(255, 255, 255, 0.05); /* Glass Effect */
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(212, 175, 55, 0.4); /* Gold Border */
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        border-radius: 20px;
        padding: 2.5rem;
        max-width: 500px;
        margin: 30px auto;
    }

    .brand-header h1 {
        font-family: 'Playfair Display', serif;
        color: var(--royal-gold);
        font-size: 1.8rem;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 1px;
        text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        margin-bottom: 5px;
    }

    .brand-header p {
        text-align: center;
        color: #ccc;
        font-size: 0.85rem;
        margin-bottom: 30px;
        letter-spacing: 1px;
        text-transform: uppercase;
    }

    label {
        color: #e0e0e0;
        font-size: 0.9rem;
        margin-bottom: 8px;
        display: block;
        font-weight: 500;
        letter-spacing: 0.5px;
    }

    .input-group {
        margin-bottom: 20px;
    }

    /* Premium Input Styling */
    .premium-input {
        width: 100%;
        padding: 14px 16px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        color: white;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .premium-input:focus {
        outline: none;
        border-color: var(--royal-gold);
        background: rgba(0, 0, 0, 0.5);
        box-shadow: 0 0 15px rgba(212, 175, 55, 0.25);
    }
    
    .premium-input option {
        background-color: var(--deep-blue);
        color: white;
    }

    .btn-generate {
        background: var(--gold-gradient);
        color: var(--deep-blue);
        font-weight: 700;
        font-size: 1.1rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        border: none;
        width: 100%;
        padding: 16px;
        border-radius: 12px;
        cursor: pointer;
        box-shadow: 0 5px 20px rgba(212, 175, 55, 0.3);
        transition: transform 0.2s, box-shadow 0.2s;
        margin-top: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .btn-generate:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(212, 175, 55, 0.5);
    }

    .btn-generate:disabled {
        background: #555;
        color: #ccc;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
    }

    /* Info Notification */
    .info-box {
        background: rgba(0, 35, 102, 0.6);
        border-left: 4px solid var(--royal-gold);
        padding: 15px;
        margin-top: 20px;
        border-radius: 8px;
        font-size: 0.85rem;
        color: #ddd;
        display: none;
    }
    .info-box strong { color: var(--royal-gold); }

    /* ==============================
       2. A4 PROFESSIONAL LETTER (Clean Output)
       ============================== */
    #letter-preview-section {
        display: none; 
        justify-content: center;
        padding: 40px 20px;
        background: #f0f2f5; 
        min-height: 100vh;
    }

    #capture {
        width: 210mm;
        height: 297mm; /* Exact A4 */
        background: #ffffff;
        color: #1f2937;
        position: relative;
        padding: 15mm;
        box-sizing: border-box;
        box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        font-family: 'Roboto', sans-serif;
        display: flex;
        flex-direction: column;
        margin: 0 auto;
    }

    /* Professional Blue Border (Bank Style) */
    .pro-border {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        border: 4px solid var(--royal-blue);
        pointer-events: none;
        z-index: 10;
    }
    .pro-border::after {
        content: '';
        position: absolute;
        top: 3px; left: 3px; right: 3px; bottom: 3px;
        border: 1px solid var(--royal-blue);
        pointer-events: none;
    }

    /* Header */
    .letter-header {
        text-align: center;
        margin-bottom: 20px;
        position: relative;
    }
    .date-stamp {
        position: absolute;
        top: 0; right: 0;
        font-size: 12px;
        color: #666;
    }
    .main-logo {
        width: 90px;
        height: 90px;
        object-fit: contain;
        margin-bottom: 10px;
    }
    .company-name {
        font-family: 'Roboto', sans-serif;
        font-size: 28px;
        font-weight: 900;
        color: #0056b3; /* Professional Blue */
        text-transform: uppercase;
        margin: 0;
        letter-spacing: 0.5px;
    }
    .form-name {
        font-size: 14px;
        color: #555;
        font-weight: 500;
        text-transform: uppercase;
        margin-bottom: 15px;
        letter-spacing: 1px;
    }
    .loan-category-badge {
        font-size: 20px;
        color: #166534; /* Green */
        font-weight: 800;
        text-transform: uppercase;
        display: inline-block;
        border-bottom: 3px solid #166534;
        padding-bottom: 2px;
    }

    /* Main Box Layout */
    .main-content-box {
        border: 2px solid #002366; /* Blue Border */
        border-radius: 8px;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
        background: #f8fbff; /* Very faint blue tint */
        position: relative;
    }

    .data-list {
        width: 65%;
    }
    .photo-section {
        width: 30%;
        text-align: center;
    }

    /* Data Rows */
    .row-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        font-size: 14px;
        color: #333;
        border-bottom: 1px dotted #ccc;
        padding-bottom: 5px;
    }
    .row-item:last-child { border-bottom: none; }
    
    .icon-box {
        width: 24px;
        text-align: center;
        margin-right: 10px;
    }
    .field-label {
        font-weight: 500;
        color: #555;
        width: 140px;
    }
    .field-value {
        font-weight: 700;
        color: #000;
        flex: 1;
    }

    /* Colors for values */
    .val-blue { color: #0056b3; }
    .val-red { color: #c0392b; }
    .val-green { color: #27ae60; }

    /* Photo Frame */
    .photo-frame {
        width: 110px;
        height: 120px;
        border: 1px solid #ccc;
        background: #fff;
        padding: 4px;
        border-radius: 4px;
        margin: 0 auto;
    }
    .photo-frame img {
        width: 100%; height: 100%; object-fit: cover;
    }
    .photo-title {
        font-size: 11px;
        font-weight: 700;
        color: #666;
        margin-bottom: 5px;
        text-transform: uppercase;
    }

    /* Additional Doc */
    .doc-preview-container {
        border: 2px dashed #bbb;
        border-radius: 8px;
        margin: 20px auto;
        width: 80%;
        height: 180px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: #fff;
    }
    .doc-preview-container img {
        max-height: 150px;
        max-width: 90%;
        object-fit: contain;
    }

    /* Footer */
    .declaration {
        text-align: center;
        font-style: italic;
        font-size: 11px;
        color: #555;
        margin-top: 20px;
    }

    .footer-area {
        margin-top: auto;
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        padding: 0 20px;
    }
    
    .stamp-wrap, .sign-wrap { text-align: center; }
    .stamp-img { width: 100px; opacity: 0.9; mix-blend-mode: multiply; }
    .sign-img { width: 130px; margin-bottom: -10px; }
    
    .footer-caption {
        font-size: 11px;
        font-weight: 600;
        color: #333;
        text-transform: uppercase;
        margin-top: 5px;
    }

    /* Loader */
    .spinner {
        border: 3px solid rgba(255,255,255,0.3);
        border-top: 3px solid #002366;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-left: 10px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Success Modal */
    #successMessage {
        display: none;
        background: white;
        padding: 30px;
        border-radius: 16px;
        text-align: center;
        color: #333;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        max-width: 400px;
        margin: 50px auto;
    }
  </style>
</head>
<body>

  <!-- === STEP 1: PREMIUM INPUT FORM === -->
  <div id="main-form-container" class="form-wrapper">
    <div class="brand-header">
        <h1>Trust Community Fund</h1>
        <p>Premium Loan Application Service</p>
    </div>

    <form id="loanForm">
        <!-- Name -->
        <div class="input-group">
            <label>Applicant Name</label>
            <select id="nameSelect" required class="premium-input"><option>Loading...</option></select>
        </div>

        <!-- Category -->
        <div class="input-group">
            <label>Loan Category</label>
            <select id="loanCategory" required class="premium-input">
                <option value="personal">Personal Loan</option>
                <option value="business">Business Loan</option>
                <option value="gold">Gold Loan</option>
                <option value="guarantor">Guarantor Loan</option>
            </select>
        </div>

        <!-- Hidden Fields -->
        <div id="goldCollateralSection" class="input-group" style="display:none;">
            <label>Collateral Item</label>
            <input type="text" id="goldCollateral" class="premium-input" placeholder="e.g. Gold Chain">
        </div>

        <div id="guarantorSection" class="input-group" style="display:none;">
            <label>Guarantor Name</label>
            <select id="guarantorSelect" class="premium-input"><option>Select Guarantor</option></select>
        </div>

        <!-- Amount -->
        <div class="input-group">
            <label>Loan Amount (₹)</label>
            <input type="number" id="amount" required class="premium-input" placeholder="10000">
        </div>

        <!-- Duration -->
        <div class="input-group">
            <label id="durationRateLabel">Interest & Duration</label>
            <select id="durationRateSelect" required class="premium-input"></select>
        </div>

        <!-- Upload -->
        <div class="input-group">
            <label>Additional Document (Optional)</label>
            <input type="file" id="imageUpload" accept="image/*" class="premium-input" style="padding: 10px;">
        </div>

        <!-- INFO Box -->
        <div id="loanInfoNotification" class="info-box"></div>

        <!-- Button -->
        <button type="submit" id="generateBtn" class="btn-generate">
            Generate Letter <i class="fas fa-arrow-right ml-2"></i>
        </button>
    </form>
  </div>

  <!-- === STEP 2: PREVIEW & GENERATE (A4) === -->
  <div id="letter-preview-section">
      <div class="flex flex-col items-center">
          
          <!-- A4 Canvas Start -->
          <div id="capture">
              <div class="pro-border"></div>
              
              <!-- Header -->
              <div class="letter-header">
                  <div class="date-stamp">Date: <span id="currentDate"></span></div>
                  <img src="https://ik.imagekit.io/kdtvm0r78/IMG-20251202-WA0000.jpg" class="main-logo" crossorigin="anonymous">
                  <h1 class="company-name">TRUST COMMUNITY FUND</h1>
                  <div class="form-name">Loan Application Form</div>
                  <div id="letterLoanCategory" class="loan-category-badge">PERSONAL LOAN</div>
              </div>

              <!-- Content Box -->
              <div class="main-content-box">
                  <div class="data-list">
                      
                      <div class="row-item">
                          <div class="icon-box"><i class="fas fa-user val-blue"></i></div>
                          <div class="field-label">Applicant Name:</div>
                          <div class="field-value val-blue" id="displayName">--</div>
                      </div>
                      
                      <div class="row-item" id="guarantorRow">
                          <div class="icon-box"><i class="fas fa-user-shield val-red"></i></div>
                          <div class="field-label">Guarantor Name:</div>
                          <div class="field-value val-red" id="displayGuarantor">--</div>
                      </div>

                      <div class="row-item" id="collateralRow" style="display:none;">
                          <div class="icon-box"><i class="fas fa-gem text-yellow-600"></i></div>
                          <div class="field-label">Collateral:</div>
                          <div class="field-value" id="displayCollateral">--</div>
                      </div>

                      <div class="row-item">
                          <div class="icon-box"><i class="fas fa-mobile-alt"></i></div>
                          <div class="field-label">Mobile Number:</div>
                          <div class="field-value" id="displayMobile">--</div>
                      </div>

                      <div class="row-item">
                          <div class="icon-box"><i class="fas fa-rupee-sign val-green"></i></div>
                          <div class="field-label">Loan Amount:</div>
                          <div class="field-value val-green" style="font-size: 1.1em;">₹ <span id="displayAmount">0</span></div>
                      </div>

                      <div class="row-item">
                          <div class="icon-box"><i class="fas fa-percent"></i></div>
                          <div class="field-label">Interest Rate:</div>
                          <div class="field-value" id="displayRate">--</div>
                      </div>

                      <!-- Hidden Rows -->
                      <div class="row-item" id="processingFeeRow" style="display:none;">
                          <div class="icon-box"><i class="fas fa-file-invoice"></i></div>
                          <div class="field-label">Processing Fee:</div>
                          <div class="field-value">₹ <span id="displayProcessingFee"></span></div>
                      </div>
                      <div class="row-item" id="emiRow" style="display:none;">
                          <div class="icon-box"><i class="fas fa-chart-pie"></i></div>
                          <div class="field-label">Full EMI:</div>
                          <div class="field-value">₹ <span id="displayEMI"></span></div>
                      </div>

                      <div class="row-item" style="background: #e8f5e9; margin-top: 5px;">
                          <div class="icon-box"><i class="fas fa-money-bill-wave val-green"></i></div>
                          <div class="field-label">Total Payable:</div>
                          <div class="field-value val-green">₹ <span id="displayTotalAmount">0</span></div>
                      </div>

                      <div class="row-item">
                          <div class="icon-box"><i class="fas fa-calendar-alt val-red"></i></div>
                          <div class="field-label">End Date:</div>
                          <div class="field-value val-red" id="repaymentDate">--</div>
                      </div>
                  </div>

                  <div class="photo-section">
                      <div class="photo-title">Applicant Photo</div>
                      <div class="photo-frame">
                          <img id="apiApplicantPhoto" src="" crossorigin="anonymous">
                      </div>
                  </div>
              </div>

              <!-- Additional Doc -->
              <div id="manualUploadSection" class="doc-preview-container" style="display:none;">
                  <div class="photo-title" style="margin-top: -25px; background: white; padding: 0 10px;">Additional Document</div>
                  <img id="manualApplicantPhoto" src="" crossorigin="anonymous">
              </div>

              <!-- Declaration -->
              <div class="declaration">
                  "I solemnly declare that I will repay the loan amount within the stipulated time. I accept all the rules and regulations of Trust Community Fund."
              </div>

              <!-- Footer -->
              <div class="footer-area">
                  <div class="stamp-wrap">
                      <img src="https://ik.imagekit.io/kdtvm0r78/20251206_210616.png" class="stamp-img" crossorigin="anonymous">
                      <div class="footer-caption">Bank Stamp</div>
                  </div>
                  <div class="sign-wrap">
                      <div class="footer-caption" style="margin-bottom: 5px; color: #666;">Authorized Signature</div>
                      <img src="https://ik.imagekit.io/kdtvm0r78/image.png" class="sign-img" crossorigin="anonymous">
                      <div class="footer-caption">Prime Members</div>
                  </div>
              </div>
          </div>
          <!-- A4 Canvas End -->

          <!-- Actions -->
          <div class="w-full max-w-md mt-6 flex flex-col gap-3">
              <button id="confirmDownloadBtn" class="bg-blue-900 text-white p-4 rounded-lg font-bold shadow-lg flex justify-center items-center hover:bg-blue-800 transition">
                  Confirm & Download <i class="fas fa-download ml-2"></i>
                  <div id="submitLoader" class="spinner hidden"></div>
              </button>
              <button onclick="window.location.reload()" class="text-gray-500 underline text-sm mt-2 text-center w-full block">Cancel & Edit</button>
          </div>
      </div>
  </div>

  <!-- SUCCESS -->
  <div id="successMessage">
      <div style="font-size: 4rem; color: #166534; margin-bottom: 10px;"><i class="fas fa-check-circle"></i></div>
      <h2 style="font-size: 1.5rem; font-weight: 700;">Success!</h2>
      <p style="color: #666; margin-bottom: 20px;">Loan letter downloaded successfully.</p>
      
      <button id="successDownloadBtn" class="bg-green-600 text-white p-3 rounded-lg font-bold w-full mb-3 shadow">Download Again</button>
      <button id="successShareBtn" class="bg-blue-600 text-white p-3 rounded-lg font-bold w-full shadow"><i class="fab fa-whatsapp"></i> Share on Group</button>
  </div>

  <script>
    let IMGBB_API_KEY_FORM = null;
    let pendingLoanData = {};
    let generatedCanvas = null;

    async function init() {
        try {
            const res = await fetch('/api/config.js');
            const config = await res.json();
            IMGBB_API_KEY_FORM = config.imgbb.formApiKey;

            if (!firebase.apps.length) firebase.initializeApp(config.firebase);
            
            firebase.auth().onAuthStateChanged(user => {
                if(user) loadData();
                else window.location.href = `/login.html?redirect=${window.location.pathname}`;
            });
        } catch(e) {
            console.error(e);
            alert("System Error: Config failed to load.");
        }
    }

    async function loadData() {
        const db = firebase.database();
        const snap = await db.ref('members').once('value');
        const members = snap.val() || {};
        
        const select = document.getElementById('nameSelect');
        const gSelect = document.getElementById('guarantorSelect');
        select.innerHTML = '<option value="" disabled selected>Select Applicant</option>';
        gSelect.innerHTML = '<option value="" disabled selected>Select Guarantor</option>';

        Object.values(members)
            .filter(m => m.status === 'Approved')
            .sort((a,b) => a.fullName.localeCompare(b.fullName))
            .forEach(m => {
                const opt = `<option value="${m.id}">${m.fullName}</option>`;
                select.innerHTML += opt;
                gSelect.innerHTML += opt;
            });
            
        updateFormUI();
    }

    const loanOptions = {
        personal: { label: 'Interest & Duration', opts: [{v:'1-1', t:'1% - 1 Month'}, {v:'3-2', t:'3% - 2 Months'}, {v:'5-3', t:'5% - 3 Months'}, {v:'2-1', t:'2% - 1 Month (2x)'}] },
        business: { label: 'Duration (18% Annual)', opts: [{v:'3-6', t:'9 Months (3 Int + 6 EMI)'}, {v:'6-6', t:'12 Months (6 Int + 6 EMI)'}] },
        gold: { label: 'Duration (3% Monthly)', opts: [{v:'3-6', t:'6 Months'}, {v:'3-12', t:'1 Year'}] },
        guarantor: { label: 'Duration (3% Monthly)', opts: [{v:'3-6', t:'6 Months'}, {v:'3-12', t:'1 Year'}] }
    };

    function updateFormUI() {
        const cat = document.getElementById('loanCategory').value;
        const conf = loanOptions[cat];
        
        const durSelect = document.getElementById('durationRateSelect');
        durSelect.innerHTML = '';
        conf.opts.forEach(o => durSelect.innerHTML += `<option value="${o.v}">${o.t}</option>`);
        document.getElementById('durationRateLabel').innerText = conf.label;

        document.getElementById('goldCollateralSection').style.display = (cat === 'gold') ? 'block' : 'none';
        
        const applicantName = document.getElementById('nameSelect').options[document.getElementById('nameSelect').selectedIndex]?.text || '';
        const needsGuarantor = cat === 'guarantor' || applicantName.toLowerCase().includes('bank');
        document.getElementById('guarantorSection').style.display = needsGuarantor ? 'block' : 'none';
        document.getElementById('guarantorSelect').required = needsGuarantor;

        // Info Notification
        const info = document.getElementById('loanInfoNotification');
        info.style.display = 'block';
        if(cat === 'personal') info.innerHTML = "<strong>Personal Loan:</strong> Eligible for 1.5x of total deposit. Duration 1-3 Months.";
        else if(cat === 'business') info.innerHTML = "<strong>Business Loan:</strong> 18% Annual Interest. Processing Fee applies.";
        else info.innerHTML = "<strong>Secured Loan:</strong> 3% Monthly Interest. Collateral/Guarantor required.";
    }

    // --- STEP 1: PREVIEW LOGIC (Button Click) ---
    document.getElementById('loanForm').addEventListener('submit', async (e) => {
        e.preventDefault(); // Stop reload
        
        const uid = document.getElementById('nameSelect').value;
        if(!uid || uid === "Loading...") return alert("Please select a valid Applicant.");

        const amount = parseFloat(document.getElementById('amount').value);
        if(!amount || amount <= 0) return alert("Enter valid amount.");

        const cat = document.getElementById('loanCategory').value;
        const rateVal = document.getElementById('durationRateSelect').value;
        
        // Fetch Member
        const db = firebase.database();
        const snap = await db.ref(`members/${uid}`).once('value');
        const member = snap.val();
        
        // Calculations
        let total=0, emi=0, procFee=0, endLabel='', months=0;
        
        if(cat === 'personal') {
            const [r, m] = rateVal.split('-').map(Number);
            total = amount + (amount * r / 100);
            endLabel = `${r}% for ${m} Months`;
            months = m;
        } else if(cat === 'business') {
            const [intMos, emiMos] = rateVal.split('-').map(Number);
            procFee = amount * 0.01 + (amount>9000?200:0);
            const rate = 0.015;
            const emiVal = (amount * rate * Math.pow(1+rate, emiMos))/(Math.pow(1+rate, emiMos)-1);
            total = (amount*rate*intMos) + (emiVal*emiMos);
            endLabel = '18% Annual';
            months = intMos + emiMos;
            document.getElementById('processingFeeRow').style.display = 'flex';
            document.getElementById('displayProcessingFee').innerText = procFee.toFixed(0);
            document.getElementById('emiRow').style.display = 'flex';
            document.getElementById('displayEMI').innerText = emiVal.toFixed(0);
        } else {
            const [r, m] = rateVal.split('-').map(Number);
            const rate = r/100;
            const fullEmi = (amount * rate * Math.pow(1+rate, m))/(Math.pow(1+rate, m)-1);
            total = fullEmi * m;
            endLabel = `${r}% Monthly`;
            months = m;
            document.getElementById('emiRow').style.display = 'flex';
            document.getElementById('displayEMI').innerText = fullEmi.toFixed(0);
        }

        // Fill Preview Data
        const date = new Date();
        document.getElementById('currentDate').innerText = date.toLocaleDateString('en-GB');
        date.setMonth(date.getMonth() + months);
        document.getElementById('repaymentDate').innerText = date.toLocaleDateString('en-GB');
        
        document.getElementById('displayName').innerText = member.fullName;
        document.getElementById('displayMobile').innerText = member.mobileNumber || 'N/A';
        document.getElementById('displayAmount').innerText = amount.toLocaleString();
        document.getElementById('displayRate').innerText = endLabel;
        document.getElementById('displayTotalAmount').innerText = total.toLocaleString('en-IN', {maximumFractionDigits: 0});
        document.getElementById('letterLoanCategory').innerText = cat.toUpperCase() + ' LOAN';

        // Guarantor Handling
        let gName = member.guarantorName || 'N/A';
        if(document.getElementById('guarantorSection').style.display === 'block') {
             const gid = document.getElementById('guarantorSelect').value;
             if(gid) {
                 const gSnap = await db.ref(`members/${gid}`).once('value');
                 gName = gSnap.val().fullName;
             }
        }
        document.getElementById('displayGuarantor').innerText = gName;
        document.getElementById('guarantorRow').style.display = (cat === 'personal' && gName === 'N/A') ? 'none' : 'flex';

        // Collateral
        const colItem = document.getElementById('goldCollateral').value;
        if(cat === 'gold') {
            document.getElementById('displayCollateral').innerText = colItem;
            document.getElementById('collateralRow').style.display = 'flex';
        }

        // Proxy Image for Canvas
        const proxy = url => url ? `https://images.weserv.nl/?url=${url.replace(/^https?:\/\//, '')}` : 'https://placehold.co/100x120?text=No+Img';
        const imgEl = document.getElementById('apiApplicantPhoto');
        imgEl.crossOrigin = "anonymous";
        imgEl.src = proxy(member.profilePicUrl);
        
        // Manual Upload
        const file = document.getElementById('imageUpload').files[0];
        const manualSec = document.getElementById('manualUploadSection');
        if(file) {
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById('manualApplicantPhoto').src = e.target.result;
                manualSec.style.display = 'flex';
            };
            reader.readAsDataURL(file);
        } else {
            manualSec.style.display = 'none';
        }

        // Save State
        pendingLoanData = {
            applicantId: uid, applicantName: member.fullName, amount, category: cat, 
            total, docFile: file, date: new Date().toISOString()
        };

        // Switch Screen
        document.getElementById('main-form-container').style.display = 'none';
        document.getElementById('letter-preview-section').style.display = 'flex';
        window.scrollTo(0,0);
    });

    // --- STEP 2: GENERATE & DOWNLOAD (Fix HTML2Canvas) ---
    document.getElementById('confirmDownloadBtn').addEventListener('click', async () => {
        const btn = document.getElementById('confirmDownloadBtn');
        const loader = document.getElementById('submitLoader');
        btn.disabled = true;
        loader.classList.remove('hidden');

        try {
            // Wait for images to load properly for canvas
            const captureArea = document.getElementById('capture');
            const imgs = captureArea.querySelectorAll('img');
            await Promise.all([...imgs].map(img => {
                if(img.complete) return;
                return new Promise(r => { img.onload=r; img.onerror=r; });
            }));

            // Generate Canvas
            const canvas = await html2canvas(captureArea, {
                scale: 2, 
                useCORS: true, 
                backgroundColor: '#ffffff',
                allowTaint: true
            });
            generatedCanvas = canvas;
            
            // Upload Logic (ImgBB)
            const blob = await new Promise(r => canvas.toBlob(r, 'image/png'));
            const formData = new FormData();
            formData.append('image', blob);
            
            let letterUrl = "offline_generated"; 
            if(IMGBB_API_KEY_FORM) {
                 try {
                     const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY_FORM}`, {method:'POST', body:formData});
                     const json = await res.json();
                     if(json.data) letterUrl = json.data.url;
                 } catch(err) { console.warn("Upload failed, proceeding with download"); }
            }

            // Save to Firebase
            await firebase.database().ref('pendingLoans').push({
                ...pendingLoanData, letterUrl, status: 'pending'
            });

            // Auto Download
            const link = document.createElement('a');
            link.download = `Loan_${pendingLoanData.applicantName}.png`;
            link.href = canvas.toDataURL();
            link.click();

            // Success View
            document.getElementById('letter-preview-section').style.display = 'none';
            document.getElementById('successMessage').style.display = 'block';

        } catch(e) {
            console.error(e);
            alert('Error generating letter: ' + e.message);
            btn.disabled = false;
            loader.classList.add('hidden');
        }
    });

    document.getElementById('successDownloadBtn').addEventListener('click', () => {
        if(!generatedCanvas) return;
        const link = document.createElement('a');
        link.download = `Loan_Copy.png`;
        link.href = generatedCanvas.toDataURL();
        link.click();
    });

    document.getElementById('successShareBtn').addEventListener('click', () => {
        window.open('https://chat.whatsapp.com/G39I0hP55WIDHMu5YkAjDZ', '_blank');
    });

    document.getElementById('nameSelect').addEventListener('change', updateFormUI);
    document.getElementById('loanCategory').addEventListener('change', updateFormUI);
    
    init();
  </script>
</body>
</html>


