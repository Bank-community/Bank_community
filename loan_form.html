<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Bank Community Loan Form</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
    }
    .form-container {
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    input:focus, select:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }
    .btn {
      transition: all 0.3s ease;
    }
    .btn:hover {
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
      transform: translateY(-3px);
    }
    .btn:disabled {
        background-color: #9ca3af;
        cursor: not-allowed;
    }
    .loader {
        border: 3px solid rgba(255,255,255,0.3);
        border-top: 3px solid #fff;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-left: 8px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #capture {
      width: 210mm;
      min-height: 290mm;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }
    .header {
      border-bottom: 4px solid #056fff;
    }
    .header h1 {
      color: #056fff;
    }
    .details-text p i {
      color: #056fff;
    }
    .highlight {
      color: #056fff;
    }
    .guarantor-highlight {
        color: #D32F2F; /* Red color */
    }
    .footer-section {
        border-top: 1px solid #eee;
    }
    /* Styles for the new notification box */
    #loanInfoNotification h3 {
        font-size: 1.1rem;
        font-weight: 700;
        color: #1e40af;
        margin-bottom: 0.75rem;
    }
    #loanInfoNotification p, #loanInfoNotification li {
        font-size: 0.875rem;
        color: #374151;
    }
    #loanInfoNotification .table {
        width: 100%;
        margin-top: 0.75rem;
        border-collapse: collapse;
    }
    #loanInfoNotification .table th, #loanInfoNotification .table td {
        border: 1px solid #d1d5db;
        padding: 0.5rem;
        text-align: left;
    }
    #loanInfoNotification .table th {
        background-color: #eef2ff;
    }
    #loanInfoNotification .note {
        margin-top: 1rem;
        padding: 0.75rem;
        background-color: #fffbe6;
        border-left: 4px solid #facc15;
        font-size: 0.85rem;
    }
  </style>
</head>
<body class="bg-gray-100 flex flex-col justify-center items-center p-5">
  <div id="main-form-container" class="form-container bg-white p-6 rounded-xl w-full max-w-md mb-8">
    <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">Smart Loan Application Form</h1>
    <form id="loanForm">
      <label for="nameSelect" class="block mb-1 font-bold text-gray-600">Applicant Name:</label>
      <select id="nameSelect" required class="w-full p-3 mb-4 border border-gray-300 rounded-lg text-base bg-white focus:outline-none">
        <option value="" disabled selected>Loading members...</option>
      </select>
      
      <label for="loanCategory" class="block mb-1 font-bold text-gray-600">Loan Category:</label>
      <select id="loanCategory" required class="w-full p-3 mb-4 border border-gray-300 rounded-lg text-base bg-white focus:outline-none">
        <option value="personal" selected>Personal Loan</option>
        <option value="business">Business Loan</option>
        <option value="gold">Gold Loan</option>
        <option value="guarantor">Guarantor Loan</option>
      </select>

      <div id="goldCollateralSection" style="display: none;">
          <label for="goldCollateral" class="block mb-1 font-bold text-gray-600">Collateral Item Name (Girvi ka Samaan):</label>
          <input type="text" id="goldCollateral" placeholder="Enter item name (e.g., Gold Chain)" class="w-full p-3 mb-4 border border-gray-300 rounded-lg text-base focus:outline-none">
      </div>

      <div id="guarantorSection" style="display: none;">
        <label for="guarantorSelect" class="block mb-1 font-bold text-gray-600">Guarantor Name:</label>
        <select id="guarantorSelect" class="w-full p-3 mb-4 border border-gray-300 rounded-lg text-base bg-white focus:outline-none">
          <option value="" disabled selected>Select Guarantor</option>
        </select>
      </div>

      <label for="amount" class="block mb-1 font-bold text-gray-600">Loan Amount (‚Çπ):</label>
      <input type="number" id="amount" placeholder="Enter loan amount" min="1" required class="w-full p-3 mb-4 border border-gray-300 rounded-lg text-base focus:outline-none">

      <div id="dynamicOptionsContainer">
        <label for="durationRateSelect" id="durationRateLabel" class="block mb-1 font-bold text-gray-600">Interest Rate & Duration:</label>
        <select id="durationRateSelect" required class="w-full p-3 mb-4 border border-gray-300 rounded-lg text-base bg-white focus:outline-none">
        </select>
      </div>

      <label for="imageUpload" class="block mb-1 font-bold text-gray-600">Upload Additional Document (Optional):</label>
      <input type="file" id="imageUpload" accept="image/*" class="w-full p-2 mb-4 text-base border rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">

      <button type="submit" class="btn w-full p-4 bg-blue-600 text-white font-bold rounded-lg text-base cursor-pointer mt-5 hover:bg-blue-700">Generate & Preview Letter</button>
      
      <div id="loanInfoNotification" class="mt-6 p-4 border border-indigo-200 bg-indigo-50 rounded-lg">
      </div>
    </form>
  </div>

  <div id="successMessage" class="hidden text-center bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
      <i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i>
      <h2 class="text-2xl font-bold text-gray-800">Application Submitted!</h2>
      <p class="text-gray-600 mt-2">Your loan application has been sent for approval. You will be notified shortly.</p>
      <!-- UPDATED: Action buttons moved here for the new flow -->
      <div id="success-action-buttons" class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 w-full mt-6">
        <button id="successDownloadBtn" class="btn hidden w-full sm:w-1/2 p-3 bg-green-600 text-white font-bold rounded-lg text-base cursor-pointer hover:bg-green-700">Download Letter</button>
        <button id="successShareBtn" class="btn hidden w-full sm:w-1/2 p-3 bg-blue-500 text-white font-bold rounded-lg text-base cursor-pointer hover:bg-blue-600">Share on WhatsApp</button>
      </div>
  </div>
  
  <div id="letter-preview-section" class="hidden w-full flex flex-col items-center">
      <div id="capture" class="bg-white p-[15mm] border border-gray-300 my-5 mx-auto flex flex-col relative">
        <!-- Letter content is the same as before -->
        <div class="header text-center pb-4 mb-5 relative">
          <div class="header-info absolute right-0 top-0 text-right text-sm text-gray-600">Date: <span id="currentDate"></span></div>
          <!-- UPDATED: Bank Logo image source changed to Base64 -->
          <img src="data:image/jpeg;base64,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" crossorigin="anonymous" class="logo w-24 mx-auto mb-1" alt="Bank Logo">
          <h1 class="text-2xl font-bold my-2">BANK COMMUNITY LOAN FORM</h1>
          <h2 id="letterLoanCategory" class="text-2xl font-bold text-green-600 mt-3"></h2>
        </div>
        <div class="loan-details-container flex justify-between items-start my-5 p-4 border border-gray-200 rounded-lg bg-gray-50">
            <div class="details-text flex-grow pr-4">
              <p class="my-2 text-sm text-gray-800 flex items-center"><i class="fas fa-user w-5 text-center mr-2"></i>Applicant Name: <span class="highlight font-bold ml-1" id="displayName"></span></p>
              <p id="guarantorRow" class="my-2 text-sm text-gray-800 flex items-center"><i class="fas fa-user-shield w-5 text-center mr-2"></i>Guarantor Name: <span class="guarantor-highlight font-bold ml-1" id="displayGuarantor"></span></p>
              <p id="collateralRow" class="my-2 text-sm text-gray-800 flex items-center" style="display: none;"><i class="fas fa-gem w-5 text-center mr-2"></i>Collateral Item: <span class="highlight font-bold ml-1" id="displayCollateral"></span></p>
              <p class="my-2 text-sm text-gray-800 flex items-center"><i class="fas fa-mobile-alt w-5 text-center mr-2"></i>Mobile Number: <span id="displayMobile" class="ml-1"></span></p>
              <p class="my-2 text-sm text-gray-800 flex items-center"><i class="fas fa-rupee-sign w-5 text-center mr-2"></i>Loan Amount: ‚Çπ<span id="displayAmount" class="ml-1"></span></p>
              <p id="processingFeeRow" class="my-2 text-sm text-gray-800 items-center" style="display: none;"><i class="fas fa-cogs w-5 text-center mr-2"></i>Processing Fee: ‚Çπ<span id="displayProcessingFee" class="ml-1"></span></p>
              <p class="my-2 text-sm text-gray-800 flex items-center"><i class="fas fa-percent w-5 text-center mr-2"></i>Interest Rate: <span id="displayRate" class="ml-1"></span></p>
              <p id="interestOnlyPaymentRow" class="my-2 text-sm text-gray-800 items-center" style="display: none;"><i class="fas fa-money-bill-wave w-5 text-center mr-2"></i>Sirf Masik Byaj (Interest Only): ‚Çπ<span id="displayInterestOnlyPayment" class="ml-1"></span></p>
              <p id="emiRow" class="my-2 text-sm text-gray-800 items-center" style="display: none;"><i class="fas fa-chart-pie w-5 text-center mr-2"></i>Puri Masik EMI (Full EMI): ‚Çπ<span id="displayEMI" class="ml-1"></span></p>
              <p id="businessInterestRow" class="my-2 text-sm text-gray-800 items-center" style="display: none;"><i class="fas fa-money-bill-wave w-5 text-center mr-2"></i>Monthly Interest Payment: ‚Çπ<span id="displayBusinessInterest" class="ml-1"></span></p>
              <p id="businessEmiRow" class="my-2 text-sm text-gray-800 items-center" style="display: none;"><i class="fas fa-chart-pie w-5 text-center mr-2"></i>Monthly EMI: ‚Çπ<span id="displayBusinessEMI" class="ml-1"></span></p>
              <p class="my-2 text-sm text-gray-800 flex items-center"><i class="fas fa-file-invoice-dollar w-5 text-center mr-2"></i>Total Payable: ‚Çπ<span id="displayTotalAmount" class="ml-1"></span></p>
              <p class="my-2 text-sm text-gray-800 flex items-center"><i class="fas fa-calendar-alt w-5 text-center mr-2"></i>Repayment Period Ends: <span id="repaymentDate" class="ml-1"></span></p>
            </div>
            <div class="api-photo-container flex-shrink-0 w-24 text-center">
                <p class="mb-1 font-bold text-gray-600 text-xs">Applicant Photo:</p>
                <img id="apiApplicantPhoto" src="" crossorigin="anonymous" alt="Applicant Photo (API)" class="max-w-full h-auto max-h-24 border border-gray-300 rounded-md object-contain mt-1 bg-white">
            </div>
        </div>
        <div id="manualUploadSection" class="my-5 mx-auto p-4 border border-dashed border-gray-300 rounded-lg text-center max-w-[80%]" style="display: none;">
            <p class="mb-2 font-bold text-gray-700 text-sm">Additional Document:</p>
            <img id="manualApplicantPhoto" src="" crossorigin="anonymous" alt="Additional Document" class="max-w-full max-h-52 h-auto border border-gray-300 rounded-md object-contain">
        </div>
        <p class="request-text highlight text-center italic text-gray-600 text-sm mt-6 font-bold">I request the bank community members to please approve this loan application.</p>
        <div class="footer-section mt-auto pt-6 flex justify-between items-end">
            <div class="stamp-section text-center">
                 <!-- UPDATED: Bank Stamp image source changed to Base64 -->
                 <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABZCAYAAABaGk2zAAAE+UlEQVR4nO2dW6+kQBSAv2+8o4AHRUURDxX0WfDA2+y/A+LBB5u1gIgeBF/w3tUfQBA8KChqJCKC4J+E+5hQmlamX59zS6b033Qzm52Z/d+009Ozo3wHIAABCEAAAhCAAAQgAAEIQAACEIAABCAAAQhAAAIQgAAEIAABCEAAAhCAAAQgAAEIQAACEIAABCAAAQhAAAIQgAAEIAABCEAAAhCAAAQgAAEIQAACEIAABCAAAQhAAAIQgAAEIAABCEAAAhCAAATeWIEfWzN1s4G/Vn/lW+vX1l4jS0vI7Vvrt9ZeA+9r29+s/5Fv3uC/H/kC5zQ08542S4s2Q1+4B3Vb2z+N8e/vDk+3k/7e7V9a+28w7323zH8b8w7Ie9t95vB/eF79vC8T/62k7/2v+t52f7V9a+3/wA36+71zH+S/3v638t+b353sV923zP5mO3sV3zV/X9a/K35t+V6fL2K3+V7l54N/5/X/s29/2/h/f9e9/5f/V/L/uP+/2v+/537V/V9+32S/+v5r870iX8uX+V797W7z/X/s28/3/m+d+2/7e/l7+yv+vtW7+X/5P2f5D/g/+38n8T/n/q/Uu8+f5/6u8t//v4r8j/LfmP+v6V/9v6N/a/mvzvSPfyl/9W2Lz9/N31f3f9O/9/X+P+137+y/x36P9L9j//c+z8n8L/l/a/Ef9r+r/u/lfzP6X/R/3/y/4/8n+3v1v6X7L/4/+f6v+b+q8+f9e/u/yP+n+f/k/6f0j38rf1a/V9t/0vW723+5/W/pfxn7X+j/t7w/lP/l/a/+f8j/X/Xv2/2v1v+y/9/137v/3+z/m/pP+n+L/m/a/8/87/x/3f9/1fz/9v6L/T/j/5//v/n/N/E/tf+v/v/Ff//8T+d/k/3/6/535Xv5M/9WzL1n8/c9e97+/s+r+7/r//e9H5X5n9L/g/+3+X//9yP0vxf+T+X/E/+r8X7X5j9L/c/+v+v8V+V/o/3f+P/L/t/R/W+Z//v/X+n/9/7/737f9//L/j/zvSffyJz0b8/c1+94eW/zX6v+u/d/y/+v9r/z/yP+U/x/1/zvyv0v/p/F/o/+v1P/u/V/y/yv+t+T/Z/3/yf4/9X9H+t/x/+v+b+r/mv+v93/Ff0j38qf9G7P1Pzvf22Obvqvuf9v8A9/w/p/mv/b//f5X+X/d/+v5P/N+Z/q/Ff+P+V/7/w//v+X+p/y/4v9X8//t/+f2f//87/9/VfpPuf//8b+//1/yvZ+4Wf9G5I1/5g0W8AIEAACEIAABCAAAQhAAAIQgAAEIAABCEAAAhCAAAQhAAAIQgAAEIAABCAAAQhAAAIQgAAEIAABCEAAAhCAAAQhAAAIQgAAEIAABCAAAQhAAAIQgAAEIAABCEAAAhCAAAQhAAAIQgAAEIAABCEDgjwrc+u+j98fF3yC88wJ/0/n+r/X/j/lfyP9X2n/L/3+S/x/9/wL/r/1/6f8r9f851v8X/f/L/v/E/2//v1b/t/R/J/2/Iv9/j/8A6yP8Y+d8B7/yJbwACFIAABCAAAQhAAAIQgAAEIAABCEAAAhCAAAQhAAAIQgAAEIAABCAAAQhAAAIQgAAEIAABCEAAAhCAAAQhAAAIQgAAEIAABCEAAAhCAAAQhAAAIQgAAEIAABCEAAQhAAAIQgAAEIAABCAAAQhAAAIQgAAEIAABCEAAQhAAAIQgAAEIAABCEAAAhCAAAQhAAAIQgAAEIAABCEDgvwv8DwWdztH62B7bAAAAAElFTkSuQmCC" crossorigin="anonymous" class="stamp-img w-36 opacity-80" alt="Bank Stamp">
                 <p class="m-0 text-xs text-gray-800">Bank Stamp</p>
            </div>
            <div class="signature-section text-center">
              <p class="m-0 text-xs text-gray-800">Authorized Signature</p>
              <!-- UPDATED: Signature image source changed to Base64 -->
              <img src="data:image/png;base64,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" crossorigin="anonymous" class="signature-img w-44 mt-1" alt="Signature">
              <p class="m-0 text-xs text-gray-800">Prime Members</p>
            </div>
        </div>
      </div> 
      <!-- UPDATED: Only the submit button is here now -->
      <div id="action-buttons" class="hidden w-full max-w-md mt-4">
        <button id="submitForApprovalBtn" class="btn w-full p-3 bg-indigo-600 text-white font-bold rounded-lg text-base cursor-pointer hover:bg-indigo-700 flex items-center justify-center">
            <span id="submitBtnText">Submit for Approval</span>
            <div id="submitLoader" class="loader hidden"></div>
        </button>
      </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
    <script>
    let IMGBB_API_KEY_FORM = null;

    async function checkAuthAndInitialize() {
        try {
            const response = await fetch('/api/config.js');
            if (!response.ok) throw new Error('Configuration failed to load.');
            const config = await response.json();
            
            IMGBB_API_KEY_FORM = config.imgbb.formApiKey;
            if (!IMGBB_API_KEY_FORM) {
                throw new Error("IMGBB_API_KEY_FORM is missing from config. Please check Vercel environment variables.");
            }

            firebase.initializeApp(config.firebase);
            
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    runAppLogic(); 
                } else {
                    window.location.href = `/login.html?redirect=${window.location.pathname}`;
                }
            });
        } catch (error)
        {
            console.error('Initialization Error:', error);
            alert('Application failed to initialize. ' + error.message);
            document.getElementById('main-form-container').innerHTML = `<p class="text-red-500 text-center">${error.message}</p>`;
        }
    }

    function runAppLogic() {
        let membersData = {};
        let pendingLoanDataForSubmit = {};
        let generatedCanvas = null; // To store the generated canvas for later use

        // All element selectors
        const mainFormContainer = document.getElementById('main-form-container');
        const successMessage = document.getElementById('successMessage');
        const letterPreviewSection = document.getElementById('letter-preview-section');
        const nameSelect = document.getElementById('nameSelect');
        const loanCategorySelect = document.getElementById('loanCategory');
        const amountInput = document.getElementById('amount');
        const durationRateSelect = document.getElementById('durationRateSelect');
        const durationRateLabel = document.getElementById('durationRateLabel');
        const imageUploadInput = document.getElementById('imageUpload');
        const loanForm = document.getElementById('loanForm');
        const captureDiv = document.getElementById('capture');
        const guarantorSection = document.getElementById('guarantorSection');
        const guarantorSelect = document.getElementById('guarantorSelect');
        const goldCollateralSection = document.getElementById('goldCollateralSection');
        const goldCollateralInput = document.getElementById('goldCollateral');
        
        // UPDATED: Selectors for the new button flow
        const actionButtonsContainer = document.getElementById('action-buttons');
        const submitForApprovalBtn = document.getElementById('submitForApprovalBtn');
        const successDownloadBtn = document.getElementById('successDownloadBtn');
        const successShareBtn = document.getElementById('successShareBtn');

        const submitBtnText = document.getElementById('submitBtnText');
        const submitLoader = document.getElementById('submitLoader');
        const currentDateEl = document.getElementById('currentDate');
        const letterLoanCategoryEl = document.getElementById('letterLoanCategory');
        const displayNameEl = document.getElementById('displayName');
        const displayGuarantorEl = document.getElementById('displayGuarantor');
        const displayMobileEl = document.getElementById('displayMobile');
        const displayAmountEl = document.getElementById('displayAmount');
        const displayRateEl = document.getElementById('displayRate');
        const displayTotalAmountEl = document.getElementById('displayTotalAmount');
        const repaymentDateEl = document.getElementById('repaymentDate');
        const apiApplicantPhotoEl = document.getElementById('apiApplicantPhoto');
        const manualUploadSectionEl = document.getElementById('manualUploadSection');
        const manualApplicantPhotoEl = document.getElementById('manualApplicantPhoto');
        const guarantorRowEl = document.getElementById('guarantorRow');
        const collateralRowEl = document.getElementById('collateralRow');
        const displayCollateralEl = document.getElementById('displayCollateral');
        const processingFeeRowEl = document.getElementById('processingFeeRow');
        const displayProcessingFeeEl = document.getElementById('displayProcessingFee');
        const interestOnlyPaymentRowEl = document.getElementById('interestOnlyPaymentRow');
        const displayInterestOnlyPaymentEl = document.getElementById('displayInterestOnlyPayment');
        const emiRowEl = document.getElementById('emiRow');
        const displayEMIEl = document.getElementById('displayEMI');
        const businessInterestRowEl = document.getElementById('businessInterestRow');
        const displayBusinessInterestEl = document.getElementById('displayBusinessInterest');
        const businessEmiRowEl = document.getElementById('businessEmiRow');
        const displayBusinessEMIEl = document.getElementById('displayBusinessEMI');
        const loanInfoNotification = document.getElementById('loanInfoNotification');

        const loanOptions = {
            personal: { label: 'Interest Rate & Duration:', options: [ { value: '1-1', text: '1% for 1 month' }, { value: '3-2', text: '3% for 2 months' }, { value: '5-3', text: '5% for 3 months' }, { value: '2-1-2x', text: '2% for 1 month (2x loan)' } ] },
            business: { label: 'Loan Duration (18% Annual Interest):', options: [ { value: '3-6', text: '9 Months (3 months interest + 6 months EMI)' }, { value: '6-6', text: '12 Months (6 months interest + 6 months EMI)' } ] },
            gold: { label: 'Loan Duration (3% Monthly Interest):', options: [ { value: '3-6', text: '6 Months' }, { value: '3-12', text: '1 Year' } ] },
            guarantor: { label: 'Loan Duration (3% Monthly Interest):', options: [ { value: '3-6', text: '6 Months' }, { value: '3-12', text: '1 Year' } ] }
        };

        const notificationContent = {
            personal: `<h3><i class="fas fa-info-circle"></i> Personal Loan - ‡§®‡§ø‡§Ø‡§Æ ‡§î‡§∞ ‡§∂‡§∞‡•ç‡§§‡•á‡§Ç</h3><p class="font-bold mt-2">üíº ‡§≤‡•ã‡§® ‡§™‡§æ‡§§‡•ç‡§∞‡§§‡§æ (Loan Eligibility)</p><ul class="list-disc list-inside ml-2"><li>‡§π‡§∞ ‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§ï‡•ã ‡§Ö‡§™‡§®‡•á ‡§ú‡§Æ‡§æ ‡§ï‡•Å‡§≤ ‡§Ø‡•ã‡§ó‡§¶‡§æ‡§® ‡§ï‡§æ 1.5 ‡§ó‡•Å‡§®‡§æ (Dedh Guna) ‡§§‡§ï ‡§≤‡•ã‡§® ‡§≤‡•á‡§®‡•á ‡§ï‡•Ä ‡§™‡§æ‡§§‡•ç‡§∞‡§§‡§æ ‡§π‡•à‡•§</li><li>‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§¨‡§®‡§®‡•á ‡§ï‡•á ‡§ï‡§Æ-‡§∏‡•á-‡§ï‡§Æ 60 ‡§¶‡§ø‡§® ‡§¨‡§æ‡§¶ ‡§π‡•Ä ‡§≤‡•ã‡§® ‡§≤‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§</li></ul><p class="font-bold mt-3">üìÜ ‡§≤‡•ã‡§® ‡§Ö‡§µ‡§ß‡§ø ‡§î‡§∞ ‡§¨‡•ç‡§Ø‡§æ‡§ú (Loan Duration & Interest)</p><p>‡§∏‡§¶‡§∏‡•ç‡§Ø ‡§≤‡•ã‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§®‡§ø‡§Æ‡•ç‡§®‡§≤‡§ø‡§ñ‡§ø‡§§ ‡§Ö‡§µ‡§ß‡§ø ‡§Æ‡•á‡§Ç ‡§∏‡•á ‡§ï‡§ø‡§∏‡•Ä ‡§è‡§ï ‡§ï‡§æ ‡§ö‡§Ø‡§® ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç:</p><table class="table"><thead><tr><th>‡§Ö‡§µ‡§ß‡§ø (Period)</th><th>‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§¶‡§∞</th><th>‡§µ‡§ø‡§µ‡§∞‡§£</th></tr></thead><tbody><tr><td>1 ‡§Æ‡§π‡•Ä‡§®‡§æ</td><td>1%</td><td>‡§ï‡§Æ ‡§Ö‡§µ‡§ß‡§ø ‡§ï‡•á ‡§≤‡§ø‡§è</td></tr><tr><td>2 ‡§Æ‡§π‡•Ä‡§®‡•á</td><td>3%</td><td>‡§Æ‡§ß‡•ç‡§Ø‡§Æ ‡§Ö‡§µ‡§ß‡§ø</td></tr><tr><td>3 ‡§Æ‡§π‡•Ä‡§®‡•á</td><td>5%</td><td>‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§Ö‡§µ‡§ß‡§ø</td></tr><tr><td>90+ ‡§¶‡§ø‡§® + 10 ‡§¶‡§ø‡§®</td><td>5.5%</td><td>‡§°‡•á‡§°‡§≤‡§æ‡§á‡§® ‡§∏‡•á ‡§•‡•ã‡§°‡§º‡•Ä ‡§¶‡•á‡§∞‡•Ä</td></tr><tr><td>100+ ‡§¶‡§ø‡§® (Delay)</td><td>6% + Penalty</td><td>‡§µ‡§ø‡§≤‡§Ç‡§¨ ‡§∂‡•Å‡§≤‡•ç‡§ï ‡§î‡§∞ ‡§∏‡§ú‡§æ</td></tr><tr><td>100 ‡§¶‡§ø‡§® ‡§∏‡•á ‡§Ö‡§ß‡§ø‡§ï + 60 ‡§¶‡§ø‡§® ‡§§‡§ï</td><td class="font-bold">No Loan</td><td>‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø ‡§Æ‡•á‡§Ç 60 ‡§¶‡§ø‡§®‡•ã‡§Ç ‡§§‡§ï ‡§ï‡•ã‡§à ‡§≤‡•ã‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•á‡§ó‡§æ</td></tr></tbody></table>`,
            business: `<h3><i class="fas fa-briefcase"></i> Business Loan - ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§î‡§∞ ‡§∂‡•Å‡§≤‡•ç‡§ï</h3><p>‡§¨‡§ø‡§ú‡§®‡•á‡§∏ ‡§≤‡•ã‡§® ‡§™‡§∞ <strong>18% ‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï (1.5% ‡§Æ‡§æ‡§∏‡§ø‡§ï)</strong> ‡§ï‡•Ä ‡§¶‡§∞ ‡§∏‡•á ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§≤‡§ó‡§§‡§æ ‡§π‡•à‡•§</p><ul class="list-disc list-inside ml-2 mt-2"><li><strong>‡§™‡•ç‡§∞‡•ã‡§∏‡•á‡§∏‡§ø‡§Ç‡§ó ‡§∂‡•Å‡§≤‡•ç‡§ï:</strong> ‡§≤‡•ã‡§® ‡§∞‡§æ‡§∂‡§ø ‡§ï‡§æ 1%‡•§ ‡§Ö‡§ó‡§∞ ‡§≤‡•ã‡§® ‡§∞‡§æ‡§∂‡§ø ‚Çπ9000 ‡§∏‡•á ‡§Ö‡§ß‡§ø‡§ï ‡§π‡•à, ‡§§‡•ã ‚Çπ200 ‡§ï‡§æ ‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ ‡§∂‡•Å‡§≤‡•ç‡§ï ‡§≤‡§æ‡§ó‡•Ç ‡§π‡•ã‡§ó‡§æ‡•§</li><li><strong>‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§∏‡§Ç‡§∞‡§ö‡§®‡§æ:</strong> ‡§™‡§π‡§≤‡•á 3 ‡§Æ‡§π‡•Ä‡§®‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•á‡§µ‡§≤ ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§ï‡§æ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§∞‡§®‡§æ ‡§π‡•ã‡§ó‡§æ‡•§ ‡§â‡§∏‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§™‡•Ç‡§∞‡•Ä EMI (‡§Æ‡•Ç‡§≤‡§ß‡§® + ‡§¨‡•ç‡§Ø‡§æ‡§ú) ‡§∂‡•Å‡§∞‡•Ç ‡§π‡•ã ‡§ú‡§æ‡§è‡§ó‡•Ä‡•§</li></ul>`,
            gold: `<h3><i class="fas fa-gem"></i> Gold Loan - ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä</h3><p>‡§Ø‡§π ‡§≤‡•ã‡§® ‡§Ü‡§™‡§ï‡•á ‡§¶‡•ç‡§µ‡§æ‡§∞‡§æ ‡§ú‡§Æ‡§æ ‡§ï‡§ø‡§è ‡§ó‡§è ‡§∏‡•ã‡§®‡•á ‡§ï‡•á ‡§∏‡§æ‡§Æ‡§æ‡§® (Collateral) ‡§ï‡•á ‡§¨‡§¶‡§≤‡•á <strong>3% ‡§™‡•ç‡§∞‡§§‡§ø ‡§Æ‡§æ‡§π</strong> ‡§ï‡•Ä ‡§¶‡§∞ ‡§™‡§∞ ‡§¶‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ ‡§π‡•à‡•§</p><p class="font-bold mt-3">üí∞ ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§ï‡§æ ‡§¨‡§Ç‡§ü‡§µ‡§æ‡§∞‡§æ (Interest Distribution)</p><p>‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§ï‡•ã ‡§§‡•Ä‡§® ‡§≠‡§æ‡§ó‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§¨‡§æ‡§Ç‡§ü‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ:</p><ul class="list-disc list-inside ml-2"><li>‡§™‡§π‡§≤‡§æ ‡§≠‡§æ‡§ó: ‡§¨‡•à‡§Ç‡§ï ‡§µ‡•â‡§≤‡•á‡§ü ‡§Æ‡•á‡§Ç</li><li>‡§¶‡•Ç‡§∏‡§∞‡§æ ‡§≠‡§æ‡§ó: ‡§∏‡§≠‡•Ä ‡§∏‡§¶‡§∏‡•ç‡§Ø‡•ã‡§Ç ‡§Æ‡•á‡§Ç</li><li>‡§§‡•Ä‡§∏‡§∞‡§æ ‡§≠‡§æ‡§ó: ‡§ó‡§æ‡§∞‡§Ç‡§ü‡§∞ ‡§ï‡•ã</li></ul><div class="note"><p class="font-bold">üìù ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ß‡•ç‡§Ø‡§æ‡§® ‡§¶‡•á‡§Ç:</p><ul class="list-disc list-inside ml-2"><li>‡§≤‡•ã‡§® ‡§ï‡•Ä ‡§Ö‡§µ‡§ß‡§ø 6 ‡§∏‡•á 12 ‡§Æ‡§π‡•Ä‡§®‡•á ‡§§‡§ï ‡§ï‡•Ä ‡§π‡•ã‡§§‡•Ä ‡§π‡•à‡•§</li><li>‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡•á‡§ï ‡§Æ‡§æ‡§π ‡§®‡§ø‡§Ø‡§Æ‡§ø‡§§ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§Ø‡§æ ‡§™‡•Ç‡§∞‡•Ä EMI ‡§ï‡§æ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§∞‡§®‡§æ ‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø ‡§π‡•à‡•§</li></ul></div>`,
            guarantor: `<h3><i class="fas fa-user-shield"></i> Guarantor Loan - ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§¨‡§æ‡§§‡•á‡§Ç</h3><p>‡§á‡§∏ ‡§≤‡•ã‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï ‡§ó‡§æ‡§∞‡§Ç‡§ü‡§∞ ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•ã‡§§‡•Ä ‡§π‡•à ‡§î‡§∞ ‡§á‡§∏ ‡§™‡§∞ <strong>3% ‡§™‡•ç‡§∞‡§§‡§ø ‡§Æ‡§æ‡§π</strong> ‡§ï‡•Ä ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§¶‡§∞ ‡§≤‡§æ‡§ó‡•Ç ‡§π‡•ã‡§§‡•Ä ‡§π‡•à‡•§</p><p class="font-bold mt-3">üí∞ ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§ï‡§æ ‡§¨‡§Ç‡§ü‡§µ‡§æ‡§∞‡§æ (Interest Distribution)</p><p>‡§ó‡•ã‡§≤‡•ç‡§° ‡§≤‡•ã‡§® ‡§ï‡•Ä ‡§§‡§∞‡§π ‡§π‡•Ä, ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§ï‡•ã ‡§§‡•Ä‡§® ‡§≠‡§æ‡§ó‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§¨‡§æ‡§Ç‡§ü‡§æ ‡§ú‡§æ‡§è‡§ó‡§æ (‡§¨‡•à‡§Ç‡§ï ‡§µ‡•â‡§≤‡•á‡§ü, ‡§∏‡§≠‡•Ä ‡§∏‡§¶‡§∏‡•ç‡§Ø, ‡§î‡§∞ ‡§ó‡§æ‡§∞‡§Ç‡§ü‡§∞)‡•§</p><div class="note" style="border-left-color: #f87171; background-color: #fef2f2;"><p class="font-bold text-red-700">‚ö†Ô∏è ‡§Æ‡§π‡§§‡•ç‡§µ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§®‡•ã‡§ü:</p><ul class="list-disc list-inside ml-2"><li><strong>‡§ó‡§æ‡§∞‡§Ç‡§ü‡§∞ ‡§ï‡•Ä ‡§∞‡§æ‡§∂‡§ø ‡§π‡•ã‡§≤‡•ç‡§°:</strong> ‡§á‡§∏ ‡§≤‡•ã‡§® ‡§Æ‡•á‡§Ç, ‡§ó‡§æ‡§∞‡§Ç‡§ü‡§∞ ‡§ï‡•á ‡§ñ‡§æ‡§§‡•á ‡§∏‡•á ‡§≤‡•ã‡§® ‡§∞‡§æ‡§∂‡§ø ‡§ï‡•á ‡§¨‡§∞‡§æ‡§¨‡§∞ ‡§ï‡•Ä ‡§∞‡§æ‡§∂‡§ø ‡§π‡•ã‡§≤‡•ç‡§° ‡§ï‡§∞ ‡§¶‡•Ä ‡§ú‡§æ‡§è‡§ó‡•Ä‡•§ ‡§Ø‡§π ‡§π‡•ã‡§≤‡•ç‡§° ‡§§‡§¨ ‡§§‡§ï ‡§∞‡§π‡•á‡§ó‡§æ ‡§ú‡§¨ ‡§§‡§ï ‡§ï‡§ø ‡§≤‡•ã‡§® ‡§™‡•Ç‡§∞‡•Ä ‡§§‡§∞‡§π ‡§∏‡•á ‡§ö‡•Å‡§ï‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§¶‡§ø‡§Ø‡§æ ‡§ú‡§æ‡§§‡§æ‡•§</li><li><strong>‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§≠‡•Å‡§ó‡§§‡§æ‡§®:</strong> ‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡•á‡§ï ‡§Æ‡§æ‡§π ‡§®‡§ø‡§Ø‡§Æ‡§ø‡§§ ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§¨‡•ç‡§Ø‡§æ‡§ú ‡§Ø‡§æ ‡§™‡•Ç‡§∞‡•Ä EMI ‡§ï‡§æ ‡§≠‡•Å‡§ó‡§§‡§æ‡§® ‡§ï‡§∞‡§®‡§æ ‡§Ö‡§®‡§ø‡§µ‡§æ‡§∞‡•ç‡§Ø ‡§π‡•à‡•§</li></ul></div>`
        };
        
        function updateLoanNotification() {
            const category = loanCategorySelect.value;
            loanInfoNotification.innerHTML = notificationContent[category] || '';
            loanInfoNotification.style.display = notificationContent[category] ? 'block' : 'none';
        }

        function updateFormUI() {
            const category = loanCategorySelect.value;
            const selectedOptions = loanOptions[category];
            const selectedApplicantText = nameSelect.options[nameSelect.selectedIndex]?.text || '';
            durationRateLabel.textContent = selectedOptions.label;
            durationRateSelect.innerHTML = '';
            selectedOptions.options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.text;
                durationRateSelect.appendChild(option);
            });
            goldCollateralSection.style.display = (category === 'gold') ? 'block' : 'none';
            goldCollateralInput.required = (category === 'gold');
            const needsManualGuarantor = category === 'guarantor' || selectedApplicantText.toLowerCase().includes('bank');
            guarantorSection.style.display = needsManualGuarantor ? 'block' : 'none';
            guarantorSelect.required = needsManualGuarantor;
            updateLoanNotification(); 
        }
        
        async function fetchMemberData() {
            try {
                const db = firebase.database();
                const membersRef = db.ref('members');
                const snapshot = await membersRef.once('value');
                if (!snapshot.exists()) throw new Error('No member data found.');
                membersData = snapshot.val();
                const approvedMembers = Object.entries(membersData)
                    .filter(([id, member]) => member.status === 'Approved' && member.fullName)
                    .map(([id, member]) => ({ id, ...member }))
                    .sort((a, b) => a.fullName.localeCompare(b.fullName));
                nameSelect.innerHTML = '<option value="" disabled selected>Select Applicant Name</option>';
                guarantorSelect.innerHTML = '<option value="" disabled selected>Select Guarantor</option>';
                approvedMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.fullName;
                    nameSelect.appendChild(option.cloneNode(true));
                    const guarantorOption = document.createElement('option');
                    guarantorOption.value = member.id;
                    guarantorOption.textContent = member.fullName;
                    guarantorSelect.appendChild(guarantorOption);
                });
                updateFormUI();
            } catch (error) {
                console.error('Error fetching member data:', error);
                nameSelect.innerHTML = '<option value="" disabled selected>Error loading members</option>';
                alert('Failed to load member data. Please check console.');
            }
        }

        function createProxyUrl(url) {
            if (!url || typeof url !== 'string' || !url.startsWith('http')) {
                return 'https://placehold.co/100x120/EFEFEF/AAAAAA&text=No+Image';
            }
            const urlWithoutProtocol = url.replace(/^(https?:\/\/)/, '');
            return `https://images.weserv.nl/?url=${urlWithoutProtocol}`;
        }

        function formatDate(date) {
            const day = date.getDate();
            const month = date.toLocaleString('default', { month: 'long' });
            const year = date.getFullYear();
            return `${day} ${month} ${year}`;
        }

        async function uploadImageToImgBB(file) {
            if (!file) return null;
            const formData = new FormData();
            formData.append('image', file);
            try {
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY_FORM}`, { method: 'POST', body: formData });
                const json = await res.json();
                if (!json.success) { throw new Error(json.error.message || 'Unknown error during image upload.'); }
                return json.data.url;
            } catch (err) {
                console.error('ImgBB upload failed:', err);
                alert('Image upload failed: ' + err.message);
                return null;
            }
        }

        async function waitForImages(containerElement) {
            const images = Array.from(containerElement.getElementsByTagName('img'));
            const promises = images.map(img => {
                // For Base64 images, they are complete synchronously. For others, wait.
                if (img.src && !img.src.startsWith('data:') && !img.complete) {
                    return new Promise((resolve) => {
                        img.onload = resolve;
                        img.onerror = () => { console.warn(`Image failed to load: ${img.src}`); resolve(); };
                    });
                }
                return Promise.resolve();
            });
            return Promise.all(promises);
        }

        loanForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const selectedMemberId = nameSelect.value;
            const member = membersData[selectedMemberId];
            if (!member) { alert('Please select a valid member.'); return; }
            
            const amount = parseFloat(amountInput.value);
            const category = loanCategorySelect.value;
            const rateValue = durationRateSelect.value;
            const uploadedFile = imageUploadInput.files[0];
            const collateralItem = goldCollateralInput.value;

            if (isNaN(amount) || !rateValue) { alert('Please fill in all required fields.'); return; }
            
            [processingFeeRowEl, interestOnlyPaymentRowEl, emiRowEl, businessInterestRowEl, businessEmiRowEl, guarantorRowEl, collateralRowEl].forEach(el => el.style.display = 'none');
            
            let guarantorName = 'N/A';
            const needsManualGuarantor = category === 'guarantor' || member.fullName.toLowerCase().includes('bank');

            if (needsManualGuarantor) {
                const guarantorId = guarantorSelect.value;
                if (!guarantorId) { alert('Please select a guarantor for this loan type.'); return; }
                guarantorName = membersData[guarantorId].fullName;
            } else {
                guarantorName = member.guarantorName || 'N/A';
            }
            displayGuarantorEl.textContent = guarantorName;
            guarantorRowEl.style.display = 'flex';
            
            if (category === 'gold' && collateralItem) {
                displayCollateralEl.textContent = collateralItem;
                collateralRowEl.style.display = 'flex';
            }
            
            let loanDetails = {};
            let interest = 0, totalMonths = 0, rateText = '', totalAmount = 0;
            
            switch(category) {
                case 'personal':
                    const [pRate, pMonths] = rateValue.split('-').map(Number);
                    interest = pRate;
                    totalMonths = pMonths;
                    rateText = durationRateSelect.options[durationRateSelect.selectedIndex].text;
                    totalAmount = amount + (amount * (interest / 100));
                    loanDetails.emi = (totalAmount / totalMonths).toFixed(2);
                    displayEMIEl.textContent = loanDetails.emi;
                    emiRowEl.style.display = 'flex';
                    break;
                case 'business':
                    const [interestOnlyMonths, emiMonths] = rateValue.split('-').map(Number);
                    const monthlyInterestRate = 1.5 / 100;
                    loanDetails.processingFee = amount * 0.015;
                    if (amount > 9000) loanDetails.processingFee += 200;
                    displayProcessingFeeEl.textContent = loanDetails.processingFee.toFixed(2);
                    processingFeeRowEl.style.display = 'flex';
                    loanDetails.monthlyInterestPayment = amount * monthlyInterestRate;
                    const emiPayment = (amount * monthlyInterestRate * Math.pow(1 + monthlyInterestRate, emiMonths)) / (Math.pow(1 + monthlyInterestRate, emiMonths) - 1);
                    loanDetails.emi = emiPayment.toFixed(2);
                    totalAmount = (loanDetails.monthlyInterestPayment * interestOnlyMonths) + (emiPayment * emiMonths);
                    totalMonths = interestOnlyMonths + emiMonths;
                    displayBusinessInterestEl.textContent = `${loanDetails.monthlyInterestPayment.toFixed(2)} (for first ${interestOnlyMonths} months)`;
                    displayBusinessEMIEl.textContent = `${loanDetails.emi} (for last ${emiMonths} months)`;
                    businessInterestRowEl.style.display = 'flex';
                    businessEmiRowEl.style.display = 'flex';
                    rateText = `18% Annually`;
                    break;
                case 'gold':
                case 'guarantor':
                    const [gRate, gMonths] = rateValue.split('-').map(Number);
                    interest = gRate;
                    totalMonths = gMonths;
                    const gMonthlyRate = interest / 100;
                    loanDetails.interestOnlyPayment = amount * gMonthlyRate;
                    displayInterestOnlyPaymentEl.textContent = loanDetails.interestOnlyPayment.toFixed(2);
                    interestOnlyPaymentRowEl.style.display = 'flex';
                    const fullEmi = (amount * gMonthlyRate * Math.pow(1 + gMonthlyRate, totalMonths)) / (Math.pow(1 + gMonthlyRate, totalMonths) - 1);
                    loanDetails.emi = fullEmi.toFixed(2);
                    totalAmount = fullEmi * totalMonths;
                    displayEMIEl.textContent = loanDetails.emi;
                    emiRowEl.style.display = 'flex';
                    rateText = `${interest}% Monthly for ${totalMonths} months`;
                    break;
            }
            
            const today = new Date();
            const repaymentDate = new Date(today);
            repaymentDate.setMonth(repaymentDate.getMonth() + totalMonths);

            currentDateEl.textContent = formatDate(today);
            let categoryText = loanCategorySelect.options[loanCategorySelect.selectedIndex].text.split('(')[0].trim();
            letterLoanCategoryEl.textContent = categoryText.replace(/LOAN/i, '').trim() + ' LOAN';
            displayNameEl.textContent = member.fullName;
            displayMobileEl.textContent = member.mobileNumber || 'N/A';
            displayAmountEl.textContent = amount.toFixed(2);
            displayRateEl.textContent = rateText;
            displayTotalAmountEl.textContent = totalAmount.toFixed(2);
            repaymentDateEl.textContent = formatDate(repaymentDate);
            apiApplicantPhotoEl.src = createProxyUrl(member.profilePicUrl);

            manualApplicantPhotoEl.src = "";
            manualUploadSectionEl.style.display = 'none';

            if (uploadedFile) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    manualApplicantPhotoEl.src = event.target.result;
                    manualUploadSectionEl.style.display = 'block';
                }
                reader.readAsDataURL(uploadedFile);
            } else if (member.documentUrl) {
                manualApplicantPhotoEl.src = createProxyUrl(member.documentUrl);
                manualUploadSectionEl.style.display = 'block';
            }

            pendingLoanDataForSubmit = {
                applicantId: selectedMemberId, applicantName: member.fullName, applicantPhotoUrl: member.profilePicUrl,
                loanAmount: amount, loanCategory: category, loanCategoryText: categoryText, rateText: rateText,
                totalPayable: totalAmount, repaymentEndDate: repaymentDate.toISOString(), guarantorName: guarantorName,
                collateralItem: category === 'gold' ? collateralItem : null, additionalDocFile: uploadedFile,
                loanDetails: loanDetails, status: 'pending'
            };

            letterPreviewSection.classList.remove('hidden');
            actionButtonsContainer.classList.remove('hidden'); // Show the submit button
            letterPreviewSection.scrollIntoView({ behavior: 'smooth' });
        });

        submitForApprovalBtn.addEventListener('click', async function() {
            submitForApprovalBtn.disabled = true;
            submitBtnText.textContent = 'Submitting...';
            submitLoader.classList.remove('hidden');

            try {
                await waitForImages(captureDiv);
                await new Promise(resolve => setTimeout(resolve, 500));
                const canvas = await html2canvas(captureDiv, { scale: 2, useCORS: true, logging: false });
                generatedCanvas = canvas; // Save canvas for later download

                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                const letterImageUrl = await uploadImageToImgBB(blob);
                const additionalDocUrl = await uploadImageToImgBB(pendingLoanDataForSubmit.additionalDocFile);

                if (!letterImageUrl) {
                    throw new Error('Failed to upload the generated loan letter. Cannot proceed.');
                }
                
                const finalData = {
                    ...pendingLoanDataForSubmit,
                    letterImageUrl: letterImageUrl,
                    additionalDocUrl: additionalDocUrl,
                    submittedAt: firebase.database.ServerValue.TIMESTAMP
                };
                delete finalData.additionalDocFile;

                const db = firebase.database();
                await db.ref('pendingLoans').push(finalData);
                
                mainFormContainer.style.display = 'none';
                letterPreviewSection.style.display = 'none';
                actionButtonsContainer.style.display = 'none';
                successMessage.classList.remove('hidden');
                successDownloadBtn.classList.remove('hidden'); // Show download button on success

            } catch (error) {
                console.error("Submission error:", error);
                alert("Failed to submit application. Error: " + error.message);
                submitForApprovalBtn.disabled = false;
                submitBtnText.textContent = 'Submit for Approval';
                submitLoader.classList.add('hidden');
            }
        });

        // --- NEW EVENT LISTENERS FOR THE SUCCESS BUTTONS ---
        successDownloadBtn.addEventListener('click', function() {
            if (!generatedCanvas) {
                alert('Could not find the letter to download. Please try generating again.');
                return;
            }
            successDownloadBtn.disabled = true;
            successDownloadBtn.textContent = 'Downloading...';
            
            const link = document.createElement('a');
            const fileName = `Loan_${displayNameEl.textContent.replace(/\s+/g, '_') || 'Form'}_${Date.now()}.png`;
            link.download = fileName;
            link.href = generatedCanvas.toDataURL('image/png');
            link.click();
            link.remove();
            
            successDownloadBtn.textContent = 'Downloaded!';
            successShareBtn.classList.remove('hidden'); // Show share button after download
        });

        successShareBtn.addEventListener('click', function() {
            const groupLink = 'https://chat.whatsapp.com/G39I0hP55WIDHMu5YkAjDZ';
            window.open(groupLink, '_blank');
        });

        loanCategorySelect.addEventListener('change', updateFormUI);
        nameSelect.addEventListener('change', updateFormUI);
        fetchMemberData();
    }

    checkAuthAndInitialize();
  </script>

</body>
</html>

