<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Bank Community Loan Form</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
    }
    .form-container {
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    input:focus, select:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }
    .btn {
      transition: all 0.3s ease;
    }
    .btn:hover {
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
      transform: translateY(-3px);
    }
    .btn:disabled {
        background-color: #9ca3af;
        cursor: not-allowed;
    }
    .loader {
        border: 3px solid rgba(255,255,255,0.3);
        border-top: 3px solid #fff;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-left: 8px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #capture {
      width: 210mm;
      min-height: 290mm;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
      background-color: white;
    }
    .header {
      border-bottom: 4px solid #056fff;
    }
    .header h1 {
      color: #056fff;
    }
    .details-text p i {
      color: #056fff;
    }
    .highlight {
      color: #056fff;
    }
    .footer-section {
        border-top: 1px solid #eee;
    }
    /* Rules Image Style */
    .rules-image-container img {
        width: 100%;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body class="bg-gray-100 flex flex-col justify-center items-center p-5">
  <div id="main-form-container" class="form-container bg-white p-6 rounded-xl w-full max-w-md mb-8">
    <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">Smart Loan Application Form</h1>
    <form id="loanForm">
      <label for="nameSelect" class="block mb-1 font-bold text-gray-600">Applicant Name:</label>
      <select id="nameSelect" required class="w-full p-3 mb-4 border border-gray-300 rounded-lg text-base bg-white focus:outline-none">
        <option value="" disabled selected>Loading members...</option>
      </select>
      
      <label for="loanCategory" class="block mb-1 font-bold text-gray-600">Loan Category:</label>
      <select id="loanCategory" required class="w-full p-3 mb-4 border border-gray-300 rounded-lg text-base bg-white focus:outline-none">
        <option value="personal" selected>Personal Loan (Cash)</option>
        <option value="product">Product Loan (Item/Asset)</option>
      </select>

      <!-- Product Name Input -->
      <div id="productCollateralSection" style="display: none;">
          <label id="productLabel" for="productInput" class="block mb-1 font-bold text-gray-600">Product Name (Product ka Naam):</label>
          <input type="text" id="productInput" placeholder="Enter product name (e.g., Mobile, Laptop)" class="w-full p-3 mb-4 border border-gray-300 rounded-lg text-base focus:outline-none">
      </div>

      <label for="amount" class="block mb-1 font-bold text-gray-600">Loan Amount (₹):</label>
      <input type="number" id="amount" placeholder="Enter loan amount" min="1" required class="w-full p-3 mb-4 border border-gray-300 rounded-lg text-base focus:outline-none">

      <div id="dynamicOptionsContainer">
        <label for="durationRateSelect" id="durationRateLabel" class="block mb-1 font-bold text-gray-600">Duration & Interest:</label>
        <select id="durationRateSelect" required class="w-full p-3 mb-4 border border-gray-300 rounded-lg text-base bg-white focus:outline-none">
           <option value="" disabled selected>Enter amount first...</option>
        </select>
      </div>

      <label for="imageUpload" class="block mb-1 font-bold text-gray-600">Upload Additional Document (Optional):</label>
      <input type="file" id="imageUpload" accept="image/*" class="w-full p-2 mb-4 text-base border rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">

      <button type="submit" class="btn w-full p-4 bg-blue-600 text-white font-bold rounded-lg text-base cursor-pointer mt-5 hover:bg-blue-700">Generate & Preview Letter</button>
      
      <!-- New Rules Image Section -->
      <div class="mt-6 rules-image-container">
          <p class="font-bold text-gray-700 mb-2">Loan Rules & Terms:</p>
          <img src="https://ik.imagekit.io/kdtvm0r78/1000119828-optimized_C4_53shzy.jpg" alt="Loan Rules">
      </div>
    </form>
  </div>

  <!-- Preview & Download Section -->
  <div id="letter-preview-section" class="hidden w-full flex flex-col items-center mb-10">
      
      <!-- Download Button Area -->
      <div class="w-full max-w-2xl flex justify-center mb-4 sticky top-4 z-10">
          <button id="downloadBtn" class="btn bg-green-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-green-700 flex items-center">
              <i class="fas fa-download mr-2"></i> Download Letter Image
          </button>
      </div>

      <div id="capture" class="bg-white p-[15mm] border border-gray-300 my-5 mx-auto flex flex-col relative">
        <div class="header text-center pb-4 mb-5 relative">
          <div class="header-info absolute right-0 top-0 text-right text-sm text-gray-600">Date: <span id="currentDate"></span></div>
          <img src="https://ik.imagekit.io/kdtvm0r78/IMG-20251202-WA0000.jpg" crossorigin="anonymous" class="logo w-24 mx-auto mb-1" alt="Bank Logo">
          <h1 class="text-2xl font-bold my-2">TRUST COMMUNITY LOAN FORM</h1>
          <h2 id="letterLoanCategory" class="text-2xl font-bold text-green-600 mt-3"></h2>
        </div>
        
        <div class="loan-details-container flex justify-between items-start my-5 p-4 border border-gray-200 rounded-lg bg-gray-50">
            <div class="details-text flex-grow pr-4">
              <p class="my-2 text-sm text-gray-800 flex items-center"><i class="fas fa-user w-5 text-center mr-2"></i>Applicant Name: <span class="highlight font-bold ml-1" id="displayName"></span></p>
              
              <!-- Product Name Row -->
              <p id="productRow" class="my-2 text-sm text-gray-800 flex items-center" style="display: none;">
                  <i class="fas fa-box-open w-5 text-center mr-2"></i>
                  <span>Product Name:</span> 
                  <span class="highlight font-bold ml-1" id="displayProduct"></span>
              </p>

              <p class="my-2 text-sm text-gray-800 flex items-center"><i class="fas fa-mobile-alt w-5 text-center mr-2"></i>Mobile Number: <span id="displayMobile" class="ml-1"></span></p>
              <p class="my-2 text-sm text-gray-800 flex items-center"><i class="fas fa-rupee-sign w-5 text-center mr-2"></i>Loan Amount: ₹<span id="displayAmount" class="ml-1"></span></p>
              
              <p id="processingFeeRow" class="my-2 text-sm text-gray-800 flex items-center" style="display: none;"><i class="fas fa-cogs w-5 text-center mr-2"></i>Processing Fee: ₹<span id="displayProcessingFee" class="ml-1"></span></p>
              
              <p class="my-2 text-sm text-gray-800 flex items-center"><i class="fas fa-percent w-5 text-center mr-2"></i>Interest Rate: <span id="displayRate" class="ml-1"></span></p>
              
              <p id="emiRow" class="my-2 text-sm text-gray-800 flex items-center"><i class="fas fa-chart-pie w-5 text-center mr-2"></i>Monthly EMI: ₹<span id="displayEMI" class="ml-1"></span></p>
              
              <p class="my-2 text-sm text-gray-800 flex items-center"><i class="fas fa-file-invoice-dollar w-5 text-center mr-2"></i>Total Payable: ₹<span id="displayTotalAmount" class="ml-1"></span></p>
              <p class="my-2 text-sm text-gray-800 flex items-center"><i class="fas fa-calendar-alt w-5 text-center mr-2"></i>Repayment Period Ends: <span id="repaymentDate" class="ml-1"></span></p>
            </div>
            
            <div class="api-photo-container flex-shrink-0 w-24 text-center">
                <p class="mb-1 font-bold text-gray-600 text-xs">Applicant Photo:</p>
                <img id="apiApplicantPhoto" src="" crossorigin="anonymous" alt="Applicant Photo" class="max-w-full h-auto max-h-24 border border-gray-300 rounded-md object-contain mt-1 bg-white">
            </div>
        </div>

        <div id="manualUploadSection" class="my-5 mx-auto p-4 border border-dashed border-gray-300 rounded-lg text-center max-w-[80%]" style="display: none;">
            <p class="mb-2 font-bold text-gray-700 text-sm">Additional Document:</p>
            <img id="manualApplicantPhoto" src="" crossorigin="anonymous" alt="Additional Document" class="max-w-full max-h-52 h-auto border border-gray-300 rounded-md object-contain">
        </div>

        <p class="request-text highlight text-center italic text-gray-600 text-sm mt-6 font-bold">I request the bank community members to please approve this loan application.</p>
        
        <div class="footer-section mt-auto pt-6 flex justify-between items-end">
            <div class="stamp-section text-center">
                 <img src="https://ik.imagekit.io/kdtvm0r78/20251206_210616.png" crossorigin="anonymous" class="stamp-img w-36 opacity-80" alt="Bank Stamp">
                 <p class="m-0 text-xs text-gray-800">Community Stamp</p>
            </div>
            <div class="signature-section text-center">
              <p class="m-0 text-xs text-gray-800">Authorized Signature</p>
              <img src="https://ik.imagekit.io/kdtvm0r78/image.png" crossorigin="anonymous" class="signature-img w-44 mt-1" alt="Signature">
              <p class="m-0 text-xs text-gray-800">Prime Members</p>
            </div>
        </div>
      </div> 
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <script>
    async function checkAuthAndInitialize() {
        try {
            const response = await fetch('/api/config.js');
            if (!response.ok) throw new Error('Configuration failed to load.');
            const config = await response.json();
            
            firebase.initializeApp(config.firebase);
            
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    runAppLogic(); 
                } else {
                    window.location.href = `/login.html?redirect=${window.location.pathname}`;
                }
            });
        } catch (error) {
            console.error('Initialization Error:', error);
            document.getElementById('main-form-container').innerHTML = `<p class="text-red-500 text-center">${error.message}</p>`;
        }
    }

    function runAppLogic() {
        let membersData = {};

        const mainFormContainer = document.getElementById('main-form-container');
        const letterPreviewSection = document.getElementById('letter-preview-section');
        const nameSelect = document.getElementById('nameSelect');
        const loanCategorySelect = document.getElementById('loanCategory');
        const amountInput = document.getElementById('amount');
        const durationRateSelect = document.getElementById('durationRateSelect');
        const imageUploadInput = document.getElementById('imageUpload');
        const loanForm = document.getElementById('loanForm');
        const captureDiv = document.getElementById('capture');
        const downloadBtn = document.getElementById('downloadBtn');

        // Product Loan Elements
        const productCollateralSection = document.getElementById('productCollateralSection');
        const productInput = document.getElementById('productInput');
        
        // Letter Elements
        const currentDateEl = document.getElementById('currentDate');
        const letterLoanCategoryEl = document.getElementById('letterLoanCategory');
        const displayNameEl = document.getElementById('displayName');
        const displayMobileEl = document.getElementById('displayMobile');
        const displayAmountEl = document.getElementById('displayAmount');
        const displayRateEl = document.getElementById('displayRate');
        const displayTotalAmountEl = document.getElementById('displayTotalAmount');
        const repaymentDateEl = document.getElementById('repaymentDate');
        const apiApplicantPhotoEl = document.getElementById('apiApplicantPhoto');
        const manualUploadSectionEl = document.getElementById('manualUploadSection');
        const manualApplicantPhotoEl = document.getElementById('manualApplicantPhoto');
        
        const productRowEl = document.getElementById('productRow');
        const displayProductEl = document.getElementById('displayProduct');
        
        const processingFeeRowEl = document.getElementById('processingFeeRow');
        const displayProcessingFeeEl = document.getElementById('displayProcessingFee');
        const emiRowEl = document.getElementById('emiRow');
        const displayEMIEl = document.getElementById('displayEMI');

        function updateOptions() {
            const category = loanCategorySelect.value;
            const amount = parseFloat(amountInput.value) || 0;
            const select = durationRateSelect;
            select.innerHTML = ''; // Clear existing

            // Show product input if needed
            if (category === 'product') {
                productCollateralSection.style.display = 'block';
                productInput.required = true;
            } else {
                productCollateralSection.style.display = 'none';
                productInput.required = false;
            }

            if (amount === 0) {
                const opt = document.createElement('option');
                opt.text = "Please enter loan amount first";
                select.add(opt);
                return;
            }

            let options = [];

            if (category === 'personal') {
                if (amount >= 30000) {
                    // Medium Term Logic
                    options = [
                        { value: '6-0.66-0.5', text: '6 Months (0.66% Monthly Interest)' },
                        { value: '9-0.66-0.5', text: '9 Months (0.66% Monthly Interest)' },
                        { value: '12-0.66-0.5', text: '12 Months (0.66% Monthly Interest)' }
                    ];
                } else {
                    // Short Term Logic (< 30k)
                    options = [
                        { value: '1-1.0-0', text: '1 Month (1% Interest)' },
                        { value: '2-1.5-0', text: '2 Months (1.5% Monthly Interest)' },
                        { value: '3-1.66-0', text: '3 Months (1.66% Monthly Interest)' },
                        { value: '4-1.66-0', text: '4 Months (1.66% Monthly Interest)' },
                        { value: '5-1.66-0', text: '5 Months (1.66% Monthly Interest)' }
                    ];
                }
            } else if (category === 'product') {
                if (amount >= 30000) {
                    // Product Medium Term
                    options = [
                        { value: '6-0.5-100', text: '6 Months (0.5% Monthly + ₹100 Fee)' },
                        { value: '9-0.5-100', text: '9 Months (0.5% Monthly + ₹100 Fee)' },
                        { value: '12-0.5-100', text: '12 Months (0.5% Monthly + ₹100 Fee)' }
                    ];
                } else {
                    // Product Short Term (< 30k)
                    const fee = amount > 5000 ? 100 : 0;
                    const feeText = fee > 0 ? '+ ₹100 Fee' : '';
                    options = [
                        { value: `1-1.0-${fee}`, text: `1 Month (1% Interest ${feeText})` },
                        { value: `2-1.0-${fee}`, text: `2 Months (1% Interest ${feeText})` },
                        { value: `3-1.0-${fee}`, text: `3 Months (1% Interest ${feeText})` },
                        { value: `4-1.0-${fee}`, text: `4 Months (1% Interest ${feeText})` },
                        { value: `5-1.0-${fee}`, text: `5 Months (1% Interest ${feeText})` }
                    ];
                }
            }

            options.forEach(opt => {
                const el = document.createElement('option');
                el.value = opt.value;
                el.textContent = opt.text;
                select.appendChild(el);
            });
        }

        async function fetchMemberData() {
            try {
                const db = firebase.database();
                const membersRef = db.ref('members');
                const snapshot = await membersRef.once('value');
                if (!snapshot.exists()) throw new Error('No member data found.');
                membersData = snapshot.val();
                
                nameSelect.innerHTML = '<option value="" disabled selected>Select Applicant Name</option>';
                const approvedMembers = Object.entries(membersData)
                    .filter(([id, member]) => member.status === 'Approved' && member.fullName)
                    .map(([id, member]) => ({ id, ...member }))
                    .sort((a, b) => a.fullName.localeCompare(b.fullName));

                approvedMembers.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.fullName;
                    nameSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching member data:', error);
                nameSelect.innerHTML = '<option value="" disabled selected>Error loading members</option>';
            }
        }

        function createProxyUrl(url) {
            if (!url || typeof url !== 'string' || !url.startsWith('http')) {
                return 'https://placehold.co/100x120/EFEFEF/AAAAAA&text=No+Image';
            }
            const urlWithoutProtocol = url.replace(/^(https?:\/\/)/, '');
            return `https://images.weserv.nl/?url=${urlWithoutProtocol}`;
        }

        function formatDate(date) {
            const day = date.getDate();
            const month = date.toLocaleString('default', { month: 'long' });
            const year = date.getFullYear();
            return `${day} ${month} ${year}`;
        }

        async function waitForImages(containerElement) {
            const images = Array.from(containerElement.getElementsByTagName('img'));
            const promises = images.map(img => {
                if (img.src && !img.complete) {
                    return new Promise((resolve) => {
                        img.onload = resolve;
                        img.onerror = () => { resolve(); };
                    });
                }
                return Promise.resolve();
            });
            return Promise.all(promises);
        }

        loanForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const selectedMemberId = nameSelect.value;
            const member = membersData[selectedMemberId];
            if (!member) { alert('Please select a valid member.'); return; }
            
            const amount = parseFloat(amountInput.value);
            const category = loanCategorySelect.value;
            const rateString = durationRateSelect.value;
            const uploadedFile = imageUploadInput.files[0];
            const productItemName = productInput.value;

            if (isNaN(amount) || !rateString) { alert('Please fill in all required fields.'); return; }
            
            // value format: "months-interestRate-fee"
            // Example: "6-0.66-0.5" (0.5 is percent if < 1, else flat amount if > 1 for this context?)
            // Let's parse strictly based on category logic used in creation
            const [months, interestRate, feeRaw] = rateString.split('-').map(Number);
            
            let processingFee = 0;
            // Fee Logic check
            if (category === 'personal' && amount >= 30000) {
                 processingFee = amount * (feeRaw / 100); // 0.5%
            } else if (category === 'product' && amount >= 30000) {
                 processingFee = feeRaw; // Flat 100
            } else if (category === 'product' && amount < 30000) {
                 processingFee = feeRaw; // Flat 100 or 0
            } else {
                 processingFee = 0;
            }

            // Calculation
            // Monthly Interest Amount
            const monthlyInterestAmount = amount * (interestRate / 100);
            
            // Total Payable
            // Formula: Principal + (MonthlyInterest * Months)
            const totalInterest = monthlyInterestAmount * months;
            const totalPayable = amount + totalInterest;
            
            // EMI
            let emi = totalPayable / months;
            
            // Rounding logic for clean EMIs (Optional but good)
            emi = Math.ceil(emi);

            // Display in Letter
            const today = new Date();
            const endDate = new Date(today);
            endDate.setMonth(endDate.getMonth() + months);

            currentDateEl.textContent = formatDate(today);
            letterLoanCategoryEl.textContent = category === 'personal' ? 'PERSONAL LOAN' : 'PRODUCT LOAN';
            displayNameEl.textContent = member.fullName;
            displayMobileEl.textContent = member.mobileNumber || 'N/A';
            displayAmountEl.textContent = amount.toFixed(2);
            
            // Show Fee if applicable
            if (processingFee > 0) {
                displayProcessingFeeEl.textContent = processingFee.toFixed(2);
                processingFeeRowEl.style.display = 'flex';
            } else {
                processingFeeRowEl.style.display = 'none';
            }

            // Product Name Display
            if (category === 'product') {
                displayProductEl.textContent = productItemName;
                productRowEl.style.display = 'flex';
            } else {
                productRowEl.style.display = 'none';
            }

            displayRateEl.textContent = `${interestRate}% Monthly for ${months} Months`;
            displayEMIEl.textContent = emi.toFixed(2);
            displayTotalAmountEl.textContent = totalPayable.toFixed(2);
            repaymentDateEl.textContent = formatDate(endDate);
            apiApplicantPhotoEl.src = createProxyUrl(member.profilePicUrl);

            // Manual Upload
            if (uploadedFile) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    manualApplicantPhotoEl.src = event.target.result;
                    manualUploadSectionEl.style.display = 'block';
                }
                reader.readAsDataURL(uploadedFile);
            } else if (member.documentUrl) {
                manualApplicantPhotoEl.src = createProxyUrl(member.documentUrl);
                manualUploadSectionEl.style.display = 'block';
            } else {
                manualUploadSectionEl.style.display = 'none';
            }

            letterPreviewSection.classList.remove('hidden');
            letterPreviewSection.scrollIntoView({ behavior: 'smooth' });
        });

        // Download Logic
        downloadBtn.addEventListener('click', async function() {
            downloadBtn.disabled = true;
            downloadBtn.innerHTML = '<div class="loader"></div> Processing...';
            
            try {
                await waitForImages(captureDiv);
                // Slight delay to ensure rendering
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const canvas = await html2canvas(captureDiv, { 
                    scale: 2, 
                    useCORS: true, 
                    logging: false,
                    backgroundColor: '#ffffff'
                });

                const link = document.createElement('a');
                const cleanName = displayNameEl.textContent.replace(/\s+/g, '_') || 'Loan_Form';
                link.download = `${cleanName}_${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                downloadBtn.disabled = false;
                downloadBtn.innerHTML = '<i class="fas fa-check mr-2"></i> Downloaded!';
                setTimeout(() => {
                    downloadBtn.innerHTML = '<i class="fas fa-download mr-2"></i> Download Again';
                }, 3000);

            } catch (err) {
                console.error(err);
                alert('Error generating image.');
                downloadBtn.disabled = false;
                downloadBtn.textContent = 'Try Again';
            }
        });

        // Event Listeners for Dynamic Options
        loanCategorySelect.addEventListener('change', updateOptions);
        amountInput.addEventListener('input', updateOptions);

        fetchMemberData();
    }

    checkAuthAndInitialize();
  </script>
</body>
</html>

